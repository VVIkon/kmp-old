{"version":3,"sources":["../__devel/js/orderEdit/preinit.js","../__devel/js/orderEdit/config/touristDocumentConfig.js","../__devel/js/orderEdit/notifications/errors.js","../__devel/js/orderEdit/notifications/messages.js","../__devel/js/orderEdit/notifications/warnings.js","../__devel/js/orderEdit/components/CustomFieldsFactory.js","../__devel/js/orderEdit/apiclient/clientInfoApi.js","../__devel/js/orderEdit/apiclient/offerInfoApi.js","../__devel/js/orderEdit/apiclient/orderActionsApi.js","../__devel/js/orderEdit/apiclient/orderInfoApi.js","../__devel/js/orderEdit/apiclient/serviceActionsApi.js","../__devel/js/orderEdit/storage/ServiceStorage.js","../__devel/js/orderEdit/storage/TouristStorage.js","../__devel/js/orderEdit/storage/InvoiceStorage.js","../__devel/js/orderEdit/storage/OrderStorage.js","../__devel/js/orderEdit/tourists/view.js","../__devel/js/orderEdit/tourists/controller.js","../__devel/js/orderEdit/services/viewModels/ServiceViewModel.js","../__devel/js/orderEdit/services/viewModels/AviaServiceViewModel.js","../__devel/js/orderEdit/services/viewModels/HotelServiceViewModel.js","../__devel/js/orderEdit/services/view.js","../__devel/js/orderEdit/services/controller.js","../__devel/js/orderEdit/payment/view.js","../__devel/js/orderEdit/payment/controller.js","../__devel/js/orderEdit/view.js","../__devel/js/orderEdit/controller.js"],"names":["KT","crates","OrderEdit","services","tourists","payment","mdx","tpl","global","factory","config","touristDocuments","this","DocConf","$","extend","prototype","getTouristNameFullValidation","RegExp","touristNameValidation","source","getDocumentSerialFullValidation","numberValidation","getDocumentNumberFullValidation","1","docname","hasExpiryDate","2","6","7","9","lifetime","moment","duration","10","18","notifications","bookingFailedNoTourists","type","title","msg","killtarget","timeout","saveServiceFailedNoTourists","saveServiceFailedIncorrectLoyality","linkingTouristFailed","removingTouristFailed","bookingFailed","bookingChangeFailed","bookingCancelFailed","issuingTicketsFailed","saveTouristFailed","loadingDocumentsFailed","loadingHistoryFailed","settingDicountFailed","changingServiceDataFailed","changingReservationDataFailed","changingTicketsDataFailed","cancellingInvoiceFailed","savingUserFailed","savingCustomFieldsFailed","settingServiceToManualFailed","AddingAdditionalServiceFailed","RemovingAdditionalServiceFailed","linkingTourists","touristsLinked","bookingChanged","bookingStarted","bookingFinished","bookingCancelled","ticketsIssued","touristAdded","touristUpdated","touristRemoved","documentUploaded","ontop","discountSet","reservationDataChanged","serviceDataChanged","serviceStatusSet","ticketsDataChanged","invoiceCancelled","userSaved","customFieldsSaved","serviceSetToManual","bookingTermsNotAccepted","bookingChangeNotSupported","bookingChangeProhibited","notAllTouristsLinked","touristLinkageNotAllowedByDocument","touristLinkageNotAllowedByAge","incorrectTouristData","uploadDocumentFailed","uploadDocumentNotAllowedByFilesize","pricesChanged","waitTOSLoading","noManualEditForm","reservationNumberNotSet","ticketNumberNotEntered","ticketTouristNotSet","changingTicketNotSelected","notAllCustomFieldsSet","customFieldsRevealed","CustomFieldsFactory","CustomField","fieldConfig","fieldTypeId","typeTemplate","fieldTypeName","required","require","modifiable","modifyAvailable","valueOptions","availableValueList","value","$field","$control","$errorTarget","$focusTarget","render","Mustache","find","prop","initialize","Error","getValue","val","validate","fieldValue","undefined","self","addClass","one","removeClass","cfunc","Object","create","__super__","constructor","fieldTypeMap","hasOwnProperty","TextCF","call","Array","isArray","selectize","openOnFocus","maxItems","options","map","option","label","selectOnTab","labelField","$control_input","addItem","jirafize","position","buttons","name","callback","$el","change","TextAreaCF","NumberCF","v","Number","on","e","char","String","fromCharCode","which","test","replace","DateCF","calendarTpl","format","clndrize","template","eventName","showDate","3","4","extendApiClient","ApiClient","getClientUserSuggest","_instance","rest","caller","data","url","urls","done","success","fail","error","setUser","userData","touristId","request","Deferred","response","resolve","reject","getClientUser","documentId","docId","apiClient","getHotelInfo","hotelId","params","lang","setDiscount","orderId","discount","agentOrderDiscount","removeOrderTourist","setOrderTourist","OrderStorage","touristData","indexOf","action","actionParams","orderWorkflowManager","uploadDocument","$docform","ajaxSubmit","usertoken","profile","userToken","uploadProgress","total","percent","dispatch","loadedData","JSON","parse","xhr","text","err","setInvoice","orderStorage","invoiceData","invoiceServices","forEach","invoice","push","serviceId","id","invoicePrice","sum","userId","paymentType","currency","getServices","prices","inClient","currencyCode","Services","cancelInvoice","invoiceId","getOrderInfo","getInCurrency","viewCurrency","getOrder","getOrderOffers","serviceIds","servicesIds","getOrderTourists","status","body","tourist","surName","lastName","document","serialNum","serialNumber","getOrderInvoices","getOrderDocuments","getOrderHistory","getAllowedTransitions","operation","checkWorkflow","validateAction","service","i","startBooking","issueTickets","bookChange","bookCancel","setServiceToManual","setTouristsLinkage","linkageInfo","setServiceData","manualSetStatus","setReservationData","setTicketsData","setServiceAdditionalData","customFieldsValues","additionalFields","addExtraService","removeExtraService","storage","ServiceStorage","processCancelPenalties","penaltiesInLocal","penaltiesInView","penaltiesInClient","length","console","penalties","localPenalty","dateFrom","dateTo","description","penaltySum","inLocal","penalty","amount","inView","ktStorage","namespace","isPartial","isTOSAgreementSet","tosDocumentName","client","net","gross","commission","supplier","inSupplier","offerInfo","isNonRefundable","clientCancelPenalties","supplierCancelPenalties","penaltySums","requestData","allowedTransitions","invoiceSum","unpaidSum","hasTravelPolicy","hasTPViolations","additionalServices","customFields","addMixin","serviceData","serviceID","isNotEmpty","serviceName","serviceDescription","isOffline","offline","typeCode","serviceType","cancellationDocumentName","fareRuleDocumentName","gatewayId","supplierId","startDate","startDateTime","endDate","endDateTime","creationDate","dateOrdered","dateAmend","localSum","localCommission","localNetSum","requestedSum","requestedNetSum","supplierCurrencyCode","supplierPrice","supplierNetPrice","paymentCurrencyCode","paymentSum","paymentCurrency","additionalData","isActionAvailable","userType","updateFullInfo","serviceStatus","salesTerms","serviceSalesTermsInfo","localCurrency","amountNetto","amountBrutto","supplierCurrency","clientCurrency","restPaymentAmount","restPaymentAmountCurrency","touristAges","adults","serviceTourists","children","declaredTouristAges","infants","adult","child","infant","fareRules","fareRule","aviaFareRule","shortRules","refund_before_rule","cancelPenalties","clientPenaltiesLocal","clientPenaltiesView","clientPenaltiesClient","supplierPenaltiesLocal","supplierPenaltiesView","supplierPenaltiesClient","valueOf","endOf","declaredTouristAmount","agegroup","travelPolicy","travelPolicyFailCodes","addServices","setAllowedTransitions","controls","checkTransition","transition","getServiceTourists","getAgeByServiceEnding","birthdate","asYears","getAgeGroup","age","checkAllTouristsLinked","allLinked","setTouristAges","countClientCancelPenalty","reduce","log","isBetween","compareSalesTerms","addAdditionalService","addService","removeAdditionalService","addServiceId","filter","idAddService","TouristStorage","linkedServices","bonusCards","firstname","htmlDecode","firstName","lastname","middlename","middleName","sex","email","phone","countryCode","cityCode","number","phoneparsed","match","isTourleader","isTourLeader","documentData","series","documentType","expiryDate","citizenship","loyalityProviderId","aviaLoyalityProgrammId","loyalityCardNumber","bonuscardNumber","touristAdditionalData","initializeFromUser","user","surname","secondName","prefix","contactPhone","birthDate","docSerial","docNumber","docType","docExpiryDate","addData","getPhoneNumber","InvoiceStorage","statuses","WAIT","INVOICED","PARTIAL_PAID","PAID","CANCELLED","invoiceNum","invoiceCur","serviceDetails","InvoiceServices","serviceSum","getServiceDetails","srv","loadStates","orderdata","servicedata","invoicedata","touristdata","transitionsdata","invoices","documents","history","pendingValidations","validatedActions","orderData","orderIdGp","orderIdUtk","isVip","VIP","isArchived","archive","isAddTouristAllowed","contractId","contractID","orderDate","creator","companyRoleType","roleType","kmpManager","managerKMP","clientManager","agentId","agencyName","tourleader","touristFirstName","touristLastName","liderPhone","liderEmail","touristsAmount","touristsNums","servicesTouristLinkage","initializeBare","bareData","clientType","clientId","clientName","setDocuments","items","setHistory","records","setServices","updateServiceTourists","getServiceIds","setInvoices","getInvoices","setTourists","linkedService","isAttached","getTourists","updateServiceId","saveTourist","Tourist","saveServiceLinkage","touristLinkage","link","removeTourist","transitions","createLinkageStructure","newTouristLinkage","linkedTourists","state","notify","getServiceCommandParams","command","agreementSet","createPenaltyInvoice","setValidatedAction","validationResults","validated","validationResult","view","crate","makeInvalid","attr","removeAttr","validateControl","rule","flag","cv","validateDate","frmt","constraints","clndr","cvdate","closest","end","initLoyalityProgramSelect","controlOptions","plugins","valueField","searchField","item","aircompanyName","allianceName","IATAcode","loyalityProgramName","modView","module","mds","templateUrl","templates","touristForm","touristFormActions","touristFormBonusCard","touristFormNoBonusCards","touristFormBonusCardActions","touristListControls","touristListEmpty","$tabLabel","$touristList","$touristListControls","touristForms","tlFlag","doctypes","doctype","countries","country","countryCodes","renderTouristList","empty","actions","allowAdd","html","Tourists","sort","a","b","isTourleaderSet","orderClientType","touristInfo","mapTouristInfo","allowedSave","allowedUserCreation","allowedReset","allowedDelete","appendTo","initControls","initCustomFields","addTouristForm","isNewOrder","tempTouristId","formActions","isNewTourist","isEditable","allowedTouristSelect","bonusCardsActions","add","key_down","start","highlight","loadThrottle","sortField","score","load","query","clearOptions","companyId","substringFIO","$selinp","seqid","setTimeout","refreshOptions","onType","str","close","onItemRemove","onChange","trigger","yh","offset","top","stop","animate","scrollTop","renderPendingProcess","$touristForm","spinner","refreshTouristForm","$target","$newForm","off","replaceWith","refreshTouristFormActions","$tourist","removeTouristForm","$tourists","adjustScroll","formOffset","slideUp","remove","each","subtract","onItemAdd","$input","Dictionary","getAsList","then","loyalityPrograms","currentValue","livecheckDocument","addBonusCardForm","$cardsList","removeBonusCardForm","$bonusCard","typeSorting","fieldData","customField","$customFields","lockClientSelect","$dataForm","$clientSuggest","disable","css","display","unlockClientSelect","enable","slideDown","getTouristFormData","$form","vname","digit","$phoneblock","$c","livetrim","countryPrefix","cityPrefix","livecapitalize","serial","errorflag","formdata","parseInt","documentConfig","docTouristNameTest","docSerialTest","docNumberTest","user_documentID","toUpperCase","join","charAt","$programId","$cardNumber","cardId","aviaLoyaltyProgramId","userAdditionalFields","field","getUserFormData","citizenshipId","сontactPhone","userDocId","$fioFields","$series","$number","$expiryDate","split","pop","removeTLSetter","rearrange","detach","prependTo","phoneCountryCode","phoneCityCode","phoneNumber","isMale","card","hasCustomFields","copyNamesToDoc","transliterate","showRevertAddTouristModal","submitAction","Modal","showRemoveTouristModal","controller","oetController","init","window","sessionStorage","removeItem","touleader","newTouristId","hasClass","target","stopPropagation","closeModal","showLoader","errors","substr","preventDefault","currentTouristId","location","assign","updateTouristForm","savingTourist","savingUser","when","touristResponse","userResponse","isNaN","$leaderToggler","submit","ServiceViewModel","headerView","mainView","additionalServicesView","minimalPriceView","actionsView","prepareViews","prepareHeaderView","prepareMainView","prepareActionsView","processCustomFields","unprocessedFields","getCustomFieldsValues","noErrors","mapTouristsInfo","getTouristsMap","touristsMap","checkTouristAddAllowance","isAddingAllowed","ag","touristsAges","ordered","current","setCommonManualFormParams","clientGrossPrice","toMoney","agentCommission","supplierGrossPrice","penaltyIndex","dateFormat","currencyIcon","getCatalogInfo","initManualFormControls","$wnd","$root","$currencyLabels","allowEmptyOption","setValidation","price","parseFloat","servicestatuses","icon","AviaServiceViewModel","ticketStatusMap","suppliersMap","serviceTypeName","fareRulesView","tripData","tripDates","tripPoints","hasPnr","pnrNumber","tickets","receipts","ticketLink","supplierCode","supplierName","manualFormParams","aviaFormHeader","aviaFormMain","aviaServiceActions","aviaTrip","aviaTripRoute","aviaLoyaltyCard","aviaNoLoyaltyCards","aviaFareRuleUnavailable","aviaMinimalPrice","aviaManualForm","wd","dm","processTrips","processPnr","pnr","itinerary","trip","firstSegment","segments","lastSegment","startdate","departureDate","marketingAirlineCode","marketingAirline","dep","city","departureCityName","iata","departureAirportCode","arr","arrivalCityName","arrivalAirportCode","tripRoute","alName","airlineCodes","alLogo","hasLogo","seg","segIndex","waitingTime","nextseg","fhm","arrivalDate","thm","asMinutes","flightNum","flightNumber","transporter","operatingAirline","code","aircraft","class","categoryClassType","className","dhours","dminutes","startpoint","airport","departureAirportName","terminal","departureTerminal","date","time","endpoint","arrivalAirportName","arrivalTerminal","waiting","hours","Math","floor","minutes","stops","baggageInfo","baggage","measureQuantity","measureCode","declOfNum","segment","transfersAmount","route","transfersNum","pnrBaggageInfo","info","receiptUrl","ticket","ticketStatus","ticketNumber","minimalPriceData","from","to","dateStart","dateFinish","changes","firstFlightNumber","firstFlightNum","amendDate","priceLocal","priceInView","viewCurrencyIcon","statusIcon","statusTitle","dates","flights","passengers","lastTicketingDate","offerSupplier","flightTrips","overNightFlight","nightTransfer","serviceActions","getServiceActions","prepareFareRulesView","rules","isActiveTab","locationMap","iataCodes","flightSegmentName","fullSegmentName","allowed","forbidden","active","rulesText","prepareEmptyFareRulesView","$container","overrideSave","isSavingAllowed","isLinked","linkedTourist","touristExtra","issuedTickets","loyalityProgram","allowSave","attached","renderTouristControls","getAsMap","loyalityProgramsMap","bonusCardsOptions","cardNumber","$providerSelect","currentProvider","onClear","programId","ManualEdit","save","BookStart","agreementDisabled","defineTermsDocuments","termsDocuments","companyTOS","renderer","loader","renderManualForm","commonParams","flightTariff","fullname","disabled","newNumber","newTicket","aviaSuppliers","ticketsList","$ticketsList","$changeTicketForm","$addTicketForm","$changingTicketSelect","$addNewTicketButton","getChangeBookDataParams","$manualForm","tariff","reservationData","reservationAction","PNR","aviaReservation","getChangeTicketDataParams","changingTicket","changingTicketSelect","changingTicketNumber","newTicketNumber","ticketData","ticketAction","getAddTicketParams","HotelServiceViewModel","categoryMap","FIVE","FOUR","THREE","TWO","ONE","bookTermsView","hotelName","hotelAddress","hotelPhoto","category","roomType","voucherLink","hasAdditionalServices","hotelFormHeader","hotelFormMain","hotelServiceActions","hotelBookTerms","hotelFullInfo","hotelAdditionalServices","hotelMinimalPrice","hotelManualForm","processHotelInfo","processReservation","prepareAdditionalServicesView","prepareBookTermsView","hotelInfo","address","mainImageUrl","c","stars","hotelReservations","reservationNumber","hotelVouchers","room","mealType","daysCount","startOf","diff","priorityOffer","days","count","residents","nightsCount","roomTypeDescription","fareName","fareDescription","availableAddServices","issuedAddServices","issuedServiceTypes","serviceSubType","oneOfTypeAllowed","Boolean","bookingSomeServices","addServiceTypes","issued","localSalesTerms","salesTermsInfo","viewSalesTerms","addServiceStatus","typeName","localPrice","viewPrice","isBooked","bookedWithService","bookAllowed","removeAllowed","available","addingAllowed","localAmount","viewAmount","initAddServicesControls","$availableAddServicesList","$showAddServiceList","$hideAddServiceList","reservation","hotelSuppliers","newReservationNumber","staticDocumentUrl","serviceForm","serviceTourist","serviceListEmpty","pricesChangedModal","bookChangeModal","bookCancelModal","sendToManagerModal","servicesTermsDocuments","$serviceList","$manualFormsRoot","$bookChangeModal","serviceViewModels","serviceForms","BookChangeModal","setBookChangeModal","BookCancelModal","setBookCancelModal","HotelInfoPages","setHotelInfoPages","ManualEditForms","setManualEditForms","renderServices","renderProcess","getAviaSuppliersMap","getHotelSuppliersMap","aviaSuppliersMap","hotelSuppliersMap","savescroll","srvFormStatus","prepare","$serviceForm","isCancelled","serviceIcon","header","main","minimalPrice","travelPolicyViolations","list","allowTouristAdd","prepareServiceTermsDocuments","doc","open","renderServiceTourists","getServiceTermsDocuments","promise","renderEmptyServiceList","renderPendingServiceProcess","navigateToService","$service","$serviceTourists","renderServiceActions","getServiceTouristsData","$bindControl","$loyalityProgramSelect","$loyalityProvider","$loyalityNumber","featherlight","lightbox","classes","attributes","persist","closeIcon","openSpeed","closeSpeed","$content","ajax","stringify","contentType","updateFareRules","serviceView","fareRuleDocument","updateAdditionalServices","elem","forms","variant","manualFormRendered","manualForm","warn","$tabs","maxHeight","height","getSaveServiceDataParams","agencyProfit","clientPrice","penaltyCurrency","penaltyAmount","cancelPenalty","orderServiceData","getSaveServiceStatusParams","newStatus","setOffline","comment","online","loaded","dummyPhoto","photoLinkTest","serviceGroupMap","Продленная регистрация","В номере","Общие","Стойка регистрации","Дети","НА свежем воздухе","Бизнес","Развлечения","Питание и напитки","Спорт/Здоровье","Трансфер","Парковка","Сейф","Персонал говорит","Интернет","Домашние животные","hotel","descriptions","descriptionTypes","descriptionType","unshift","serviceMap","serviceGroupCode","group","hotelChain","mainImage","cityName","countryName","checkIn","checkInTime","checkOut","checkOutTime","distance","fax","siteurl","photos","images","$hotelInfo","parent","background-image","wrapInner","append","baron","root","scroller","bar","track","scrollingCls","draggingCls","showPricesChangedModal","newSalesTerms","Service","cancelAction","oldPrice","newPrice","showNonrefundableModal","$modal","showModal","toManagerAction","modalParams","dateIn","dateOut","clearData","showSendToManagerModal","getParams","linkedAmount","$dateIn","$dateOut","getToManagerParams","$comment","cancelPenaltySum","viewAmout","isInvoiceOptional","$isSetInvoiceSelected","commandParams","oesController","callServicesRendering","showService","getItem","fareRulesLoader","retry","offersData","linkingServiceId","activeTab","result","serviceid","$sf","$dataform","saveCustomFields","bookService","always","bookChangeParams","errorCode","toManagerParams","bookCancelParams","setItem","$addService","touristIds","addServiceOfferId","orderTourists","bookrequest","newOfferData","rebookResponse","serviceList","serviceListRow","serviceNoActions","invoiceListItem","invoiceListItemService","invoiceListEmpty","TOSAgreementModal","multiBookCancelModal","$invoiceList","$invoiceActions","discountSum","renderServiceList","totalNet","totalGross","totalCommission","totalDiscount","showNetPrice","serviceInfo","serviceTable","profit","$discountField","margin","toFixed","not","clearServiceActions","getSelectedServices","renderInvoiceList","Invoices","invoiceList","Invoice","currencySign","invoiceInfo","cancel","flushInvoiceList","flushServiceList","showChainBookingModal","tosData","tosDocName","showChainBookCancelModal","hasPenalty","servicePenalty","showChainIssueModal","showChainSetToManualModal","showCancelInvoiceModal","oepController","flushSetInvoiceForm","$invoice","toggle","checkedServices","servicesTransitions","validationParams","transitionsAmount","shift","every","paramsMergeError","serviceValidations","hasNonRefundableServices","tosdoc","bookProcesses","apply","bookCancelProcesses","$serviceInvoiceCheckbox","issueProcesses","chainProcesses","headerOrderInfo","headerSpinner","invoicesRow","documentsRow","documentsEmpty","historyRow","$headerInfo","$headerControls","$breadcrumb","$btnInvoices","$btnDocuments","SetInvoiceForm","$wrapper","wnd","$history","History","$addServiceBlock","initTabs","enableTab","tab","disableTab","setActiveTab","renderHeaderInfo","tourleaderName","hasTourleader","gatewayOrderIds","clientCompany","gp","utk","order","vip","orderStatusIcon","orderStatusTitle","touristSet","touristName","touristCount","touristTel","touristEmail","requestedCurrency","$bindcontainer","bindelem","toggler","historyList","record","eventTime","serviceStatusTitle","serviceStatusIcon","orderStatus","renderSetInvoiceForm","invoiceRows","leftToPay","invoiceTable","selectPayment","createOnBlur","renderDocumentsForm","documentsList","fileName","showDocUploadProgress","$progresslabel","$progressbar","width","flushDocumentsForm","checkInvoiceFormInput","$serviceRow","maxInvoiceSum","$inputs","$checkbox","inputValue","markServiceForInvoice","defaultInvoiceSum","getInvoiceFormData","invServices","hasZeroSum","$row","flushTopInfo","oeController","pathname","orderInfo","transitionsData","high","file","$lbl","files","reset","show","hide","getTemplates","loadBare","getStoredSettings","companyInfo","fieldsFilter","clientData"],"mappings":"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","file":"cui-orderEdit.min.js","sourcesContent":["KT.crates.OrderEdit = {};\nKT.crates.OrderEdit.services = {};\nKT.crates.OrderEdit.tourists = {};\nKT.crates.OrderEdit.payment = {};\n\nKT.mdx.OrderEdit = {};\nKT.mdx.OrderEdit.tpl = {};\nKT.mdx.OrderEdit.services = {};\nKT.mdx.OrderEdit.tourists = {};\nKT.mdx.OrderEdit.payment = {};\n","/**\n* Конфигурация документов туриста \n*/\n(function(global, factory) {\n\n    KT.config.touristDocuments = factory();\n\n}(this, function() {\n    /* Объект конифгурации документа */\n    var DocConf = function(config) {\n      $.extend(this, config); \n    };\n\n    /* Формирование теста для полей ФИО в документе */\n    DocConf.prototype.getTouristNameFullValidation = function() {\n      return new RegExp( ('^('+this.touristNameValidation[0].source+')+$') );\n    };\n    /* Формирование теста для поля серии документа */\n    DocConf.prototype.getDocumentSerialFullValidation = function() {\n      return new RegExp(\n          '^' + this.numberValidation[0].source +\n          this.numberValidation[2] + '$'\n      );\n    };\n    /* Формирование теста для поля номера документа */\n    DocConf.prototype.getDocumentNumberFullValidation = function() {\n      return new RegExp(\n        '^' + this.numberValidation[1].source +\n        this.numberValidation[3] + '$'\n      );\n    };\n\n    /*\n    * Внимание! формат количества символов исключительно в форме {\\d} или {\\d,\\d},\n    * см. функцию livecheckDocument в tourists/view.js\n    */\n    var documentConfig = {\n      1: new DocConf({\n        docname: 'Паспорт гражданина РФ',\n        numberValidation: [/[0-9]/,/[0-9]/,'{4}','{6}'],\n        touristNameValidation: [/[A-z-]/],\n        hasExpiryDate: false,\n      }),\n      2: new DocConf({\n        docname: 'Загран паспорт гражданина РФ',\n        numberValidation: [/[0-9]/,/[0-9]/,'{2}','{7}'],\n        touristNameValidation: [/[A-z-]/],\n        hasExpiryDate: true,\n      }),\n      6: new DocConf({\n        docname: 'Военный билет солдата (матроса, сержанта, старшины)',\n        numberValidation: [/[А-я]/,/[0-9]/,'{2}','{7}'],\n        touristNameValidation: [/[A-z-]/],\n        hasExpiryDate: false,\n      }),\n      7: new DocConf({\n        docname: 'Военный билет офицера',\n        numberValidation: [/[А-я]/,/[0-9]/,'{2}','{7}'],\n        touristNameValidation: [/[A-z-]/],\n        hasExpiryDate: false,\n      }),\n      9: new DocConf({\n        docname: 'Удостоверение личности моряка',\n        numberValidation: [/[XIVLMCxivlmc]/,/[0-9]/,'{2}','{7}'],\n        touristNameValidation: [/[A-z-]/],\n        hasExpiryDate: true,\n        lifetime: moment.duration(5, 'years')\n      }),\n      10: new DocConf({\n        docname: 'Свидетельство о рождении',\n        numberValidation: [/[А-я]|[XIVLMCxivlmc-]/,/[0-9]/,'{1,6}','{6}'],\n        touristNameValidation: [/[A-z-]/],\n        hasExpiryDate: false\n      }),\n      18: new DocConf({\n        docname: 'Другой документ',\n        numberValidation: [/./,/./,'{0,10}','{0,30}'],\n        touristNameValidation: [/./],\n        hasExpiryDate: false\n      })\n    };\n\n    return documentConfig;\n}));","$.extend(KT.notifications,{\n  'bookingFailedNoTourists': {\n    type:'warning',\n    title:'Не удалось забронировать услугу',\n    msg:'Вы еще не добавили туристов в заявку!',\n    killtarget:'body',\n    timeout:10000\n  },\n  'saveServiceFailedNoTourists': {\n    type:'warning',\n    title:'Не удалось сохранить услугу',\n    msg:'Вы еще не добавили туристов в заявку!',\n    killtarget:'body',\n    timeout:10000\n  },\n  'saveServiceFailedIncorrectLoyality': {\n    type:'warning',\n    title:'Не удалось сохранить услугу',\n    msg:'Некорректные данные программы лояльности',\n    killtarget:'body',\n    timeout:10000\n  },\n  'linkingTouristFailed': {\n    type:'error',\n    title:'Не удалось сохранить привязку!',\n    msg:'',\n    killtarget:'body'\n  },\n  'removingTouristFailed': {\n    type:'error',\n    title:'Не удалось удалить туриста!',\n    msg:'',\n    killtarget:'body'\n  },\n  'bookingFailed': {\n    type:'error',\n    title:'Бронирование не запустилось',\n    msg:'Не удалось запустить процесс бронирования, обратитесь к менеджеру КМП для уточнения причин'\n  },\n  'bookingChangeFailed': {\n    type:'error',\n    title:'Не удалось изменить данные брони',\n    msg:'Не удалось изменить данные брони, обратитесь к менеджеру КМП для уточнения причин'\n  },\n  'bookingCancelFailed': {\n    type:'error',\n    title:'Бронь не отменена',\n    msg:'Не удалось отменить бронирование, обратитесь к менеджеру КМП для уточнения причин'\n  },\n  'issuingTicketsFailed': {\n    type:'error',\n    title:'Выписка билетов не удалась!',\n    msg:'',\n    killtarget:'body',\n    timeout:10000\n  },\n  'saveTouristFailed': {\n    type:'error',\n    title:'Не удалось сохранить туриста',\n    msg:'',\n    killtarget:'body'\n  },\n  'loadingDocumentsFailed': {\n    type:'error',\n    title:'Не удалось загрузить документы',\n    msg:'',\n    killtarget:'body'\n  },\n  'loadingHistoryFailed': {\n    type:'error',\n    title:'Не удалось загрузить историю заявки',\n    msg:'',\n    killtarget:'body'\n  },\n  'settingDicountFailed': {\n    type:'error',\n    title:'Не удалось сохранить скидку',\n    msg:''\n  },\n  'changingServiceDataFailed': {\n    type:'error',\n    title:'Не удалось изменить данные услуги',\n    msg:''\n  },\n  'changingReservationDataFailed': {\n    type:'error',\n    title:'Не удалось изменить данные брони',\n    msg:''\n  },\n  'changingTicketsDataFailed': {\n    type:'error',\n    title:'Не удалось изменить данные билетов',\n    msg:''\n  },\n  'cancellingInvoiceFailed': {\n    type:'error',\n    title:'Не удалось отменить счет',\n    msg:''\n  },\n  'savingUserFailed': {\n    type:'error',\n    title:'Не удалось сохранить сотрудника',\n    msg:''\n  },\n  'savingCustomFieldsFailed': {\n    type:'error',\n    title:'Не удалось сохранить данные услуги',\n    msg:''\n  },\n  'settingServiceToManualFailed': {\n    type:'error',\n    title:'Не удалось отправить запрос на изменение услуги менеджеру',\n    msg:''\n  },\n  'AddingAdditionalServiceFailed': {\n    type:'error',\n    title:'Не удалось добавить дополнительную услугу',\n    msg:''\n  },\n  'RemovingAdditionalServiceFailed': {\n    type:'error',\n    title:'Не удалось удалить дополнительную услугу',\n    msg:''\n  }\n});\n","$.extend(KT.notifications,{\n  'linkingTourists': {\n    type:'success',\n    title:'Выполняется привязка туристов...',\n    msg:'',\n    killtarget:'body',\n    timeout:1000\n  },\n  'touristsLinked': {\n    type:'success',\n    title:'Привязка туристов прошла успешно!',\n    msg:'',\n    killtarget:'body'\n  },\n  'bookingChanged': {\n    type:'success',\n    title:'Данные брони успешно изменены',\n    msg:''\n  },\n  'bookingStarted': {\n    type:'success',\n    title:'Бронирование началось!',\n    msg:'Процесс бронирования успешно запущен'\n  },\n  'bookingFinished': {\n    type:'success',\n    title:'Бронирование завершено!',\n    msg:'Услуга успешно забронирована'\n  },\n  'bookingCancelled': {\n    type:'success',\n    title:'Бронь отменена!',\n    msg:'Отмена брони прошла успешно'\n  },\n  'ticketsIssued': {\n    type:'success',\n    title:'Выписка билетов совершена успешно!',\n    msg:'Маршрутная квитанция отправлена на указанный e-mail',\n    killtarget:'body',\n    timeout:10000\n  },\n  'touristAdded': {\n    type:'success',\n    title:'Информация сохранена успешно!',\n    msg:'Турист <b>{{name}}</b> добавлен в заявку',\n    killtarget:'body'\n  },\n  'touristUpdated': {\n    type:'success',\n    title:'Информация сохранена успешно!',\n    msg:'Информация по туристу <b>{{name}}</b> обновлена',\n    killtarget:'body'\n  },\n  'touristRemoved': {\n    type:'success',\n    title:'Операция выполнена успешно!',\n    msg:'Турист <b>{{name}}</b> удален из заявки',\n    killtarget:'body'\n  },\n  'documentUploaded': {\n    type:'success',\n    title:'Документ успешно загружен!',\n    msg:'',\n    ontop:true,\n    killtarget:'body'\n  },\n  'discountSet': {\n    type:'success',\n    title:'Скидка успешно выставлена!',\n    msg:'Новый размер скидки: {{discount}}'\n  },\n  'reservationDataChanged': {\n    type:'success',\n    title:'Данные брони успешно изменены!',\n    msg:''\n  },\n  'serviceDataChanged': {\n    type:'success',\n    title:'Данные услуги успешно изменены!',\n    msg:''\n  },\n  'serviceStatusSet': {\n    type:'success',\n    title:'Статус услуги успешно изменен!',\n    msg:''\n  },\n  'ticketsDataChanged': {\n    type:'success',\n    title:'Данные билетов успешно изменены!',\n    msg:''\n  },\n  'invoiceCancelled': {\n    type:'success',\n    title:'Счет успешно отменен!',\n    msg:''\n  },\n  'userSaved': {\n    type:'success',\n    title:'Данные сотрудника успешно сохранены!',\n    msg:''\n  },\n  'customFieldsSaved': {\n    type:'success',\n    title:'Внесенные данные успешно сохранены!',\n    msg:''\n  },\n  'serviceSetToManual': {\n    type:'success',\n    title:'Услуга передана менеджеру на редактирование',\n    msg:''\n  }\n});\n","$.extend(KT.notifications,{\n  'bookingFailedNoTourists': {\n    type:'warning',\n    title:'Не удалось забронировать услугу',\n    msg:'Вы еще не добавили туристов в заявку!',\n    killtarget:'body',\n    timeout:10000\n  },\n  'saveServiceFailedNoTourists': {\n    type:'warning',\n    title:'Не удалось сохранить услугу',\n    msg:'Вы еще не добавили туристов в заявку!',\n    killtarget:'body',\n    timeout:10000\n  },\n  'bookingTermsNotAccepted': {\n    type:'warning',\n    title:'Вы не можете начать бронирование',\n    msg:'Необходимо подтвердить согласие с условиями бронирования',\n    killtarget:'body',\n    timeout:10000\n  },\n  'bookingChangeNotSupported': {\n    type:'warning',\n    title:'Невозможно изменить бронь',\n    msg:'Поставщик не поддерживает изменение брони'\n  },\n  'bookingChangeProhibited': {\n    type:'warning',\n    title:'Невозможно изменить бронь',\n    msg:'Поставщик отказал в изменении брони для данной услуги'\n  },\n  'notAllTouristsLinked': {\n    type:'warning',\n    title:'Вы не можете выполнить операцию',\n    msg:'Необходимо прикрепить к услуге заявленное число туристов',\n    killtarget:'body',\n    timeout:10000\n  },\n  'touristLinkageNotAllowedByDocument': {\n    type:'warning',\n    title:'Туриста нельзя привязать к услуге',\n    msg:'У туриста заканчивается срок действия документа',\n    killtarget:'body',\n    timeout:10000\n  },\n  'touristLinkageNotAllowedByAge': {\n    type:'warning',\n    title:'Данного туриста нельзя привязать к услуге',\n    msg:'В эту услугу нельзя добавить еще одного туриста данной возрастной группы',\n    killtarget:'body',\n    timeout:10000\n  },\n  'incorrectTouristData': {\n    type:'warning',\n    title:'Некорретные данные!',\n    msg:'Проверьте форму на правильность заполнения',\n    killtarget:'body'\n  },\n  'uploadDocumentFailed': {\n    type:'warning',\n    title:'Не удалось загрузить документ',\n    msg:'Сбой загрузки, попробуйте еще раз',\n    ontop:true,\n    killtarget:'body'\n  },\n  'uploadDocumentNotAllowedByFilesize': {\n    type:'warning',\n    title:'Не удалось загрузить документ',\n    msg:'Размер файла превышает допустимое значение',\n    ontop:true,\n    killtarget:'body'\n  },\n  'pricesChanged': {\n    type:'warning',\n    title:'Изменились цены предложения',\n    msg:'Для продолжения операции требуется подтверждение согласия с новыми ценами',\n    ontop:true,\n    killtarget:'body'\n  },\n  'waitTOSLoading': {\n    type:'warning',\n    title:'Документ еще загружается',\n    msg:'Попробуйте открыть снова через несколько секунд',\n    ontop:true,\n    killtarget:'body'\n  },\n  'noManualEditForm': {\n    type:'warning',\n    title:'Нет формы для редактирования услуги',\n    msg:'Для данной услуги не поддерживается ручное редактирование',\n    ontop:true,\n    killtarget:'body'\n  },\n  'reservationNumberNotSet': {\n    type:'warning',\n    title:'Не указан номер брони',\n    msg:'Для создания брони необходимо указать номер',\n    ontop:true,\n    killtarget:'body'\n  },\n  'ticketNumberNotEntered': {\n    type:'warning',\n    title:'Не указан номер билета',\n    msg:'Введите номер билета',\n    ontop:true,\n    killtarget:'body'\n  },\n  'ticketTouristNotSet': {\n    type:'warning',\n    title:'Не указан турист для создания билета',\n    msg:'Укажите туриста',\n    ontop:true,\n    killtarget:'body'\n  },\n  'changingTicketNotSelected': {\n    type:'warning',\n    title:'Не выбран билет для редактирования',\n    msg:'Выберите билет',\n    ontop:true,\n    killtarget:'body'\n  },\n  'notAllCustomFieldsSet': {\n    type:'warning',\n    title:'Не все обязательные поля заполнены',\n    msg:'',\n    ontop:true,\n    killtarget:'body'\n  },\n  'customFieldsRevealed': {\n    type:'warning',\n    title:'Проверьте данные',\n    msg:'У туриста есть незаполненные дополнительные поля',\n    ontop:true,\n    killtarget:'body'\n  }\n});\n","/* Фабрика обработчиков дополнительных полей */\n(function(global,factory) {\n\n    KT.crates.OrderEdit.CustomFieldsFactory = factory();\n    \n}(this, function() {\n\n  /** \n  * Базовый класс кастомных полей\n  * @param {Object} fieldConfig - конфиг поля\n  * @param {String} tpl - строка шаблона Mustache\n  */\n  var CustomField = function(fieldConfig) {\n    this.fieldTypeId = fieldConfig.fieldTypeId;\n    this.typeTemplate = fieldConfig.typeTemplate;\n    this.fieldTypeName = fieldConfig.fieldTypeName;\n\n    this.required = fieldConfig.require;\n    this.modifiable = fieldConfig.modifyAvailable;\n\n    this.valueOptions = fieldConfig.availableValueList;\n    this.value = fieldConfig.value;\n\n    // весь блок элемента управления\n    this.$field = null;\n    // сам элемент (input, select, etc.)\n    this.$control = null;\n    // элемент для сигнализации ошибки\n    this.$errorTarget = null;\n    // элемент, получающий фокус\n    this.$focusTarget = null;\n  };\n\n  /** \n  * Генерирует html-код поля\n  * @return {Object} [jQuery DOM] html-код поля\n  */\n  CustomField.prototype.render = function() {\n    this.$field = $(Mustache.render(this.tpl, {\n      'fieldTypeId': this.fieldTypeId,\n      'fieldTypeName': this.fieldTypeName,\n      'required': this.required\n    }));\n\n    this.$control = this.$field.find('.js-custom-field--control');\n\n    if (!this.modifiable) {\n      this.$control.prop('disabled', true);\n    }\n\n    return this.$field;\n  };\n\n  /** Инициализация поля */\n  CustomField.prototype.initialize = function() { throw new Error('CustomField:init not implemented'); };\n\n  /** \n  * Получение значения поля \n  * @return {*} -значение поля\n  */\n  CustomField.prototype.getValue = function() {\n    return this.$control.val();\n  };\n\n  /** \n  * Проверка значения поля. Если не пройдена, поле отмечается классом ошибки\n  * @param {*} [fieldValue] - если указано значение, проверяется оно, иначе сначала будет вызван getValue()\n  * @return {Boolean} результат проверки\n  */\n  CustomField.prototype.validate = function(fieldValue) {\n    if (fieldValue === undefined) {\n      fieldValue = this.getValue();\n    }\n\n    if (fieldValue === '') {\n      var self = this;\n\n      if (this.required) {\n        self.$errorTarget.addClass('error');\n        self.$focusTarget.one('focus change', function() {\n          self.$errorTarget.removeClass('error');\n        });\n        return false;\n      } else {\n        return true;\n      }\n    } else {\n      return true;\n    }\n  };\n\n  /** Механизм наследования */\n  CustomField.extend = function (cfunc) {\n    cfunc.prototype = Object.create(this.prototype);\n    cfunc.__super__ = this.prototype;\n    cfunc.constructor = cfunc;\n    return cfunc;\n  };\n\n  /*=================================\n  *  Фабрика кастомных полей\n  *=================================*/\n  /** Список обработчиков доп. полей */\n  var fieldTypeMap;\n\n  /**\n  * @param {Object} tpl - список шаблонов \n  */\n  var CustomFieldsFactory = function(tpl) {\n    this.tpl = tpl;\n  };\n    \n  /**\n  * Создает объект управления дополнительным полем\n  * @param {Object} fieldConfig - конфигурация поля (sk_user_corporate_fields)\n  */\n  CustomFieldsFactory.prototype.create = function(fieldConfig) {\n    if (fieldTypeMap.hasOwnProperty(fieldConfig.typeTemplate)) {\n      return new fieldTypeMap[fieldConfig.typeTemplate](fieldConfig, this.tpl);\n    } else {\n      return null;\n    }\n  };\n\n  /*=================================\n  *  Классы полей\n  *=================================*/\n\n  /* Строка текста */\n  var TextCF = CustomField.extend(function(fieldConfig, tpl) {\n    CustomField.call(this, fieldConfig);\n    this.tpl = tpl['TextCF'];\n  });\n\n  TextCF.prototype.initialize = function() {\n    if (!Array.isArray(this.valueOptions)) {\n      this.$control\n        .jirafize({\n          position: 'left',\n          buttons: {\n            name: 'clear',\n            type: 'reset',\n            callback: function($el) { $el.val('').change(); }\n          }\n        });\n\n      this.$errorTarget = this.$control;\n      this.$focusTarget = this.$control;\n\n      if (this.value !== null) {\n        this.$control.val(this.value);\n      }\n    } else {\n      this.$control\n        .selectize({\n          openOnFocus: true,\n          create: false,\n          maxItems: 1,\n          options: this.valueOptions.map(function(option) {\n              return {'value': option, 'label': option};\n            }),\n          selectOnTab:true,\n          labelField:'label'\n        });\n\n      this.$errorTarget = this.$control[0].selectize.$control;\n      this.$focusTarget = this.$control[0].selectize.$control_input;\n      \n      if (this.value !== null) {\n        this.$control[0].selectize.addItem(this.value);\n      }\n      \n      this.getValue = function() {\n        return this.$control[0].selectize.getValue();\n      };\n    }\n  };\n\n  /* Текстовое поле */\n  /** @todo сделать textarea, а не копию TextCF */\n  var TextAreaCF = CustomField.extend(function(fieldConfig, tpl) {\n    CustomField.call(this, fieldConfig);\n    this.tpl = tpl['TextAreaCF'];\n  });\n\n  TextAreaCF.prototype.initialize = function() {\n    this.$control\n      .jirafize({\n        position: 'left',\n        buttons: {\n          name: 'clear',\n          type: 'reset',\n          callback: function($el) { $el.val('').change(); }\n        }\n      });\n      \n    this.$errorTarget = this.$control;\n    this.$focusTarget = this.$control;\n    \n    if (this.value !== null) {\n      this.$control.val(this.value);\n    }\n  };\n\n  /* Число */\n  var NumberCF = CustomField.extend(function(fieldConfig, tpl) {\n    CustomField.call(this, fieldConfig);\n    this.tpl = tpl['NumberCF'];\n  });\n\n  NumberCF.prototype.initialize = function() {\n    if (!Array.isArray(this.valueOptions)) {\n      this.$control\n        .jirafize({\n          position: 'left',\n          buttons: {\n            name: 'clear',\n            type: 'reset',\n            callback: function($el) { $el.val('').change(); }\n          }\n        });\n\n      this.$errorTarget = this.$control;\n      this.$focusTarget = this.$control;\n\n      if (this.value !== null) {\n        this.$control.val(this.value);\n      }\n\n      this.$control.on('keypress', function(e) {\n          var char = String.fromCharCode(e.which);\n          var check = /[0-9.,]/;\n          if (!check.test(char)) {\n            return false;\n          }\n        });\n\n      this.getValue = function() {\n        var v = this.$control.val();\n        if (v !== '') {\n          return Number(String(v).replace(',','.'));\n        } else {\n          return v;\n        }\n      };\n    } else {\n      this.$control\n        .selectize({\n          openOnFocus: true,\n          create: false,\n          maxItems: 1,\n          options: this.valueOptions.map(function(option) {\n              return {'value': option, 'label': option};\n            }),\n          selectOnTab:true,\n          labelField:'label'\n        });\n\n      this.$errorTarget = this.$control[0].selectize.$control;\n      this.$focusTarget = this.$control[0].selectize.$control_input;\n      \n      if (this.value !== null) {\n        this.$control[0].selectize.addItem(this.value);\n      }\n\n      this.getValue = function() {\n        var v = this.$control[0].selectize.getValue();\n        return (v !== '') ? Number(v) : v;\n      };\n    }\n  };\n\n  /* Дата */\n  var DateCF = CustomField.extend(function(fieldConfig, tpl) {\n    CustomField.call(this, fieldConfig);\n    this.tpl = tpl['DateCF'];\n    this.calendarTpl = tpl['clndr'];\n  });\n\n  DateCF.prototype.initialize = function() {\n    if (this.value !== null) {\n      this.$control.val(moment(this.value,'YYYY-MM-DD').format('DD.MM.YYYY'));\n    }\n\n    this.$control\n      .clndrize({\n        'template': this.calendarTpl,\n        'eventName': 'Дата',\n        'showDate': moment()\n      });\n\n    this.$errorTarget = this.$control;\n    this.$focusTarget = this.$control;\n    \n    this.getValue = function() {\n      var v = this.$control.val();\n      return (v !== '') ? moment(v,'DD.MM.YYYY').format('YYYY-MM-DD') : v;\n    };\n  };\n\n  /*=================================\n  *  Маппинг типов полей\n  *=================================*/\n  fieldTypeMap = {\n    1: TextCF,\n    2: TextAreaCF,\n    3: NumberCF,\n    4: DateCF\n  };\n\n  return CustomFieldsFactory;\n\n}));","(function(global, extendApiClient) {\n\n    extendApiClient(KT.apiClient);\n\n}(this,function(ApiClient) {\n\n  /**\n  * Саджест сотрудников компании клиента\n  * @param {Object} options - опции\n  * @param {Object} options.data - параметры саджеста\n  * @param {Function} options.error - коллбек при ошибке\n  * @param {Function} options.success - коллбэк при успехе\n  */\n  ApiClient.getClientUserSuggest = function(options) {\n    var _instance = this;\n    \n    KT.rest({\n        caller:\"orderEdit - getClientUserSuggest\",\n        data: options.data,\n        url: _instance.urls.getClientUserSuggest\n      })\n      .done(options.success)\n      .fail(options.error);\n  };\n\n  /**\n  * Создание/обновление сотрудника компании \n  * @param {Object} userData - данные пользователя \n  * @param {String|Integer} touristId - ID сохраняемого туриста\n  */\n  ApiClient.setUser = function(userData, touristId) {\n    var _instance = this;\n    var request = $.Deferred();\n\n    KT.rest({\n        caller:'orderEdit#tourists - setUser',\n        url: _instance.urls.setUser,\n        data: userData\n      })\n      .done(function(response) {\n        response.touristId = touristId;\n        request.resolve(response);\n      })\n      .fail(request.reject);\n\n    return request;\n  };\n\n  /**\n  * Получение данных сотрудника компании\n  * @param {Integer} documentId - ID документа пользователя\n  */\n  ApiClient.getClientUser = function(documentId) {\n    var _instance = this;\n\n    return KT.rest({\n        caller:'orderEdit#tourists - getClientUser',\n        url: _instance.urls.getClientUser,\n        data: {'docId': documentId}\n      });\n      /*\n      .done(function(response) {\n        _instance.dispatch('gotClientUser', response);\n      });\n      */\n  };\n\n}));","(function(global, extendApiClient) {\n\n    extendApiClient(KT.apiClient);\n\n}(this,function(ApiClient) {\n\n  /**\n  * Получение полной информации по отелю\n  * @param {Integer} hotelId - ID отеля\n  */\n  ApiClient.getHotelInfo = function(hotelId) {\n    var _instance = this;\n\n    var params = {\n      'hotelId': hotelId,\n      'lang':'ru'\n    };\n\n    return KT.rest({\n        caller: \"orderEdit - getHotelInfo\",\n        data: params,\n        url: _instance.urls.getHotelInfo\n      });\n      /*\n      .done(function(data) {\n        _instance.dispatch('gotFullHotelInfo',data);\n      }); */\n\n  };\n\n}));","(function(global, extendApiClient) {\n\n    extendApiClient(KT.apiClient);\n\n}(this,function(ApiClient) {\n\n  /** Установка скидки\n  * @param {Integer} orderId - ID заявки\n  * @param {Number} discount - сумма скидки в рублях\n  * @fires ApiClient.setDiscount\n  */\n  ApiClient.setDiscount = function(orderId, discount) {\n    var _instance = this;\n    var request = $.Deferred();\n\n    var params = {\n      'orderId': orderId,\n      'agentOrderDiscount': discount\n    };\n\n    KT.rest({\n        caller: 'orderEdit#payment - setDiscount',\n        data: params,\n        url: _instance.urls.setDiscount\n      })\n      .done(function (data) {\n        data.discount = discount;\n        request.resolve(data);\n        //_instance.dispatch('setDiscount',data);\n      })\n      .fail(request.reject);\n\n    return request;\n  };\n\n  /**\n  * Удаление туриста из заявки\n  * @param {Integer} touristId - id туриста для удаления\n  * @fires ApiClient.removedTourist\n  */\n  ApiClient.removeOrderTourist = function(orderId, touristId) {\n    var _instance = this;\n    var request = $.Deferred();\n\n    var params = {\n      'orderId':orderId,\n      'touristId':touristId\n    };\n\n    KT.rest({\n        caller:'orderEdit#tourists - removeOrderTourist',\n        data: params,\n        url: _instance.urls.removeOrderTourist\n      })\n      .done(function (response) {\n        response.touristId = touristId;\n        request.resolve(response);\n        //_instance.dispatch('removedTourist', response);\n      })\n      .fail(request.reject);\n\n    return request;\n  };\n\n  /**\n  * Добавление/обновление туриста в заявк(у|е)\n  * @param {Object} touristData - информация по туристу\n  * @fires ApiClient.setOrderTourist\n  */\n  ApiClient.setOrderTourist = function(OrderStorage, touristData) {\n    var _instance = this;\n    var request = $.Deferred();\n\n    if (\n      String(touristData.touristId).indexOf('tmp') === 0 ||\n      String(touristData.touristId).indexOf('doc') === 0 \n    ) {\n      // если добавляем в заявку нового туриста\n      delete touristData.touristId;\n    }\n\n    var params = {\n      'orderId': (OrderStorage.orderId !== 'new') ? OrderStorage.orderId : null,\n      'action':'AddTourist',\n      'actionParams':touristData\n    };\n\n    KT.rest({\n        caller:'orderEdit#tourists - setOrderTourist',\n        data: params,\n        url: _instance.urls.orderWorkflowManager\n      })\n      .done(function (response) {\n        request.resolve(response);\n        /*\n        _instance.dispatch('setOrderTourist', {\n          'touristData': touristData, //данные отправленной формы туриста\n          'currentTouristId': currentTouristId, // текущий ID туриста: если турист добавляется, здесь будет его временный ID\n          'response': response\n        }); */\n      })\n      .fail(request.reject);\n\n    return request;\n  };\n\n  /**\n  * Загрузка документов в заявку\n  * @param {Object} $docform - форма отправки документов\n  * @fires Apiclient.documentUploadProgress\n  * @fires Apiclient.uploadedDocument\n  * @todo убрать проброс формы\n  */\n  ApiClient.uploadDocument = function(orderId, $docform) {\n    var _instance = this;\n\n    $docform.ajaxSubmit({\n      url: _instance.urls.uploadDocument,\n      data: {\n        'orderId': orderId,\n        'usertoken': KT.profile.userToken\n      },\n      uploadProgress: function(e, position, total, percent) {\n        _instance.dispatch('documentUploadProgress', {'percent': percent});\n      },\n      success: function(data) {\n        try {\n          var loadedData = JSON.parse(data);\n          _instance.dispatch('uploadedDocument', loadedData);\n        } catch(e) {\n          _instance.dispatch('uploadedDocument', {'error':'uploadDocument: not json'});\n        }\n      },\n      error: function(xhr,text,err) {\n        _instance.dispatch('uploadedDocument', {'error':text + ' ' + err});\n      }\n    });\n  };\n\n  /**\n  * Выставление счета\n  * @param {OrderStorage} orderStorage - данные заявки\n  * @param {Array} invoiceData - массив номеров услуг и счетов по ним\n  * @param {mwmodal} loader - модальное окно с загрузчиком\n  * @fires Apiclient.setInvoice\n  * @todo вот про модальное окно тут вообще ничего знать не надо, переделать\n  */\n  ApiClient.setInvoice = function(orderStorage, invoiceData) {\n    var _instance = this;\n\n    var invoiceServices = [];\n    invoiceData.forEach(function(invoice) {\n      invoiceServices.push({\n        'serviceId': invoice.id,\n        'invoicePrice': invoice.sum\n      });\n    });\n\n    /** @todo грязнейший хак, по сути же одна клиентская валюта? */\n    var params = {\n      'userId': KT.profile.userId,\n      'orderId': orderStorage.orderId,\n      'paymentType': '2',\n      'currency': orderStorage.getServices()[0].prices.inClient.currencyCode,\n      'Services': invoiceServices\n    };\n\n    return KT.rest({\n        caller: 'orderEdit - setInvoice',\n        data: params,\n        url: _instance.urls.setInvoice\n      });\n      /*\n      .done(function(response) {\n        _instance.dispatch('setInvoice', response);\n      }); */\n  };\n\n  /**\n  * Отмена счета\n  * @param {Integer} invoiceId  - ID отменяемого счета \n  */\n  ApiClient.cancelInvoice = function(invoiceId) {\n    var _instance = this;\n\n    /** @todo грязнейший хак, по сути же одна клиентская валюта? */\n    var params = {\n      'invoiceId': invoiceId\n    };\n\n    return KT.rest({\n        caller: 'orderEdit - setInvoice',\n        data: params,\n        url: _instance.urls.cancelInvoice\n      });\n      /*\n      .done(function(response) {\n        _instance.dispatch('cancelledInvoice', response);\n      }); */\n  };\n\n}));","(function(global, extendApiClient) {\n\n    extendApiClient(KT.apiClient);\n\n}(this,function(ApiClient) {\n\n  /**\n  * Запрос информации о заявке\n  * @fires Apiclient.gotOrderInfo\n  */\n  ApiClient.getOrderInfo = function(orderId) {\n    var _instance = this;\n    var params = {\n      'orderId':orderId,\n      'getInCurrency':KT.profile.viewCurrency\n    };\n\n    return KT.rest({\n        caller:\"orderEdit - getOrderInfo\",\n        data: params,\n        url: _instance.urls.getOrder\n      });\n      /*\n      .done(function (response) {\n        //_instance.dispatch('gotOrderInfo', response);\n      });\n      */\n  };\n\n  /**\n  * Получение информации по услуге перелета\n  * @param {Array} serviceIds - массив ID'шников сервисов\n  * @fires Apiclient.gotOrderOffers\n  */\n  ApiClient.getOrderOffers = function(orderId, serviceIds) {\n    var _instance = this;\n\n    var params = {\n      'orderId':orderId,\n      'servicesIds':serviceIds,\n      'lang':'ru',\n      'getInCurrency':KT.profile.viewCurrency\n    };\n\n    return KT.rest({\n        caller:'orderEdit#services - getOrderOffers',\n        data: params,\n        url: _instance.urls.getOrderOffers\n      });\n      /*\n      .done(function (response) {\n        _instance.dispatch('gotOrderOffers', response);\n      });\n      */\n  };\n\n  /**\n  * Получение информации по туристам заявки\n  * @fires ApiClient.gotOrderTourists\n  */\n  ApiClient.getOrderTourists = function(orderId) {\n    var _instance = this;\n    var request = $.Deferred();\n\n    var params = {\n      'orderId':orderId\n    };\n\n    KT.rest({\n        caller:'orderEdit#tourists - getOrderTourists',\n        data: params,\n        url: _instance.urls.getOrderTourists\n      })\n      .done(function (response) {\n        /** @todo API patch; deprecated with KT-1351 */\n        if (response.status === 0 && Array.isArray(response.body.tourists)) {\n          response.body.tourists.forEach(function(tourist) {\n            if (tourist.surName !== undefined) {\n              tourist.lastName = tourist.surName;\n              delete tourist.surName;\n            }\n            if (tourist.document.surName !== undefined) {\n              tourist.document.lastName = tourist.document.surName;\n              delete tourist.document.surName;\n            }\n            if (tourist.document.serialNum !== undefined) {\n              tourist.document.serialNumber = tourist.document.serialNum;\n              delete tourist.document.serialNum;\n            }\n          });\n        }\n        /** @todo end API patch */\n        request.resolve(response);\n        //_instance.dispatch('gotOrderTourists', response);\n      })\n      .fail(request.reject);\n\n    return request;\n  };\n\n  /**\n  * Запрос информации о счетах\n  * @fires Apiclient.gotOrderInvoices\n  */\n  ApiClient.getOrderInvoices = function(orderId) {\n    var _instance = this;\n\n    var params = {\n      'orderId':orderId\n    };\n\n    return KT.rest({\n        caller:'orderEdit - getOrderInvoices',\n        data: params,\n        url: _instance.urls.getOrderInvoices\n      });\n      /*\n      .done(function (response) {\n        _instance.dispatch('gotOrderInvoices', response);\n      }); */\n  };\n\n  /**\n  * Получение списка документов\n  * @fires Apiclient.gotOrderDocuments\n  */\n  ApiClient.getOrderDocuments = function(orderId) {\n    var _instance = this;\n\n    var params = {\n      'orderId':orderId\n    };\n\n    return KT.rest({\n        caller:'orderEdit - getOrderDocuments',\n        data: params,\n        url: _instance.urls.getOrderDocuments\n      });\n      /*\n      .done(function (response) {\n        _instance.dispatch('gotOrderDocuments', response);\n      }); */\n  };\n\n  /**\n  * Получение истории заявки\n  * @fires Apiclient.gotOrderHistory\n  */\n  ApiClient.getOrderHistory = function(orderId) {\n    var _instance = this;\n\n    var params = {\n      'orderId': orderId,\n      'lang': 'ru'\n    };\n\n    return KT.rest({\n        caller:'orderEdit - getOrderHistory',\n        data: params,\n        url: _instance.urls.getOrderHistory\n      });\n      /*\n      .done(function (response) {\n        _instance.dispatch('gotOrderHistory', response);\n      }); */\n  };\n\n\n}));","(function(global, extendApiClient) {\n\n    extendApiClient(KT.apiClient);\n\n}(this,function(ApiClient) {\n\n  /**\n  * Получение доступных действий с услугами\n  * @param {Integer} orderId - ID заявки\n  */\n  ApiClient.getAllowedTransitions = function(orderId) {\n    var _instance = this;\n\n    var params = {\n        'operation': 'checkTransition',\n        'orderId': orderId\n    };\n\n    return KT.rest({\n        caller: 'orderEdit - getAllowedTransitions',\n        data: params,\n        url: _instance.urls.checkWorkflow\n      });\n  };\n\n  /**\n  * Проверка доступности совершения операции с услугами с определенным набором параметров\n  * @param {Integer} orderId - ID заявки\n  * @param {String} action - валидируемое действие\n  * @param {Object[]} actionParams - массив структур actionParams для услуг\n  */\n  ApiClient.validateAction = function(orderId, action, actionParams) {\n    var _instance = this;\n    var request = $.Deferred();\n\n    var params = {\n        'operation': 'validate',\n        'orderId': orderId,\n        'action': action,\n        'actionParams': actionParams\n    };\n\n    KT.rest({\n        caller: 'orderEdit - validateAction',\n        data: params,\n        url: _instance.urls.checkWorkflow\n      })\n      .done(function(response) {\n        response.action = action;\n        if (response.status === 0) {\n          actionParams.forEach(function(service, i) {\n            response.body[i].serviceId = service.serviceId;\n          });\n        }\n\n        request.resolve(response);\n      })\n      .fail(request.reject);\n\n    return request;\n  };\n\n  /**\n  * Запрос на старт процесса бронирования\n  * @param {Integer} orderId - ID заявки\n  * @param {Object} actionParams - параметры actionParams команды\n  */\n  ApiClient.startBooking = function(orderId, actionParams) {\n    var _instance = this;\n\n    var params = {\n      'orderId':orderId,\n      'action':'BookStart',\n      'actionParams': actionParams\n    };\n\n    return KT.rest({\n        caller: 'orderEdit#services - startBooking',\n        url: _instance.urls.orderWorkflowManager,\n        data: params\n      });\n  };\n\n  /**\n  * Запрос на выписку билетов\n  * @param {Integer} orderId - ID заявки\n  * @param {Object} serviceId - ID сервиса для выписки\n  * @fires Apiclient.issuedTickets\n  */\n  ApiClient.issueTickets = function(orderId, serviceId) {\n    var _instance = this;\n\n    var params = {\n      'orderId': orderId,\n      'action': 'IssueTickets',\n      'actionParams': {\n        'serviceId': serviceId\n      }\n    };\n\n    return KT.rest({\n        caller:'orderEdit#services - issueTickets',\n        url: _instance.urls.orderWorkflowManager,\n        data:params\n      });\n  };\n\n  /**\n  * Запрос на изменение данных брони\n  * @param {Integer} orderId - ID заявки\n  * @param {Object} actionParams - параметры actionParams команды\n  */\n  ApiClient.bookChange = function(orderId, actionParams) {\n    var _instance = this;\n    var request = $.Deferred();\n\n    var params = {\n      'orderId': orderId,\n      'action': 'BookChange',\n      'actionParams': actionParams\n    };\n\n    KT.rest({\n        caller:'orderEdit#services - bookChange',\n        url: _instance.urls.orderWorkflowManager,\n        data:params\n      })\n      .done(function(response) {\n        response.body.serviceId = actionParams.serviceId;\n        request.resolve(response);\n      })\n      .fail(request.reject);\n    \n    return request;\n  };\n\n  /**\n  * Запрос на отмену бронирования услуги\n  * @param {Integer} orderId - ID заявки\n  * @param {Object} actionParams - параметры actionParams команды\n  */\n  ApiClient.bookCancel = function(orderId, actionParams) {\n    var _instance = this;\n\n    var params = {\n      'orderId': orderId,\n      'action': 'BookCancel',\n      'actionParams': actionParams\n    };\n\n    return KT.rest({\n        caller:'orderEdit#services - bookCancel',\n        url: _instance.urls.orderWorkflowManager,\n        data:params\n      });\n  };\n\n  /**\n  * Запрос на отмену бронирования услуги\n  * @param {Integer} orderId - ID заявки\n  * @param {Object} actionParams - параметры actionParams команды\n  */\n  ApiClient.setServiceToManual = function(orderId, actionParams) {\n    var _instance = this;\n    var request = $.Deferred();\n\n    var params = {\n      'orderId': orderId,\n      'action': 'Manual',\n      'actionParams': actionParams\n    };\n\n    KT.rest({\n        caller: 'orderEdit#services - Manual',\n        url: _instance.urls.orderWorkflowManager,\n        data: params\n      })\n      .done(function(response) {\n        response.serviceId = actionParams.serviceId;\n        request.resolve(response);\n      })\n      .fail(request.reject);\n\n    return request;\n  };\n\n  /**\n  * Установка привязки туристов к услуге\n  * @param {Integer} orderId - ID заявки\n  * @param {Integer} serviceId - ID сохраняемого сервиса\n  * @param {Object[]} linkageInfo - данные по туристам\n  */\n  ApiClient.setTouristsLinkage = function(orderId, serviceId, linkageInfo) {\n    var _instance = this;\n    var request = $.Deferred();\n\n    var params = {\n      'orderId': orderId,\n      'action':'TouristToService',\n      'actionParams':{\n        'serviceId': serviceId,\n        'touristData': linkageInfo\n      }\n    };\n\n    KT.rest({\n        caller:'orderEdit#services - setTouristsLinkage',\n        data: params,\n        url: _instance.urls.orderWorkflowManager\n      })\n      .done(function (response) {\n        response.serviceId = serviceId;\n        response.linkageInfo = linkageInfo;\n\n        request.resolve(response);\n      })\n      .fail(request.reject);\n\n    return request;\n  };\n\n  /**\n  * Изменение параметров услуги в ручном режиме (даты, цены)\n  * @param {Integer} orderId - ID заявки\n  * @param {Integer} serviceId - ID сохраняемого сервиса\n  * @param {Object} actionParams - параметры команды \n  */\n  ApiClient.setServiceData = function(orderId, serviceId, actionParams) {\n    var _instance = this;\n\n    var params = {\n      'orderId':orderId,\n      'action':'SetServiceData',\n      'actionParams': actionParams\n    };\n\n    return KT.rest({\n        caller:'orderEdit#services - setServiceData',\n        data: params,\n        url: _instance.urls.orderWorkflowManager\n      });\n  };\n\n  /**\n  * Изменение статуса услуги в ручном режиме\n  * @param {Integer} orderId - ID заявки\n  * @param {Integer} serviceId - ID сохраняемого сервиса\n  * @param {Object} actionParams - параметры команды \n  */\n  ApiClient.manualSetStatus = function(orderId, serviceId, actionParams) {\n    var _instance = this;\n\n    var params = {\n      'orderId':orderId,\n      'action':'ManualSetStatus',\n      'actionParams': actionParams\n    };\n\n    return KT.rest({\n        caller:'orderEdit#services - manualSetStatus',\n        data: params,\n        url: _instance.urls.orderWorkflowManager\n      });\n  };\n\n  /**\n  * Изменение параметров брони услуги в ручном режиме\n  * @param {Integer} orderId - ID заявки\n  * @param {Integer} serviceId - ID сохраняемого сервиса\n  * @param {Object} actionParams - параметры команды \n  */\n  ApiClient.setReservationData = function(orderId, serviceId, actionParams) {\n    var _instance = this;\n\n    var params = {\n      'orderId':orderId,\n      'action':'SetReservationData',\n      'actionParams': actionParams\n    };\n\n    return KT.rest({\n        caller:'orderEdit#services - SetReservationData',\n        data: params,\n        url: _instance.urls.orderWorkflowManager\n      });\n  };\n\n  /**\n  * Добавление/изменение билетов\n  * @param {Integer} orderId - ID заявки\n  * @param {Integer} serviceId - ID сохраняемого сервиса\n  * @param {Object} actionParams - параметры команды \n  */\n  ApiClient.setTicketsData = function(orderId, serviceId, actionParams) {\n    var _instance = this;\n\n    var params = {\n      'orderId':orderId,\n      'action':'SetTicketsData',\n      'actionParams': actionParams\n    };\n\n    return KT.rest({\n        caller:'orderEdit#services - SetTicketsData',\n        data: params,\n        url: _instance.urls.orderWorkflowManager\n      });\n  };\n\n  /**\n  * Сохранение значений дополнительных полей услуги \n  * @param {Integer} orderId - ID заявки\n  * @param {Array} customFieldsValues - список значений дополнительных полей\n  */\n  ApiClient.setServiceAdditionalData = function(orderId, customFieldsValues) {\n    var _instance = this;\n\n    var params = {\n      'orderId': orderId,\n      'action': 'SetAdditionalData',\n      'actionParams': {\n        'additionalFields': customFieldsValues\n      }\n    };\n\n    return KT.rest({\n        caller:'orderEdit#services - SetAdditionalData',\n        data: params,\n        url: _instance.urls.orderWorkflowManager\n      });\n  };\n\n  /**\n  * Добавление дополнительной услуги\n  * @param {Integer} orderId - ID заявки\n  * @param {Object} axctionParams - параметры команды \n  */\n  ApiClient.addExtraService = function(orderId, actionParams) {\n    var _instance = this;\n\n    var params = {\n      'orderId':orderId,\n      'action':'AddExtraService',\n      'actionParams': actionParams\n    };\n\n    return KT.rest({\n        caller:'orderEdit#services - AddExtraService',\n        data: params,\n        url: _instance.urls.orderWorkflowManager\n      });\n  };\n\n  /**\n  * Добавление дополнительной услуги\n  * @param {Integer} orderId - ID заявки\n  * @param {Object} avtionParams - параметры команды \n  */\n  ApiClient.removeExtraService = function(orderId, actionParams) {\n    var _instance = this;\n\n    var params = {\n      'orderId':orderId,\n      'action':'RemoveExtraService',\n      'actionParams': actionParams\n    };\n\n    return KT.rest({\n        caller:'orderEdit#services - RemoveExtraService',\n        data: params,\n        url: _instance.urls.orderWorkflowManager\n      });\n  };\n\n}));","/* global ktStorage */\n(function(global,factory){\n\n    KT.storage.ServiceStorage = factory();\n\n}(this,function() {\n  /**\n  * Прототип хранилища данных услуги\n  * @module ServiceStorage\n  * @constructor\n  * @param {Integer} serviceId - ID услуги\n  */\n  var ServiceStorage = ktStorage.extend(function(serviceId) {\n    this.namespace = 'ServiceStorage';\n\n    this.serviceId = serviceId;\n\n    // флаг, обозначающий отсутствие оффера в услуге\n    this.isPartial = false;\n\n    // флаг согласия с условиями бронирования\n    this.isTOSAgreementSet = false;\n\n    // название документа для условий бронирования:\n    // нужно для идентификации документа для вывода со страниц услуг и оформления\n    this.tosDocumentName = false;\n\n    // структура дл записи цен\n    this.prices = {\n      inLocal: {\n        currencyCode: 'RUB', /** @todo default currency constant */\n        client: {\n          net: null,\n          gross: null,\n          commission: {\n            amount: null, /** @todo клиентская комиссия? */\n            percent: null\n          }\n        },\n        supplier: {\n          net: null,\n          gross: null,\n          commission: {\n            amount: null,\n            percent: null\n          }\n        }\n      },\n      inView: {\n        currencyCode: null,\n        client: {\n          net: null,\n          gross: null,\n          commission: {\n            amount: null,\n            percent: null\n          }\n        },\n        supplier: {\n          net: null,\n          gross: null,\n          commission: {\n            amount: null,\n            percent: null\n          }\n        }\n      },\n      inSupplier: {\n        currencyCode: null,\n        client: {\n          net: null,\n          gross: null,\n          commission: {\n            amount: null,\n            percent: null\n          }\n        },\n        supplier: {\n          net: null,\n          gross: null,\n          commission: {\n            amount: null,\n            percent: null\n          }\n        }\n      },\n      inClient: {\n        currencyCode: null,\n        client: {\n          net: null,\n          gross: null,\n          commission: {\n            amount: null,\n            percent: null\n          }\n        },\n        supplier: {\n          net: null,\n          gross: null,\n          commission: {\n            amount: null,\n            percent: null\n          }\n        }\n      }\n    };\n\n    // данные оффера\n    this.offerInfo = null;\n\n    // флаг невозможности возврата средств при отмене бронирования\n    this.isNonRefundable = false;\n\n    // возможные штрафы за отмену\n    this.clientCancelPenalties = null;\n    this.supplierCancelPenalties = null;\n\n    // начисленные штрафы\n    this.penalties = null;\n    this.penaltySums = null;\n\n    //  данные запроса по предложению\n    this.requestData = null;\n\n    // данные по привязке туристов\n    this.tourists = {};\n\n    // доступные действия с услугой\n    this.allowedTransitions = [];\n\n    // сумма выставленных на услугу счетов\n    // NOTE: валюта должна быть та же, что и у clientCurrency\n    this.invoiceSum = 0;\n    // сумма незаплаченных денег\n    this.unpaidSum = 0;\n\n    // наличие данных по TP\n    this.hasTravelPolicy = false;\n    // наличие нарушений TP\n    this.hasTPViolations = false;\n\n    // дополнительные услуги (добавленные)\n    this.additionalServices = [];\n    \n    // структура дополнительных полей\n    this.customFields = null;\n  });\n\n  KT.addMixin(ServiceStorage,'Dispatcher');\n\n  /**\n  * Инициализация хранилища\n  * @param {Object} serviceData - данные услуги (/getOrder)\n  */\n  ServiceStorage.prototype.initialize = function(serviceData) {\n    if (serviceData.serviceID !== this.serviceId) {\n        KT.error(\n          this.namespace+': ' +\n          'попытка инициализации данными другой услуги,' +\n          ' текущая: ' . this.serviceId +\n          ' данные от: '. serviceData.serviceID\n        );\n    }\n\n    var isNotEmpty = function(v) {\n      return !(v === undefined || v === null || v === '');\n    };\n\n    // название услуги\n    this.name = serviceData.serviceName;\n\n    // описание услуги\n    this.description = serviceData.serviceDescription;\n\n    // статусная информация\n    this.status = serviceData.status;\n    this.isOffline = serviceData.offline;\n\n    // код типа услуги\n    this.typeCode = +serviceData.serviceType;\n\n    // установка названия документа с условиями бронирования\n    // cancellationDocumentName - в каком документе содержатся правила отмены, для вкладки \"оформление\"\n    /** @todo создать отдельные классы для каждого типа услуг */\n    switch(this.typeCode) {\n      case 1:\n        this.tosDocumentName = 'hotelBookTerms-'+this.serviceId;\n        this.cancellationDocumentName = this.tosDocumentName;\n        break;\n      case 2:\n        this.tosDocumentName = 'aviaBookTerms';\n        // название документа для правил тарифа авиа\n        this.fareRuleDocumentName = 'aviaFareRule-'+this.serviceId;\n        this.cancellationDocumentName = this.fareRuleDocumentName;\n        break;\n    }\n\n    // ID шлюза, связанного с услугой\n    this.gatewayId = serviceData.supplierId; /** @todo атавизм? */\n\n    // даты начала и окончания услуги\n    this.startDate = moment(serviceData.startDateTime,'YYYY-MM-DD HH:mm:ss');\n    this.endDate = moment(serviceData.endDateTime,'YYYY-MM-DD HH:mm:ss');\n\n    // дата заказа услуги\n    this.creationDate = moment(serviceData.dateOrdered,'YYYY-MM-DD HH:mm:ss');\n\n    // дата оплаты (оплатить до)\n    this.dateAmend = isNotEmpty(serviceData.dateAmend) ?\n      moment(serviceData.dateAmend,'YYYY-MM-DD HH:mm:ss') : null;\n\n    // ценовая информация\n    this.prices.inLocal.client.gross = Number(serviceData.localSum);\n    this.prices.inLocal.client.commission.amount = Number(serviceData.localCommission);\n    this.prices.inLocal.supplier.gross = Number(serviceData.localNetSum);\n    this.prices.inView.currencyCode = KT.profile.viewCurrency;\n    this.prices.inView.client.gross = Number(serviceData.requestedSum);\n    this.prices.inView.supplier.gross = Number(serviceData.requestedNetSum);\n    this.prices.inSupplier.currencyCode = serviceData.supplierCurrencyCode;\n    this.prices.inSupplier.client.gross = Number(serviceData.supplierPrice);\n    this.prices.inSupplier.supplier.gross = Number(serviceData.supplierNetPrice);\n    this.prices.inClient.currencyCode = serviceData.paymentCurrencyCode;\n    this.prices.inClient.client.gross = Number(serviceData.paymentSum);\n\n    this.paymentCurrency = this.prices.inClient.currency;\n\n    /** @todo как-то странно тут скидка, не пришей кобыле хвост... */\n    this.discount = isNotEmpty(serviceData.discount) ?\n      Number(serviceData.discount) : 0;\n\n    /** структура дополнительных полей */\n    this.customFields = Array.isArray(serviceData.additionalData) ? \n      serviceData.additionalData : null;\n\n    // разрешенные операции\n    /** @todo checkworkflow */\n    this.isActionAvailable = {\n      'setInvoice': (\n        [2,3,4,8].indexOf(this.status) !== -1 ||\n        (KT.profile.userType === 'op' && this.status === 9)\n      )\n    };\n  };\n\n  /*\n  * Обновление полной информации по услуге (getOrderOffer)\n  */\n  ServiceStorage.prototype.updateFullInfo = function(serviceData) {\n    var self = this;\n\n    this.status = +serviceData.serviceStatus;\n    this.offerInfo = serviceData.offerInfo;\n    this.requestData = serviceData.requestData;\n\n    // сохранение ценовых компонентов\n    var salesTerms = serviceData.serviceSalesTermsInfo;\n    this.prices = {\n      inLocal: {\n        currencyCode: 'RUB',\n        client: {\n          net: Number(salesTerms.localCurrency.client.amountNetto),\n          gross: Number(salesTerms.localCurrency.client.amountBrutto),\n          commission: {\n            amount: Number(salesTerms.localCurrency.client.commission.amount),\n            percent: Number(salesTerms.localCurrency.client.commission.percent)\n          }\n        },\n        supplier: {\n          net: Number(salesTerms.localCurrency.supplier.amountNetto),\n          gross: Number(salesTerms.localCurrency.supplier.amountBrutto),\n          commission: {\n            amount: Number(salesTerms.localCurrency.supplier.commission.amount),\n            percent: Number(salesTerms.localCurrency.supplier.commission.percent)\n          }\n        }\n      },\n      inView: {\n        currencyCode: salesTerms.viewCurrency.client.currency,\n        client: {\n          net: Number(salesTerms.viewCurrency.client.amountNetto),\n          gross: Number(salesTerms.viewCurrency.client.amountBrutto),\n          commission: {\n            amount: Number(salesTerms.viewCurrency.client.commission.amount),\n            percent: Number(salesTerms.viewCurrency.client.commission.percent)\n          }\n        },\n        supplier: {\n          net: Number(salesTerms.viewCurrency.supplier.amountNetto),\n          gross: Number(salesTerms.viewCurrency.supplier.amountBrutto),\n          commission: {\n            amount: Number(salesTerms.viewCurrency.supplier.commission.amount),\n            percent: Number(salesTerms.viewCurrency.supplier.commission.percent)\n          }\n        }\n      },\n      inSupplier: {\n        currencyCode: salesTerms.supplierCurrency.supplier.currency,\n        client: {\n          net: Number(salesTerms.supplierCurrency.client.amountNetto),\n          gross: Number(salesTerms.supplierCurrency.client.amountBrutto),\n          commission: {\n            amount: Number(salesTerms.supplierCurrency.client.commission.amount),\n            percent: Number(salesTerms.supplierCurrency.client.commission.percent)\n          }\n        },\n        supplier: {\n          net: Number(salesTerms.supplierCurrency.supplier.amountNetto),\n          gross: Number(salesTerms.supplierCurrency.supplier.amountBrutto),\n          commission: {\n            amount: Number(salesTerms.supplierCurrency.supplier.commission.amount),\n            percent: Number(salesTerms.supplierCurrency.supplier.commission.percent)\n          }\n        }\n      },\n      inClient: {\n        currencyCode: salesTerms.clientCurrency.client.currency,\n        client: {\n          net: Number(salesTerms.clientCurrency.client.amountNetto),\n          gross: Number(salesTerms.clientCurrency.client.amountBrutto),\n          commission: {\n            amount: Number(salesTerms.clientCurrency.client.commission.amount),\n            percent: Number(salesTerms.clientCurrency.client.commission.percent)\n          }\n        },\n        supplier: {\n          net: Number(salesTerms.clientCurrency.supplier.amountNetto),\n          gross: Number(salesTerms.clientCurrency.supplier.amountBrutto),\n          commission: {\n            amount: Number(salesTerms.clientCurrency.supplier.commission.amount),\n            percent: Number(salesTerms.clientCurrency.supplier.commission.percent)\n          }\n        }\n      }\n    };\n    \n    // сохранение суммы для оплаты\n    this.unpaidSum = Number(serviceData.restPaymentAmount);\n    this.paymentCurrency = serviceData.restPaymentAmountCurrency;\n\n    // сохранение данных по штрафам\n    this.penalties = serviceData.penalties;\n    if (this.penalties !== null) {\n      this.penaltySums = {\n        inLocal: {\n          currencyCode: this.penalties.client.localCurrency.currency,\n          client: Number(this.penalties.client.localCurrency.amount),\n          supplier: Number(this.penalties.supplier.localCurrency.amount)\n        },\n        inView: {\n          currencyCode: this.penalties.client.viewCurrency.currency,\n          client: Number(this.penalties.client.viewCurrency.amount),\n          supplier: Number(this.penalties.supplier.viewCurrency.amount)\n        },\n        inClient: {\n          currencyCode: this.penalties.client.clientCurrency.currency,\n          client: Number(this.penalties.client.clientCurrency.amount),\n          supplier: Number(this.penalties.supplier.clientCurrency.amount)\n        }\n      };\n    }\n\n    // определение возможных действий с услугой\n    this.isActionAvailable.setInvoice = (\n        this.isActionAvailable.setInvoice &&\n        this.unpaidSum > 0\n      );\n\n    // обработка специфичная для онлайн и оффлайн услуг\n    if (this.offerInfo === null) {\n      this.isPartial = true;\n\n      /** @todo хак, т.к. из УТК такой информации не достается */\n\n      switch (this.typeCode) {\n        case 1:\n          this.touristAges = {\n            adults: serviceData.serviceTourists.length,\n            children: 0\n          };\n\n          this.declaredTouristAges = {\n            adults: serviceData.serviceTourists.length,\n            children: 0\n          };\n          break;\n        case 2:\n          this.touristAges = {\n            adults: serviceData.serviceTourists.length,\n            children: 0,\n            infants: 0\n          };\n\n          this.declaredTouristAges = {\n            adults: serviceData.serviceTourists.length,\n            children: 0,\n            infants: 0\n          };\n          break;\n      }\n    } else {\n      // данные по возрастному составу: текущий привязанный и согласно заказу\n      /** @todo для каждого типа услуги нужен свой класс хранилища */\n      switch (this.typeCode) {\n        case 1:\n          this.touristAges = {\n            adults: null,\n            children: null\n          };\n\n          this.declaredTouristAges = {\n            adults: this.offerInfo.adult,\n            children: this.offerInfo.child\n          };\n          break;\n        case 2:\n          this.touristAges = {\n            adults: null,\n            children: null,\n            infants: null\n          };\n\n          this.declaredTouristAges = {\n            adults: this.offerInfo.requestData.adult,\n            children: this.offerInfo.requestData.child,\n            infants: this.offerInfo.requestData.infant\n          };\n\n          if (Array.isArray(this.offerInfo.fareRules)) {\n            this.offerInfo.fareRules.forEach(function(fareRule) {\n              if (fareRule.aviaFareRule.shortRules.refund_before_rule === false) {\n                self.isNonRefundable = true;\n              }\n            });\n          }\n          break;\n      }\n\n      // услугонезависимая обработка\n\n      if (this.offerInfo.cancelPenalties !== null) {\n        var clientPenaltiesLocal = this.offerInfo.cancelPenalties.localCurrency.client;\n        var clientPenaltiesView = this.offerInfo.cancelPenalties.viewCurrency.client;\n        var clientPenaltiesClient = this.offerInfo.cancelPenalties.clientCurrency.client;\n\n        if (Array.isArray(clientPenaltiesLocal) && clientPenaltiesLocal.length > 0) {\n          this.clientCancelPenalties = processCancelPenalties(\n            clientPenaltiesLocal, clientPenaltiesView, clientPenaltiesClient\n          );\n        }\n\n        var supplierPenaltiesLocal = this.offerInfo.cancelPenalties.localCurrency.supplier;\n        var supplierPenaltiesView = this.offerInfo.cancelPenalties.viewCurrency.supplier;\n        var supplierPenaltiesClient = this.offerInfo.cancelPenalties.clientCurrency.supplier;\n\n        if (Array.isArray(supplierPenaltiesLocal) && supplierPenaltiesLocal.length > 0) {\n          this.supplierCancelPenalties = processCancelPenalties(\n            supplierPenaltiesLocal, supplierPenaltiesView, supplierPenaltiesClient\n          );\n        }\n\n        if (Array.isArray(this.supplierCancelPenalties)) {\n          this.supplierCancelPenalties.forEach(function(penalty) {\n            if (!self.isNonRefundable && penalty.dateFrom.valueOf() < moment().endOf('day').valueOf()) {\n              self.isNonRefundable = true;\n            }\n          });\n        }\n      }\n\n      this.declaredTouristAmount = 0;\n      for (var agegroup in this.declaredTouristAges) {\n        if (this.declaredTouristAges.hasOwnProperty(agegroup)) {\n          this.declaredTouristAmount += this.declaredTouristAges[agegroup];\n        }\n      }\n\n      // определение наличия трэвел-политик\n      this.hasTravelPolicy = (typeof this.offerInfo.travelPolicy === 'object' && this.offerInfo.travelPolicy !== null);\n      this.hasTPViolations = (\n        this.hasTravelPolicy && \n        Array.isArray(this.offerInfo.travelPolicy.travelPolicyFailCodes) &&\n        this.offerInfo.travelPolicy.travelPolicyFailCodes.length > 0\n      );\n\n      // дополнительные услуги\n      if (Array.isArray(serviceData.addServices)) {\n        this.additionalServices = serviceData.addServices;\n      }\n    }\n  };\n\n  /**\n  * Обработка плановых штрафов\n  * @param {Object[]} penaltiesInLocal - штрафы в локальной валюте\n  * @param {Object[]} penaltiesInView - штрафы в валюте просмотра\n  * @param {Object[]} penaltiesInClient - штрафы в валюте оплаты\n  * @return {Object[]} - скомпонованные  штрафы\n  */\n  function processCancelPenalties(penaltiesInLocal, penaltiesInView, penaltiesInClient) {\n      if (penaltiesInLocal.length !== penaltiesInView.length) {\n        console.error('amount of penalties in local currency and in view currency not equal!');\n        return null;\n      } else {\n        var penalties = [];\n\n        penaltiesInLocal.forEach(function(localPenalty, i) {\n          penalties.push({\n            'dateFrom': moment(localPenalty.dateFrom, 'YYYY-MM-DD HH:mm:ss'),\n            'dateTo': moment(localPenalty.dateTo, 'YYYY-MM-DD HH:mm:ss'),\n            'description': localPenalty.description,\n            'penaltySum': {\n              'inLocal': {\n                'currency': localPenalty.penalty.currency,\n                'amount': localPenalty.penalty.amount\n              },\n              'inView': {\n                'currency': penaltiesInView[i].penalty.currency,\n                'amount': penaltiesInView[i].penalty.amount\n              },\n              'inClient': {\n                'currency': penaltiesInClient[i].penalty.currency,\n                'amount': penaltiesInClient[i].penalty.amount\n              }\n            }\n          });\n        });\n\n        return penalties;\n      }\n  }\n\n  /**\n  * Установка списка доступных действий с услугой\n  */\n  ServiceStorage.prototype.setAllowedTransitions = function(controls) {\n    this.allowedTransitions = controls;\n  };\n\n  /**\n  * Проверка доступности действия\n  * @param {String} transition - название действия\n  * @return {Boolean} - результат проверки\n  */\n  ServiceStorage.prototype.checkTransition = function(transition) {\n    return (this.allowedTransitions.indexOf(transition) !== -1);\n  };\n\n  /**\n  * Возращает список туристов с информацией о привязке к услуге в виже массива\n  * @return {Array} - информация о туристах\n  */\n  ServiceStorage.prototype.getServiceTourists = function() {\n    var tourists = [];\n\n    for (var touristId in this.tourists) {\n      if (this.tourists.hasOwnProperty(touristId)) {\n        tourists.push(this.tourists[touristId]);\n      }\n    }\n\n    return tourists;\n  };\n\n  /**\n  * Возвращает возраст туриста на момент окончания услуги\n  * @param {Object} birthdate - дата рождения туриста в структуре moment.js\n  * @return {Integer} - возраст туриста\n  */\n  ServiceStorage.prototype.getAgeByServiceEnding = function(birthdate) {\n    return moment.duration(this.endDate.valueOf() - birthdate.valueOf()).asYears();\n  };\n\n  /**\n  * Возвращает возрастную группу туриста для данной услуги\n  * @param {Integer} age - возраст туриста\n  * @return {String} - возрастная группа (infants, adults, children)\n  * @todo сделать классы для каждой услуги\n  */\n  ServiceStorage.prototype.getAgeGroup = function(age) {\n    var agegroup = 'adults';\n    switch (this.typeCode) {\n      case 1:\n        if (age < 12) { agegroup = 'children'; }\n        else { agegroup = 'adults'; }\n        break;\n      case 2:\n        if (age < 3) { agegroup = 'infants'; }\n        else if (age < 12) { agegroup = 'children'; }\n        else { agegroup = 'adults'; }\n        break;\n    }\n    return agegroup;\n  };\n\n  /**\n  * Проверяет, привязаны ли все необходимые туристы согласно заявленному\n  * возрастному составу\n  * @return {Boolean} результат проверки\n  */\n  ServiceStorage.prototype.checkAllTouristsLinked = function() {\n    var allLinked = true;\n\n    for (var agegroup in this.touristAges) {\n      if (this.touristAges.hasOwnProperty(agegroup)) {\n        if (this.touristAges[agegroup] !== this.declaredTouristAges[agegroup]) {\n          allLinked = false;\n        }\n      }\n    }\n\n    return allLinked;\n  };\n\n  /**\n  * Обновление информации по привязанным туристам (возрастной состав)\n  * @param {Object]} tourists - список данных туристов [TouristStorage]\n  * @todo для каждого типа услуги нужен свой класс хранилища\n  */\n  ServiceStorage.prototype.setTouristAges = function(tourists) {\n    if (this.isPartial) { return false; }\n\n    var touristId, age;\n    switch (this.typeCode) {\n      case 1:\n        this.touristAges = {\n          adults: 0,\n          children: 0\n        };\n\n        for (touristId in tourists) {\n          if (this.tourists.hasOwnProperty(touristId)) {\n            age = tourists[touristId].age;\n            if (age < 12) { this.touristAges.children += 1; }\n            else { this.touristAges.adults += 1; }\n          }\n        }\n        break;\n      case 2:\n        this.touristAges = {\n          adults: 0,\n          children: 0,\n          infants: 0\n        };\n\n        for (touristId in this.tourists) {\n          if (this.tourists.hasOwnProperty(touristId)) {\n            age = tourists[touristId].age;\n            if (age < 3) { this.touristAges.infants += 1; }\n            else if (age < 12) { this.touristAges.children += 1; }\n            else { this.touristAges.adults += 1; }\n          }\n        }\n        break;\n    }\n  };\n\n  /**\n  * Подсчет суммы клиентских штрафов при отмене брони\n  * @return {Object|false} данные штрафа (сумма, валюта) или false в случае отсутствия\n  */\n  ServiceStorage.prototype.countClientCancelPenalty = function() {\n    if (this.isPartial) { return null; }\n    if (this.clientCancelPenalties === null) { return null; }\n\n    return this.clientCancelPenalties.reduce(function(total, penalty) {\n      console.log('penalty:');\n      console.log(penalty);\n      if (moment().isBetween(penalty.dateFrom, penalty.dateTo, null, '[]')) {\n        total.inLocal += penalty.penaltySum.inLocal.amount;\n        total.inView += penalty.penaltySum.inView.amount;\n      }\n      return total;\n    }, {'inLocal': 0, 'inView': 0});\n  };\n\n  /**\n  * Сравнение цен услуги с переданными\n  * согласно задаче, достаточно сравнить брутто-цены\n  * @param {Object} salesTerms - ценообразователи в стуктуре КТ\n  */\n  ServiceStorage.prototype.compareSalesTerms = function(salesTerms) {\n    return (this.prices.inClient.client.gross === Number(salesTerms.clientCurrency.client.amountBrutto));\n  };\n\n  /**\n  * Добавление дополнительной услуги\n  * @param {Object} addService - дополнительная услуга\n  */\n  ServiceStorage.prototype.addAdditionalService = function(addService) {\n    this.additionalServices.push(addService);\n  };\n\n  /**\n  * Удаление дополнительной услуги\n  * @param {Integer} addServiceId - ID дополнительной услуги\n  */\n  ServiceStorage.prototype.removeAdditionalService = function(addServiceId) {\n    this.additionalServices = this.additionalServices.filter(function(addService) {\n      return addService.idAddService !== addServiceId;\n    });\n  };\n\n  return ServiceStorage;\n}));\n","/* global ktStorage */\n(function(global,factory){\n\n    KT.storage.TouristStorage = factory();\n\n}(this,function() {\n  /**\n  * Прототип хранилища данных туриста\n  * @module TouristStorage\n  * @constructor\n  * @param {Integer} serviceId - ID услуги\n  */\n  var TouristStorage = ktStorage.extend(function(touristId) {\n    this.namespace = 'TouristStorage';\n\n    this.touristId = touristId;\n\n    // услуги, с которыми связан турист\n    this.linkedServices = [];\n\n    // карты программ лояльности\n    this.bonusCards = [];\n\n    // структура дополнительных полей\n    this.customFields = null;\n  });\n\n  KT.addMixin(TouristStorage,'Dispatcher');\n\n  /**\n  * Инициализация хранилища\n  * @param {Object} touristData - данные туриста (/getOrderTourist)\n  */\n  TouristStorage.prototype.initialize = function(touristData) {\n    if (touristData.touristId !== this.touristId) {\n        KT.error(\n          this.namespace+': ' +\n          'попытка инициализации данными другого туриста,' +\n          ' текущий: ' . this.touristId +\n          ' данные от: '. serviceData.touristId\n        );\n    }\n\n    var isNotEmpty = function(v) {\n      return !(v === undefined || v === null || v === '');\n    };\n\n    // ФИО туриста\n    this.firstname = htmlDecode(touristData.firstName);\n    this.lastname = htmlDecode(touristData.lastName);\n    this.middlename = isNotEmpty(touristData.middleName) ?\n      htmlDecode(touristData.middleName) : null;\n\n    // пол\n    this.sex = (touristData.sex === 1) ? 'male' : 'female';\n\n    // контакты\n    this.email = isNotEmpty(touristData.email) ? touristData.email : null;\n    this.phone = {\n      countryCode: null,\n      cityCode: null,\n      number: null\n    };\n\n    if (isNotEmpty(touristData.phone)) {\n      var phone = String(touristData.phone).replace(/\\s/g,'');\n      var phoneparsed = phone.match(/^\\+?(\\d+)\\((\\d+)\\)(\\d+)$/);\n\n      if (phoneparsed === null) {\n        this.phone.number = phone;\n      } else {\n        this.phone.countryCode = phoneparsed[1];\n        this.phone.cityCode = phoneparsed[2];\n        this.phone.number = phoneparsed[3];\n      }\n    }\n\n    // признак турлидера\n    this.isTourleader = touristData.isTourLeader;\n\n    // дата рождения и возраст\n    this.birthdate = (touristData.birthdate !== null) ? moment(touristData.birthdate,'YYYY-MM-DD') : null;\n    this.age = (this.birthdate !== null ) ? \n      moment.duration(moment().valueOf() - this.birthdate.valueOf()).asYears() : \n      null;\n\n    // документы\n    var documentData = touristData.document;\n    this.document = {\n      series: documentData.serialNumber,\n      number: documentData.number,\n      type: documentData.documentType,\n      firstname: htmlDecode(documentData.firstName),\n      lastname: htmlDecode(documentData.lastName),\n      middlename: isNotEmpty(documentData.middleName) ?\n        htmlDecode(documentData.middleName) : null,\n      //issueDate: moment(documentData.issueDate,'YYYY-MM-DD'),\n      expiryDate: (documentData.expiryDate !== null) ? \n        moment(documentData.expiryDate,'YYYY-MM-DD') : null,\n      //issueDepartment: documentData.issueDepartment,\n      citizenship: documentData.citizenship\n    };\n\n    var self = this;\n\n    // привязка к сервисам\n    if (Array.isArray(touristData.services)) {\n      touristData.services.forEach(function(service) {\n        self.linkedServices.push({\n          'serviceId': service.serviceId,\n          'loyalityProviderId': service.aviaLoyalityProgrammId,\n          'loyalityCardNumber': service.bonuscardNumber\n        });\n      });\n    }\n\n    // карты программ лояльности\n    this.bonusCards = Array.isArray(touristData.bonusCards) ? touristData.bonusCards : [];\n\n    // дополнительные поля\n    this.customFields = (\n        Array.isArray(touristData.touristAdditionalData) && \n        touristData.touristAdditionalData.length > 0\n      ) ? touristData.touristAdditionalData : null;\n  };\n\n  /**\n  * Инициализация хранилища по данным пользователя\n  * @param {Object} userData - данные пользователя (ль getClientUser) \n  */\n  TouristStorage.prototype.initializeFromUser = function(userData) {\n    var isNotEmpty = function(v) {\n      return !(v === undefined || v === null || v === '');\n    };\n\n    // ID связанного пользователя\n    this.userId = userData.user.userId;\n\n    // ФИО туриста\n    this.firstname = htmlDecode(userData.user.name);\n    this.lastname = htmlDecode(userData.user.surname);\n    this.middlename = isNotEmpty(userData.user.secondName) ?\n      htmlDecode(userData.user.secondName) : null;\n\n    // пол\n    this.sex = (userData.user.prefix === 1) ? 'male' : 'female';\n\n    // контакты\n    this.email = isNotEmpty(userData.user.email) ? userData.user.email : null;\n    this.phone = {\n      countryCode: null,\n      cityCode: null,\n      number: null\n    };\n\n    if (isNotEmpty(userData.user.contactPhone)) {\n      var phone = String(userData.user.contactPhone).replace(/\\s/g,'');\n      var phoneparsed = phone.match(/^\\+?(\\d+)\\((\\d+)\\)(\\d+)$/);\n\n      if (phoneparsed === null) {\n        this.phone.number = phone;\n      } else {\n        this.phone.countryCode = phoneparsed[1];\n        this.phone.cityCode = phoneparsed[2];\n        this.phone.number = phoneparsed[3];\n      }\n    }\n\n    // признак турлидера\n    this.isTourleader = false;\n\n    // дата рождения и возраст\n    this.birthdate = (userData.user.birthDate !== null) ? moment(userData.user.birthDate,'YYYY-MM-DD') : null;\n    this.age = (userData.user.birthDate !== null ) ? \n      moment.duration(moment().valueOf() - this.birthdate.valueOf()).asYears() : \n      null;\n\n    // документы\n    this.document = {\n      documentId: userData.document.docId,\n      series: userData.document.docSerial,\n      number: userData.document.docNumber,\n      type: userData.document.docType,\n      firstname: htmlDecode(userData.document.firstName),\n      lastname: htmlDecode(userData.document.lastName),\n      middlename: isNotEmpty(userData.document.middleName) ?\n        htmlDecode(userData.document.middleName) : null,\n      //issueDate: moment(documentData.issueDate,'YYYY-MM-DD'),\n      expiryDate: (userData.document.docExpiryDate !== null) ? \n        moment(userData.document.docExpiryDate,'YYYY-MM-DD') : null,\n      //issueDepartment: documentData.issueDepartment,\n      citizenship: userData.document.citizenship\n    };\n\n    // карты программ лояльности\n    this.bonusCards = Array.isArray(userData.user.bonusCards) ? userData.user.bonusCards : [];\n\n    // дополнительные поля\n    this.customFields = Array.isArray(userData.addData) ? \n      userData.addData : null;\n  };\n\n  /**\n  * Возвращает строку с номером телефона\n  * @return {String|null} - номер телефона или null если его нет\n  */\n  TouristStorage.prototype.getPhoneNumber = function() {\n    if (this.phone.number !== null) {\n      if (this.phone.countryCode !== null) {\n        return '+' + this.phone.countryCode +\n          '(' + this.phone.cityCode + ')' +\n          this.phone.number;\n      } else {\n        return this.phone.number;\n      }\n    } else {\n      return null;\n    }\n  };\n\n  return TouristStorage;\n}));\n","/* global ktStorage */\n(function(global,factory){\n\n    KT.storage.InvoiceStorage = factory();\n\n}(this,function() {\n  /**\n  * Прототип хранилища данных счета\n  * @module InvoiceStorage\n  * @constructor\n  * @param {Integer} invoiceId - ID услуги\n  */\n  var InvoiceStorage = ktStorage.extend(function(invoiceId) {\n    this.namespace = 'InvoiceStorage';\n\n    this.invoiceId = invoiceId;\n  });\n\n  KT.addMixin(InvoiceStorage,'Dispatcher');\n\n  // статусы счета\n  InvoiceStorage.prototype.statuses = {\n    'WAIT': 1,\n    'INVOICED': 2,\n    'PARTIAL_PAID': 3,\n    'PAID': 4,\n    'CANCELLED': 5\n  };\n\n  /**\n  * Инициализация хранилища\n  * @param {Object} invoiceData - данные счета (/getOrder)\n  */\n  InvoiceStorage.prototype.initialize = function(invoiceData) {\n    if (invoiceData.invoiceId !== this.invoiceId) {\n        KT.error(\n          this.namespace+': ' +\n          'попытка инициализации данными другого инвойса,' +\n          ' текущая: ' . this.invoiceId +\n          ' данные от: '. invoiceData.invoiceId\n        );\n    }\n\n    // номер счета\n    this.number = invoiceData.invoiceNum;\n\n    // статус счета\n    this.status = +invoiceData.status;\n\n    // описание счета\n    this.description = invoiceData.description;\n\n    // дата выставления\n    this.creationDate = moment(invoiceData.creationDate,'YYYY-MM-DD HH:mm:ss');\n\n    // сумма счета и валюта\n    this.sum = Number(invoiceData.invoiceSum);\n    this.currency = invoiceData.invoiceCur;\n\n    // детализация по услугам\n    this.serviceDetails = {};\n\n    var self = this;\n\n    invoiceData.InvoiceServices.forEach(function(service) {\n      self.serviceDetails[service.serviceId] = {\n        'sum': Number(service.serviceSum),\n        'name': service.serviceName\n      };\n    });\n  };\n\n  /**\n  * Возвращает детализацию счета по услугам в виде массива\n  * @return {Array} - информация по услуге в составе счета\n  */\n  InvoiceStorage.prototype.getServiceDetails = function() {\n    var serviceDetails = [], srv;\n\n    for (var serviceId in this.serviceDetails) {\n      if (this.serviceDetails.hasOwnProperty(serviceId)) {\n        srv = $.extend(true,{},this.serviceDetails[serviceId]);\n        srv.serviceId = serviceId;\n        serviceDetails.push(srv);\n      }\n    }\n\n    return serviceDetails;\n  };\n\n  return InvoiceStorage;\n}));\n","/* global moment */\n/* global KT */\n/* global ktStorage */\n\n(function(global,factory){\n\n    KT.storage.OrderStorage = factory();\n\n}(this,function() {\n  /**\n  * Прототип хранилища данных заявки\n  * @module OrderStorage\n  * @constructor\n  * @param {Integer} orderId - ID заявки\n  */\n  var OrderStorage = ktStorage.extend(function(orderId) {\n    this.namespace = 'OrderStorage';\n\n    // состояние загрузки данных\n    this.loadStates = {\n      'orderdata': null,\n      'servicedata': null,\n      'invoicedata': null,\n      'touristdata': null,\n      'transitionsdata': null\n    };\n\n    // Идентификатор заявки (KT)\n    this.orderId = orderId;\n    // список услуг (ServiceStorage)\n    this.services = {};\n    // список счетов\n    this.invoices = {};\n    // список туристов (TouristStorage)\n    this.tourists = {};\n    // документы заявки\n    this.documents = [];\n    // история заявки\n    this.history = [];\n\n    // счетчик оставшихся активнх запросов по валидации действий над услугами\n    // см. checkWorkflow - validate\n    this.pendingValidations = 0;\n\n    // результат валидации для группы услуг: {действие: вердикт}\n    this.validatedActions = {};\n  });\n\n  KT.addMixin(OrderStorage,'Dispatcher');\n\n  /**\n  * Инициализация хранилища данными из getOrder\n  * @param {Object} orderData - данные заявки\n  */\n  OrderStorage.prototype.initialize = function(orderData) {\n    if (orderData.orderId !== this.orderId) {\n        KT.error(\n          this.namespace+': ' +\n          'попытка инициализации данными другой заявки,' +\n          ' текущая: ' . this.orderId +\n          ' данные от: '. orderData.orderId\n        );\n    }\n\n    var isNotEmpty = function(v) {\n      return !(v === undefined || v === null || v === '');\n    };\n\n    // Идентификаторы заявки в шлюзах\n    this.orderIdGp = isNotEmpty(orderData.orderIdGp) ? orderData.orderIdGp : null;\n    this.orderIdUtk = isNotEmpty(orderData.orderIdUtk) ? orderData.orderIdUtk : null;\n\n    // статусная информация\n    this.status = +orderData.status;\n    this.isVip = orderData.VIP;\n    this.isArchived = orderData.archive;\n    this.isOffline = false;\n    this.isAddTouristAllowed = false;\n\n    // ID контракта заявки\n    this.contractId = orderData.contractID;\n\n    // даты создания/начала/окончания заявки\n    /** @todo дата создания пока не приходит */\n    this.creationDate = (orderData.orderDate !== null) ?\n      moment(orderData.orderDate,'YYYY-MM-DD HH:mm:ss') : null;\n    this.startDate = moment(orderData.startDate,'YYYY-MM-DD HH:mm:ss');\n    this.endDate = moment(orderData.endDate,'YYYY-MM-DD HH:mm:ss');\n\n    // данные создателя заявки\n    this.creator = (orderData.creator.id === null) ? null : {\n      id: orderData.creator.id,\n      firstname: orderData.creator.firstName,\n      lastname: orderData.creator.lastName,\n      middlename: isNotEmpty(orderData.creator.middleName) ?\n        orderData.creator.middleName : null\n    };\n\n    // тип компании, для которой создается заявка (агентство, корпоратор)\n    this.companyRoleType = (function(roleType) {\n      switch (roleType) {\n        case 1: return 'op';\n        case 2: return 'agent';\n        case 3: return 'corp';\n        default: return KT.profile.userType;\n      }\n    }(orderData.companyRoleType));\n\n    // данные ответственного менеджера КМП заявки\n    this.kmpManager = (orderData.managerKMP.id === null) ? null : {\n      id: orderData.managerKMP.id,\n      firstname: orderData.managerKMP.firstName,\n      lastname: orderData.managerKMP.lastName,\n      middlename: isNotEmpty(orderData.managerKMP.middleName) ?\n        orderData.managerKMP.middleName : null\n    };\n\n    // данные ответственного менеджера клиента заявки\n    this.clientManager = (orderData.clientManager.id === null) ? null : {\n      id: orderData.clientManager.id,\n      firstname: orderData.clientManager.firstName,\n      lastname: orderData.clientManager.lastName,\n      middlename: isNotEmpty(orderData.clientManager.middleName) ?\n        orderData.clientManager.middleName : null\n    };\n\n    // данные клиента заявки\n    this.client = {\n      id: orderData.agentId,\n      name: orderData.agencyName\n    };\n\n    // данные турлидера заявки\n    this.tourleader = (\n        orderData.touristFirstName !== null &&\n        orderData.touristLastName !== null\n      ) ? {\n      firstname: orderData.touristFirstName,\n      lastname: orderData.touristLastName,\n      middlename: null, /** @todo отчество турлидера не приходит */\n      phone: isNotEmpty(orderData.liderPhone) ? orderData.liderPhone : null,\n      email: isNotEmpty(orderData.liderEmail) ? orderData.liderEmail : null\n    } : null;\n\n    // количество туристов\n    this.touristsAmount = orderData.touristsNums;\n\n    // данные привязки туристов к услугам\n    this.servicesTouristLinkage = {};\n\n    var self = this;\n\n    // заполнение услуг\n    if (Array.isArray(orderData.services)) {\n      orderData.services.forEach(function(service) {\n        if (self.services[service.serviceID] === undefined) {\n          self.services[service.serviceID] = new KT.storage.ServiceStorage(service.serviceID);\n        }\n\n        self.services[service.serviceID].initialize(service);\n        if (self.services[service.serviceID].isOffline) {\n          self.isOffline = true;\n        }\n      });\n    }\n\n    /** @todo это все должно уйти в checkworkflow, наверное? */\n    var allowedStatuses = [ 0,1,2,5,9,10 ];\n    if (allowedStatuses.indexOf(this.status) !== -1) {\n      this.isAddTouristAllowed = true;\n    }\n\n    this.loadStates.orderdata = 'loaded';\n    this.dispatch('initialized', this);\n  };\n\n  /**\n  * Инициализация хранилища для новой заявки (установка настроек по умолчанию)\n  * @param {Object} bareData - начальные данные заявки (клиент, создатель, ...)\n  */\n  OrderStorage.prototype.initializeBare = function(bareData) {\n    // Идентификаторы заявки в шлюзах\n    this.orderIdGp = null;\n    this.orderIdUtk = null;\n\n    // статусная информация\n    this.status = 0;\n    this.isVip = false;\n    this.isArchived = false;\n    this.isOffline = false;\n    this.isAddTouristAllowed = true;\n\n    // ID контракта заявки\n    this.contractId = bareData.contractId;\n\n    // даты создания/начала/окончания заявки\n    /** @todo дата создания пока не приходит */\n    this.creationDate = moment();\n    this.startDate = this.creationDate;\n    this.endDate = this.creationDate;\n\n    // данные создателя заявки\n    this.creator = {\n      'id': KT.profile.user.id,\n      'firstname': KT.profile.user.firstName,\n      'lastname': KT.profile.user.lastName,\n      'middlename': KT.profile.user.middleName\n    };\n\n    // тип компании, для которой создается заявка (агентство, корпоратор)\n    this.companyRoleType = (function(roleType) {\n      switch (roleType) {\n        case 1: return 'op';\n        case 2: return 'agent';\n        case 3: return 'corp';\n        default: return KT.profile.userType;\n      }\n    }(bareData.clientType));\n\n    // данные ответственного менеджера КМП заявки\n    this.kmpManager = null;\n\n    // данные ответственного менеджера клиента заявки\n    this.clientManager = null;\n\n    // данные клиента заявки\n    this.client = {\n      id: bareData.clientId,\n      name: bareData.clientName\n    };\n\n    // данные турлидера заявки\n    this.tourleader = null;\n\n    // количество туристов\n    this.touristsAmount = 0;\n\n    this.dispatch('initialized', this);\n  };\n\n  /**\n  * Сохранение информации по документам заявки \n  * @param {Array} documents - документы\n  */\n  OrderStorage.prototype.setDocuments = function(documents) {\n    this.documents = documents;\n    this.dispatch('setDocuments', {'items': documents});\n  };\n\n  /**\n  * Сохранение истории заявки\n  * @param {Array} history - история заявки \n  */\n  OrderStorage.prototype.setHistory = function(history) {\n    this.history = history;\n    this.dispatch('setHistory', {'records': history});\n  };\n\n  /**\n  * Сохранение информации по услугам\n  * @param {Array} services - информация по услугам (/getOrderOffer)\n  */\n  OrderStorage.prototype.setServices = function(services) {\n    var self = this;\n\n    services.forEach(function(service) {\n      if (self.services[service.serviceId] === undefined) {\n        KT.error(this.namespace + ': ' + 'неизвестная услуга:' + service.serviceId);\n        return;\n      }\n\n      self.services[service.serviceId].updateFullInfo(service);\n    });\n\n    // если туристы уже загружены, обновить для услуг информацию по возрастному составу\n    if (this.loadStates.touristdata !== null) {\n      this.updateServiceTourists();\n    }\n\n    this.loadStates.servicedata = 'loaded';\n    this.dispatch('setServices',this);\n  };\n\n  /**\n  * Возвращает список услуг как массив\n  * @return {ServiceStorage[]} массив услуг\n  */\n  OrderStorage.prototype.getServices = function() {\n    var services = [];\n\n    for(var serviceId in this.services) {\n      if (this.services.hasOwnProperty(serviceId)) {\n        services.push(this.services[serviceId]);\n      }\n    }\n\n    return services;\n  };\n\n  /**\n  * Возвращает список идентификаторов услуг в заявке\n  * @return {Integer[]} массив идентификаторов\n  */\n  OrderStorage.prototype.getServiceIds = function() {\n    var serviceIds = [];\n\n    for(var serviceId in this.services) {\n      if (this.services.hasOwnProperty(serviceId)) {\n        serviceIds.push(serviceId);\n      }\n    }\n\n    return serviceIds;\n  };\n\n  /**\n  * Сохраняет информацию по счетам\n  * @param {Array} invoices - массив счетов (/getOrderInvoices)\n  */\n  OrderStorage.prototype.setInvoices = function(invoices) {\n    var self = this;\n\n    for (var serviceId in this.services) {\n      if (this.services.hasOwnProperty(serviceId)) {\n        this.services[serviceId].invoiceSum = 0;\n      }\n    }\n\n    invoices.forEach(function(invoice) {\n      if (self.invoices[invoice.invoiceId] === undefined) {\n        self.invoices[invoice.invoiceId] = new KT.storage.InvoiceStorage(invoice.invoiceId);\n      }\n      self.invoices[invoice.invoiceId].initialize(invoice);\n    });\n\n    this.loadStates.invoicedata = 'loaded';\n    this.dispatch('setInvoices',this);\n  };\n\n  /**\n  * Возвращает список счетов как массив\n  * @return {InvoiceStorage[]} массив счетов\n  */\n  OrderStorage.prototype.getInvoices = function() {\n    var invoices = [];\n\n    for(var invoiceId in this.invoices) {\n      if (this.invoices.hasOwnProperty(invoiceId)) {\n        invoices.push(this.invoices[invoiceId]);\n      }\n    }\n\n    return invoices;\n  };\n\n  /**\n  * Сохранение информации по туристам\n  * @param {Array} tourists - информация по туристам (/getOrderTourists)\n  */\n  OrderStorage.prototype.setTourists = function(tourists) {\n    var self = this;\n\n    this.servicesTouristLinkage = {};\n\n    tourists.forEach(function(tourist) {\n      if (self.tourists[tourist.touristId] === undefined) {\n        self.tourists[tourist.touristId] = new KT.storage.TouristStorage(tourist.touristId);\n      }\n      self.tourists[tourist.touristId].initialize(tourist);\n      var TouristStorage = self.tourists[tourist.touristId];\n\n      TouristStorage.linkedServices.forEach(function(linkedService) {\n        if (!self.servicesTouristLinkage.hasOwnProperty(linkedService.serviceId)) {\n          self.servicesTouristLinkage[linkedService.serviceId] = {};\n        }\n        self.servicesTouristLinkage[linkedService.serviceId][TouristStorage.touristId] = {\n          'touristId': TouristStorage.touristId,\n          'isAttached': true, /** @deprecated?  */\n          'firstname': TouristStorage.firstname,\n          'lastname': TouristStorage.lastname,\n          'middlename': TouristStorage.middlename,\n          'loyalityProviderId': linkedService.loyalityProviderId,\n          'loyalityCardNumber': linkedService.loyalityCardNumber\n        };\n      });\n    });\n\n    // если услуги уже загружены, обновить для услуг информацию по возрастному составу\n    if (this.loadStates.servicedata !== null) {\n      this.updateServiceTourists();\n    }\n\n    this.loadStates.touristdata = 'loaded';\n    this.dispatch('setTourists', this);\n  };\n\n  /**\n  * Возвращает список туристов как массив\n  * @return {TouristStorage[]} массив туристов\n  */\n  OrderStorage.prototype.getTourists = function() {\n    var tourists = [];\n\n    for (var touristId in this.tourists) {\n      if (this.tourists.hasOwnProperty(touristId)) {\n        tourists.push(this.tourists[touristId]);\n      }\n    }\n\n    return tourists;\n  };\n\n  /**\n  * Обновление информации о туристах в составе услуг (возрастной состав)\n  * @param {Integer} [serviceId] - если указано, обновить данные только по этой услуге \n  */\n  OrderStorage.prototype.updateServiceTourists = function(updateServiceId) {\n    var self = this;\n\n    var updateServiceTourists = function(serviceId) {\n        if (self.servicesTouristLinkage.hasOwnProperty(serviceId)) {\n          self.services[serviceId].tourists = self.servicesTouristLinkage[serviceId];\n        }\n        self.services[serviceId].setTouristAges(self.tourists);\n    };\n\n    if (updateServiceId !== undefined) {\n      updateServiceTourists(updateServiceId);\n    } else {\n      for (var serviceId in this.services) {\n        if (this.services.hasOwnProperty(serviceId)) {\n          updateServiceTourists(serviceId);\n        }\n      }\n    }\n  };\n\n  /**\n  * Сохранение туриста в структуре заявки\n  * @param {TouristStorage} Tourist - турист\n  */\n  OrderStorage.prototype.saveTourist = function(Tourist) {\n    this.tourists[Tourist.touristId] = Tourist;\n\n    if (Tourist.isTourleader || this.tourleader === null) {\n\n      this.tourleader = {\n        firstname: Tourist.firstname,\n        lastname: Tourist.lastname,\n        middlename: null, /** @todo отчество турлидера не приходит */\n        phone: Tourist.getPhoneNumber(),\n        email: Tourist.email\n      };\n    }\n\n    // количество туристов\n    this.touristsAmount = this.getTourists().length;\n\n    this.dispatch('savedTourist', {'touristId': Tourist.touristId});\n  };\n\n  /**\n  * Сохранение статусов привязки туристов к услуге\n  * @param {Integer} serviceId - ID услуги\n  * @param {Object} linkageInfo - данные привязки туристов\n  */\n  OrderStorage.prototype.saveServiceLinkage = function(serviceId, linkageInfo) {\n    var self = this;\n    var service = this.services[serviceId];\n\n    linkageInfo.forEach(function(touristLinkage) {\n      var tourist = self.tourists[touristLinkage.touristId];\n      if (touristLinkage.link === true) {\n        tourist.linkedServices.push({\n          'serviceId': service.serviceId,\n          'loyalityProviderId': touristLinkage.aviaLoyalityProgrammId,\n          'loyalityCardNumber': touristLinkage.bonuscardNumber\n        });\n        service.tourists[tourist.touristId] = {\n          'touristId': tourist.touristId,\n          'isAttached': true, /** @deprecated?  */\n          'firstname': tourist.firstname,\n          'lastname': tourist.lastname,\n          'middlename': tourist.middlename,\n          'loyalityProviderId': touristLinkage.aviaLoyalityProgrammId,\n          'loyalityCardNumber': touristLinkage.bonuscardNumber\n        };\n      } else {\n        tourist.linkedServices = tourist.linkedServices.filter(function(linkedService) {\n          return (linkedService.serviceId !== serviceId);\n        });\n        delete service.tourists[tourist.touristId];\n      }\n    });\n    \n    service.setTouristAges(this.tourists);\n\n    this.dispatch('savedServiceLinkage', {\n      'serviceId' : serviceId\n    });\n  };\n\n  /**\n  * Удаление туриста\n  * @param {Integer} touristId - ID удаляемого туриста\n  */\n  OrderStorage.prototype.removeTourist = function(touristId) {\n    if (this.tourists[touristId].isTourleader) {\n      this.tourleader = null;\n    }\n    delete this.tourists[touristId];\n    this.dispatch('touristRemoved', {'touristId': touristId});\n  };\n\n  /**\n  * Сохранение данные о доступных действиях\n  * @param {Array} transitions - списов доступных действий (/checkWorkflow)\n  */\n  OrderStorage.prototype.setAllowedTransitions = function(transitions) {\n    var self = this;\n\n    transitions.forEach(function(service) {\n      self.services[service.serviceId].setAllowedTransitions(service.controls);\n    });\n\n    this.loadStates.transitionsdata = 'loaded';\n    this.dispatch('setAllowedTransitions',this);\n  };\n  \n  /**\n  * Формирование структуры привязки туристов к услуге\n  * @param {Integer} serviceId - ID редактируемой услуги\n  * @param {Object} newTouristLinkage - список туристов со статусами привязки и дополнительной информацией\n  * @return {Array} - параметры привязки туристов для передачи в BE\n  */\n  OrderStorage.prototype.createLinkageStructure = function(serviceId, newTouristLinkage) {\n    var linkageInfo = [];\n    var linkedTourists = {};\n    var service = this.services[serviceId];\n\n    /* Сохранить уже привязанных туристов */\n    service.getServiceTourists().forEach(function(tourist) {\n      linkedTourists[tourist.touristId] = true;\n    });\n\n    for (var touristId in newTouristLinkage) {\n      if (newTouristLinkage.hasOwnProperty(touristId)) {\n        var isAttached = newTouristLinkage[touristId].state;\n        if (isAttached) {\n          var tourist = this.tourists[touristId];\n\n          if (tourist.document.expiryDate !== null) {\n            var docExpiry = tourist.document.expiryDate.valueOf();\n            if (docExpiry <= service.endDate.valueOf()) {\n              KT.notify('touristLinkageNotAllowedByDocument');\n              return false;\n            }\n          }\n\n          linkageInfo.push({\n            'touristId': +touristId,\n            'bonuscardNumber': newTouristLinkage[touristId].loyalityCardNumber,\n            'aviaLoyalityProgrammId': newTouristLinkage[touristId].loyalityProviderId,\n            'link': true\n          });\n        } else if (linkedTourists[touristId] === true && !isAttached) {\n          linkageInfo.push({\n            'touristId': +touristId,\n            'bonuscardNumber': null,\n            'aviaLoyalityProgrammId': null,\n            'link': false\n          });\n        }\n      }\n    }\n\n    return linkageInfo;\n  };\n\n  /**\n  * Формирование параметров для вызова команд для работы с услугой\n  * @param {String} command - название команды\n  * @param {Integer} serviceId - ID услуги для проверки\n  * @return {Object|false} - набор параметров (actionParams) или false в случае ошибки формирования\n  */\n  OrderStorage.prototype.getServiceCommandParams = function(command, serviceId) {\n    switch(command) {\n      // Команда запуска бронирования\n      case 'BookStart':\n        if (this.services[serviceId] === undefined) {\n          console.error('BookStart: услуга ' + serviceId + ' не найдена');\n          return false;\n        }\n        var service = this.services[serviceId];\n\n        return {\n          'serviceId':serviceId,\n          'agreementSet':service.isTOSAgreementSet\n        };\n      // Команда отмены брони\n      case 'BookCancel':\n        return {\n          'serviceId': serviceId,\n          'createPenaltyInvoice': true\n        };\n      // Команда выписки билетов\n      case 'IssueTickets':\n        return {\n          'serviceId': serviceId\n        };\n      // Команда выставления счетов\n      case 'PayStart':\n        return {\n          'serviceId': serviceId\n        };\n      // Команда выставления статуса ручного режима\n      case 'Manual':\n        return {\n          'serviceId': serviceId\n        };\n      // Команда запроса на изменение / изменения услуги\n      case 'ServiceChange':\n        return {\n          'serviceId': serviceId\n        };\n      // Команда отмены услуги\n      case 'ServiceCancel':\n        return {\n          'serviceId': serviceId\n        };\n\n      default:\n        return false;\n    }\n  };\n\n  /**\n  * Сохранение результата валидации действий над услугами\n  * @param {String} action - валидируемое действие\n  * @param {Object|false} validationResult - данные процедуры валидации или false в случае ошибки\n  */\n  OrderStorage.prototype.setValidatedAction = function(action, validationResults) {\n    var self = this;\n\n    self.pendingValidations--;\n\n    if (validationResults === false) {\n      self.validatedActions[action] = {'validated': false};\n    } else {\n      self.validatedActions[action] = {'validated': true};\n\n      validationResults.forEach(function(service) {\n        if (service.validationResult === false) {\n          self.validatedActions[action].validated = false;\n        }\n      });\n    }\n\n    if (this.pendingValidations === 0) {\n      this.dispatch('setValidatedActions', this);\n    }\n  };\n\n  return OrderStorage;\n}));\n","/* global transliterate */\n(function(global,factory) {\n\n    KT.crates.OrderEdit.tourists.view = factory(KT.crates.OrderEdit);\n\n}(this, function(crate) {\n  /**\n  * Редактирование заявки: туристы\n  * @constructor\n  * @param {Object} module - хранилище родительского модуля\n  * @param {Object} [options] - Объект конфигурации класса\n  */\n  var modView = function(module,options) {\n    this.mds = module;\n    if (options === undefined) { options = {}; }\n    this.config = $.extend(true,{\n      'templateUrl':'/cabinetUI/orders/getTemplates',\n      'templates':{\n        touristForm:'orderEdit/tourists/touristForm',\n        touristFormActions:'orderEdit/tourists/touristFormActions',\n        touristFormBonusCard: 'orderEdit/tourists/touristFormBonusCard',\n        touristFormNoBonusCards: 'orderEdit/tourists/touristFormNoBonusCards',\n        touristFormBonusCardActions: 'orderEdit/tourists/touristFormBonusCardActions',\n        touristListControls:'orderEdit/tourists/touristListControls',\n        touristListEmpty:'orderEdit/tourists/touristListEmpty',\n        clndr:'clndrTemplate',\n        // custom fields\n        TextCF: 'orderEdit/customFields/textCF',\n        TextAreaCF: 'orderEdit/customFields/textAreaCF',\n        NumberCF: 'orderEdit/customFields/numberCF',\n        DateCF: 'orderEdit/customFields/dateCF'\n      }\n    },options);\n\n    this.$tabLabel = $('#tab-headers').find('.tab-headers__link[data-tab=\"tourists\"]');\n\n    this.$touristList = $('#order-edit-tourists');\n    this.$touristListControls = $('#order-edit-tourists--controls');\n\n    // ссылки на формы туристов по ID туриста\n    this.touristForms = {};\n\n    // флаг наличия турлидера в заявке\n    this.tlFlag = false; \n\n    // дополнительные поля туристов\n    this.customFields = {};\n\n    // список объектов документов (тип, валидация, ...)\n    this.doctypes = [];\n    for (var doctype in KT.config.touristDocuments) {\n      if (KT.config.touristDocuments.hasOwnProperty(doctype)) {\n        this.doctypes.push({\n          value: doctype,\n          text: KT.config.touristDocuments[doctype].docname\n        });\n      }\n    }\n\n    // список стран для выбора в поле \"Гражданство\"\n    this.countries = [];\n    for(var country in KT.countryCodes) {\n      if (KT.countryCodes.hasOwnProperty(country)) {\n        this.countries.push({\n          value:country,\n          text:KT.countryCodes[country]\n        });\n      }\n    }\n  };\n\n  /** Отображение списка туристов\n  * @param {OrderStorage} OrderStorage - данные заявки\n  */\n  modView.prototype.renderTouristList = function(OrderStorage) {\n    var _instance = this;\n\n    _instance.$touristList.empty();\n    _instance.touristForms = {};\n\n    var actions = {\n      'allowAdd': OrderStorage.isAddTouristAllowed\n    };\n\n    _instance.$touristListControls.html(\n      Mustache.render(_instance.mds.tpl.touristListControls, actions)\n    );\n\n    var Tourists = OrderStorage.getTourists();\n\n    if (Tourists.length === 0) {\n      _instance.$tabLabel.addClass('empty');\n      _instance.$touristList.html(Mustache.render(_instance.mds.tpl.touristListEmpty, {}));\n      return;\n    } else {\n      _instance.$tabLabel.removeClass('empty');\n    }\n\n    // турлидер(-ы) должен быть в начале списка\n    Tourists.sort(function(a,b) {\n      if (a.isTourleader) {\n        return (b.isTourleader) ? 0 : -1;\n      } else {\n        return (b.isTourleader) ? 1 : 0;\n      }\n    });\n\n    var isTourleaderSet = (OrderStorage.tourleader === null) ? false : true;\n    var isOffline = (OrderStorage.isOffline !== true) ? false : true;\n    var orderClientType = OrderStorage.companyRoleType;\n\n    Tourists.forEach(function(Tourist) {\n      var touristInfo = _instance.mapTouristInfo(Tourist, isTourleaderSet, OrderStorage.isOffline);\n\n      touristInfo.actions = Mustache.render(_instance.mds.tpl.touristFormActions, isOffline ? {} : {\n        'allowedSave': true,\n        'allowedUserCreation': (orderClientType === 'corp'),\n        'allowedReset': true,\n        'allowedDelete': true,\n      });\n\n      _instance.touristForms[Tourist.touristId] = $(Mustache.render(_instance.mds.tpl.touristForm, touristInfo))\n        .appendTo(_instance.$touristList);\n\n      _instance.initControls(Tourist.touristId);\n      _instance.initCustomFields(Tourist);\n    });\n\n  };\n\n  /**\n  * Добавление новой формы туриста\n  * @param {OrderStorage} OrderStorage - хранилище данных заявки\n  */\n  modView.prototype.addTouristForm = function(OrderStorage) {\n    var _instance = this;\n    var isTourleaderSet = (OrderStorage.tourleader === null) ? false : true;\n    var orderClientType = OrderStorage.companyRoleType;\n    var isNewOrder = (OrderStorage.orderId === 'new');\n    \n    var tempTouristId = 'tmp' + moment().valueOf();\n\n    if (this.$touristList.children('.js-ore-tourist').length === 0) {\n      this.$touristList.empty();\n    }\n\n    var formActions = Mustache.render(this.mds.tpl.touristFormActions, {\n        'allowedSave': true,\n        'allowedUserCreation': (orderClientType === 'corp'),\n        'allowedReset': !isNewOrder,\n        'allowedDelete': !isNewOrder\n    });\n\n    this.touristForms[tempTouristId] = $(Mustache.render(this.mds.tpl.touristForm, {\n        'touristId': tempTouristId,\n        'isNewTourist': true,\n        'isEditable': true,\n        'allowedTouristSelect': (orderClientType === 'corp'),\n        'isTourleaderSet':isTourleaderSet,\n        'bonusCards': Mustache.render(_instance.mds.tpl.touristFormNoBonusCards, {}),\n        'bonusCardsActions': Mustache.render(_instance.mds.tpl.touristFormBonusCardActions, {\n            'add': true\n          }),\n        'actions': formActions\n      }))\n      .addClass('active')\n      .appendTo(this.$touristList);\n\n    if (orderClientType === 'corp') {\n      this.touristForms[tempTouristId].find('.js-ore-tourist--suggest')\n        .selectize({\n          plugins: {'key_down': { start: 2 }},\n          openOnFocus: true,\n          create: false,\n          selectOnTab: true,\n          highlight: false,\n          loadThrottle: 300,\n          valueField: 'docId',\n          labelField: 'name',\n          sortField:'seqid',\n          options:[],\n          render: {\n            item: function(user) {\n              return '<div class=\"ore-tourist-suggest__item\">' +\n                user.lastName + ' ' + user.firstName + \n                ' (' + user.docSerial + ' ' + user.docNumber + ')' +\n                '</div>';\n            },\n            option: function(user) {\n              return '<div class=\"ore-tourist-suggest__option\">' +\n                user.lastName + ' ' + user.firstName + \n                ' (' + user.docSerial + ' ' + user.docNumber + ')' +\n                '</div>';\n            }\n          },\n          score:function() {\n            return function(item) {\n              return 1000 / (item.seqid);\n            };\n          },\n          load: function(query, callback) {\n            var self = this;\n\n            this.clearOptions();\n\n            if (!query.length || query.length < 2) {\n              return callback();\n            }\n\n            KT.apiClient.getClientUserSuggest({\n              data: {\n                'companyId': _instance.mds.OrderStorage.client.id,\n                'substringFIO': query\n              },\n              error: function() {\n                callback();\n              },\n              success: function(response) {\n                var $selinp = self.$control;\n\n                if (+response.status === 0 && Array.isArray(response.body)) {\n                  response.body.forEach(function(item, i) {\n                    item.seqid = i + 1;\n                  });\n                  callback(response.body);\n\n                  if (response.body.length === 0) {\n                    $selinp.addClass('warning');\n                    setTimeout(function() {\n                      $selinp.removeClass('warning');\n                    }, 2000);\n                  }\n                } else {\n                  callback();\n                  self.refreshOptions(true);\n                  $selinp.addClass('warning');\n                  setTimeout(function() {\n                    $selinp.removeClass('warning');\n                  }, 2000);\n                }\n              }\n            });\n          },\n          onType:function(str) {\n            if (str.length < 2) {\n              this.close();\n              this.clearOptions();\n            }\n          },\n          onItemRemove: function() {\n            this.clearOptions();\n          },\n          onChange: function(val) {\n            if (val === '') {\n              this.trigger('item_remove');\n            }\n          }\n        });\n    }\n\n    var yh = this.touristForms[tempTouristId].offset().top;\n\n    /** @todo this is for baron scroller, redefine in KT core? */\n    $('#main-scroller').stop().animate({\n        scrollTop: $('#main-scroller').scrollTop() + (yh-20)\n      }, 300, 'swing');\n\n    this.initControls(tempTouristId);\n  };\n\n  /**\n  * Отображение лоадера в процессе обработки туриста\n  * @todo перенести в центральный класс вьюх?\n  * @param {Object} $touristForm - форма редактирования туриста\n  */\n  modView.prototype.renderPendingProcess = function($touristForm) {\n    $touristForm.find('.js-ore-tourist--actions')\n      .html(Mustache.render(KT.tpl.spinner, {'type':'medium'}));\n  };\n\n  /**\n  * Обновление информации по определенному туристу\n  * @param {TouristStorage} Tourist - турист\n  * @param {Boolean} isOffline - признак оффлайновости заявки\n  */\n  modView.prototype.refreshTouristForm = function(Tourist, isOffline) {\n    if (isOffline !== true) { isOffline = false; }\n    var isNewOrder = (this.mds.OrderStorage.orderId === 'new');\n    var orderClientType = this.mds.OrderStorage.companyRoleType;\n\n    this.$tabLabel.removeClass('empty');\n    console.log('tourist: ');\n    console.log(Tourist);\n    var $target = this.touristForms[Tourist.touristId];\n    \n    var touristInfo = this.mapTouristInfo(Tourist, false, isOffline);\n    touristInfo.actions = Mustache.render(this.mds.tpl.touristFormActions, isOffline ? {} : {\n      'allowedSave': true,\n      'allowedUserCreation': (orderClientType === 'corp'),\n      'allowedReset': true,\n      'allowedDelete': !isNewOrder,\n    });\n\n    var $newForm = $(Mustache.render(this.mds.tpl.touristForm, touristInfo));\n    $target.off().replaceWith($newForm);\n    $newForm.addClass('active');\n\n    this.touristForms[Tourist.touristId] = $newForm;\n\n    this.initControls(Tourist.touristId);\n    this.initCustomFields(Tourist);\n  };\n\n  /**\n  * Обновление действий с формой туриста\n  * @param {Obejct} $tourist - форма турисиа\n  * @param {Boolean} isOffline - признак оффлайновости заявки\n  */\n  modView.prototype.refreshTouristFormActions = function($tourist, isOffline) {\n    var isNewOrder = (this.mds.OrderStorage.orderId === 'new');\n    var orderClientType = this.mds.OrderStorage.companyRoleType;\n\n    $tourist.find('.js-ore-tourist--actions')\n      .html(Mustache.render(this.mds.tpl.touristFormActions, isOffline ? {} : {\n        'allowedSave': true,\n        'allowedUserCreation': (orderClientType === 'corp'),\n        'allowedReset': true,\n        'allowedDelete': !isNewOrder,\n      }));\n  };\n\n  /**\n  * Удаление формы туриста\n  * @param {Integer|String} touristId - ID туриста (или временный ID для новой формы)\n  */\n  modView.prototype.removeTouristForm = function(touristId) {\n    var $tourists = this.$touristList.find('.js-ore-tourist');\n    var $touristForm = this.touristForms[touristId];\n    var touristsAmount = $tourists.length;\n    var adjustScroll = $('#main-scroller').scrollTop();\n    var formOffset = $touristForm.offset().top;\n\n    if (formOffset < 15) {\n      adjustScroll -= (15 - formOffset);\n      if (adjustScroll < 0) { adjustScroll = 0; }\n      $('#main-scroller').animate({'scrollTop': adjustScroll}, 400);\n    }\n    $touristForm.slideUp(400, function() { $(this).remove(); });\n\n    if (touristsAmount === 1) {\n      this.$tabLabel.addClass('empty');\n    }\n  };\n\n  /**\n  * Инициализация элементов управления (календари, селекты, ...)\n  * @param {String|Integer} touristId - идентификатор туриста\n  */\n  modView.prototype.initControls = function(touristId) {\n    var _instance = this;\n    var $touristForm = _instance.touristForms[touristId];\n\n    $touristForm.find('.simpletoggler input').trigger('change');\n    \n    $touristForm.find('input[name=\"birthdate\"]')\n      .each(function() {\n          $(this).clndrize({\n            'template':_instance.mds.tpl.clndr,\n            'eventName':'Дата рождения',\n            'showDate':moment().subtract(20,'years'),\n            'clndr': {\n              'constraints': {\n                'startDate':'1915-01-01',\n                'endDate':moment().format('YYYY-MM-DD')\n              }\n            }\n          });\n      });\n\n    $touristForm.find('select[name=\"citizenship\"]')\n      .selectize({\n        openOnFocus: true,\n        create: false,\n        options: _instance.countries,\n        selectOnTab:true,\n        sortField:'text',\n        searchField: 'text',\n        render: {\n          item: function(item) {\n            return '<div data-value=\"'+item.value+'\" class=\"item\" title=\"'+item.text+'\">'+item.text+'</div>';\n          },\n          option: function(item) {\n            return '<div data-value=\"'+item.value+'\" data-selectable class=\"option\">'+item.text+'</div>';\n          }\n        }\n      });\n    \n    $touristForm.find('input[name=\"docenddate\"]')\n      .each(function() {\n        $(this).clndrize({\n          'template':_instance.mds.tpl.clndr,\n          'eventName':'Дата окончания',\n          'clndr': {\n            'constraints': {\n              'startDate':moment().add(2,'days').format('YYYY-MM-DD'),\n              'endDate':moment().add(10,'years').format('YYYY-MM-DD')\n            }\n          }\n        });\n      });\n\n    $touristForm.find('select[name=\"doctype\"]')\n      .selectize({\n        openOnFocus: true,\n        create: false,\n        selectOnTab:true,\n        options: _instance.doctypes,\n        searchField: 'text',\n        onItemAdd: function(v) {\n          v = +v;\n          if (v === 1 || v === 2) {\n            var $cz = this.$input.closest('.js-ore-tourist').find('select[name=\"citizenship\"]');\n            if ($cz.val() === '') {\n              this.$input.closest('.js-ore-tourist').find('select[name=\"citizenship\"]')[0].selectize.addItem('RU');\n            }\n          }\n        }\n      });\n\n    $touristForm.find('input[name=\"country-prefix\"],input[name=\"city-prefix\"],input[name=\"phone\"]')\n      .on('keypress',function(e) {\n          var char = String.fromCharCode(e.which);\n          var check = /[0-9]/;\n          if (!check.test(char)) {\n            return false;\n          }\n        });\n\n    KT.Dictionary.getAsList('loyalityPrograms')\n      .then(function(loyalityPrograms) {\n        $touristForm.find('.js-ore-tourist--bonus-card-program')\n          .each(function() {\n            var currentValue = $(this).val();\n\n            initLoyalityProgramSelect($(this), {\n              options: loyalityPrograms\n            });\n\n            if (currentValue !== '') {\n              $(this)[0].selectize.addItem(+currentValue);\n            }\n          });\n      });\n\n    _instance.livecheckDocument($touristForm);\n  };\n\n  /** \n  * Добавляет форму ввода мильной карты к форме редактирования туриста \n  * @param {Object} $touristForm - форма туриста\n  */\n  modView.prototype.addBonusCardForm = function($touristForm) {\n    var _instance = this;\n    var $cardsList = $touristForm.find('.js-ore-tourist--bonus-cards');\n\n    KT.Dictionary.getAsList('loyalityPrograms')\n      .then(function(loyalityPrograms) {\n        if ($cardsList.children('.js-ore-tourist--bonus-card').length === 0) {\n          $cardsList.empty();\n        }\n\n        var $loyalityProgramSelect = $(Mustache.render(_instance.mds.tpl.touristFormBonusCard, {}))\n          .appendTo($cardsList)\n          .find('.js-ore-tourist--bonus-card-program');\n\n        initLoyalityProgramSelect($loyalityProgramSelect, {\n          options: loyalityPrograms\n        });\n      });\n  };\n\n  /** \n  * Удаление формы ввода мильной карты\n  * @param {Object} $bonusCard - форма мильной карты\n  */\n  modView.prototype.removeBonusCardForm = function($bonusCard) {\n    var $cardsList = $bonusCard.closest('.js-ore-tourist--bonus-cards');\n    $bonusCard.remove();\n\n    if ($cardsList.children('.js-ore-tourist--bonus-card').length === 0) {\n      $cardsList.html(Mustache.render(this.mds.tpl.touristFormNoBonusCards, {}));\n    }\n  };\n\n  /**\n  * Инициализация дополнительных полей туриста \n  * @param {TouristStorage} Tourist - данные туриста\n  */\n  modView.prototype.initCustomFields = function(Tourist) {\n    if (Tourist.customFields === null || Tourist.customFields.length === 0) {\n      return;\n    }\n\n    var CustomFieldsFactory = new crate.CustomFieldsFactory(this.mds.tpl);\n    var touristId = Tourist.touristId;\n\n    // хак - поля типа textArea отсортировать в конец для нормального отображения\n    Tourist.customFields.sort(function(a,b) {\n      var typeSorting = (a.typeTemplate === 2) ?\n        ((b.typeTemplate === 2) ? 0 : 1) :\n        ((b.typeTemplate === 2) ? -1 : 0);\n      \n      if (typeSorting !== 0) {\n        return typeSorting;\n      } else {\n        return (a.require) ?\n          (b.require ? 0 : -1) :\n          (b.require ? 1 : 0);\n      }\n    });\n\n    var self = this;\n    self.customFields[touristId] = [];\n\n    Tourist.customFields.forEach(function(fieldData) {\n      var customField = CustomFieldsFactory.create(fieldData);\n      if (customField !== null) {\n        self.customFields[touristId].push(customField);\n      }\n    });\n\n    var $customFields = $();\n\n    self.customFields[touristId].forEach(function(customField) {\n      $customFields = $customFields.add(customField.render());\n    });\n\n    this.touristForms[touristId].find('.js-ore-tourist-custom-fields').html($customFields);\n\n    self.customFields[touristId].forEach(function(customField) {\n      customField.initialize();\n    });\n  };\n\n  /**\n  * Блокировка формы туриста в процессе получения данных пользователя\n  * @param {Object} $touristForm - объект формы туриста\n  * @param {Function} callback - хак для красивости интерфейса\n  * @todo некрасиво, подумать над вариантами\n  */\n  modView.prototype.lockClientSelect = function($touristForm, callback) {\n    var $dataForm = $touristForm.find('.js-ore-tourist--form-wrapper');\n    $touristForm.addClass('is-locked').removeClass('active');\n    \n    var $clientSuggest = $touristForm.find('.js-ore-tourist--suggest');\n    if ($clientSuggest.length !== 0) { \n      $clientSuggest[0].selectize.disable();\n    }\n\n    $dataForm.css({'display':'block'}).slideUp(500, function() {\n      $touristForm.find('.js-ore-tourist--header-lock').css({'display': 'block'});\n      if (typeof callback === 'function') { callback(); }\n    });\n  };\n\n  /**\n  * Разблокировка формы туриста в процессе получения данных пользователя\n  * @param {Object} $touristForm - объект формы туриста\n  */\n  modView.prototype.unlockClientSelect = function($touristForm) {\n    var $dataForm = $touristForm.find('.js-ore-tourist--form-wrapper');\n    $touristForm.removeClass('is-locked').addClass('active');\n\n    var $clientSuggest = $touristForm.find('.js-ore-tourist--suggest');\n    if ($clientSuggest.length !== 0) { \n      $clientSuggest[0].selectize.enable();\n    }\n\n    $dataForm.css({'display':'none'}).slideDown(500);\n  };\n\n  /**\n  * Сбор и валидация данных по туристу из формы\n  * @param {Object} $form - форма туриста\n  * @return {Object|false} - данные туриста или false в случае ошибки\n  * @todo fix hack with dynamic serialnum\n  */\n  modView.prototype.getTouristFormData = function($form) {  \n    var $phoneblock = $form.find('.js-ore-tourist--phone-input');\n    var $c = {\n      'sex': $form.find('input[name=\"sex\"]'),\n      'firstName': $form.find('input[name=\"firstname\"]').livetrim(),\n      'lastName': $form.find('input[name=\"lastname\"]').livetrim(),\n      'middleName': $form.find('input[name=\"middlename\"]').livetrim(),\n      'birthdate': $form.find('input[name=\"birthdate\"]'),\n      'email': $form.find('input[name=\"email\"]').livetrim(),\n      'phone': {\n        'countryPrefix': $phoneblock.find('input[name=\"country-prefix\"]'),\n        'cityPrefix': $phoneblock.find('input[name=\"city-prefix\"]'),\n        'number': $phoneblock.find('input[name=\"phone\"]')\n      },\n      'document': {\n        'type': $form.find('select[name=\"doctype\"]'),\n        'firstName': $form.find('input[name=\"docfirstname\"]').livetrim().livecapitalize(),\n        'lastName': $form.find('input[name=\"doclastname\"]').livetrim().livecapitalize(),\n        'middleName': $form.find('input[name=\"docmiddlename\"]').livetrim().livecapitalize(),\n        'serial': $form.find('input[name=\"docseries\"]').livetrim(),\n        'number': $form.find('input[name=\"docnumber\"]').livetrim(),\n        'citizenship': $form.find('select[name=\"citizenship\"]'),\n        'expiryDate': $form.find('input[name=\"docenddate\"]')\n      },\n      'bonusCards': $form.find('.js-ore-tourist--bonus-card')\n    };\n\n    // валидация email\n    function vemail(v) {\n      if (v !== '' && (/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\\.[A-Z0-9.-]+$/ig).test(v)) { return true; } \n      else { return false; }\n    }\n    // валидация имени/фамилии туриста\n    function vname(v) {\n      if (v !== '' && (/^[^0-9\\.,\\s\\t\\nъЪ]*$/g).test(v) && (/^([A-z-]+|[А-яёЁ-]+)$/g).test(v)) { return true; } \n      else { return false; }\n    }\n    // проверка на число\n    function digit(v) {\n      if (v !== '' && (/^[0-9]+$/g).test(v)) { return true; } \n      else { return false; }\n    }\n\n    var errorflag = {val: false};\n    var touristId = $form.data('touristid');\n    if (\n      String($form.data('touristid')).indexOf('tmp') === -1 &&\n      String($form.data('touristid')).indexOf('doc') === -1\n    ) { touristId = +touristId; }\n\n    var userId = $form.data('userid');\n\n    var formdata = {\n      'userId': (userId !== undefined && userId !== '') ? +userId : null,\n      'contractId': this.mds.OrderStorage.contractId,\n      'touristId': touristId,\n      'isTourLeader': ($form.data('leader') === 'true') ? true : false,\n      'sex': $c.sex.prop('checked') ? 1 : 0,\n      'firstName': validateControl($c.firstName, vname, errorflag, 'Введите имя'),\n      'lastName': validateControl($c.lastName, vname, errorflag, 'Введите фамилию'),\n      'middleName': $c.middleName.val(),\n      'birthdate': validateDate($c.birthdate, errorflag, 'YYYY-MM-DD'),\n      'email': validateControl($c.email, vemail, errorflag, 'Введите email'),\n      'phone': ($c.phone.number.val() === '') ? null :\n          (\n            '+' +\n            validateControl($c.phone.countryPrefix, digit, errorflag) + '(' +\n            validateControl($c.phone.cityPrefix, digit, errorflag) + ')' +\n            validateControl($c.phone.number, digit, errorflag)\n          ),\n      'bonusCards': []\n    };\n\n    var docType = parseInt($c.document.type.val());\n    var documentConfig = KT.config.touristDocuments[docType];\n\n    if (documentConfig !== undefined) {\n      var docTouristNameTest = documentConfig.getTouristNameFullValidation();\n      var docSerialTest = documentConfig.getDocumentSerialFullValidation();\n      var docNumberTest = documentConfig.getDocumentNumberFullValidation();\n      var documentId = $form.find('.js-ore-tourist--document').data('documentid');\n\n      formdata.document = {\n        'user_documentID': (documentId !== undefined && documentId !== '') ? +documentId : null,\n        'documentType': docType,\n        'firstName': validateControl($c.document.firstName, function (v) {\n              if (v !== '' && docTouristNameTest.test(v)) { return true; } \n              else { return false; }\n            }, errorflag, 'Введите имя'),\n        'lastName': validateControl($c.document.lastName, function (v) {\n              if (v !== '' && docTouristNameTest.test(v)) { return true; } \n              else { return false; }\n            }, errorflag, 'Введите фамилию'),\n        'middleName': $c.document.middleName.val(),\n        'serialNumber': ($c.document.serial.val() === '') ? null :\n            String(validateControl($c.document.serial, function (v) {\n              if (docSerialTest.test(v)) { return true; } else { return false; }\n            },errorflag)).toUpperCase(),\n        'number': ($c.document.number.val() === '') ? null :\n            String(validateControl($c.document.number, function (v) {\n              if (docNumberTest.test(v)) { return true; } else { return false; }\n            },errorflag)).toUpperCase(),\n        'expiryDate': (!documentConfig.hasExpiryDate ||\n              ($c.document.number.val() === '' && $c.document.serial.val() === '')\n            ) ? null : \n            validateDate($c.document.expiryDate, errorflag, 'YYYY-MM-DD'),\n        'citizenship': ($c.document.citizenship.val() !== '') ? \n            $c.document.citizenship[0].selectize.getValue() : \n            (function($c, errorflag) {\n                errorflag.val = true;\n                $c.document.citizenship[0].selectize.$control\n                  .addClass('error')\n                  .one('click',function() { $(this).removeClass('error'); });\n                return false;\n            }($c, errorflag))\n      };\n    } else {\n      formdata.document = {};\n      errorflag.val = true;\n      $c.document.type[0].selectize.$control.addClass('error');\n      $c.document.type[0].selectize.$control_input.one('focus', function() {\n        $c.document.type[0].selectize.$control.removeClass('error');\n      });\n      makeInvalid($c.document.firstName);\n      makeInvalid($c.document.lastName);\n      makeInvalid($c.document.serial);\n      makeInvalid($c.document.number);\n      console.error('Не определены правила валидации для документа: ' + $form.find('select[name=\"doctype\"]').val());\n    }\n\n    /** Доп. правила валидации ФИО туриста */\n    if ([\n          formdata.document['firstName'],\n          formdata.document['middleName'],\n          formdata.document['lastName']\n        ].join('').length > 55\n    ) {\n      errorflag.val = true;\n      makeInvalid($c.document.firstName);\n      makeInvalid($c.document.lastName);\n      makeInvalid($c.document.middleName);\n    }\n\n    if (\n      formdata.document['firstName'] === null ||\n      (/[ьЬ]/).test(String(formdata.document['firstName']).charAt(0))\n    ) {\n      errorflag.val = true;\n      makeInvalid($c.document.firstName);\n    }\n\n    if (\n      formdata.document['lastName'] === null ||\n      (/[ьЬ]/).test(String(formdata.document['lastName']).charAt(0))\n    ) {\n      errorflag.val = true;\n      makeInvalid($c.document.lastName);\n    }\n\n    if (\n      formdata.document['middleName'] !== '' &&\n      (/[ьЬ]/).test(String(formdata.document['middleName']).charAt(0))\n    ) {\n      errorflag.val = true;\n      makeInvalid($c.document.middleName);\n    }\n\n    // бонусные карты\n    if ($c.bonusCards.length !== 0) {\n      $c.bonusCards.each(function() {\n        var $programId = $(this).find('.js-ore-tourist--bonus-card-program');\n        if ($programId.val() !== '') {\n          var $cardNumber = $(this).find('.js-ore-tourist--bonus-card-number');\n          if ($cardNumber.val() === '') {\n            errorflag.val = true;\n            $cardNumber\n              .addClass('error')\n              .one('focus', function() {\n                $cardNumber.removeClass('error');\n              });\n          } else {\n            var cardId = $(this).data('cardid');\n\n            formdata.bonusCards.push({\n              'id': (cardId !== undefined) ? cardId : null,\n              'bonuscardNumber': $cardNumber.val(),\n              'aviaLoyaltyProgramId': $programId.val()\n            });\n          }\n        }\n      });\n    }\n\n    // дополнительные поля\n    if (Array.isArray(this.customFields[touristId])) {\n      formdata.userAdditionalFields = [];\n\n      this.customFields[touristId].forEach(function(field) {\n        var fieldValue = field.getValue();\n        if (field.modifiable && field.validate(fieldValue)) {\n          formdata.userAdditionalFields.push({\n            'fieldTypeId': field.fieldTypeId,\n            'value': (fieldValue !== '') ? fieldValue : null,\n          });\n        } else { errorflag.val = true; }\n      });\n    }\n\n    return (errorflag.val) ? false : formdata;\n  };\n\n  /**\n  * Сбор и валидация данных из формы для создания пользователя\n  * @param {Object} $form - форма туриста\n  * @return {Object|false} - данные туриста или false в случае ошибки\n  */\n  modView.prototype.getUserFormData = function($form) {\n    var _instance = this;\n\n    var formdata = this.getTouristFormData($form);\n    if (formdata === false) { return false; }\n\n    var userData = {\n      'user': {\n        'userId': formdata.userId,\n        'clientId': _instance.mds.OrderStorage.client.id,\n        'sex': formdata.sex,\n        'firstName': formdata.firstName,\n        'middleName': formdata.middleName,\n        'lastName': formdata.lastName,\n        'birthdate': formdata.birthdate,\n        'citizenshipId': null, /** @deprecated */\n        'сontactPhone': formdata.phone,\n        'email': formdata.email,\n        'bonusCards': Array.isArray(formdata.bonusCards) ?\n          formdata.bonusCards.map(function(item) {\n            delete item.id;\n            return item;\n          }) : formdata.bonusCards\n      },\n      'document': {\n        'userDocId': formdata.document.user_documentID,\n        'docType': formdata.document.documentType,\n        'firstName': formdata.document.firstName,\n        'middleName': formdata.document.middleName,\n        'lastName': formdata.document.lastName,\n        'docSerial': formdata.document.serialNumber,\n        'docNumber': formdata.document.number,\n        'docExpiryDate': formdata.document.expiryDate,\n        'citizenship': formdata.document.citizenship,\n      }\n    };\n\n    return userData;\n  };\n\n  /**\n  * Контроль ввода серии и номера документа на лету\n  * @param {Object} $form - (jQuery DOM) форма туриста\n  * @todo parse rules should be here?\n  */\n  modView.prototype.livecheckDocument = function($form) {\n    var docType = parseInt( $form.find('select[name=\"doctype\"]').val() );\n    var $fioFields = $form.find('input').filter('[name=\"docfirstname\"],[name=\"docmiddlename\"],[name=\"doclastname\"]');\n    var $series = $form.find('input[name=\"docseries\"]');\n    var $number = $form.find('input[name=\"docnumber\"]');\n    var $expiryDate = $form.find('input[name=\"docenddate\"]');\n\n    var documentConfig = KT.config.touristDocuments[docType];\n\n    if (documentConfig !== undefined) {\n      if (documentConfig.hasExpiryDate) {\n        $expiryDate.prop('disabled', false).trigger('change');\n\n        if (documentConfig.lifetime !== undefined) {\n          var calendar = $expiryDate.data('plugin_clndrize').config.clndr;\n          calendar.constraints.endDate = moment().add(documentConfig.lifetime).format('YYYY-MM-DD');\n        }\n      } else {\n        $expiryDate.prop('disabled', true).val('').trigger('change');\n      }\n\n      $expiryDate.closest('.clndr-datepicker-wrap').removeClass('error');\n\n      $fioFields\n        .off('.livecheck')\n        .removeClass('error')\n        .on('keypress.livecheck',function(e) {\n          var char = String.fromCharCode(e.which);\n          var check = documentConfig.touristNameValidation[0];\n          if (!check.test(char)) {\n            return false;\n          }\n        });\n\n      $series\n        .off('.livecheck')\n        .removeClass('error')\n        .on('keypress.livecheck',function(e) {\n          var char = String.fromCharCode(e.which);\n          var check = documentConfig.numberValidation[0];\n          if (!check.test(char)) {\n            return false;\n          }\n        })\n        .attr('maxlength', documentConfig.numberValidation[2].replace(/[{}]/g, '').split(',').pop());\n\n      $number\n        .off('.livecheck')\n        .removeClass('error')\n        .on('keypress.livecheck',function(e) {\n          var char = String.fromCharCode(e.which);\n          var check = documentConfig.numberValidation[1];\n          if (!check.test(char)) {\n            return false;\n          }\n        })\n        .attr('maxlength',documentConfig.numberValidation[3].replace(/[{}]/g, '').split(',').pop());\n    }\n  };\n\n  /** Убрать возможность установки заказчика */\n  modView.prototype.removeTLSetter = function() {\n    this.$touristList.find('.js-ore-tourist--tourleader-block').remove();\n    return this;\n  };\n\n  /** Сместить заказчика наверх списка туристов */\n  modView.prototype.rearrange = function() {\n    this.$touristList.find('.js-ore-tourist').filter('[data-leader=\"true\"]').detach().prependTo(this.$touristList);\n    return this;\n  };\n\n  /**\n  * Маппинг данных туриста для вывода формы\n  * @param {TouristStorage} tourist - Данные туриста\n  * @param {Boolean} isTourleaderSet - Установлен ли турлидер в заявке\n  * @param {Boolean} isOffline - оффлайновая ли заявка\n  */\n  modView.prototype.mapTouristInfo = function(Tourist, isTourleaderSet, isOffline) {\n    var _instance = this;\n    if (isOffline !== true) { isOffline = false; }\n\n    var touristInfo = {\n      'isEditable': !isOffline,\n      'touristId': Tourist.touristId,\n      'userId': (Tourist.userId !== undefined) ? Tourist.userId : null,\n      'isTourleader': Tourist.isTourleader,\n      'firstname': Tourist.firstname,\n      'lastname': Tourist.lastname,\n      'middlename': (Tourist.middlename !== null) ? Tourist.middlename : '',\n      'email': (Tourist.email !== null) ? Tourist.email : '',\n      'phoneCountryCode': (Tourist.phone.countryCode !== null) ?\n        Tourist.phone.countryCode : '',\n      'phoneCityCode': (Tourist.phone.cityCode !== null) ?\n        Tourist.phone.cityCode : '',\n      'phoneNumber': (Tourist.phone.number !== null) ?\n        Tourist.phone.number : '',\n      'phone': (Tourist.phone.countryCode !== null) ?\n        (Tourist.phone.countryCode + '(' + Tourist.phone.cityCode + ')' + Tourist.phone.number) :\n        Tourist.phone.number,\n      'isTourleaderSet': isTourleaderSet,\n      'isMale': (Tourist.sex === 'male') ? true : false,\n      'birthdate': (Tourist.birthdate !== null) ? Tourist.birthdate.format('DD.MM.YYYY') : '',\n      'document': {\n        'documentId': (Tourist.document.documentId !== undefined) ? \n          Tourist.document.documentId : null,\n        'type': Tourist.document.type,\n        'series': Tourist.document.series,\n        'number': Tourist.document.number,\n        'firstname': Tourist.document.firstname,\n        'lastname': Tourist.document.lastname,\n        'middlename': (Tourist.document.middlename !== null) ?\n          Tourist.document.middlename : '',\n        'citizenship': Tourist.document.citizenship,\n        //'issueDate': tourist.document.issueDate.format('DD.MM.YYYY'),\n        'expiryDate': (Tourist.document.expiryDate !== null) ? \n          Tourist.document.expiryDate.format('DD.MM.YYYY') : ''\n      },\n      'bonusCards': (Tourist.bonusCards.length === 0) ? \n        Mustache.render(_instance.mds.tpl.touristFormNoBonusCards, {}) :\n        Tourist.bonusCards.map(function(card) {\n          return Mustache.render(_instance.mds.tpl.touristFormBonusCard, card);\n        }).join(''),\n      'bonusCardsActions': Mustache.render(_instance.mds.tpl.touristFormBonusCardActions, {\n          'add': true\n        }),\n      'hasCustomFields': (Tourist.customFields !== null && Tourist.customFields.length > 0)\n    };\n\n    return touristInfo;\n  };\n\n  /**\n  * Скопировать значения полей ФИО из данных туриста в документ\n  * @param {Object} $el - (jQuery DOM) кнопка формы\n  */\n  modView.prototype.copyNamesToDoc = function($el) {\n    var $form = $el.closest('.js-ore-tourist');\n    $form.find('input[name=\"doclastname\"]')\n      .removeClass('error')\n      .val( transliterate($form.find('input[name=\"lastname\"]').val()) );\n    $form.find('input[name=\"docfirstname\"]')\n      .removeClass('error')\n      .val( transliterate($form.find('input[name=\"firstname\"]').val()) );\n    $form.find('input[name=\"docmiddlename\"]')\n      .removeClass('error')\n      .val( transliterate($form.find('input[name=\"middlename\"]').val()) );\n  };\n\n  /** \n  * Вывод модального окна отмены добавления туриста \n  * @param {Function} submitAction - действие при подтверждении\n  */\n  modView.prototype.showRevertAddTouristModal = function(submitAction) {\n    KT.Modal.notify({\n      type: 'warning',\n      title: 'Удаление туриста из заявки',\n      msg: '<p>Вы действительно хотите отменить добавление туриста?</p>',\n      buttons:[{\n          type: 'warning',\n          title: 'нет'\n        },\n        {\n          type: 'error',\n          title: 'да',\n          callback: submitAction\n      }]\n    });\n  };\n\n  /** \n  * Вывод модального окна удаления туриста \n  * @param {Function} submitAction - действие при подтверждении\n  */\n  modView.prototype.showRemoveTouristModal = function(submitAction) {\n    KT.Modal.notify({\n      type: 'warning',\n      title: 'Удаление туриста из заявки',\n      msg: '<p>Вы действительно хотите удалить туриста из заявки?</p>',\n      buttons:[{\n          type: 'warning',\n          title: 'нет'\n        },\n        {\n          type: 'error',\n          title: 'да',\n          callback: submitAction\n      }]\n    });\n  };\n\n  /**\n  * Отобразить ошибку значения в поле\n  * @param {Object} $el - [jQuery DOM] поле формы\n  * @param {String} [msg] - текст для плейсхолдера контрола\n  */\n  function makeInvalid($el, msg) {\n    if (msg === undefined || msg === null) { msg = ''; }\n    $el\n      .addClass('error')\n      .attr('data-pl', $el.attr('placeholder'))\n      .attr('placeholder', msg)\n      .one('focus', function() {\n        $(this)\n          .removeClass('error')\n          .attr('placeholder', $(this).attr('data-pl'))\n          .removeAttr('data-pl');\n      });\n  }\n\n  /**\n  * Проверка значений форм\n  * @param {Object} $el - (jQuery DOM) элемент для проверки\n  * @param {Function} rule - функция проверки значения, принимает значение и возвращает true/false\n  * @param {Object} flag - объект флага для сохранения состояния ошибки\n  * @param {String} [msg] - текст для плейсхолдера контрола\n  * @return {*|Boolean} - возращает значение элемента или false в случае непрошедшей валидации\n  */\n  function validateControl($el, rule, flag, msg) {\n    var cv = $el.val();\n    if (msg === undefined || msg === null) { msg = ''; }\n\n    if (rule(cv)) {\n      return cv;\n    } else {\n      makeInvalid($el, msg);\n      flag.val = true;\n      return null;\n    }\n  }\n\n  /**\n  * Проверка даты в контролах Clndrize\n  * @param {Object} $el - (jQuery DOM) элемент для проверки (input)\n  * @param {Object} flag - объект флага для сохранения состояния ошибки\n  * @param {String} frmt - формат возвращаемой даты\n  * @return {*|Boolean} - возращает дату в заданном формате или false в случае непрошедшей валидации\n  */\n  function validateDate($el,flag, frmt) {\n    var cv = $el.val();\n\n    if (cv !== '' && (/^\\d{2}\\.\\d{2}\\.\\d{4}$/ig).test(cv)) {\n      var constraints = $el.data('plugin_clndrize').config.clndr.constraints;\n      var cvdate = moment(cv,'DD.MM.YYYY');\n      if (\n        cvdate >= moment(constraints.startDate,'YYYY-MM-DD') &&\n        cvdate <= moment(constraints.endDate,'YYYY-MM-DD')\n      ) {\n        $el.attr('title','');\n        return moment(cv,'DD.MM.YYYY').format(frmt);\n      } else {\n        $el.attr('title','Введенная дата выходит за допустимые границы');\n      }\n    }\n\n    $el\n      .closest('.clndr-datepicker-wrap')\n        .addClass('error')\n      .end()\n      .one('focus click',function() {\n        $(this).closest('.clndr-datepicker-wrap').removeClass('error');\n      });\n\n    flag.val = true;\n    return null;\n  }\n\n  /**\n  * Инициализация элемента выбора программы лояльности\n  * @param {Object} $control - элемент выбора \n  * @param {Object} [params] - дополнительные параметры\n  */\n  function initLoyalityProgramSelect($control, params) {\n    var controlOptions = {\n      plugins: {'jirafize':{}},\n      openOnFocus: true,\n      create: false,\n      options: [],\n      selectOnTab: true,\n      valueField: 'programId',\n      searchField: ['IATAcode','loyalityProgramName', 'aircompanyName'],\n      render: {\n        item: function(item) {\n          return '<div class=\"item\" ' +\n            'data-tooltip=\"авиакомпания: ' + item.aircompanyName + '<br>' +\n            ' альянс: ' + item.allianceName + '\">' + \n            '<b>[' + item.IATAcode + ']</b> ' + item.loyalityProgramName + \n            '</div>';\n        },\n        option: function(item) {\n          return '<div class=\"option\" ' +\n            'data-tooltip=\"авиакомпания: ' + item.aircompanyName + '<br>' +\n            ' альянс: ' + item.allianceName + '\">' + \n            '<b>[' + item.IATAcode + ']</b> ' + item.loyalityProgramName + \n            '</div>';\n        }\n      }\n    };\n\n    if (typeof params === 'object') {\n      $.extend(controlOptions, params);\n    }\n\n    $control.selectize(controlOptions);\n  }\n\n  return modView;\n}));\n","(function(global,factory) {\n\n    KT.crates.OrderEdit.tourists.controller = factory(KT.crates.OrderEdit.tourists);\n\n}(this,function(crate) {\n  /**\n  * Редактирование заявки: туристы\n  * submodule\n  * @constructor\n  * @param {Object} module - хранилище модуля (родительского)\n  * @param {Object} orderId - ID заявки\n  */\n  var oetController = function(module, orderId) {\n    this.mds = module;\n    this.orderId = orderId;\n    this.mds.tourists.view = new crate.view(this.mds);\n  };\n\n  oetController.prototype.init = function() {\n    var _instance = this;\n    var modView = this.mds.tourists.view;\n\n    /** ID сервиса, из которого вызвано добавление туриста; при перезагрузке неактуально */\n    window.sessionStorage.removeItem('serviceToAddTourist');\n\n    /**\n    * Запрос на добавление туриста к заявке\n    * @todo rethink mechanism\n    */\n    KT.on('OrderEdit.createAddTouristForm', function() {\n      modView.addTouristForm(_instance.mds.OrderStorage);\n    });\n\n    /*==========Обработчики событий модели============================*/\n    /** Рендер пустого списка если в заявке нет услуг */\n    KT.on('OrderStorage.initialized', function(e, OrderStorage) {\n      if (OrderStorage.orderId === 'new') {\n        modView.$touristList.empty();\n        modView.addTouristForm(_instance.mds.OrderStorage);\n      }\n    });\n\n    /** Обработка обновления информации по туристам в заявке */\n    KT.on('OrderStorage.setTourists', function(e, OrderStorage) {\n      modView.renderTouristList(OrderStorage);\n    });\n\n    /** Добавление/обновление туриста */\n    KT.on('OrderStorage.savedTourist', function(e, data) {\n      var touristId = data.touristId;\n      var Tourist = _instance.mds.OrderStorage.tourists[touristId];\n      var isOffline = _instance.mds.OrderStorage.isOffline;\n      modView.refreshTouristForm(Tourist, isOffline);\n\n      if (_instance.mds.OrderStorage.touleader !== null) {\n        modView.removeTLSetter().rearrange();\n      }\n\n      KT.dispatch('OrderEdit.reloadHeader');\n    });\n\n    /*==========Обработчики событий представления============================*/\n\n    /** Обработка выбора сотрудника в саджесте */\n    modView.$touristList.on('change', '.js-ore-tourist--suggest', function() {\n      var documentId = $(this).val();\n      if (documentId !== '') {\n        var userId = $(this)[0].selectize.options[+documentId].userId;\n        var tempTouristId = $(this).closest('.js-ore-tourist').attr('data-touristid');\n        var $touristForm = modView.touristForms[tempTouristId];\n\n        modView.lockClientSelect($touristForm, function() {\n          KT.apiClient.getClientUser(documentId)\n            .done(function(response) {\n              if (response.status === 0) {\n                var documentId = response.body.document.docId;\n                var newTouristId = 'doc' + documentId;\n                var Tourist = new KT.storage.TouristStorage(newTouristId);\n        \n                $touristForm.attr('data-touristid', newTouristId);\n                $touristForm.data('userid', userId);\n\n                modView.touristForms[newTouristId] = modView.touristForms[tempTouristId];\n                delete modView.touristForms[tempTouristId];\n\n                Tourist.initializeFromUser(response.body);\n                modView.refreshTouristForm(Tourist, false);\n              }\n            });\n        });\n      }\n    });\n\n    /** Скрыть/показать подробную информацию по туристу */\n    modView.$touristList.on('click','.js-ore-tourist--header',function(e) {\n      var $touristForm = $(this).closest('.js-ore-tourist');\n\n      if (!$touristForm.hasClass('is-locked')) {\n        var $dataForm = $touristForm.find('.js-ore-tourist--form-wrapper');\n\n        if ($(e.target).closest('.js-ore-tourist--suggest-field', $touristForm).length === 0) {\n          if ($touristForm.hasClass('active')) {\n            $touristForm.removeClass('active');\n            $dataForm.css({'display':'block'}).slideUp(500);\n          } else {\n            $touristForm.addClass('active');\n            $dataForm.css({'display':'none'}).slideDown(500);\n          }\n        }\n      }\n    });\n\n    /** Обработка нажатия на кнопку \"Удалить туриста\" */\n    modView.$touristList.on('click','.js-ore-tourist--remove',function(e) {\n      e.stopPropagation();\n\n      var $touristForm = $(this).closest('.js-ore-tourist');\n      var touristId = $touristForm.data('touristid');\n\n      if (String(touristId).indexOf('tmp') === 0 || String(touristId).indexOf('doc') === 0) {\n        // отмена добавления туриста\n        modView.showRevertAddTouristModal(function() {\n          KT.Modal.closeModal();\n          $touristForm.remove();\n          window.sessionStorage.removeItem('serviceToAddTourist');\n        });\n\n      } else {\n        // удаление туриста\n        modView.showRemoveTouristModal(function() {\n          KT.Modal.showLoader();\n          modView.renderPendingProcess($touristForm);\n\n          touristId = +touristId;\n\n          KT.apiClient.removeOrderTourist(_instance.orderId, touristId)\n            .done(function(response) {\n              KT.Modal.closeModal();\n              if (response.status === 0) {\n                var tourist = _instance.mds.OrderStorage.tourists[touristId];\n\n                _instance.mds.OrderStorage.removeTourist(touristId);\n                modView.removeTouristForm(touristId);\n\n                KT.dispatch('OrderEdit.reloadHeader');\n                KT.notify('touristRemoved',{name: tourist.firstname + ' ' + tourist.lastname});\n              } else {\n                modView.refreshTouristFormActions($touristForm,  _instance.mds.OrderStorage.isOffline);\n                KT.notify('removingTouristFailed', response.errors);\n              }\n            });\n        });\n      }\n    });\n\n    /** Обработка нажатия кнопки отмены ввода данных формы туриста\n    * @todo для свежесозданного туриста надо полностью очищать форму\n    */\n    modView.$touristList.on('click','.js-ore-tourist--reset',function() {\n      var $touristForm = $(this).closest('.js-ore-tourist');\n      var touristId = $touristForm.data('touristid');\n\n      if (String(touristId).indexOf('tmp') !== -1) {\n          modView.removeTouristForm(touristId);\n\n      } else if (String(touristId).indexOf('doc') !== -1) {\n        var documentId = +touristId.substr(3);\n        modView.renderPendingProcess($touristForm);\n\n        KT.apiClient.getClientUser(documentId)\n          .done(function(response) {\n            if (response.status === 0) {\n              var Tourist = new KT.storage.TouristStorage(touristId);\n              Tourist.initializeFromUser(response.body);\n              modView.refreshTouristForm(Tourist, false);\n            }\n          });\n\n      } else {\n        touristId = +touristId;\n        var Tourist = _instance.mds.OrderStorage.tourists[touristId];\n        var isOffline = _instance.mds.OrderStorage.isOffline;\n        modView.refreshTouristForm(Tourist, isOffline);\n      }\n    });\n\n    /** Обработка подтверждения формы данных туриста */\n    modView.$touristList.on('submit','.js-ore-tourist',function(e) {\n      e.preventDefault();\n      var $touristForm = $(this);\n      var formdata = modView.getTouristFormData($touristForm);\n\n      if (formdata !== false && typeof formdata === 'object') {\n        modView.renderPendingProcess($touristForm);\n\n        var currentTouristId = formdata.touristId;\n        var newTouristId;\n\n        KT.apiClient.setOrderTourist(_instance.mds.OrderStorage, formdata)\n          .then(function(response) {\n            if (response.status === 0) {\n              /* если заявка создана через туриста */\n              if (_instance.mds.OrderStorage.orderId === 'new') {\n                window.sessionStorage.removeItem('clientId');\n                window.sessionStorage.removeItem('contractId');\n                window.location.assign('/cabinetUI/orders/order/' + response.body.orderId);\n              } else {\n                newTouristId = response.body.touristId;\n                _instance.updateTouristForm(currentTouristId, newTouristId);\n              }\n\n            } else {\n              if (_instance.mds.OrderStorage.tourleader === null) {\n                $touristForm.removeAttr('data-leader')\n                  .find('.js-ore-tourist--tourleader-toggler')\n                    .prop('checked',false).change();\n              }\n              modView.refreshTouristFormActions($touristForm, _instance.mds.OrderStorage.isOffline);\n              KT.notify('saveTouristFailed', response.errors);\n            }\n          });\n      } else {\n        KT.notify('incorrectTouristData');\n      }\n    });\n\n    /** Обработка нажатия на кнопку \"Сохранить как сотрудника\" */\n    modView.$touristList.on('click', '.js-ore-tourist--save-user', function() {\n      var $touristForm = $(this).closest('.js-ore-tourist');\n      var tempTouristId = $touristForm.data('touristid');\n      var touristData = modView.getTouristFormData($touristForm);\n      var userData = modView.getUserFormData($touristForm);\n\n      if (touristData !== false && userData !== false) {\n        userData.user.clientId = _instance.mds.OrderStorage.client.id;\n        var currentTouristId = touristData.touristId;\n        var newTouristId;\n\n        modView.renderPendingProcess($touristForm);\n\n        var savingTourist = KT.apiClient.setOrderTourist(_instance.mds.OrderStorage, touristData);\n        var savingUser = KT.apiClient.setUser(userData, tempTouristId);\n\n        $.when(savingTourist, savingUser)\n          .then(function(touristResponse, userResponse) {\n            if (touristResponse.status === 0) {\n              /* если заявка создана через туриста */\n              if (_instance.mds.OrderStorage.orderId === 'new') {\n                window.sessionStorage.removeItem('clientId');\n                window.sessionStorage.removeItem('contractId');\n                window.location.assign('/cabinetUI/orders/order/' + touristResponse.body.orderId);\n              } else {\n                newTouristId = touristResponse.body.touristId;\n                _instance.updateTouristForm(currentTouristId, newTouristId);\n\n                if (userResponse.status === 0) {\n                  KT.notify('userSaved');\n                } else {\n                  KT.notify('savingUserFailed', userResponse.errors);\n                }\n              }\n            } else {\n              // обработка ошибкуи сохранения туриста\n              if (_instance.mds.OrderStorage.tourleader === null) {\n                $touristForm.removeAttr('data-leader')\n                  .find('.js-ore-tourist--tourleader-toggler')\n                    .prop('checked',false).change();\n              }\n              modView.refreshTouristFormActions($touristForm, _instance.mds.OrderStorage.isOffline);\n              KT.notify('saveTouristFailed', touristResponse.errors);\n\n              // обработка результата сохранения сотрудника\n              if (userResponse.status === 0) {\n                // несохраненные туристы имеют Id со строковым префиксом\n                var isExistingTourist = !isNaN(parseInt(tempTouristId));\n\n                if (!isExistingTourist) {\n                  var documentId = userResponse.body.userDocId;\n                  var userId = userResponse.body.userId;\n                  newTouristId = 'doc' + documentId;\n\n                  if (newTouristId !== tempTouristId) {\n                    $touristForm.attr('data-touristid', newTouristId);\n                    $touristForm.attr('data-userid', userId);\n                    $touristForm.data('userid', userId);\n\n                    modView.touristForms[newTouristId] = modView.touristForms[tempTouristId];\n                    delete modView.touristForms[tempTouristId];\n                  }\n\n                  modView.lockClientSelect($touristForm, function() {\n                    KT.apiClient.getClientUser(documentId)\n                      .done(function(response) {\n                        if (response.status === 0) {\n                          var Tourist = new KT.storage.TouristStorage(newTouristId);\n                          Tourist.initializeFromUser(response.body);\n                          modView.refreshTouristForm(Tourist, false);\n                        }\n                      });\n                  });\n                }\n                KT.notify('userSaved');\n              } else {\n                KT.notify('savingUserFailed', userResponse.errors);\n              }\n            }\n          });\n      } else {\n        console.error('Ошибка ввода данных туриста');\n      }\n    });\n\n    /** Обработка изменения переключателя \"Заказчик\" */\n    modView.$touristList.on('change','.js-ore-tourist--tourleader-toggler',function() {\n      var $leaderToggler = $(this);\n      var $touristForm = $leaderToggler.closest('.js-ore-tourist');\n\n      var declineAction = function() {\n        $leaderToggler.prop('checked',false).change();\n        KT.Modal.closeModal();\n      };\n\n      var submitAction = function() {\n        KT.Modal.closeModal();\n        $touristForm.attr('data-leader','true');\n        $touristForm.submit();\n      };\n\n      if ($leaderToggler.prop('checked')) {\n        KT.Modal.notify({\n          type:'info',\n          title:'Определить заказчика',\n          msg:'<p>Вы действительно хотите сделать этого туриста заказчиком?</p>',\n          buttons:[{\n              type:'common',\n              title:'нет',\n              callback:declineAction\n            },\n            {\n              type:'success',\n              title:'да',\n              callback:submitAction\n          }]\n        });\n      } else {\n        $leaderToggler.closest('.simpletoggler').removeClass('active');\n        $touristForm.removeAttr('data-leader');\n      }\n    });\n\n    /** Обработка изменения типа документа */\n    modView.$touristList.on('change','select[name=\"doctype\"]',function() {\n      modView.livecheckDocument($(this).closest('.js-ore-tourist'));\n    });\n\n    /** Добавление новой формы ввода мильной карты */\n    modView.$touristList.on('click', '.js-ore-tourist--bonus-card-add', function() {\n      modView.addBonusCardForm($(this).closest('.js-ore-tourist'));\n    });\n\n    /** Удаление формы ввода мильной карты */\n    modView.$touristList.on('click', '.js-ore-tourist--bonus-card-delete', function() {\n      modView.removeBonusCardForm($(this).closest('.js-ore-tourist--bonus-card'));\n    });\n\n    /** Изменение тогглера\n    * @todo move to library\n    */\n    modView.$touristList.on('change','.simpletoggler input',function() {\n      if ($(this).prop('checked')) {\n        $(this).closest('.simpletoggler').addClass('active');\n      } else {\n        $(this).closest('.simpletoggler').removeClass('active');\n      }\n    });\n\n    /** Обработка нажатия на кнопку \"скопировать из данных ФИО туриста\" */\n    modView.$touristList.on('click','.js-ore-tourist--copy-name',function() {\n      modView.copyNamesToDoc($(this));\n    });\n\n    /** @deprecated\n    * Обработка нажатия на переключатель \"виза\"\n    */\n    modView.$touristList.on('change','input[name=\"getvisa\"]',function() {\n      var text = $(this).prop('checked') ? 'Требуется' : 'Не требуется';\n      $(this).closest('.js-ore-tourist').find('.js-ore-tourist--require-visa').text(text);\n    });\n\n    /** @deprecated\n    * Обработка нажатия на переключатель \"страховка\"\n    */\n    modView.$touristList.on('change','input[name=\"getinsurance\"]',function() {\n      var text = $(this).prop('checked') ? 'Требуется' : 'Не требуется';\n      $(this).closest('.js-ore-tourist').find('.js-ore-tourist--require-insurance').text(text);\n    });\n\n    /** Обработка нажатия на кнопку \"Добавить туриста\" */\n    modView.$touristListControls.on('click','.js-ore-tourists--add-new',function() {\n      modView.addTouristForm(_instance.mds.OrderStorage);\n    });\n\n    \n  };\n\n  /** \n  * Обновление данных формы туриста \n  */\n  oetController.prototype.updateTouristForm = function(currentTouristId, newTouristId) {\n    var _instance = this;\n    var modView = _instance.mds.tourists.view;\n    var $touristForm = modView.touristForms[currentTouristId];\n\n    KT.apiClient.getOrderTourists(_instance.orderId)\n      .then(function(response) {\n        if (response.status !== 0) {\n          window.location.assign('/cabinetUI/orders/order/' + _instance.orderId);\n        } else {\n          var touristData = response.body.tourists.filter(function(item) {\n            return newTouristId === item.touristId;\n          })[0];\n\n          var Tourist = new KT.storage.TouristStorage(touristData.touristId);\n          Tourist.initialize(touristData);\n\n          if (newTouristId !== currentTouristId) {\n            // изменение данных формы туриста и сброс структур отображения\n            $touristForm\n              .attr('data-touristid', newTouristId)\n              .data('touristid', newTouristId);\n            modView.touristForms[newTouristId] = $touristForm;\n            delete modView.touristForms[currentTouristId];\n            delete modView.customFields[currentTouristId];\n\n            /*\n            * Проверка наличия у туриста доп. полей: \n            * если есть, не совершать переход к услуге\n            */\n            if (Tourist.customFields !== null) {\n              window.sessionStorage.removeItem('serviceToAddTourist');\n              KT.notify('customFieldsRevealed');\n            }\n          }\n\n          _instance.mds.OrderStorage.saveTourist(Tourist);\n\n          if (newTouristId === currentTouristId) {\n            KT.notify('touristUpdated', {name: [Tourist.firstname, Tourist.lastname].join(' ')});\n          } else {\n            KT.notify('touristAdded', {name: [Tourist.firstname, Tourist.lastname].join(' ')});\n          }\n        }\n      });\n  };\n\n  return oetController;\n}));\n","(function(global,factory){\n\n    KT.crates.OrderEdit.services.ServiceViewModel = factory(KT.crates.OrderEdit);\n\n}(this,function(crate) {\n\n  /**\n  * Базовый класс view-модели услуги\n  * @constructor\n  * @param {ServiceStorage} ServiceStorage - данные услуги\n  * @param {Object} templates - ссылка на коллекцию шаблонов модуля\n  */\n  \n  var ServiceViewModel = function(ServiceStorage, templates) {\n    this.ServiceStorage = ServiceStorage;\n    this.tpl = templates;\n    this.customFields = [];\n    \n    this.headerView = '';\n    this.mainView = '';\n    this.additionalServicesView = '';\n    this.minimalPriceView = '';\n    this.actionsView = '';\n  };\n\n  /** Механизм наследования */\n  ServiceViewModel.extend = function (cfunc) {\n    cfunc.prototype = Object.create(this.prototype);\n    cfunc.__super__ = this.prototype;\n    cfunc.constructor = cfunc;\n    return cfunc;\n  };\n\n  /** Подготовка шаблонов для вывода услуги */\n  ServiceViewModel.prototype.prepareViews = function() {\n    throw new Error('ServiceViewModel:prepareViews not implemented');\n  };\n\n  /** Подготовка шаблона шапки */\n  ServiceViewModel.prototype.prepareHeaderView = function() {\n    throw new Error('ServiceViewModel:prepareHeaderView not implemented');\n  };\n\n  /** Подготовка основного шаблона */\n  ServiceViewModel.prototype.prepareMainView = function() {\n    throw new Error('ServiceViewModel:prepareMainView not implemented');\n  };\n\n  /** Подготовка шаблона действий с услугой */\n  ServiceViewModel.prototype.prepareActionsView = function() {\n    throw new Error('ServiceViewModel:prepareActionsView not implemented');\n  };\n\n  /** \n  * Обработка дополнительных полей. \n  * Метод возвращает массив необработанных доп. полей, соответственно в дочернем классе\n  * можно определить собственную обработку для уникальных/специализированных доп. полей\n  * @return {Array|null} - массив доп. полей или null если доп. полей нет\n  */\n  ServiceViewModel.prototype.processCustomFields = function() {\n    var self = this;\n    var ServiceStorage = this.ServiceStorage;\n    var CustomFieldsFactory = new crate.CustomFieldsFactory(this.tpl);\n    \n    this.customFields = [];\n    var unprocessedFields = [];\n\n    if (Array.isArray(ServiceStorage.customFields)) {\n      // хак - поля типа textArea отсортировать в конец для нормального отображения\n      ServiceStorage.customFields.sort(function(a,b) {\n        var typeSorting = (a.typeTemplate === 2) ?\n          ((b.typeTemplate === 2) ? 0 : 1) :\n          ((b.typeTemplate === 2) ? -1 : 0);\n        \n        if (typeSorting !== 0) {\n          return typeSorting;\n        } else {\n          return (a.require) ?\n            (b.require ? 0 : -1) :\n            (b.require ? 1 : 0);\n        }\n      });\n\n      ServiceStorage.customFields.forEach(function(fieldData) {\n        var customField = CustomFieldsFactory.create(fieldData);\n        if (customField !== null) {\n          self.customFields.push(customField);\n        } else {\n          unprocessedFields.push(fieldData);\n        }\n      });\n\n      return unprocessedFields;\n    } else { return null; }\n  };\n\n  /** Инициализация элементов управления после рендера формы */\n  ServiceViewModel.prototype.initControls = function() {\n    throw new Error('ServiceViewModel:initControls not implemented');\n  };\n\n  /**\n  * Сбор значений дополнительных полей\n  * @return {Array|null} - массив значений доп. полей или null в случае ошибки\n  */\n  ServiceViewModel.prototype.getCustomFieldsValues = function() {\n    var ServiceStorage = this.ServiceStorage;\n    var customFieldsValues = [];\n    /* \n    * Флаг отсутствия ошибок при обработке полей. \n    * Флаг специально, чтобы отметить все ошибочные поля, а не первое папавшееся\n    */\n    var noErrors = true;\n\n    this.customFields.forEach(function(field) {\n      var fieldValue = field.getValue();\n      if (field.modifiable && field.validate(fieldValue)) {\n        customFieldsValues.push({\n          'fieldTypeId': field.fieldTypeId,\n          'value': (fieldValue !== '') ? fieldValue : null,\n          'serviceId': ServiceStorage.serviceId\n        });\n      } else { noErrors = false; }\n    });\n\n    return noErrors ? customFieldsValues : null;\n  };\n\n  /**\n  * Связывание информации о туристах из заявки (getOrderTourists)\n  * с информацией из услуги и формирование данных для блока туристов\n  * @param {TouristStorage[]} tourists - массив информации по туристам\n  * @param {Boolean} [overrideSave] - явное указание возможности сохранения привязки\n  */\n  ServiceViewModel.prototype.mapTouristsInfo = function() {\n    throw new Error('ServiceViewModel:mapTouristsInfo not implemented');\n  };\n\n  /**\n  * Получение структуры данных привязок туристов\n  * @return {Object[]} структура данных привязок\n  */\n  ServiceViewModel.prototype.getTouristsMap = function() {\n    if (this.touristsMap !== undefined) {\n      return this.touristsMap;\n    } else {\n      console.error('Ошибка получения данных формы туристов: сначала необходимо вызвать mapTouristInfo()');\n      return false;\n    }\n  };\n\n  /**\n  * Получение статуса возможности добавления туриста к услуге\n  * (на основании текущей привязки туристов)\n  * @return {Boolean} возможность добавления туриста\n  */\n  ServiceViewModel.prototype.checkTouristAddAllowance = function() {\n    var ServiceStorage = this.ServiceStorage;\n\n    var isSavingAllowed = (\n        !ServiceStorage.isPartial &&\n        ((ServiceStorage.status === 9 && KT.profile.userType === 'op') || ServiceStorage.status === 0)\n      );\n\n    if (!isSavingAllowed) { return false; }\n\n    var isAddingAllowed = false;\n\n    for (var ag in this.touristsAges) {\n      if (this.touristsAges.hasOwnProperty(ag)) {\n        if (this.touristsAges[ag].ordered > this.touristsAges[ag].current) {\n          isAddingAllowed = true;\n        }\n      }\n    }\n    \n    return isAddingAllowed;\n  };\n\n  /**\n  * Установка общих для всех услуг параметров формы ручного редактирования\n  * @return {Object} - общие параметры\n  */\n  ServiceViewModel.prototype.setCommonManualFormParams = function() {\n    var ServiceStorage = this.ServiceStorage;\n\n    return {\n      'serviceId': ServiceStorage.serviceId,\n      'clientCurrency': ServiceStorage.prices.inClient.currencyCode,\n      'clientGrossPrice': ServiceStorage.prices.inClient.client.gross.toMoney(2,',',' '),\n      'agentCommission': ServiceStorage.prices.inClient.client.commission.amount.toMoney(2,',',' '),\n      'supplierGrossPrice': ServiceStorage.prices.inSupplier.supplier.gross.toMoney(2,',',' '),\n      'supplierCurrency': ServiceStorage.prices.inSupplier.currencyCode,\n      'clientCancelPenalties': (ServiceStorage.clientCancelPenalties === null) ? null : \n        ServiceStorage.clientCancelPenalties.map(function(penalty, i) {\n          return {\n            'penaltyIndex': i,\n            'dateFrom': penalty.dateFrom.format(KT.config.dateFormat),\n            'dateTo': penalty.dateTo.format(KT.config.dateFormat),\n            'amount': Number(penalty.penaltySum.inClient.amount).toMoney(2,',',' '),\n            'currency': penalty.penaltySum.inClient.currency,\n            'currencyIcon': KT.getCatalogInfo('lcurrency', penalty.penaltySum.inClient.currency, 'icon')\n          };\n        })\n    };\n  };\n\n  /**\n  * Инициализация общих для всех услуг элементов управления окна ручного редактирования услуги\n  * @param {Object} $wnd - [jQueryDom] объект окна\n  * @param {Object} mds - объект модуля\n  */\n  ServiceViewModel.prototype.initManualFormControls = function($wnd, mds) {\n    var ServiceStorage = this.ServiceStorage;\n\n    // настройка переключения между вкладками\n    $wnd.on('click','.js-ore-service-manualedit--tab-link',function() {\n      if (!$(this).hasClass('active')) {\n        var $root = $(this).closest('.js-ore-service-manualedit');\n\n        $root.children('.js-ore-service-manualedit--tab-header')\n          .children('.js-ore-service-manualedit--tab-link')\n            .filter('.active').removeClass('active');\n        $(this).addClass('active');\n\n        var $tabs = $root.children('.js-ore-service-manualedit--tab');\n        $tabs.removeClass('active')\n          .filter('[data-tab=\"'+$(this).data('tab')+'\"]')\n            .addClass('active');\n      }\n    });\n\n    // даты начала - окончания услуги\n    $wnd.find('.js-ore-service-manualedit--start-date')\n      .val(this.ServiceStorage.startDate.format('DD.MM.YYYY'))\n      .clndrize({\n        'template':mds.tpl.clndr,\n        'eventName':'Дата начала услуги',\n        'showDate':this.ServiceStorage.startDate,\n        'clndr': {\n          'constraints': {\n            'startDate':moment().format('YYYY-MM-DD'),\n            'endDate':moment().add(1,'years').format('YYYY-MM-DD')\n          }\n        }\n      });\n\n    $wnd.find('.js-ore-service-manualedit--end-date')\n      .val(this.ServiceStorage.endDate.format('DD.MM.YYYY'))\n      .clndrize({\n        'template':mds.tpl.clndr,\n        'eventName':'Дата окончания услуги',\n        'showDate':this.ServiceStorage.endDate,\n        'clndr': {\n          'constraints': {\n            'startDate':moment().format('YYYY-MM-DD'),\n            'endDate':moment().add(1,'years').format('YYYY-MM-DD')\n          }\n        }\n      });\n\n    // цены, комиссии, штрафы\n    var $currencyLabels = $wnd.find('.js-ore-service-manualedit--selected-currency');\n    \n    $wnd.find('.js-ore-service-manualedit--currency')\n      .selectize({\n        openOnFocus: true,\n        create: false,\n        allowEmptyOption: false,\n        valueField: 'value',\n        labelField: 'text',\n        options: [\n          {\n            'value': ServiceStorage.prices.inClient.currencyCode,\n            'text': 'Валюта продажи'\n          },\n          {\n            'value': ServiceStorage.prices.inSupplier.currencyCode,\n            'text': 'Валюта поставщика'\n          },\n          {\n            'value': ServiceStorage.prices.inView.currencyCode,\n            'text': 'Валюта просмотра'\n          },\n          {\n            'value': ServiceStorage.prices.inLocal.currencyCode,\n            'text': 'Локальная валюта'\n          }\n        ],\n        items: [ServiceStorage.prices.inClient.currencyCode],\n        render: {\n          item: function(item) {\n            return '<div class=\"item\">' + item.value + ' (' + item.text + ')</div>';\n          },\n          option: function(item) {\n            return '<div class=\"option\">' + item.value + ' (' + item.text + ')</div>';\n          }\n        },\n        onItemAdd: function(value) {\n          $currencyLabels.text(value);\n        }\n      });\n\n    $wnd.find('.js-ore-service-manualedit--client-gross-price')\n      .setValidation('price', null, true)\n      .on('change, focusout', function() {\n        var price = parseFloat($(this).val().replace(/\\s+/g,'').replace(',','.'));\n        if (isNaN(price) || $(this).val() === '') {\n          $(this).val(ServiceStorage.prices.inClient.client.gross.toMoney(2,',',' '));\n          $(this)\n            .addClass('error')\n            .one('click, focusin', function() { $(this).removeClass('error'); });\n        }\n      });\n\n    $wnd.find('.js-ore-service-manualedit--agent-commission')\n      .setValidation('price', null, true)\n      .on('change, focusout', function() {\n        var commission = parseFloat($(this).val().replace(/\\s+/g,'').replace(',','.'));\n        if (isNaN(commission) || $(this).val() === '') {\n          $(this).val(ServiceStorage.prices.inClient.client.commission.amount.toMoney(2,',',' '));\n          $(this)\n            .addClass('error')\n            .one('click, focusin', function() { $(this).removeClass('error'); });\n        }\n      });\n\n    $wnd.find('.js-ore-service-manualedit--client-cancel-penalty-amount')\n      .setValidation('price', null, true)\n      .on('change, focusout', function() {\n        var price = parseFloat($(this).val().replace(/\\s+/g,'').replace(',','.'));\n        if (isNaN(price) || $(this).val() === '') {\n          $(this).val($(this).data('penalty'));\n        }\n      });\n\n    /* Установка статуса */\n    var statuses = [];\n    for (var status in KT.getCatalogInfo.servicestatuses) {\n      status = +status;\n      if ([0,2,5,7,8].indexOf(status) !== -1) { // см. app/__devel/js/core/config/catalogs.js\n        statuses.push({\n          'value': status,\n          'name': KT.getCatalogInfo.servicestatuses[status][1],\n          'icon': KT.getCatalogInfo.servicestatuses[status][0]\n        });\n      }\n    }\n\n    $wnd.find('.js-ore-service-manualedit--change-status')\n      .selectize({\n        openOnFocus: true,\n        create: false,\n        valueField: 'value',\n        labelField: 'name',\n        options: statuses,\n        render: {\n          item: function(item) {\n            return '<div data-value=\"' + item.value + '\" class=\"item\" title=\"' + item.name + '\">' + \n              '<i class=\"service-status-small service-sm-status-' + item.icon + '\"></i> ' + item.name + \n              '</div>';\n          },\n          option: function(item) {\n            return '<div data-value=\"'+item.value+'\" data-selectable class=\"option\">' +\n              '<i class=\"service-status-small service-sm-status-' + item.icon + '\"></i> ' + item.name + \n              '</div>';\n          }\n        }\n      });\n  };\n\n  return ServiceViewModel;\n\n}));","(function(global,factory) {\n\n    KT.crates.OrderEdit.services.AviaServiceViewModel = factory(KT.crates.OrderEdit);\n\n}(this, function(crate) {\n  var ServiceViewModel = crate.services.ServiceViewModel;\n\n  var ticketStatusMap = {\n    1: 'ISSUED',\n    2: 'VOIDED',\n    3: 'RETURNED',\n    4: 'CHANGED'\n  };\n\n  /**\n  * View-объект для отображения оффера перелета\n  * @constructor\n  * @param {ServiceStorage} ServiceStorage - данные услуги\n  * @param {Object} templates - ссылка на коллекцию шаблонов модуля\n  * @param {Object} suppliersMap - список поставщиков\n  */\n  var AviaServiceViewModel = ServiceViewModel.extend(function(ServiceStorage, templates, suppliersMap) {\n    ServiceViewModel.call(this, ServiceStorage, templates);\n\n    this.serviceTypeName = 'avia';\n\n    this.touristsAges = {\n      'adults': {\n        'ordered':ServiceStorage.declaredTouristAges.adults,\n        'current':0\n      },\n      'children': {\n        'ordered':ServiceStorage.declaredTouristAges.children,\n        'current':0\n      },\n      'infants': {\n        'ordered':ServiceStorage.declaredTouristAges.infants,\n        'current':0\n      }\n    };\n\n    this.fareRulesView = '';\n\n    this.tripData = [];\n    this.tripDates = []; //dates\n    this.tripPoints = []; //flights\n\n    this.hasPnr = false;\n    this.pnrNumber = false;\n    this.tickets = false;\n    this.receipts = false;\n    this.ticketLink = false;\n\n    this.touristsMap = [];\n\n    if (!ServiceStorage.isPartial) {\n      this.supplierCode = ServiceStorage.offerInfo.supplierCode;\n\n      this.supplierName = (suppliersMap[this.supplierCode] !== undefined) ?\n        suppliersMap[this.supplierCode].name :\n        this.supplierCode;\n    }\n\n    this.manualFormParams = null;\n  });\n\n  /* Шаблоны для авиа */\n  AviaServiceViewModel.templates = {\n    aviaFormHeader: 'orderEdit/services/avia/aviaFormHeader',\n    aviaFormMain: 'orderEdit/services/avia/aviaFormMain',\n    aviaServiceActions: 'orderEdit/services/avia/aviaServiceActions',\n    aviaTrip: 'orderEdit/services/avia/aviaTrip',\n    aviaTripRoute: 'orderEdit/services/avia/aviaTripRoute',\n    aviaLoyaltyCard: 'orderEdit/services/avia/aviaLoyaltyCard',\n    aviaNoLoyaltyCards: 'orderEdit/services/avia/aviaNoLoyaltyCards',\n    aviaFareRule: 'orderEdit/services/avia/aviaFareRule',\n    aviaFareRuleUnavailable: 'orderEdit/services/avia/aviaFareRuleUnavailable',\n    aviaMinimalPrice: 'orderEdit/services/avia/aviaMinimalPrice',\n    aviaManualForm: 'orderEdit/services/avia/aviaManualForm'\n  };\n\n  /**  Подготовка шаблонов */\n  AviaServiceViewModel.prototype.prepareViews = function() {\n    var ServiceStorage = this.ServiceStorage;\n\n    if (!ServiceStorage.isPartial) {\n      this.processTrips();\n      this.processPnr();\n      this.processCustomFields();\n    } else {\n      this.tripDates.push({\n        'wd': ServiceStorage.startDate.format('dd'),\n        'dm': ServiceStorage.startDate.format('DD.MM')\n      });\n    }\n\n    this.prepareHeaderView();\n    this.prepareMainView();\n    this.prepareActionsView();\n  };\n\n  /** Обработка маршрута перелета и формирование данных */\n  AviaServiceViewModel.prototype.processTrips = function() {\n    var self = this;\n\n    this.tripData = [];\n    this.tripDates = [];\n    this.tripPoints = [];\n\n    var hasPnr = (\n      !this.ServiceStorage.isPartial && \n      this.ServiceStorage.offerInfo.pnr !== undefined && \n      this.ServiceStorage.offerInfo.pnr !== null\n    );\n\n    this.ServiceStorage.offerInfo.itinerary.forEach(function(trip) {\n      var firstSegment = trip.segments[0];\n      var lastSegment = trip.segments[(+trip.segments.length - 1)];\n\n      var startdate = moment(firstSegment.departureDate,'YYYY-MM-DD HH:mm:ss');\n      var marketingAirlineCode = firstSegment.marketingAirline;\n\n      self.tripDates.push({\n        'wd': startdate.format('dd'),\n        'dm': startdate.format('DD.MM')\n      });\n\n      self.tripPoints.push({\n        'dep':{\n          'city': firstSegment.departureCityName,\n          'iata': firstSegment.departureAirportCode\n        },\n        'arr':{\n          'city': lastSegment.arrivalCityName,\n          'iata': lastSegment.arrivalAirportCode\n        }\n      });\n\n      var tripRoute = {\n        'alName': (KT.airlineCodes[marketingAirlineCode] !== undefined) ?\n          KT.airlineCodes[marketingAirlineCode].name : marketingAirlineCode,\n        'alLogo': (\n            KT.airlineCodes[marketingAirlineCode] !== undefined &&\n            KT.airlineCodes[marketingAirlineCode].hasLogo === true\n          ) ? marketingAirlineCode : false,\n        'segments':[]\n      };\n\n      trip.segments.forEach(function(seg, segIndex) {\n        var waitingTime = false;\n\n        if (segIndex + 1 < trip.segments.length) {\n          var nextseg = trip.segments[segIndex + 1];\n          var fhm = moment(seg.arrivalDate,'YYYY-MM-DD HH:mm:ss');\n          var thm = moment(nextseg.departureDate,'YYYY-MM-DD HH:mm:ss');\n          waitingTime = moment.duration(thm.valueOf() - fhm.valueOf()).asMinutes();\n        }\n\n        tripRoute.segments.push({\n          'flightNum':seg.marketingAirline + ' ' + seg.flightNumber,\n          'transporter': (seg.operatingAirline === seg.marketingAirline) ? false :\n            {\n              'code': seg.operatingAirline,\n              'name': (KT.airlineCodes[seg.operatingAirline] !== undefined) ?\n                KT.airlineCodes[seg.operatingAirline].name : seg.operatingAirline\n            },\n          'aircraft': seg.aircraft,\n          'class': (seg.categoryClassType!==null) ? seg.categoryClassType.substr(0,1) : 'A',\n          'className': (seg.categoryClassType!==null) ? seg.categoryClassType : false,\n          'dhours': parseInt(seg.duration/60),\n          'dminutes': seg.duration%60,\n          'startpoint': {\n            'city': seg.departureCityName,\n            'airport': seg.departureAirportName,\n            'terminal': seg.departureTerminal,\n            'iata': seg.departureAirportCode,\n            'date': seg.departureDate.split(' ')[0],\n            'time': seg.departureDate.split(' ')[1].substr(0,5)\n          },\n          'endpoint': {\n            'city': seg.arrivalCityName,\n            'airport': seg.arrivalAirportName,\n            'terminal': seg.arrivalTerminal,\n            'iata': seg.arrivalAirportCode,\n            'date': seg.arrivalDate.split(' ')[0],\n            'time': seg.arrivalDate.split(' ')[1].substr(0,5)\n          },\n          'waiting': (waitingTime === false) ? false : {\n            'hours': Math.floor(waitingTime / 60),\n            'minutes': waitingTime % 60,\n          },\n          'stops': []\n        });\n      });\n\n      var baggageInfo = [];\n      if (trip.segments.length === 1) {\n        if (Array.isArray(trip.segments[0].baggage)) {\n          baggageInfo.push(\n            trip.segments[0].baggage.map(function(baggage) {\n              return [\n                baggage.measureQuantity,\n                (baggage.measureCode === 'PC' ? \n                  declOfNum(baggage.measureQuantity, ['место', 'места', 'мест']) : \n                  baggage.measureCode\n                )\n              ].join(' ');\n            }).join(', ')\n          );\n        }\n      } else {\n        trip.segments.forEach(function(segment) {\n          if (Array.isArray(segment.baggage)) {\n            baggageInfo.push(\n              segment.departureAirportCode + ' - ' + segment.arrivalAirportCode + ': ' +\n              segment.baggage.map(function(baggage) {\n                return [\n                  baggage.measureQuantity,\n                  (baggage.measureCode === 'PC' ? \n                    declOfNum(baggage.measureQuantity, ['место', 'места', 'мест']) : \n                    baggage.measureCode\n                  )\n                ].join(' ');\n              }).join(', ')\n            );\n          }\n        });\n      }\n\n      var transfersAmount = trip.segments.length - 1;\n      self.tripData.push(Mustache.render(self.tpl.aviaTrip, {\n        'route': Mustache.render(self.tpl.aviaTripRoute, tripRoute),\n        'hasPnr': hasPnr,\n        'baggageInfo': baggageInfo,\n        'transfersNum': (transfersAmount === 0) ? 'без пересадок' :\n          transfersAmount + ' ' + declOfNum(transfersAmount, ['пересадка','пересадки','пересадок']),\n      }));\n    });\n  };\n\n  /** Обработка данных брони и билетов */\n  AviaServiceViewModel.prototype.processPnr = function() {\n    var self = this;\n    var ServiceStorage = this.ServiceStorage;\n\n    if (ServiceStorage.offerInfo.pnr !== undefined && ServiceStorage.offerInfo.pnr !== null) {\n      self.hasPnr = true;\n      self.pnrNumber = ServiceStorage.offerInfo.pnr.pnrNumber;\n      self.pnrBaggageInfo = {\n        'info': null\n      };\n\n      if (\n          ServiceStorage.offerInfo.pnr.receipts !== undefined &&\n          Array.isArray(ServiceStorage.offerInfo.pnr.receipts)\n        ) {\n          self.receipts = ServiceStorage.offerInfo.pnr.receipts;\n\n        self.ticketLink = (self.receipts[0] !== undefined) ?\n          self.receipts[0].receiptUrl : false;\n      }\n\n      if (\n        ServiceStorage.offerInfo.pnr.tickets !== undefined &&\n        Array.isArray(ServiceStorage.offerInfo.pnr.tickets) &&\n        ServiceStorage.offerInfo.pnr.tickets.length !== 0\n      ) {\n        self.tickets = {};\n        ServiceStorage.offerInfo.pnr.tickets.forEach(function(ticket) {\n          if (!self.tickets.hasOwnProperty(ticket.touristId)) {\n            self.tickets[ticket.touristId] = [];\n          }\n          self.tickets[ticket.touristId].push({\n            'status': ticketStatusMap[ticket.ticketStatus],\n            'number': ticket.ticketNumber\n          });\n        });\n      }\n\n      if (Array.isArray(ServiceStorage.offerInfo.pnr.baggage)) {\n        ServiceStorage.offerInfo.pnr.baggage.map(function(baggage) {\n          if (baggage.measureCode === 'PC') { \n            baggage.measureCode = declOfNum(baggage.measureQuantity, ['место', 'места', 'мест']);\n          }\n        });\n\n        self.pnrBaggageInfo.info = ServiceStorage.offerInfo.pnr.baggage;\n      }\n    }\n  };\n\n  /** Обработка дополнительных полей  */\n  AviaServiceViewModel.prototype.processCustomFields = function() {\n    var self = this;\n    var unprocessedFields = ServiceViewModel.prototype.processCustomFields.call(this);\n    \n    // Обработка специализированных доп. полей\n    if (Array.isArray(unprocessedFields)) {\n      unprocessedFields.forEach(function(fieldData) {\n        switch (fieldData.typeTemplate) {\n          case 5: // minimal price\n            if (fieldData.value === null) { return; }\n            var minimalPriceData = JSON.parse(fieldData.value);\n\n            self.minimalPriceView = Mustache.render(self.tpl.aviaMinimalPrice, {\n              'from': minimalPriceData.from,\n              'to': minimalPriceData.to,\n              'dateStart': moment(minimalPriceData.dateStart, 'YYYY-MM-DD HH:mm:ss')\n                .format('HH:mm YYYY-MM-DD'),\n              'dateFinish': moment(minimalPriceData.dateFinish, 'YYYY-MM-DD HH:mm:ss')\n                .format('HH:mm YYYY-MM-DD'),\n              'duration': {\n                'hours': Math.floor(minimalPriceData.duration / 60),\n                'minutes': minimalPriceData.duration % 60,\n              },\n              'changes': [\n                  minimalPriceData.changes,\n                  declOfNum(minimalPriceData.changes, ['пересадка','пересадки','пересадок'])\n                ].join(' '),\n              'price': Number(minimalPriceData.price).toMoney(0,',',' '),\n              'currency': KT.getCatalogInfo('lcurrency', minimalPriceData.currency, 'icon')\n            });\n            break;\n        }\n      });\n    }\n  };\n\n  /** Подготовка интерфейса шапки */\n  AviaServiceViewModel.prototype.prepareHeaderView = function() {\n    var ServiceStorage = this.ServiceStorage;\n\n    var firstFlightNumber = '';\n    if (!ServiceStorage.isPartial) {\n      if (\n        ServiceStorage.offerInfo.itinerary[0] !== undefined &&\n        ServiceStorage.offerInfo.itinerary[0].segments[0] !== undefined\n      ) {\n        var firstSegment = ServiceStorage.offerInfo.itinerary[0].segments[0];\n        firstFlightNumber = firstSegment.marketingAirline+'-'+firstSegment.flightNumber;\n      }\n    } else {\n      firstFlightNumber = ServiceStorage.serviceName;\n    }\n\n    this.headerView = Mustache.render(this.tpl.aviaFormHeader, {\n      'firstFlightNum': firstFlightNumber,\n      'amendDate':(ServiceStorage.dateAmend === null) ? false :\n        ServiceStorage.dateAmend.format('DD.MM.YYYY'),\n      'priceLocal': Number(ServiceStorage.prices.inLocal.client.gross).toMoney(0,',',' '),\n      'priceInView': Number(ServiceStorage.prices.inView.client.gross).toMoney(0,',',' '),\n      'viewCurrencyIcon': KT.getCatalogInfo(\n          'lcurrency', ServiceStorage.prices.inView.currencyCode, 'icon'\n        ),\n      'statusIcon':KT.getCatalogInfo('servicestatuses',ServiceStorage.status,'icon'),\n      'statusTitle': (KT.profile.userType === 'op' && ServiceStorage.status === 9) ?\n        'Ручной режим' :\n        KT.getCatalogInfo('servicestatuses',ServiceStorage.status,'title'),\n      'dates': this.tripDates,\n      'flights': this.tripPoints,\n      'passengers': {\n        'adult': ServiceStorage.declaredTouristAges.adults,\n        'child': ServiceStorage.declaredTouristAges.children,\n        'infant': ServiceStorage.declaredTouristAges.infants,\n      },\n      'pnrNumber': this.pnrNumber,\n      'ticketLink': this.ticketLink\n    });\n  };\n\n  /** Подготовка интерфейса главного блока */\n  AviaServiceViewModel.prototype.prepareMainView = function() {\n    var ServiceStorage = this.ServiceStorage;\n\n    if (!ServiceStorage.isPartial) {\n      var lastTicketingDate = (ServiceStorage.offerInfo.lastTicketingDate !== null) ?\n            moment(ServiceStorage.offerInfo.lastTicketingDate,'YYYY-MM-DD HH:mm:ss').format('HH:mm DD-MM-YYYY') :\n            null;\n\n      this.mainView = Mustache.render(this.tpl.aviaFormMain, {\n        //'minimalPrice': this.minimalPriceView,\n        'offerSupplier': (KT.profile.userType === 'op') ? this.supplierName : false,\n        'lastTicketingDate': lastTicketingDate,\n        'flightTrips': this.tripData,\n        'overNightFlight': !ServiceStorage.hasTravelPolicy ? false :\n          ServiceStorage.offerInfo.travelPolicy.overNightFlight,\n        'nightTransfer': !ServiceStorage.hasTravelPolicy ? false :\n          ServiceStorage.offerInfo.travelPolicy.nightTransfer,\n        'pnrBaggageInfo': this.pnrBaggageInfo,\n        'ticketLink': this.ticketLink\n      });\n    } else { this.mainView = ''; }\n  };\n\n  /** Подготовка интерфейса действий с услугой */\n  AviaServiceViewModel.prototype.prepareActionsView = function() {\n    var self = this;\n    var ServiceStorage = this.ServiceStorage;\n\n    if (!ServiceStorage.isPartial) {\n      var serviceActions = this.getServiceActions();\n\n      this.actionsView = Mustache.render(self.tpl.aviaServiceActions, serviceActions);\n      this.prepareFareRulesView();\n    } else { this.actionsView = ''; }\n  };\n\n  /** Подготовка интерфейса правил тарифов перелета */\n  AviaServiceViewModel.prototype.prepareFareRulesView = function() {\n    var ServiceStorage = this.ServiceStorage;\n\n    if (\n      !Array.isArray(ServiceStorage.offerInfo.fareRules) ||\n      ServiceStorage.offerInfo.fareRules.length === 0\n    ) {\n      this.fareRulesView = Mustache.render(KT.tpl.spinner, {});\n      return;\n    }\n\n    var fareRule = {'rules': []};\n    var isActiveTab = true;\n\n    var locationMap = {};\n    ServiceStorage.offerInfo.itinerary.forEach(function(trip) {\n      trip.segments.forEach(function(segment) {\n        locationMap[segment.arrivalAirportCode] = segment.arrivalCityName;\n        locationMap[segment.departureAirportCode] = segment.departureCityName;\n      });\n    });\n\n    ServiceStorage.offerInfo.fareRules.forEach(function(rule) {\n      var shortRules = {};\n\n      var iataCodes = rule.segment.flightSegmentName.split(/\\s*-\\s*/);\n      var fullSegmentName = locationMap[iataCodes[0]] + ' - ' + locationMap[iataCodes[1]];\n\n      for (var flag in rule.aviaFareRule.shortRules) {\n        if (rule.aviaFareRule.shortRules.hasOwnProperty(flag)) {\n          switch (rule.aviaFareRule.shortRules[flag]) {\n            case true:\n              shortRules[flag] = {'allowed':true};\n              break;\n            case false:\n              shortRules[flag] = {'forbidden':true};\n              break;\n            default:\n              shortRules[flag] = {'undefined':true};\n              break;\n          }\n        }\n      }\n      \n      fareRule.rules.push({\n        'active': isActiveTab,\n        'segment' : rule.segment.flightSegmentName,\n        'fullSegmentName': fullSegmentName,\n        'shortRules': shortRules,\n        'rulesText': rule.aviaFareRule.rules\n      });\n\n      isActiveTab = false;\n    });\n\n    this.fareRulesView = Mustache.render(this.tpl.aviaFareRule, fareRule);\n  };\n\n  /** Подготовка пустой формы правил тарифов (не найдены) */\n  AviaServiceViewModel.prototype.prepareEmptyFareRulesView = function() {\n    this.fareRulesView = Mustache.render(this.tpl.aviaFareRuleUnavailable, {});\n  };\n\n  /** \n  * Инициализация элементов управления после рендера формы\n  * @param {Object} $container - форма услуги\n  * @todo в принципе передать управление контейнером услуги в класс viewModel?\n  */\n  AviaServiceViewModel.prototype.initControls = function($container) {\n    if (this.customFields.length > 0) {\n      var $customFields = $();\n\n      this.customFields.forEach(function(customField) {\n        $customFields = $customFields.add(customField.render());\n      });\n\n      $container.find('.js-service-form-custom-fields').html($customFields);\n\n      this.customFields.forEach(function(customField) {\n        customField.initialize();\n      });\n    }\n  };\n\n  /**\n  * Связывание информации о туристах из заявки (getOrderTourists)\n  * с информацией из услуги и формирование данных для блока туристов\n  * @param {TouristStorage[]} tourists - массив информации по туристам\n  * @param {Boolean} [overrideSave] - явное указание возможности сохранения привязки\n  */\n  AviaServiceViewModel.prototype.mapTouristsInfo = function(tourists, overrideSave) {\n    var self = this;\n    var ServiceStorage = this.ServiceStorage;\n\n    this.touristsAges = {\n      'adults': {\n        'ordered':ServiceStorage.declaredTouristAges.adults,\n        'current':0\n      },\n      'children': {\n        'ordered':ServiceStorage.declaredTouristAges.children,\n        'current':0\n      },\n      'infants': {\n        'ordered':ServiceStorage.declaredTouristAges.infants,\n        'current':0\n      }\n    };\n    this.touristsMap = [];\n\n    if (tourists.length === 0) { return; }\n    if (overrideSave === undefined) { overrideSave = false; }\n    var isSavingAllowed = (\n        !ServiceStorage.isPartial &&\n        ((ServiceStorage.status === 9 && KT.profile.userType === 'op') || ServiceStorage.status === 0)\n      );\n\n    tourists.forEach(function(TouristStorage) {\n      var isLinked = ServiceStorage.tourists.hasOwnProperty(TouristStorage.touristId);\n      var linkedTourist = isLinked ? ServiceStorage.tourists[TouristStorage.touristId] : null;\n      var touristExtra = '';\n\n      if (!ServiceStorage.isPartial) {\n\n        // сохранение числа привязанных туристов по возрастным группам\n        if (isLinked) {\n          var age = moment.duration(\n              moment().valueOf() - TouristStorage.birthdate.valueOf()\n            ).asYears();\n          if (age < 3) { self.touristsAges.infants.current += 1; }\n          else if (age < 12) { self.touristsAges.children.current += 1; }\n          else { self.touristsAges.adults.current += 1; }\n        }\n\n        if (self.tickets !== undefined && self.tickets[TouristStorage.touristId] !== undefined) {\n          var issuedTickets = self.tickets[TouristStorage.touristId].filter(function(ticket) {\n              return (ticket.status === 'ISSUED');\n            }).map(function(ticket) {\n              return ticket.number;\n            });\n            \n          touristExtra = '<div class=\"service-form-tourist__ticket-number\">№ билет' +\n            ((issuedTickets.length > 1) ? 'ов' : 'а') + ': ' + \n            issuedTickets.join(', ') + \n            '</div>';\n\n        } else {\n          if (\n            (isLinked && linkedTourist.loyalityProviderId  !== null) ||\n            TouristStorage.bonusCards.length > 0\n          ) {\n            touristExtra = Mustache.render(self.tpl.aviaLoyaltyCard, {\n              'isSavingAllowed': isSavingAllowed,\n              'loyalityProgram': isLinked ? linkedTourist.loyalityProviderId : null,\n              'loyalityCardNumber': isLinked ? linkedTourist.loyalityCardNumber : null,\n            });\n          } else {\n            touristExtra = Mustache.render(self.tpl.aviaNoLoyaltyCards, {});\n          }\n        }\n      }\n\n      if (overrideSave || isSavingAllowed || isLinked) {\n        self.touristsMap.push({\n          'allowSave': isSavingAllowed,\n          'touristId': TouristStorage.touristId,\n          'firstName': TouristStorage.firstname,\n          'bonusCards': TouristStorage.bonusCards,\n          'surName': TouristStorage.lastname,\n          'attached': isLinked,\n          'touristExtra': touristExtra\n        });\n      }\n    });\n  };\n\n  /**\n  * Рендер элементов управления туриста \n  * @param {Object} $tourist - блок туриста\n  * @param {Object} tourist - данные туриста (touristsMap)\n  */\n  AviaServiceViewModel.prototype.renderTouristControls = function($tourist, tourist) {\n    KT.Dictionary.getAsMap('loyalityPrograms', 'programId')\n      .then(function(loyalityProgramsMap) {\n        var bonusCardsOptions = tourist.bonusCards.map(function(card) {\n          if (loyalityProgramsMap.hasOwnProperty(card.aviaLoyaltyProgramId)) {\n            return $.extend(true, {\n              'cardNumber': card.bonuscardNumber\n            }, loyalityProgramsMap[card.aviaLoyaltyProgramId]);\n          }\n        });\n\n        if (bonusCardsOptions.length === 0) { return; }\n\n        var $bonusCard = $tourist.find('.js-service-avia-loyalty-program');\n        // карт не будет, если услуга оформлена\n        if ($bonusCard.length !== 0) {\n          var $providerSelect = $bonusCard.find('.js-service-avia-loyalty-program--provider');\n          var $cardNumber = $bonusCard.find('.js-service-avia-loyalty-program--number');\n          var currentProvider = $providerSelect.val();\n\n          $providerSelect.selectize({\n            plugins: {'jirafize':{}},\n            openOnFocus: true,\n            create: false,\n            options: bonusCardsOptions,\n            selectOnTab: true,\n            valueField: 'programId',\n            searchField: ['IATAcode','loyalityProgramName', 'aircompanyName'],\n            render:{\n              item: function(item) {\n                return '<div class=\"item\" ' +\n                  'data-tooltip=\"авиакомпания: ' + item.aircompanyName + '<br>' +\n                  ' альянс: ' + item.allianceName + '\">' + \n                  '<b>[' + item.IATAcode + ']</b> ' + item.loyalityProgramName + \n                  '</div>';\n              },\n              option: function(item) {\n                return '<div class=\"option\" ' +\n                  'data-tooltip=\"авиакомпания: ' + item.aircompanyName + '<br>' +\n                  ' альянс: ' + item.allianceName + '\">' + \n                  '<b>[' + item.IATAcode + ']</b> ' + item.loyalityProgramName + \n                  '</div>';\n              }\n            },\n            onItemAdd: function(value) {\n              $cardNumber.val(this.options[value].cardNumber);\n            },\n            onItemRemove: function() {\n              $cardNumber.val('');\n            },\n            onClear: function() {\n              $cardNumber.val('');\n            }\n          });\n\n          if (currentProvider !== '' && currentProvider !== null) {\n            $providerSelect[0].selectize.addItem(+currentProvider);\n          } else if (bonusCardsOptions.length > 0 && tourist.allowSave && !tourist.attached) {\n            /*\n            * выбор первого элемента только в том случае ,если турист не привязан:\n            * нужно для того, чтобы при бронировании не было \"мелькания\" мильной карты на услуге\n            */\n            $providerSelect[0].selectize.addItem(bonusCardsOptions[0].programId);\n          }\n        }\n      });\n  };\n\n  /**\n  * Получение структуры доступных действий над услугой\n  * @return {Object} идентификатор услуги и разрешения на действия\n  */\n  AviaServiceViewModel.prototype.getServiceActions = function() {\n    var ServiceStorage = this.ServiceStorage;\n\n    var serviceActions = {\n      'serviceId': ServiceStorage.serviceId,\n      'ManualEdit': (KT.profile.userType === 'op' && ServiceStorage.status === 9) ? true : false,\n      'save': (this.customFields.length > 0)\n    };\n\n    ServiceStorage.allowedTransitions.forEach(function(transition) {\n      serviceActions[transition] = true;\n    });\n\n    // хак для разного стиля кнопок, переделать?\n    if (KT.profile.userType !== 'op' && serviceActions['Manual']) {\n      serviceActions['Manual'] = false;\n      serviceActions['ToManager'] = true;\n    }\n\n    serviceActions.agreementSet = ServiceStorage.isTOSAgreementSet;\n\n    if (!serviceActions.BookStart) {\n      serviceActions.agreementDisabled = true;\n      serviceActions.agreementSet = true;\n    }\n\n    return serviceActions;\n  };\n\n  /**\n  * Создает список документов с условиями работы с услугой с методами их получения\n  * @return {Object} объект с документами и методами их получения\n  */\n  AviaServiceViewModel.prototype.defineTermsDocuments = function() {\n    var self = this;\n    var ServiceStorage = this.ServiceStorage;\n\n    /*\n    * renderer - функция, отрисовывающая контент. \n    *  Принимает название документа и контент, Возвращает ссылку на DOM-объект окна\n    * loader - функция загрузки документа.\n    *  Принимает название документа и коллбэк\n    */\n\n    var termsDocuments = {\n      'companyTOS': {\n        'load':function(renderer, loader) {\n          loader('companyTOS', renderer);\n        }\n      }\n    };\n    termsDocuments[ServiceStorage.tosDocumentName] = {\n      'load':function(renderer, loader) {\n        loader('aviaBookTerms', renderer);\n      }\n    };\n\n    termsDocuments[ServiceStorage.fareRuleDocumentName] = {\n      'load':function(renderer) {\n        var $fareRule = renderer(ServiceStorage.fareRuleDocumentName, self.fareRulesView);\n        $fareRule.on('click','.js-avs-fare-rule--tab-link', function() {\n          if (!$(this).hasClass('active')) {\n            var $root = $(this).closest('.js-avs-fare-rule');\n            \n            $root.children('.js-avs-fare-rule--tab-header')\n              .children('.js-avs-fare-rule--tab-link')\n                .filter('.active')\n                  .removeClass('active');\n            $(this).addClass('active');\n\n            var $tabs = $root.children('.js-avs-fare-rule--tab');\n            $tabs.removeClass('active')\n              .filter('[data-tab=\"' + $(this).data('tab') + '\"]')\n                .addClass('active');\n          }\n        });\n      }\n    };\n\n    return termsDocuments;\n  };\n\n  /**\n  * Рендер формы ручного редактирования улуги\n  * @param {Object} mds - объект модуля\n  * @return {String} - код формы редактирования услуги\n  */\n  AviaServiceViewModel.prototype.renderManualForm = function(mds) {\n    var ServiceStorage = this.ServiceStorage;\n\n    var commonParams = ServiceViewModel.prototype.setCommonManualFormParams.call(this);\n\n    var manualFormParams = $.extend(commonParams, {\n        'flightTariff': ServiceStorage.offerInfo.flightTariff,\n        'pnr': (this.hasPnr) ?\n          ServiceStorage.offerInfo.pnr.pnrNumber : null,\n        'tickets': null\n      });\n    \n    if (this.hasPnr) {\n      var tickets = this.ServiceStorage.offerInfo.pnr.tickets;\n      if (tickets !== undefined && tickets.length !== 0) {\n        manualFormParams.tickets = [];\n\n        tickets.forEach(function(ticket) {\n          var tourist = mds.OrderStorage.tourists[ticket.touristId];\n\n          manualFormParams.tickets.push({\n            'pnr': ServiceStorage.offerInfo.pnr.pnrNumber,\n            'number': ticket.ticketNumber,\n            'tourist': {\n              'id': tourist.touristId,\n              'fullname': [\n                  tourist.lastname,\n                  tourist.firstname,\n                  (tourist.middlename === null ? '' : tourist.middlename)\n                ].join(' '),\n              'document': {\n                'docname': KT.config.touristDocuments[tourist.document.type].docname,\n                'number': tourist.document.series + ' ' + tourist.document.number\n              }\n            },\n            'status': ticketStatusMap[+ticket.ticketStatus],\n            'disabled': (ticketStatusMap[+ticket.ticketStatus] !== 'ISSUED'),\n            'newNumber': (ticket.newTicket !== undefined) ? ticket.newTicket: null\n          });\n        });\n      }\n    }\n\n    this.manualFormParams = manualFormParams;\n    return Mustache.render(this.tpl.aviaManualForm, manualFormParams);\n  };\n\n  /**\n  * Инициализация элементов управления окна ручного редактирования услуги\n  * @param {Object} $wnd - [jQueryDom] объект окна\n  * @param {Object} mds - объект модуля\n  * @todo Убрать зависимость от модуля\n  */\n  AviaServiceViewModel.prototype.initManualFormControls = function($wnd, mds) {\n    var self = this;\n\n    ServiceViewModel.prototype.initManualFormControls.call(this, $wnd, mds);\n\n    var ServiceStorage = this.ServiceStorage;\n\n    /* Изменение параметров брони */\n    KT.Dictionary.getAsList('suppliers', {'serviceId': ServiceStorage.typeCode, 'active': 1})\n      .then(function(aviaSuppliers) {\n        /*\n        var suppliers = [];\n        for (var supplierCode in aviaSuppliers) {\n          if (aviaSuppliers.hasOwnProperty(supplierCode)) {\n            suppliers.push({\n              'value': supplierCode,\n              'name': aviaSuppliers[supplierCode].name\n            });\n          }\n        } */\n\n        $wnd.find('.js-ore-service-manualedit--supplier')\n          .selectize({\n            openOnFocus: true,\n            create: false,\n            valueField: 'supplierCode',\n            labelField: 'name',\n            options: aviaSuppliers,\n            items: [self.supplierCode] //!!!\n          });\n      });\n\n    var lastTicketingDate = (ServiceStorage.offerInfo.lastTicketingDate !== null) ?\n      moment(ServiceStorage.offerInfo.lastTicketingDate,'YYYY-MM-DD HH:mm:ss') : null;\n\n    $wnd.find('.js-ore-service-manualedit--last-ticketing-date')\n      .val((lastTicketingDate !== null) ? lastTicketingDate.format('DD.MM.YYYY') : '')\n      .clndrize({\n        'template': mds.tpl.clndr,\n        'eventName': 'Выписать до',\n        'showDate': (lastTicketingDate !== null) ? lastTicketingDate : '',\n        'clndr': {\n          'constraints': {\n            'startDate': moment().format('YYYY-MM-DD'),\n            'endDate': this.ServiceStorage.startDate.format('YYYY-MM-DD')\n          }\n        }\n      });\n    \n    /* Редактирование авиабилетов */\n    var ticketsList = (this.manualFormParams.tickets === null) ? [] : \n      this.manualFormParams.tickets.filter(function(ticket) {\n        return (ticket.status === 'ISSUED');\n      });\n\n    var $ticketsList = $wnd.find('.js-ore-service-manualedit--avia-tickets-list');\n    var $changeTicketForm = $wnd.find('.js-ore-service-manualedit--change-avia-ticket');\n    var $addTicketForm = $wnd.find('.js-ore-service-manualedit--add-avia-ticket');\n    var $changingTicketSelect = $wnd.find('.js-ore-service-manualedit--current-ticket-number');\n    var $addNewTicketButton = $wnd.find('.js-ore-service-manualedit--add-avia-ticket-button');\n\n    // редактирование билетов\n\n    $changingTicketSelect.selectize({\n        openOnFocus: true,\n        create: false,\n        valueField: 'number',\n        labelField: 'number',\n        options: ticketsList\n      });\n\n    $ticketsList.on('click', '.js-ore-service-manualedit--avia-ticket:not(.disabled)', function() {\n        $addTicketForm.removeClass('active');\n        /*\n        $changeTicketForm.data('changingTicket', {\n          'number': $(this).data('ticket'),\n          'pnr': $(this).data('pnr'),\n          'touristId': $(this).data('touristid')\n        }); */\n        $changeTicketForm.addClass('active');\n        $changingTicketSelect[0].selectize.addItem($(this).data('ticket'));\n      });\n\n    // форма добавления билетов\n    $addNewTicketButton\n      .on('click', function() {\n        $changeTicketForm.removeClass('active');\n        $addTicketForm.addClass('active');\n      });\n\n    var tourists = [];\n    mds.OrderStorage.getTourists().forEach(function(Tourist) {\n      // билеты можно добавить/редактировать только привязанным туристам\n      if (ServiceStorage.tourists.hasOwnProperty(Tourist.touristId)) {\n        tourists.push({\n          'value': Tourist.touristId,\n          'name': [\n              Tourist.lastname,\n              Tourist.firstname\n            ].join(' '),\n          'document': [\n              KT.config.touristDocuments[Tourist.document.type].docname,\n              Tourist.document.series,\n              Tourist.document.number\n            ].join(' ')\n        });\n      }\n    });\n\n    $wnd.find('.js-ore-service-manualedit--new-ticket-tourist')\n      .selectize({\n        openOnFocus: true,\n        create: false,\n        valueField: 'value',\n        labelField: 'name',\n        options: tourists,\n        render: {\n          item: function(item) {\n            return '<div data-value=\"' + item.value + '\" class=\"item\" data-tooltip=\"' + item.document + '\">' +\n            item.name + '</div>';\n          },\n          option: function(item) {\n            return '<div data-value=\"' + item.value + '\" data-selectable class=\"option\">' +\n            item.name + '<br>(' + item.document + ')</div>';\n          }\n        }\n      });\n  };\n\n  /**\n  * Получение параметров для команды изменения брони\n  * @param {Object} $manualForm - [jQuery DOM] форма ручного редактирования услуги\n  */\n  AviaServiceViewModel.prototype.getChangeBookDataParams = function($manualForm) {\n    var ServiceStorage = this.ServiceStorage;\n\n    var pnr = $manualForm.find('.js-ore-service-manualedit--new-pnr-number').val();\n    var supplier = $manualForm.find('.js-ore-service-manualedit--supplier').val();\n    var tariff = $manualForm.find('.js-ore-service-manualedit--tariff').val();\n    var lastTicketingDate = $manualForm.find('.js-ore-service-manualedit--last-ticketing-date').val();\n\n    if (pnr === '') {\n      if (ServiceStorage.offerInfo.pnr.pnrNumber !== undefined) {\n        pnr = ServiceStorage.offerInfo.pnr.pnrNumber;\n      } else {\n        KT.notify('reservationNumberNotSet');\n        return false;\n      }\n    }\n\n    if (supplier === '') { supplier = this.supplierCode; } //!!!!\n\n    lastTicketingDate = (lastTicketingDate !== '') ?\n      moment(lastTicketingDate,'DD.MM.YYYY').format('YYYY-MM-DD HH:mm:ss') : null;\n\n    return {\n      'serviceId': ServiceStorage.serviceId,\n      'reservationData': [{\n        'reservationAction' : 'update',\n        'PNR': pnr,\n        'aviaReservation': {\n          'PNR': pnr,\n          'segments': null,\n          'supplierCode': supplier,\n          'status' : 1\n        },\n        'flightTariff': tariff,          \n        'lastTicketingDate': lastTicketingDate\n      }]\n    };\n  };\n\n  /**\n  * Получение параметров для команды изменения билетов\n  * @param {Object} $manualForm - [jQuery DOM] форма ручного редактирования услуги\n  */\n  AviaServiceViewModel.prototype.getChangeTicketDataParams = function($manualForm) {\n    var $changeTicketForm = $manualForm.find('.js-ore-service-manualedit--change-avia-ticket');\n    var changingTicketSelect = $changeTicketForm.find('.js-ore-service-manualedit--current-ticket-number')[0].selectize;\n    \n    var changingTicketNumber = changingTicketSelect.getValue();\n    var changingTicket;\n\n    if (changingTicketNumber === '' || changingTicketNumber === null) {\n      KT.notify('changingTicketNotSelected');\n      return false;\n    } else {\n      changingTicket = changingTicketSelect.options[changingTicketNumber];\n    }\n\n    var newTicketNumber = $changeTicketForm.find('.js-ore-service-manualedit--new-ticket-number').val();\n    if (newTicketNumber === '') {\n      KT.notify('ticketNumberNotEntered');\n      return false;\n    }\n\n    return {\n      'serviceId': this.ServiceStorage.serviceId,\n      'ticketData': {\n        'ticketAction': 'update',\n        'ticketNumber': changingTicket.number,\n        'ticketData': {\n          'pnr': changingTicket.pnr,\n          'touristId': changingTicket.tourist.id,\n          'ticketNumber': newTicketNumber,\n          'ticketStatus': 1,\n          'newTicket': null\n        }\n      }\n    };\n  };\n\n  /**\n  * Получение параметров для команды создания билета\n  * @param {Object} $manualForm - [jQuery DOM] форма ручного редактирования услуги\n  */\n  AviaServiceViewModel.prototype.getAddTicketParams = function($manualForm) {\n    var $addTicketForm = $manualForm.find('.js-ore-service-manualedit--add-avia-ticket');\n    var newTicketNumber = $addTicketForm.find('.js-ore-service-manualedit--new-ticket-number').val();\n    if (newTicketNumber === '') {\n      KT.notify('ticketNumberNotEntered');\n      return false;\n    }\n    var touristId = $addTicketForm.find('.js-ore-service-manualedit--new-ticket-tourist').val();\n    if (touristId === '') {\n      KT.notify('ticketTouristNotSet');\n      return false;\n    }\n\n    return {\n      'serviceId': this.ServiceStorage.serviceId,\n      'ticketData': {\n        'ticketAction': 'add',\n        'ticketNumber': null,\n        'ticketData': {\n          'pnr': this.ServiceStorage.offerInfo.pnr.pnrNumber,\n          'touristId': +touristId,\n          'ticketNumber': newTicketNumber,\n          'ticketStatus': 1,\n          'newTicket': null\n        }\n      }\n    };\n  };\n\n  return AviaServiceViewModel;\n\n}));\n","(function(global, factory){\n\n    KT.crates.OrderEdit.services.HotelServiceViewModel = factory(KT.crates.OrderEdit);\n\n}(this, function(crate) {\n  var ServiceViewModel = crate.services.ServiceViewModel;\n\n  /** карта категорий отеля */\n  var categoryMap = {\n    'FIVE': 5,\n    'FOUR': 4,\n    'THREE': 3,\n    'TWO': 2,\n    'ONE': 1\n  };\n\n  /**\n  * View-объект для отображения оффера проживания\n  * @constructor\n  * @param {ServiceStorage} ServiceStorage - данные услуги\n  * @param {Object} templates - ссылка на коллекцию шаблонов модуля\n  * @param {Object} suppliersMap - список поставщиков\n  */\n  var HotelServiceViewModel = ServiceViewModel.extend(function(ServiceStorage, templates, suppliersMap) {\n    ServiceViewModel.call(this, ServiceStorage, templates);\n\n    this.serviceTypeName = 'hotel';\n\n    this.touristsAges = {\n      'adults': {\n        'ordered':ServiceStorage.declaredTouristAges.adults,\n        'current':0\n      },\n      'children': {\n        'ordered':ServiceStorage.declaredTouristAges.children,\n        'current':0\n      }\n    };\n\n    this.bookTermsView = '';\n\n    this.hotelName = ServiceStorage.name;\n    this.hotelAddress = '';\n    this.hotelPhoto = '';\n    this.category = null;\n    this.roomType = '';\n\n    this.reservationData = false;\n    this.voucherLink = false;\n    this.hasAdditionalServices = false;\n\n    this.touristsMap = [];\n\n    if (!ServiceStorage.isPartial) {      \n      this.supplierCode = ServiceStorage.offerInfo.supplierCode;\n      this.supplierName = (suppliersMap[this.supplierCode] !== undefined) ?\n          suppliersMap[this.supplierCode].name :\n          this.supplierCode;\n          \n      this.tosDocumentName = ServiceStorage.tosDocumentName;\n    }\n  });\n\n  /* Шаблоны для отелей */\n  HotelServiceViewModel.templates = {\n    hotelFormHeader: 'orderEdit/services/hotel/hotelFormHeader',\n    hotelFormMain: 'orderEdit/services/hotel/hotelFormMain',\n    hotelServiceActions: 'orderEdit/services/hotel/hotelServiceActions',\n    hotelBookTerms: 'orderEdit/services/hotel/hotelBookTerms',\n    hotelFullInfo: 'orderEdit/services/hotel/hotelFullInfo',\n    hotelAdditionalServices: 'orderEdit/services/hotel/hotelAdditionalServices',\n    hotelMinimalPrice: 'orderEdit/services/hotel/hotelMinimalPrice',\n    hotelManualForm: 'orderEdit/services/hotel/hotelManualForm'\n  };\n\n  /**  Подготовка шаблонов */\n  HotelServiceViewModel.prototype.prepareViews = function() {\n    if (!this.ServiceStorage.isPartial) {\n      this.processHotelInfo();\n      this.processReservation();\n      this.processCustomFields();\n    }\n\n    this.prepareHeaderView();\n    this.prepareMainView();\n    this.prepareAdditionalServicesView();\n    this.prepareActionsView();\n    this.prepareBookTermsView();\n  };\n\n  /** Обработка информации об отеле */\n  HotelServiceViewModel.prototype.processHotelInfo = function() {\n    var ServiceStorage = this.ServiceStorage;\n\n    this.hotelName = (ServiceStorage.offerInfo.hotelInfo !== null) ? \n        ServiceStorage.offerInfo.hotelInfo.name : 'нет названия';\n\n    this.hotelAddress = (ServiceStorage.offerInfo.hotelInfo !== null) ? \n        ServiceStorage.offerInfo.hotelInfo.address : 'нет адреса';\n\n    this.hotelPhoto = (ServiceStorage.offerInfo.hotelInfo !== null) ? \n        ServiceStorage.offerInfo.hotelInfo.mainImageUrl : '';\n\n    this.category = (\n        ServiceStorage.offerInfo.hotelInfo === null || \n        ServiceStorage.offerInfo.hotelInfo.category === null\n      ) ? false : (function(c) {\n        var stars = [];\n        if (categoryMap[c] !== undefined) {\n          for (var i = 0; i < categoryMap[c]; i++) {\n            stars.push(true);\n          }\n        }\n        return stars;\n      }(ServiceStorage.offerInfo.hotelInfo.category));\n\n    this.roomType = ServiceStorage.offerInfo.roomType;\n  };\n\n  /** Обработка данных брони и ваучеров */\n  HotelServiceViewModel.prototype.processReservation = function() {\n    var ServiceStorage = this.ServiceStorage;\n\n    this.reservationData = (ServiceStorage.offerInfo.hotelReservations !== null) ?\n          {'number': ServiceStorage.offerInfo.hotelReservations.reservationNumber} : \n          false;\n    \n    this.voucherLink = (\n        ServiceStorage.offerInfo.hotelReservations !== null && \n        ServiceStorage.offerInfo.hotelReservations.hotelVouchers !== null && \n        Array.isArray(ServiceStorage.offerInfo.hotelReservations.hotelVouchers)\n      ) ? ServiceStorage.offerInfo.hotelReservations.hotelVouchers[0].receiptUrl : false;\n  };\n\n  /** Обработка дополнительных полей  */\n  HotelServiceViewModel.prototype.processCustomFields = function() {\n    var self = this;\n    var unprocessedFields = ServiceViewModel.prototype.processCustomFields.call(this);\n\n    // Обработка специализированных доп. полей\n    if (Array.isArray(unprocessedFields)) {\n      unprocessedFields.forEach(function(fieldData) {\n        switch (fieldData.typeTemplate) {\n          case 5: // minimal price\n            if (fieldData.value === null) { return; }\n            var minimalPriceData = JSON.parse(fieldData.value);\n\n            self.minimalPriceView = Mustache.render(self.tpl.hotelMinimalPrice, {\n              'hotelName': minimalPriceData.hotelName,\n              'room': minimalPriceData.roomType,\n              'mealType': minimalPriceData.mealType,\n              'price': Number(minimalPriceData.price).toMoney(0,',',' '),\n              'currency': KT.getCatalogInfo('lcurrency', minimalPriceData.currency, 'icon')\n            });\n            break;\n        }\n      });\n    }\n  };\n\n  /** Подготовка интерфейса шапки */\n  HotelServiceViewModel.prototype.prepareHeaderView = function() {\n    var self = this;\n    var ServiceStorage = this.ServiceStorage;\n\n    var dateFrom = ServiceStorage.startDate;\n    var dateTo = ServiceStorage.endDate;\n    var nightsCount = dateTo.startOf('day').diff(dateFrom.startOf('day'), 'days');\n    var daysCount = nightsCount + 1;\n\n    this.headerView = Mustache.render(this.tpl.hotelFormHeader, {\n      'priorityOffer': !ServiceStorage.hasTravelPolicy ? false :\n        ServiceStorage.offerInfo.travelPolicy.priorityOffer,\n      'isPartial': ServiceStorage.isPartial,\n      'roomType': (!ServiceStorage.isPartial) ? ServiceStorage.offerInfo.roomType : '',\n      'hotelId': (!ServiceStorage.isPartial) ? ServiceStorage.offerInfo.hotelId : '',\n      'hotelName': self.hotelName,\n      'hotelAddress': self.hotelAddress,\n      'hotelPhoto': self.hotelPhoto,\n      'category': self.category,\n      'priceLocal': Number(ServiceStorage.prices.inLocal.client.gross).toMoney(0,',',' '),\n      'priceInView': Number(ServiceStorage.prices.inView.client.gross).toMoney(0,',',' '),\n      'viewCurrencyIcon': KT.getCatalogInfo(\n          'lcurrency', ServiceStorage.prices.inView.currencyCode,'icon'\n        ),\n      'statusIcon': KT.getCatalogInfo('servicestatuses', ServiceStorage.status, 'icon'),\n      'statusTitle': (KT.profile.userType === 'op' && ServiceStorage.status === 9) ?\n        'Ручной режим' :\n        KT.getCatalogInfo('servicestatuses', ServiceStorage.status, 'title'),\n      'dateFrom': {\n        'wd': dateFrom.format('dd'),\n        'dm': dateFrom.format('DD.MM')\n      },\n      'dateTo': {\n        'wd': dateTo.format('dd'),\n        'dm': dateTo.format('DD.MM')\n      },\n      'days': {\n        'count': daysCount,\n        'label': declOfNum(daysCount,['день','дня','дней'])\n      },\n      'residents': {\n        'adults': ServiceStorage.declaredTouristAges.adults,\n        'children': ServiceStorage.declaredTouristAges.children,\n      },\n      'reservationData': self.reservationData,\n      'voucherLink': self.voucherLink\n    });\n  };\n\n  /** Подготовка интерфейса главного блока */\n  HotelServiceViewModel.prototype.prepareMainView = function() {\n    var ServiceStorage = this.ServiceStorage;\n\n    var dateFrom = ServiceStorage.startDate;\n    var dateTo = ServiceStorage.endDate;\n    var nightsCount = dateTo.startOf('day').diff(dateFrom.startOf('day'), 'days');\n    var daysCount = nightsCount + 1;\n\n    if (!ServiceStorage.isPartial) {\n      this.mainView = Mustache.render(this.tpl.hotelFormMain, {\n        'offerSupplier': (KT.profile.userType === 'op') ? this.supplierName : false,\n        'roomType': this.roomType,\n        'roomTypeDescription':(\n            typeof ServiceStorage.offerInfo.roomTypeDescription === 'string' &&\n            ServiceStorage.offerInfo.roomTypeDescription !== ''\n          ) ? ServiceStorage.offerInfo.roomTypeDescription.replace(/<\\/?[^>]+>/gi, '') : false,\n        'mealType': ServiceStorage.offerInfo.mealType,\n        'daysCount': daysCount + ' ' + declOfNum(daysCount,['день','дня','дней']),\n        'nightsCount': nightsCount + ' ' + declOfNum(nightsCount,['ночь','ночи','ночей']),\n        'fareName':(\n            typeof ServiceStorage.offerInfo.fareName === 'string' &&\n            ServiceStorage.offerInfo.fareName !== ''\n          ) ? ServiceStorage.offerInfo.fareName.replace(/<\\/?[^>]+>/gi, '') : false,\n        'fareDescription':(\n            typeof ServiceStorage.offerInfo.fareDescription === 'string' &&\n            ServiceStorage.offerInfo.fareDescription !== ''\n          ) ? ServiceStorage.offerInfo.fareDescription.replace(/<\\/?[^>]+>/gi, '') : false,\n        'voucherLink': this.voucherLink\n      });\n    }\n  };\n\n  /** Подготовка интерфеса дополнительных услуг */\n  HotelServiceViewModel.prototype.prepareAdditionalServicesView = function() {\n    if (this.ServiceStorage.isPartial) { return; }\n    var availableAddServices = this.ServiceStorage.offerInfo.additionalServices;\n    var issuedAddServices = this.ServiceStorage.additionalServices;\n\n    if (!Array.isArray(availableAddServices) || availableAddServices.length === 0) {\n      return;\n    }\n\n    var issuedServiceTypes = {};\n    issuedAddServices.forEach(function(addService) {\n      issuedServiceTypes[addService.serviceSubType] = {\n        'oneOfTypeAllowed': !Boolean(addService.bookingSomeServices)\n      };\n    });\n\n    this.hasAdditionalServices = true;\n\n    var addServiceTypes = {\n      1: {\n        'icon': 'service-meal',\n        'name': 'Дополнительное питание'\n      }\n    };\n\n    var self = this;\n\n    this.additionalServicesView = Mustache.render(this.tpl.hotelAdditionalServices, {\n      'issued': issuedAddServices\n        .map(function(addService) {\n          var serviceType = addService.serviceSubType;\n          if (!addServiceTypes.hasOwnProperty(serviceType)) {\n            return false;\n          }\n\n          var localSalesTerms = addService.salesTermsInfo.localCurrency.client;\n          var viewSalesTerms = addService.salesTermsInfo.viewCurrency.client;\n          var addServiceStatus = +addService.status;\n          \n          return {\n            'id': addService.idAddService,\n            'name': addService.name,\n            'typeName': addServiceTypes[serviceType].name,\n            'icon': addServiceTypes[serviceType].icon,\n            'localPrice': Number(localSalesTerms.amountBrutto).toMoney(0, ',', ' '),\n            'localCurrency': KT.getCatalogInfo('lcurrency', localSalesTerms.currency, 'icon'),\n            'viewPrice': Number(viewSalesTerms.amountBrutto).toMoney(2, ',', ' '),\n            'viewCurrency': KT.getCatalogInfo('lcurrency', viewSalesTerms.currency, 'icon'),\n            'isBooked': (addServiceStatus !== 0), //TODO: добавить 1, когда статусы будут приведены в соответствие\n            'bookedWithService': (addServiceStatus === 0 && addService.bookedWithService),\n            'bookAllowed': (addServiceStatus === 0 && !addService.bookedWithService),\n            'removeAllowed': (\n              self.ServiceStorage.checkTransition('RemoveExtraService') &&\n              addServiceStatus === 0\n            )\n          };\n        })\n        .filter(function(addService) { return addService !== false; }),\n      'available': availableAddServices\n        .map(function(addService) {\n          var serviceType = addService.serviceSubType;\n          if (!addServiceTypes.hasOwnProperty(serviceType)) {\n            return false;\n          }\n\n          var localSalesTerms = addService.salesTermsInfo.localCurrency.client;\n          var viewSalesTerms = addService.salesTermsInfo.viewCurrency.client;\n          \n          return {\n            'id': addService.idAddService,\n            'name': addService.name,\n            'typeName': addServiceTypes[serviceType].name,\n            'icon': addServiceTypes[serviceType].icon,\n            'addingAllowed': (\n                !issuedServiceTypes.hasOwnProperty(serviceType) || \n                !issuedServiceTypes[serviceType].oneOfTypeAllowed\n              ),\n            'localPrice': Number(localSalesTerms.amountBrutto).toMoney(0, ',', ' '),\n            'localCurrency': KT.getCatalogInfo('lcurrency', localSalesTerms.currency, 'icon'),\n            'viewPrice': Number(viewSalesTerms.amountBrutto).toMoney(2, ',', ' '),\n            'viewCurrency': KT.getCatalogInfo('lcurrency', viewSalesTerms.currency, 'icon')\n          };\n        })\n        .filter(function(addService) { return addService !== false; })\n    });\n  };\n\n  /** Подготовка интерфейса действий с услугой */\n  HotelServiceViewModel.prototype.prepareActionsView = function() {\n    var self = this;\n    var ServiceStorage = this.ServiceStorage;\n\n    if (!ServiceStorage.isPartial) {\n      var serviceActions = this.getServiceActions();\n\n      this.actionsView = Mustache.render(self.tpl.hotelServiceActions, serviceActions);\n    } else { this.actionsView = ''; }\n  };\n\n  /** Подготовка интерфейса условий бронирования */\n  HotelServiceViewModel.prototype.prepareBookTermsView = function() {\n    var ServiceStorage = this.ServiceStorage;\n\n    var penalties = null;\n\n    if (Array.isArray(ServiceStorage.clientCancelPenalties)) {\n      penalties = [];\n\n      ServiceStorage.clientCancelPenalties.forEach(function(penalty) {\n        penalties.push({\n          'dateFrom': penalty.dateFrom.format(KT.config.dateFormat),\n          'dateTo': penalty.dateTo.format(KT.config.dateFormat),\n          'description': penalty.description,\n          'localAmount': Number(penalty.penaltySum.inLocal.amount).toMoney(2, ',', ' '),\n          'localCurrency': KT.getCatalogInfo('lcurrency', penalty.penaltySum.inLocal.currency, 'icon'),\n          'viewAmount': Number(penalty.penaltySum.inView.amount).toMoney(2, ',', ' '),\n          'viewCurrency': KT.getCatalogInfo('lcurrency', penalty.penaltySum.inView.currency, 'icon'),\n        });\n      });\n    }\n\n    this.bookTermsView = Mustache.render(this.tpl.hotelBookTerms, {\n      'hotelName': this.hotelName,\n      'roomType': this.roomType,\n      'penalties': penalties\n    });\n  };\n\n  /** \n  * Инициализация элементов управления после рендера формы\n  * @param {Object} $container - форма услуги\n  * @todo в принципе передать управление контейнером услуги в класс viewModel?\n  */\n  HotelServiceViewModel.prototype.initControls = function($container) {\n    this.initAddServicesControls($container);\n\n    if (this.customFields.length > 0) {\n      var $customFields = $();\n\n      this.customFields.forEach(function(customField) {\n        $customFields = $customFields.add(customField.render());\n      });\n\n      $container.find('.js-service-form-custom-fields').html($customFields);\n\n      this.customFields.forEach(function(customField) {\n        customField.initialize();\n      });\n    }\n  };\n\n  /**\n  * Инициализация элементов управления формы дополнительных услуг\n  * @param {Object} $container - формв услуги\n  */\n  HotelServiceViewModel.prototype.initAddServicesControls = function($container) {\n    if (this.hasAdditionalServices) {\n      var $availableAddServicesList = $container.find('.js-service-form--available-add-services-list');\n      var $showAddServiceList = $container.find('.js-service-form--show-add-services-list');\n      var $hideAddServiceList = $container.find('.js-service-form--hide-add-services-list');\n\n      $showAddServiceList.on('click', function() {\n        $hideAddServiceList.addClass('active');\n        $showAddServiceList.removeClass('active');\n        $availableAddServicesList.slideDown(200).addClass('active');\n      });\n\n      $hideAddServiceList.on('click', function() {\n        $hideAddServiceList.removeClass('active');\n        $showAddServiceList.addClass('active');\n        $availableAddServicesList.slideUp(200).removeClass('active');\n      });\n    }\n  };\n\n  /**\n  * Связывание информации о туристах из заявки (getOrderTourists)\n  * с информацией из услуги и формирование данных для блока туристов\n  * @param {TouristStorage[]} tourists - массив информации по туристам\n  * @param {Boolean} [overrideSave] - явное указание возможности сохранения привязки\n  */\n  HotelServiceViewModel.prototype.mapTouristsInfo = function(tourists, overrideSave) {\n    var self = this;\n    var ServiceStorage = this.ServiceStorage;\n\n    this.touristsAges = {\n      'adults': {\n        'ordered': ServiceStorage.declaredTouristAges.adults,\n        'current':0\n      },\n      'children': {\n        'ordered': ServiceStorage.declaredTouristAges.children,\n        'current':0\n      }\n    };\n    this.touristsMap = [];\n\n    if (tourists.length === 0) { return; }\n    if (overrideSave === undefined) { overrideSave = false; }\n    var isSavingAllowed = (\n        !ServiceStorage.isPartial &&\n        ((ServiceStorage.status === 9 && KT.profile.userType === 'op') || ServiceStorage.status === 0)\n      );\n\n    tourists.forEach(function(TouristStorage) {\n      var isLinked = ServiceStorage.tourists.hasOwnProperty(TouristStorage.touristId);\n\n      if (!ServiceStorage.isPartial) {\n\n        // сохранение числа привязанных туристов по возрастным группам\n        if (isLinked) {\n          var age = moment.duration(\n              moment().valueOf() - TouristStorage.birthdate.valueOf()\n            ).asYears();\n          if (age < 12) { self.touristsAges.children.current += 1; }\n          else { self.touristsAges.adults.current += 1; }\n        }\n      }\n\n      if (overrideSave || isSavingAllowed || isLinked) {\n        self.touristsMap.push({\n          'allowSave': isSavingAllowed,\n          'touristId': TouristStorage.touristId,\n          'firstName': TouristStorage.firstname,\n          'surName': TouristStorage.lastname,\n          'attached': isLinked,\n          'touristExtra': ''\n        });\n      }\n    });\n  };\n\n  /**\n  * Рендер элементов управления блока туристоп\n  * @param {Object} $tourist - блок туриста\n  * @param {Object} tourist - данные туриста (touristsMap)\n  */\n  HotelServiceViewModel.prototype.renderTouristControls = function() {};\n\n  /**\n  * Получение структуры доступных действий над услугой\n  * @return {Object} идентификатор услуги и разрешения на действия\n  */\n  HotelServiceViewModel.prototype.getServiceActions = function() {\n    var ServiceStorage = this.ServiceStorage;\n\n    var serviceActions = {\n      'serviceId': ServiceStorage.serviceId,\n      'ManualEdit': (KT.profile.userType === 'op' && ServiceStorage.status === 9) ? true : false,\n      'save': (this.customFields.length > 0)\n    };\n\n    ServiceStorage.allowedTransitions.forEach(function(transition) {\n      serviceActions[transition] = true;\n    });\n\n    // хак для разного стиля кнопок, переделать?\n    if (KT.profile.userType !== 'op' && serviceActions['Manual']) {\n      serviceActions['Manual'] = false;\n      serviceActions['ToManager'] = true;\n    }\n\n    serviceActions.agreementSet = ServiceStorage.isTOSAgreementSet;\n\n    if (!serviceActions.BookStart) {\n      serviceActions.agreementDisabled = true;\n      serviceActions.agreementSet = true;\n    }\n\n    return serviceActions;\n  };\n\n  /**\n  * Создает список документов с условиями работы с услугой с методами их получения\n  * @return {Object} объект с документами и методами их получения\n  */\n  HotelServiceViewModel.prototype.defineTermsDocuments = function() {\n    var _instance = this;\n\n    var termsDocuments = {\n      'companyTOS': {\n        'load':function(renderer,loader) {\n          loader('companyTOS',renderer);\n        }\n      }\n    };\n    termsDocuments[_instance.tosDocumentName] = {\n      'load':function(renderer) {\n        renderer(_instance.tosDocumentName, _instance.bookTermsView);\n      }\n    };\n\n    return termsDocuments;\n  };\n\n  /**\n  * Рендер формы ручного редактирования улуги\n  * @return {String} - код формы редактирования услуги\n  */\n  HotelServiceViewModel.prototype.renderManualForm = function() {\n    var commonParams = ServiceViewModel.prototype.setCommonManualFormParams.call(this);\n\n    var manualFormParams = $.extend(commonParams, {\n          'reservation': (\n            this.ServiceStorage.offerInfo.hotelReservations !== null &&\n            this.ServiceStorage.offerInfo.hotelReservations.reservationNumber !== null\n          ) ? this.ServiceStorage.offerInfo.hotelReservations.reservationNumber : null\n      });\n\n    return Mustache.render(this.tpl.hotelManualForm, manualFormParams);\n  };\n\n  /**\n  * Инициализация элементов управления окна ручного редактирования услуги\n  * @param {Object} $wnd - [jQueryDom] объект окна\n  * @param {Object} mds - объект модуля\n  * @todo Убрать зависимость от модуля\n  */\n  HotelServiceViewModel.prototype.initManualFormControls = function($wnd, mds) {\n    var self = this;\n    ServiceViewModel.prototype.initManualFormControls.call(this, $wnd, mds);\n\n    var ServiceStorage = this.ServiceStorage;\n\n    /* Изменение параметров брони */\n    KT.Dictionary.getAsList('suppliers', {'serviceId': ServiceStorage.typeCode, 'active': 1})\n      .then(function(hotelSuppliers) {\n        /*\n        var suppliers = [];\n        for (var supplierCode in aviaSuppliers) {\n          if (aviaSuppliers.hasOwnProperty(supplierCode)) {\n            suppliers.push({\n              'value': supplierCode,\n              'name': aviaSuppliers[supplierCode].name\n            });\n          }\n        } */\n\n        $wnd.find('.js-ore-service-manualedit--supplier')\n          .selectize({\n            openOnFocus: true,\n            create: false,\n            valueField: 'supplierCode',\n            labelField: 'name',\n            options: hotelSuppliers,\n            items: [self.supplierCode] //!!!\n          });\n      });\n  };\n\n  /**\n  * Получение параметров для команды изменения брони\n  * @param {Object} $manualForm - [jQuery DOM] форма ручного редактирования услуги\n  */\n  HotelServiceViewModel.prototype.getChangeBookDataParams = function($manualForm) {\n    var newReservationNumber = $manualForm.find('.js-ore-service-manualedit--new-reservation-number').val();\n    var supplier = $manualForm.find('.js-ore-service-manualedit--supplier').val();\n\n    if (newReservationNumber === '') {\n      if (this.ServiceStorage.offerInfo.hotelReservations !== null) {\n        newReservationNumber = this.ServiceStorage.offerInfo.hotelReservations.reservationNumber;\n      } else {\n        return false;\n      }\n    }\n\n    if (supplier === '') { supplier = this.supplierCode; }\n\n    return  {\n      'serviceId': this.serviceId,\n      'reservationData': [{\n        'reservationNumber': newReservationNumber,\n        'supplierCode': supplier\n      }]\n    };\n  };\n\n  return HotelServiceViewModel;\n  \n}));\n","(function(global,factory) {\n\n    KT.crates.OrderEdit.services.view = factory(KT.crates.OrderEdit.services);\n\n}(this,function(crate) {\n  var AviaServiceViewModel = crate.AviaServiceViewModel;\n  var HotelServiceViewModel = crate.HotelServiceViewModel;\n\n  /**\n  * Редактирование заявки: услуги\n  * @constructor\n  * @param {Object} module - хранилище родительского модуля\n  * @param {Object} [options] - Объект конфигурации класса\n  */\n  var modView = function(module,options) {\n    this.mds = module;\n    if (options === undefined) {options = {};}\n    this.config = $.extend(true, {\n      'templateUrl': '/cabinetUI/orders/getTemplates',\n      'staticDocumentUrl': '/cabinetUI/orders/getStaticDocument',\n      'templates': {\n        serviceForm: 'orderEdit/services/serviceForm',\n        serviceTourist: 'orderEdit/services/serviceTourist',\n        serviceListEmpty: 'orderEdit/services/serviceListEmpty',\n        // staticDoc: 'orderEdit/staticDoc',\n        pricesChangedModal: 'orderEdit/modals/pricesChanged',\n        bookChangeModal: 'orderEdit/modals/bookChange',\n        bookCancelModal: 'orderEdit/modals/bookCancel',\n        sendToManagerModal: 'orderEdit/modals/sendToManager',\n        // custom fields\n        TextCF: 'orderEdit/customFields/textCF',\n        TextAreaCF: 'orderEdit/customFields/textAreaCF',\n        NumberCF: 'orderEdit/customFields/numberCF',\n        DateCF: 'orderEdit/customFields/dateCF'\n      }\n    },options);\n\n    // добавить шаблоны view-моделей услуг\n    $.extend(this.config.templates, AviaServiceViewModel.templates);\n    $.extend(this.config.templates, HotelServiceViewModel.templates);\n\n    this.mds.servicesTermsDocuments = {};\n\n    this.$serviceList = $('#cab-services');\n    this.$manualFormsRoot = $('body');\n\n    // ссылка на модальное окно изменения брони\n    this.$bookChangeModal = null;\n\n    // view-модели услуг\n    this.serviceViewModels = {};\n    // формы услуг\n    this.serviceForms = {};\n\n    // управление окном изменения брони\n    this.BookChangeModal = this.setBookChangeModal();\n    // управление окном отмены брони\n    this.BookCancelModal = this.setBookCancelModal();\n\n    // управление окном просмотра полной информации об отеле\n    this.HotelInfoPages = this.setHotelInfoPages();\n    // управление окнами редактирования услуг в ручном режиме\n    this.ManualEditForms = this.setManualEditForms();\n  };\n\n  /**\n  * Рендер услуг - общий метод\n  * @param {OrderStorage} OrderStorage - хранилище данных заявки\n  * @return {Promise} - процесс рендера\n  */\n  modView.prototype.renderServices = function(OrderStorage) {\n    var _instance = this;\n    var renderProcess = $.Deferred();\n\n    var getAviaSuppliersMap = KT.Dictionary.getAsMap('suppliers', 'supplierCode', {'serviceId': 2, 'active': 1});\n    var getHotelSuppliersMap = KT.Dictionary.getAsMap('suppliers', 'supplierCode', {'serviceId': 1, 'active': 1});\n\n    $.when(getAviaSuppliersMap, getHotelSuppliersMap)\n      .then(function(aviaSuppliersMap, hotelSuppliersMap) {\n        var serviceIds = [];\n        var termsDocuments = {};\n\n        /*\n        * сохраняем текущую позицию окна для возврата после перезагрузки форм,\n        * если есть открытые услуги, сохраняем состояние,\n        * очищаем список услуг\n        */\n        var savescroll = $('#main-scroller').scrollTop();\n        var srvFormStatus = {};\n\n        _instance.$serviceList.find('.js-service-form')\n          .each(function() {\n            srvFormStatus[$(this).attr('data-sid')] = $(this).hasClass('active');\n          })\n          .end()\n          .empty();\n\n        // обработка массива услуг\n        OrderStorage.getServices().forEach(function(ServiceStorage) {\n          var ServiceViewModel;\n          var serviceId = ServiceStorage.serviceId;\n\n          if (_instance.serviceViewModels.hasOwnProperty(serviceId)) {\n            ServiceViewModel = _instance.serviceViewModels[serviceId];\n          } else {\n            switch(ServiceStorage.typeCode) {\n              case 1:\n                ServiceViewModel = new HotelServiceViewModel(ServiceStorage, _instance.mds.tpl, hotelSuppliersMap);\n                break;\n              case 2:\n                ServiceViewModel = new AviaServiceViewModel(ServiceStorage, _instance.mds.tpl, aviaSuppliersMap);\n                break;\n              default:\n                return;\n            }\n            _instance.serviceViewModels[serviceId] = ServiceViewModel;\n          }\n\n          ServiceViewModel.prepareViews();\n          ServiceViewModel.mapTouristsInfo(OrderStorage.getTourists());\n          $.extend(termsDocuments, ServiceViewModel.defineTermsDocuments());\n          _instance.ManualEditForms.prepare(ServiceViewModel);\n\n          var $serviceForm = $(\n              Mustache.render(_instance.mds.tpl.serviceForm, {\n                'serviceId':ServiceStorage.serviceId,\n                'isCancelled': (ServiceStorage.status === 7 || ServiceStorage.penaltySums !== null),\n                'serviceName': KT.getCatalogInfo('servicetypes', ServiceStorage.typeCode, 'title'),\n                'serviceType': ServiceStorage.typeCode,\n                'serviceTypeName': ServiceViewModel.serviceTypeName,\n                'serviceIcon': KT.getCatalogInfo('servicetypes',ServiceStorage.typeCode,'icon'),\n                'penalty': (ServiceStorage.penaltySums === null) ? null : {\n                    'client': {\n                      'inLocal': ServiceStorage.penaltySums.inLocal.client.toMoney(0,',',' '),\n                      'inView': ServiceStorage.penaltySums.inView.client.toMoney(2,',',' '),\n                      'viewCurrencyIcon': KT.getCatalogInfo(\n                          'lcurrency', ServiceStorage.penaltySums.inView.currencyCode, 'icon'\n                        )\n                    },\n                    'supplier': (KT.profile.userType !== 'op') ? null : {\n                      'inLocal': ServiceStorage.penaltySums.inLocal.supplier.toMoney(0,',',' '),\n                      'inView': ServiceStorage.penaltySums.inView.supplier.toMoney(2,',',' '),\n                      'viewCurrencyIcon': KT.getCatalogInfo(\n                          'lcurrency', ServiceStorage.penaltySums.inView.currencyCode, 'icon'\n                        )\n                    }\n                  },\n                'header': ServiceViewModel.headerView,\n                'main': ServiceViewModel.mainView,\n                'additionalServices': (!ServiceViewModel.hasAdditionalServices) ? null :\n                  ServiceViewModel.additionalServicesView,\n                'minimalPrice': ServiceViewModel.minimalPriceView,\n                'travelPolicyViolations': (!ServiceStorage.hasTPViolations) ? null : \n                  {'list': ServiceStorage.offerInfo.travelPolicy.travelPolicyFailCodes},\n                'allowTouristAdd': (\n                    OrderStorage.isAddTouristAllowed &&\n                    ServiceViewModel.checkTouristAddAllowance()\n                  ) ? true : false,\n                'tourists': '', //touristsList /** @deprecated */ */\n                'hasCustomFields': (ServiceViewModel.customFields.length > 0)\n              })\n            )\n            .appendTo(_instance.$serviceList)\n            .data('unsaved', false);\n\n          ServiceViewModel.initControls($serviceForm);\n\n          _instance.serviceForms[serviceId] = $serviceForm;\n\n          if (srvFormStatus[ServiceStorage.serviceId] === true) {\n            $serviceForm.addClass('active');\n          }\n\n          _instance.serviceForms[ServiceStorage.serviceId] = $serviceForm;\n          serviceIds.push(serviceId);\n        });\n\n        $('#main-scroller').scrollTop(savescroll);\n\n        _instance.prepareServiceTermsDocuments(termsDocuments);\n\n        serviceIds.forEach(function(serviceId) {\n          _instance.serviceForms[serviceId]\n            .find('.js-service-form-actions')\n              .html(_instance.serviceViewModels[serviceId].actionsView)\n              .end()\n            .find('.js-service-form-tos-agreement')\n              .on('click','.js-service-form-tos-agreement--tos-link',function() {\n                var doc = $(this).attr('data-link');\n                _instance.mds.servicesTermsDocuments[doc].open();\n              });\n          \n          _instance.renderServiceTourists(serviceId);\n        });\n\n        _instance.getServiceTermsDocuments(termsDocuments);\n        renderProcess.resolve();\n      });\n\n      return renderProcess.promise();\n  };\n\n  /** Вывод информации об отсутствии услуг для вывода */\n  modView.prototype.renderEmptyServiceList = function() {\n    this.$serviceList.html(Mustache.render(this.mds.tpl.serviceListEmpty, {}));\n  };\n\n  /**\n  * Отображение лоадера в процессе обработки услуги\n  * @todo перенести в центральный класс вьюх?\n  * @param {Integer} serviceId - ID редактируемой услуги\n  */\n  modView.prototype.renderPendingServiceProcess = function(serviceId) {\n    this.serviceForms[serviceId].find('.js-service-form-actions')\n      .html(Mustache.render(KT.tpl.spinner, {'type':'medium'}));\n  };\n\n  /**\n  * Раскрыть полную информацию об услуге и *дослайдить* до нее \n  * @param {Integer} serviceId - ID услуги\n  */\n  modView.prototype.navigateToService = function(serviceId) {\n    var $service = this.serviceForms[serviceId];\n    console.log('navigating to service: ' + serviceId + ', offset: ' + $service.offset().top);\n\n    if ($service !== undefined) {\n      $('#main-scroller').animate({'scrollTop': $service.offset().top}, 400, function() {\n        $service.addClass('active');\n      });\n    }\n  };\n\n  /**\n  * Рендер блока туристов конкретной услуги\n  * @param {Integer} serviceId - ID услуги\n  * @todo переделать view-модели и этот метод\n  */\n  modView.prototype.renderServiceTourists = function(serviceId) {\n    var _instance = this;\n\n    var $serviceForm = _instance.serviceForms[serviceId];\n    var ServiceViewModel = _instance.serviceViewModels[serviceId];\n    var ServiceStorage = ServiceViewModel.ServiceStorage;\n\n    ServiceViewModel.mapTouristsInfo(_instance.mds.OrderStorage.getTourists());\n\n    var $serviceTourists = $serviceForm.find('.js-service-form-tourists');\n    $serviceTourists.data('unsaved', false).empty();\n\n    ServiceViewModel.touristsMap.forEach(function(tourist) {\n      var $tourist = $(Mustache.render(_instance.mds.tpl.serviceTourist, tourist))\n        .appendTo($serviceTourists);\n      ServiceViewModel.renderTouristControls($tourist, tourist);\n    });    \n\n    if (ServiceStorage.checkAllTouristsLinked()) {\n      $serviceForm.find('.js-service-form--add-tourist').remove();\n    }\n  };\n\n  /**\n  * Рендер доступных действий с услугой \n  * @param {Integer} serviceId - ID услуги\n  */\n  modView.prototype.renderServiceActions = function(serviceId) {\n    var ServiceViewModel = this.serviceViewModels[serviceId];\n    var $serviceForm = this.serviceForms[serviceId];\n\n    ServiceViewModel.prepareActionsView();\n\n    $serviceForm.find('.js-service-form-actions')\n      .html(ServiceViewModel.actionsView);\n  };\n\n  /**\n  * Сбор данных из блока туристов услуги \n  * @param {Integer} serviceId - ID услуги\n  * @return {Object} данные по привязке и дополнительные данные туристов\n  */\n  modView.prototype.getServiceTouristsData = function(serviceId) {\n    var touristData = {};\n    var errors = false;\n\n    this.serviceForms[serviceId].find('.js-service-form-tourist')\n      .each(function() {\n        var $bindControl = $(this).find('.js-service-form-tourist--service-bound');\n        var touristId = +$bindControl.attr('data-touristid');\n\n        touristData[touristId] = {\n          'state': $bindControl.prop('checked'),\n          'loyalityProviderId': null,\n          'loyalityCardNumber': null\n        };\n\n        var $loyalityProgramSelect = $(this).find('.js-service-avia-loyalty-program');\n        if ($loyalityProgramSelect.length !== 0) {\n          var $loyalityProvider = $loyalityProgramSelect.find('.js-service-avia-loyalty-program--provider');\n          var $loyalityNumber = $loyalityProgramSelect.find('.js-service-avia-loyalty-program--number');\n\n          if ($loyalityNumber.val() !== '') {\n            if ($loyalityProvider.val() === '') {\n              errors = true;\n              KT.notify('saveServiceFailedIncorrectLoyality');\n              $loyalityNumber\n                .addClass('error')\n                .one('focus', function() {\n                  $loyalityNumber.removeClass('error');\n                });\n            } else {\n              touristData[touristId].loyalityProviderId = $loyalityProvider.val();\n              touristData[touristId].loyalityCardNumber = $loyalityNumber.val();\n            }\n          }\n        }\n      });\n\n    return (!errors) ? touristData : false;\n  };\n\n  /**\n  * Подготовка окон для документов с условиями работы с услугой\n  * @param {Object} termsDocuments - список документов, определенных для услуги\n  */\n  modView.prototype.prepareServiceTermsDocuments = function(termsDocuments) {\n    for (var doc in termsDocuments) {\n        this.mds.servicesTermsDocuments[doc] = $.featherlight(\n          //$(Mustache.render(this.mds.tpl.staticDoc,{docName:doc})),\n          Mustache.render(KT.tpl.lightbox, {\n              classes: 'js-service-form--staticdoc', \n              attributes: 'data-doc=\"doc\"'\n            }\n          ),\n          {\n            persist:true,\n            closeIcon:'',\n            openSpeed:0,\n            closeSpeed:0\n        });\n        this.mds.servicesTermsDocuments[doc].close();\n        this.mds.servicesTermsDocuments[doc].openSpeed = 250;\n        this.mds.servicesTermsDocuments[doc].closeSpeed = 250;\n    }\n  };\n\n  /**\n  * Загрузка и отображение документов с условиями работы с услугой\n  * @param {Object} termsDocuments - список документов\n  */\n  modView.prototype.getServiceTermsDocuments = function(termsDocuments) {\n    var _instance = this;\n\n    var renderer = function(document,data) {\n      _instance.mds.servicesTermsDocuments[document].$content.html(data);\n      return _instance.mds.servicesTermsDocuments[document].$content;\n    };\n\n    var loader = function(document,callback) {\n      $.ajax({\n        type: 'POST',\n        data: JSON.stringify({'document':document}),\n        contentType: 'application/json; charset=utf-8',\n        url: _instance.config.staticDocumentUrl,\n        success: function (data) {\n          var loadedData;\n          try {\n            loadedData = JSON.parse(data);\n            if (loadedData.status === 0) {\n              callback(document,loadedData.document);\n            } else {\n              callback('Document not found');\n            }\n          } catch (e) {\n            console.error(\"Не получилось загрузить статические документы =(\");\n            callback('Document not found');\n          }\n        }\n      });\n    };\n\n    for (var doc in termsDocuments) {\n      termsDocuments[doc].load(renderer,loader);\n    }\n  };\n\n  /**\n  * Только для авиа - обновление правил тарифа\n  * @param {Integer} serviceId - ID услуги\n  * @param {Object} [data] - данные правил тарифа, если они есть\n  */\n  modView.prototype.updateFareRules = function(serviceId, data) {\n    var serviceView = this.serviceViewModels[serviceId];\n    var fareRuleDocument = serviceView.ServiceStorage.fareRuleDocumentName;\n\n    if (data === undefined) {\n      // пустые правила тарифа\n      serviceView.prepareEmptyFareRulesView();\n    } else {\n      serviceView.prepareFareRulesView();\n    }\n    this.mds.servicesTermsDocuments[fareRuleDocument].$content.html(serviceView.fareRulesView);\n  };\n\n  /**\n  * Обновление формы дополнительных услуг \n  */\n  modView.prototype.updateAdditionalServices = function(serviceId) {\n    var ServiceViewModel = this.serviceViewModels[serviceId];\n    var $serviceForm = this.serviceForms[serviceId];\n\n    ServiceViewModel.prepareAdditionalServicesView();\n    $serviceForm.find('.js-service-form--add-services')\n      .html(ServiceViewModel.additionalServicesView);\n    ServiceViewModel.initAddServicesControls($serviceForm);\n  };\n\n  /**\n  * Сбор значений дополнительных полей услуги\n  * @param {Integer} serviceId - ID услуги\n  * @return {Array|null} - массив доп. полей или null в случае ошибки\n  */\n  modView.prototype.getCustomFieldsValues = function(serviceId) {\n    var ServiceViewModel = this.serviceViewModels[serviceId];\n    return ServiceViewModel.getCustomFieldsValues();\n  };\n\n  /**\n  * Управление выводом окон редактироваия услуг в ручном режиме\n  */\n  modView.prototype.setManualEditForms = function() {\n    var _instance = this;\n\n    var ManualEditForms = {\n      elem: {\n        $root: $('body')\n      },\n      forms: {},\n      prepare: function(ServiceViewModel) {\n        if (KT.profile.userType !== 'op') { return; }\n\n        var ServiceStorage = ServiceViewModel.ServiceStorage;\n        var serviceId = ServiceStorage.serviceId;\n\n        if (ServiceStorage.status === 9) {\n          // подготовка или обнуление окна формы\n          if (this.forms[serviceId] === undefined) {\n            this.forms[serviceId] = $.featherlight(Mustache.render(KT.tpl.lightbox, {}), {\n              persist:true,\n              variant:'featherlight--fix-scroll',\n              closeIcon:'',\n              openSpeed:0,\n              closeSpeed:0\n            });\n            this.forms[serviceId].close();\n            this.forms[serviceId].openSpeed = 250;\n            this.forms[serviceId].closeSpeed = 250;\n          } else {\n            this.forms[serviceId].$content.html(Mustache.render(KT.tpl.spinner, {}));\n            this.forms[serviceId].$content.off();\n          }\n          this.forms[serviceId].manualFormRendered = false;\n        } else {\n          // очистка формы \n          if (this.forms[serviceId] !== undefined) {\n            /** @todo find out where persisted featherlight is stored & kill it */\n            delete this.forms[serviceId];\n          }\n        }\n      },\n      open: function(serviceId) {\n        if (KT.profile.userType !== 'op') { return; }\n\n        var ServiceViewModel = _instance.serviceViewModels[serviceId];\n        var manualForm = this.forms[serviceId];\n\n        if (manualForm === undefined) {\n          console.warn('для услуги ' + serviceId + ' не создана форма работы в ручном режиме!');\n          KT.notify('noManualEditForm');\n          return;\n        }\n\n        manualForm.open();\n\n        if (!manualForm.manualFormRendered) {\n          manualForm.$content.html(ServiceViewModel.renderManualForm(_instance.mds));\n          ServiceViewModel.initManualFormControls(manualForm.$content, _instance.mds);\n          manualForm.manualFormRendered = true;\n          // нормализация высоты табов\n          var $tabs = manualForm.$content.find('.js-ore-service-manualedit--tab');\n          var maxHeight = 0;\n          $tabs.each(function() {\n            if ($(this).height() > maxHeight) {\n              maxHeight = $(this).height();\n            }\n          });\n          $tabs.height(maxHeight);\n        }\n      },\n      getSaveServiceDataParams: function(serviceId) {\n        var ServiceStorage = _instance.serviceViewModels[serviceId].ServiceStorage;\n\n        var $manualForm = this.forms[serviceId].$content.find('.js-ore-service-manualedit');\n\n        var startDate = $manualForm.find('.js-ore-service-manualedit--start-date').val();\n        var endDate = $manualForm.find('.js-ore-service-manualedit--end-date').val();\n\n        var agencyProfit = $manualForm.find('.js-ore-service-manualedit--agent-commission').val();\n        agencyProfit = (agencyProfit !== '') ? parseFloat(agencyProfit.replace(/\\s+/g,'').replace(',','.')) : null;\n\n        var clientPrice = $manualForm.find('.js-ore-service-manualedit--client-gross-price').val();\n        clientPrice = (clientPrice !== '') ? parseFloat(clientPrice.replace(/\\s+/g,'').replace(',','.')) : null;\n\n        var currency = $manualForm.find('.js-ore-service-manualedit--currency').val();\n\n        var clientCancelPenalties = [];\n        $manualForm.find('.js-ore-service-manualedit--client-cancel-penalty').each(function() {\n          var penaltyIndex = +$(this).data('id');\n          var penaltyCurrency = $(this).data('currency');\n          var penaltyAmount = $(this).find('.js-ore-service-manualedit--client-cancel-penalty-amount').val();\n          var cancelPenalty = ServiceStorage.clientCancelPenalties[penaltyIndex];\n\n          clientCancelPenalties.push({\n            'dateFrom': cancelPenalty.dateFrom.format('YYYY-MM-DD HH:mm'),\n            'dateTo': cancelPenalty.dateTo.format('YYYY-MM-DD HH:mm'),\n            'description': cancelPenalty.description,\n            'penalty': {\n              'amount': (penaltyAmount !== '') ? parseFloat(penaltyAmount.replace(/\\s+/g,'').replace(',','.')) : 0,\n              'currency': penaltyCurrency\n            }\n          });\n        });\n\n        return {\n          'serviceId': serviceId,\n          'orderServiceData': {\n            'dateStart': (startDate !== '') ? moment(startDate,'DD.MM.YYYY').format('YYYY-MM-DD') : null,\n            'dateFinish': (endDate !== '') ? moment(endDate,'DD.MM.YYYY').format('YYYY-MM-DD') : null,\n            'agencyProfit': agencyProfit,\n            'cancelPenalties': {\n              'client': clientCancelPenalties\n            },\n            'salesTerms': {\n              'client':{\n                'amountBrutto': clientPrice,\n                'currency': currency\n              }\n            }\n          }\n        };\n      },\n      getSaveServiceStatusParams: function(serviceId) {\n        var service = _instance.mds.OrderStorage.services[serviceId];\n        var $manualForm = this.forms[serviceId].$content.find('.js-ore-service-manualedit');\n\n        var newStatus = $manualForm.find('.js-ore-service-manualedit--change-status').val();\n        var setOffline = $manualForm.find('.js-ore-service-manualedit--set-offline').prop('checked');\n        var comment = $manualForm.find('.js-ore-service-manualedit--status-comment').val();\n\n        var params = {\n          'serviceId': serviceId,\n          'serviceStatus': (newStatus !== '' && +newStatus !== service.status) ?\n            +newStatus : null,\n          'online': setOffline ? false : null,\n          'comment': comment\n        };\n\n        return params;\n      },\n      getChangeBookDataParams: function(serviceId) {\n        var $manualForm = this.forms[serviceId].$content.find('.js-ore-service-manualedit');\n        if (_instance.serviceViewModels[serviceId].getChangeBookDataParams !== undefined) {\n          return _instance.serviceViewModels[serviceId].getChangeBookDataParams($manualForm);\n        } else { return false; }\n      },\n      getChangeTicketDataParams: function(serviceId) {\n        var $manualForm = this.forms[serviceId].$content.find('.js-ore-service-manualedit');\n        if (_instance.serviceViewModels[serviceId].getChangeTicketDataParams !== undefined) {\n          return _instance.serviceViewModels[serviceId].getChangeTicketDataParams($manualForm);\n        } else { return false; }\n      },\n      getAddTicketParams: function(serviceId) {\n        var $manualForm = this.forms[serviceId].$content.find('.js-ore-service-manualedit');\n        if (_instance.serviceViewModels[serviceId].getAddTicketParams !== undefined) {\n          return _instance.serviceViewModels[serviceId].getAddTicketParams($manualForm);\n        } else { return false; }\n      }\n    };\n\n    return ManualEditForms;\n  };\n\n  /**\n  * Управление выводом полной информации по отелям\n  * @return {Object} - модуль управления выводом полной информации об отеле\n  */\n  modView.prototype.setHotelInfoPages = function() {\n    var _instance = this;\n\n    var HotelInfoPages = {\n      loaded: {},\n      dummyPhoto: '/resources/hotels/dummy.jpg',\n      photoLinkTest: /^(http|[^\\/]{2,}\\.[^\\/.]{2,}\\/).*/,\n      categoryMap: {\n        'ONE':1,\n        'TWO':2,\n        'THREE':3,\n        'FOUR':4,\n        'FIVE':5\n      },\n      serviceGroupMap: {\n        'Продленная регистрация': 'prolonged-regtime',\n        'В номере': 'room-service',\n        'Общие': 'general',\n        'Стойка регистрации': 'reception',\n        'Дети': 'children',\n        'НА свежем воздухе': 'fresh-air',\n        'Бизнес': 'business',\n        'Развлечения': 'entertainment',\n        'Питание и напитки': 'food-n-drink',\n        'Спорт/Здоровье': 'sports',\n        'Трансфер': 'transfer',\n        'Парковка': 'parking',\n        'Сейф': 'safe',\n        'Персонал говорит': 'staff-lang',\n        'Интернет': 'internet',\n        'Домашние животные': 'pet'\n      },\n      init: function(hotelId) {\n        if (!this.loaded.hasOwnProperty(hotelId)) {\n          this.loaded[hotelId] = $.featherlight(Mustache.render(KT.tpl.lightbox, {}), {\n            persist:true,\n            closeIcon:'',\n            openSpeed:250,\n            closeSpeed:250\n          });\n          return true;\n        } else {\n          return false;\n        }\n      },\n      render: function(hotel) {\n        var self = this;\n\n        /* вывести краткое описание наверх списка */\n        if (Array.isArray(hotel.descriptions)) {\n          var descriptionTypes = {};\n\n          // убрать дубли\n          hotel.descriptions.forEach(function(description) {\n            descriptionTypes[description.descriptionType] = description;\n          });\n\n          hotel.descriptions = [];\n\n          for (var type in descriptionTypes) {\n            descriptionTypes[type].description = htmlDecode(descriptionTypes[type].description);\n            // краткое описание в начало списка\n            if (type !== 'short') {\n              hotel.descriptions.push(descriptionTypes[type]);\n            } else {\n              hotel.descriptions.unshift(descriptionTypes[type]);\n            }\n          }\n        }\n        \n        var serviceMap = {};\n        hotel.services.forEach(function(service) {\n          var icon = self.serviceGroupMap[service.serviceGroupCode];\n          if (icon !== undefined) {\n            if (serviceMap[icon] === undefined) {\n              serviceMap[icon] = {\n                'group': service.serviceGroupCode,\n                'icon': icon,\n                'list': []\n              };\n            }\n\n            serviceMap[icon].list.push({'name':service.name});\n          }\n        });\n\n        var services = [];\n        for (var group in serviceMap) {\n          if (serviceMap.hasOwnProperty(group)) {\n            services.push(serviceMap[group]);\n          }\n        }\n        services.sort(function(a,b) {\n          if (a.list.length > b.list.length) { return 1; }\n          else if (a.list.length < b.list.length) { return -1; }\n          else { return 0; }\n        });\n\n        var hotelInfo = {\n          'name': hotel.name,\n          'icon': hotel,\n          'hotelChain': (hotel.hotelChain === '') ? null : hotel.hotelChain,\n          'mainImage': (\n              hotel.mainImageUrl !== undefined &&\n              hotel.mainImageUrl !== null &&\n              this.photoLinkTest.test(String(hotel.mainImageUrl))\n            ) ?\n              hotel.mainImageUrl :\n              this.dummyPhoto,\n          'category': (hotel.category === null || this.categoryMap[hotel.category] === undefined) ? false :\n            (function(category){\n              var stars = [];\n              for (var i = 0; i < category; i++) {\n                stars.push(true);\n              }\n              return stars;\n            }(this.categoryMap[hotel.category])),\n          'city': hotel.cityName,\n          'country': hotel.countryName, \n          'checkIn': (hotel.checkInTime !== null) ? \n            moment(hotel.checkInTime,'HH:mm:ss').format('HH:mm') : null, \n          'checkOut': (hotel.checkOutTime !== null) ? \n            moment(hotel.checkOutTime,'HH:mm:ss').format('HH:mm') : null, \n          'address': hotel.address,\n          'distance': hotel.distance,\n          'phone': hotel.phone,\n          'fax': hotel.fax,\n          'email': hotel.email,\n          'siteurl': (KT.profile.userType === 'op') ? hotel.url : null,\n          'photos': hotel.images,\n          'services': services,\n          'descriptions': hotel.descriptions\n        };\n\n        var $hotelInfo = this.loaded[hotel.hotelId].$content;\n\n        $hotelInfo\n          .html(Mustache.render(_instance.mds.tpl.hotelFullInfo, hotelInfo))\n          .find('.js-hotel-info__gallery')\n            .on('click','.js-hotel-info__gallery-item', function() {\n              $(this).parent().children('.active').removeClass('active');\n              $(this).addClass('active');\n              var url = $(this).data('url');\n              $hotelInfo.find('.js-hotel-info__main-photo').css({'background-image': 'url('+url+')'});\n            })\n            .addClass('baron baron__root baron__clipper _simple')\n            .wrapInner('<div class=\"js-hotel-info__gallery-wrap\"></div>')\n            .wrapInner('<div class=\"js-hotel-info__gallery-scroller baron__scroller\"></div>')\n            .append('<div class=\"js-hotel-info__gallery-track baron__track\">'+\n                '<div class=\"baron__control baron__up\">▲</div>'+\n                '<div class=\"baron__free\">'+\n                '<div class=\"js-hotel-info__gallery-bar baron__bar\"></div>'+\n                '</div>'+\n                '<div class=\"baron__control baron__down\">▼</div>'+\n                '</div>')\n            .baron({\n              root: $('.js-hotel-info__gallery'),\n              scroller: '.js-hotel-info__gallery-scroller',\n              bar: '.js-hotel-info__gallery-bar',\n              track: '.js-hotel-info__gallery-track',\n              scrollingCls: '_scrolling',\n              draggingCls: '_dragging'\n            });\n      },\n      open: function(hotelId) {\n        this.loaded[hotelId].open();\n      }\n    };\n\n    return HotelInfoPages;\n  };\n\n  /**\n  * Рендер сообщения диалога согласия с изменением цены\n  * @param {Object} newSalesTerms - новые ценовые данные предложения\n  * @param {ServiceStorage} Service - изменившаяся услуга\n  * @param {Function} [submitAction] - действие при подтверждении\n  * @param {Function} [cancelAction] - действие при отмене\n  * @return {String} - сообщение диалога\n  */\n  modView.prototype.showPricesChangedModal = function(newSalesTerms, Service, submitAction, cancelAction) {\n    var prices = {};\n    prices.client = {\n      'oldPrice': Service.prices.inClient.client.gross.toMoney(2,',',' '),\n      'newPrice': Number(newSalesTerms.clientCurrency.client.amountBrutto).toMoney(2,',',' '),\n      'currency': KT.getCatalogInfo('lcurrency', newSalesTerms.clientCurrency.client.currency, 'icon')\n    };\n    if (KT.profile.userType === 'op') {\n      prices.supplier = {\n        'oldPrice': Service.prices.inSupplier.supplier.gross.toMoney(2,',',' '),\n        'newPrice': Number(newSalesTerms.supplierCurrency.supplier.amountBrutto).toMoney(2,',',' '),\n        'currency': KT.getCatalogInfo('lcurrency', newSalesTerms.supplierCurrency.supplier.currency, 'icon')\n      };\n    }\n\n    var buttons = [];\n    if (typeof submitAction !== 'function') {\n      buttons.push({\n          type:'warning',\n          title:'ok'\n        });\n    } else {\n      buttons.push({\n        type:'warning',\n        title:'принять',\n        callback: submitAction\n      });\n\n      if (typeof cancelAction === 'function') {\n        buttons.push({\n            type:'warning',\n            title:'отклонить',\n            callback: cancelAction\n          });\n      }\n    }\n\n    KT.Modal.notify({\n      type:'warning',\n      title:'Изменение данных брони',\n      msg: Mustache.render(this.mds.tpl.pricesChangedModal, prices),\n      buttons: buttons\n    });\n  };\n\n  /**\n  * Рендер сообщения о невозвратности услуги\n  */\n  modView.prototype.showNonrefundableModal = function(submitAction, cancelAction) {\n    KT.Modal.notify({\n      type:'warning',\n      title:'Невозвратная услуга',\n      msg: '<p style=\"text-align:center\">Услуга, которую Вы собираетесь забронировать, является невозвратной</p>',\n      buttons:[{\n          type:'warning',\n          title:'Продолжить',\n          callback: submitAction\n        },\n        {\n          type:'warning',\n          title:'Отмена',\n          callback: cancelAction\n      }]\n    });\n  };\n\n  /**\n  * Подготовка объекта управления окном изменения брони\n  * @return {Object} - объект управления\n  */\n  modView.prototype.setBookChangeModal = function() {\n    var _instance = this;\n\n    var BookChangeModal = {\n      $modal: null,\n      serviceId: null,\n      touristAges: {},\n      /** \n      * рендер окна\n      * @param {Integer} serviceId - ID рдактируемой услуги\n      * @param {Function} submitAction - действие при подтверждении\n      * @param {Function} cancelAction - действие при отмене\n      * @param {Function} toManagerAction - действие при отправке услуги на редактирование менеджеру\n      */\n      showModal: function(serviceId, submitAction, cancelAction, toManagerAction) {\n        var self = this;\n\n        var ServiceViewModel = _instance.serviceViewModels[serviceId];\n        var Service = ServiceViewModel.ServiceStorage;\n\n        self.serviceId = serviceId;\n        self.touristAges = $.extend(true, {}, Service.touristAges);\n\n        ServiceViewModel.mapTouristsInfo(_instance.mds.OrderStorage.getTourists(), true);\n\n        var modalParams = {\n          'serviceId': serviceId,\n          'serviceIcon': KT.getCatalogInfo('servicetypes', Service.typeCode, 'icon'),\n          'serviceName': Service.name,\n          'dateIn': Service.startDate.format('DD.MM.YYYY'),\n          'dateOut': Service.endDate.format('DD.MM.YYYY'),\n          'tourists': ServiceViewModel.touristsMap\n        };\n\n        var buttons = [\n          {title:'да', callback: submitAction },\n          {title:'нет', callback: function($modal) { self.clearData(); cancelAction($modal); }}\n        ];\n\n        if (KT.profile.userType !== 'op') {\n          buttons.push({\n            title:'Передать менеджеру', \n            callback: function() { \n              self.showSendToManagerModal(modalParams, toManagerAction, cancelAction); \n            }\n          });\n        }\n\n        self.$modal = KT.Modal.notify({\n          type: 'info',\n          title: 'Изменение данных брони',\n          msg: Mustache.render(_instance.mds.tpl.bookChangeModal, modalParams),\n          buttons: buttons\n        }).$content;\n\n        self.$modal.find('.js-modal-book-change--date-in').clndrize({\n          'template': _instance.mds.tpl.clndr,\n          'eventName': 'Дата заезда',\n          'showDate': moment(),\n          'clndr': {\n            'constraints': {\n              'startDate': moment().format('YYYY-MM-DD'),\n              'endDate': moment().add(1,'years').format('YYYY-MM-DD')\n            }\n          }\n        });\n\n        self.$modal.find('.js-modal-book-change--date-out').clndrize({\n          'template': _instance.mds.tpl.clndr,\n          'eventName': 'Дата выезда',\n          'showDate': moment(),\n          'clndr': {\n            'constraints': {\n              'startDate': moment().format('YYYY-MM-DD'),\n              'endDate': moment().add(1,'years').format('YYYY-MM-DD')\n            }\n          }\n        });\n\n        self.$modal.on('change', '.js-modal-book-change--tourist-bound' , function() {\n          var touristId = +$(this).attr('data-touristid');\n          var tourist = _instance.mds.OrderStorage.tourists[touristId];\n\n          var agegroup = Service.getAgeGroup(Service.getAgeByServiceEnding(tourist.birthdate));\n\n          if ($(this).prop('checked')) {\n            if ((self.touristAges[agegroup] + 1) <= Service.declaredTouristAges[agegroup]) {\n              self.touristAges[agegroup] += 1;\n            } else {\n              $(this).prop('checked',false).closest('.simpletoggler').removeClass('active');\n              KT.notify('touristLinkageNotAllowedByAge');\n            }\n          } else {\n            self.touristAges[agegroup] -= 1;\n          }\n        });\n      },\n      /**\n      * рендер модального окна отправки запроса менеджеру на изменение брони\n      */\n      showSendToManagerModal: function(modalParams, toManagerAction, cancelAction) {\n        var self = this;\n\n        self.$modal = KT.Modal.notify({\n          type: 'info',\n          title: 'Передача услуги менеджеру для исправления других параметров',\n          msg: Mustache.render(_instance.mds.tpl.sendToManagerModal, modalParams),\n          buttons: [\n            {title:'передать менеджеру', callback: toManagerAction},\n            {title:'отмена', callback: function($modal) { self.clearData(); cancelAction($modal); }}\n          ]\n        }).$content;\n      },\n      /**\n      * Сбор параметров с формы\n      * @return {Object|null} - параметры формы или null случае ошибки\n      */\n      getParams: function() {\n        var self = this;\n        \n        var newTouristLinkage = {};\n        var linkedAmount = 0;\n\n        self.$modal.find('.js-modal-book-change--tourist-bound')\n          .each(function() {\n            var touristId = +$(this).attr('data-touristid');\n            newTouristLinkage[touristId] = {\n              'state': $(this).prop('checked'),\n              'loyalityProviderId': null,\n              'loyalityCardNumber': null\n            };\n            if (newTouristLinkage[touristId].state) { linkedAmount++; }\n          });\n\n        var linkageInfo = _instance.mds.OrderStorage.createLinkageStructure(self.serviceId, newTouristLinkage);\n\n        var service = _instance.mds.OrderStorage.services[self.serviceId];\n        if (linkedAmount !== service.declaredTouristAmount) {\n          KT.notify('notAllTouristsLinked');\n          return null;\n        }\n\n        var $dateIn = self.$modal.find('.js-modal-book-change--date-in');\n        var $dateOut = self.$modal.find('.js-modal-book-change--date-out');\n        var dateIn = $dateIn.val();\n        var dateOut = $dateOut.val();\n        dateIn = moment(\n            (dateIn === '' || dateIn === null) ? $dateIn.data('default') : dateIn,\n            'DD.MM.YYYY'\n          ).format('YYYY-MM-DD');\n        dateOut = moment(\n            (dateOut === '' || dateOut === null) ? $dateOut.data('default') : dateOut,\n            'DD.MM.YYYY'\n          ).format('YYYY-MM-DD');\n\n        return {\n          'serviceId': self.serviceId,\n          'serviceData': {\n            'dateStart': dateIn,\n            'dateFinish': dateOut,\n            'touristData': linkageInfo\n          }\n        };\n      },\n      /**\n      * Сбор параметров с формы отправки запроса менеджеру \n      * @return {Object|null} - параметры формы или null случае ошибки\n      */\n      getToManagerParams: function() {\n        var self = this;\n        var $comment = self.$modal.find('.js-modal-send-to-manager--comment');\n\n        if ($comment.val() === '') {\n          $comment.addClass('error')\n            .attr('placeholder', 'Оставьте комментарий')\n            .one('focus', function() { $(this).removeClass('error'); });\n          return null;\n        } else {\n          return {\n            'serviceId': self.serviceId,\n            'comment': $comment.val()\n          };\n        }\n      },\n      /**\n      * Очистка сохраненных данных по услуге\n      */\n      clearData: function() {\n        this.$modal = null;\n        this.serviceId = null;\n        this.touristAges = {};\n      }\n    };\n\n    return BookChangeModal;\n  };\n\n  /**\n  * Подготовка объекта управления окном отмены брони\n  * @return {Object} - объект управления\n  */\n  modView.prototype.setBookCancelModal = function() {\n    var _instance = this;\n\n    var BookCancelModal = {\n      $modal: null,\n      serviceId: null,\n      /** \n      * рендер окна\n      * @param {Integer} serviceId - ID рдактируемой услуги\n      * @param {Function} submitAction - действие при подтверждении\n      * @param {Function} cancelAction - действие при отмене\n      */\n      showModal: function(serviceId, submitAction, cancelAction) {\n        var self = this;\n\n      self.serviceId = serviceId;\n\n        var ServiceViewModel = _instance.serviceViewModels[serviceId];\n        var Service = ServiceViewModel.ServiceStorage;\n\n        var cancelPenaltySum = Service.countClientCancelPenalty();\n\n        var modalParams = {\n          'serviceName': Service.name,\n          'penalty': (cancelPenaltySum !== null && cancelPenaltySum.inLocal !== 0) ? {\n              'localAmount': Number(cancelPenaltySum.inLocal).toMoney(0,',',' '),\n              'localCurrency': KT.getCatalogInfo('lcurrency', KT.profile.localCurrency, 'icon'),\n              'viewAmout': Number(cancelPenaltySum.inView).toMoney(0,',',' '),\n              'viewCurrency': KT.getCatalogInfo('lcurrency', KT.profile.viewCurrency, 'icon'),\n            } : null,\n          'isInvoiceOptional': false\n        };\n\n        self.$modal = KT.Modal.notify({\n          type: 'info',\n          title: 'Отмена бронирования',\n          msg: Mustache.render(_instance.mds.tpl.bookCancelModal, modalParams),\n          buttons: [{\n              type: 'common',\n              title: 'да',\n              callback: submitAction\n            },\n            {\n              type: 'common',\n              title: 'нет',\n              callback: function() {\n                self.clearData();\n                cancelAction();\n              }\n          }]\n        }).$content;\n      },\n      /**\n      * Сбор параметров с формы\n      * @return {Object|null} - параметры формы или null случае ошибки\n      */\n      getParams: function() {\n        var self = this;\n\n        var $isSetInvoiceSelected = self.$modal.find('.js-modal-book-cancel--set-invoice');\n        var commandParams = _instance.mds.OrderStorage.getServiceCommandParams('BookCancel', self.serviceId);\n        if ($isSetInvoiceSelected.length !== 0) {\n          commandParams['createPenaltyInvoice'] = $isSetInvoiceSelected.prop('checked');\n        } else {\n          commandParams['createPenaltyInvoice'] = true;\n        }\n\n        return commandParams;\n      },\n      /**\n      * Очистка сохраненных данных по услуге\n      */\n      clearData: function() {\n        this.$modal = null;\n        this.serviceId = null;\n        this.touristAges = {};\n      }\n    };\n\n    return BookCancelModal;\n  };\n\n  return modView;\n\n}));\n","(function(global,factory) {\n\n    KT.crates.OrderEdit.services.controller = factory(KT.crates.OrderEdit);\n\n}(this,function(crate) {\n  /**\n  * Редактирование заявки: услуги\n  * @constructor\n  * @param {Object} module - хранилище родительского модуля\n  * @param {Integer} orderId - ID заявки\n  */\n  var oesController = function(module,orderId) {\n    this.mds = module;\n    this.orderId = orderId;\n\n    this.mds.services.view = new crate.services.view(this.mds);\n\n    /** @deprecated */\n    //this.mds.orderInfo = {};\n  };\n\n  /** Инициализация событий модуля */\n  oesController.prototype.init = function() {\n    var _instance = this;\n    var modView = this.mds.services.view;\n\n    /*==========Обработчики событий модели============================*/\n\n    /** @todo временное решение, надо бы переделать с отдельным рендером\n    * самой услуги и блока привязки туристов\n    * @param {OrderStorage} OrderStorage - хранилище данных заявки\n    */\n    var callServicesRendering = function(OrderStorage) {\n      modView.renderServices(OrderStorage)\n        .then(function() {\n          var showService = window.sessionStorage.getItem('showService');\n          if (showService !== null) {\n            window.sessionStorage.removeItem('showService');\n            modView.navigateToService(+showService);\n          }\n          \n          // исключительно для авиации: проверка на наличие правил тарифа\n          OrderStorage.getServices().forEach(function(Service) {\n            if (Service.typeCode === 2 && !Service.isPartial) {\n              var fareRules = Service.offerInfo.fareRules;\n              if (!Array.isArray(fareRules) || fareRules.length === 0) {\n\n                var fareRulesLoader = function(serviceId, retry) {\n                  console.log('load rules');\n                  retry--;\n                  if (retry === 0) { \n                    modView.updateFareRules(serviceId);\n                    return;\n                  }\n\n                  KT.apiClient.getOrderOffers(OrderStorage.orderId, [serviceId])\n                    .then(function(response) {\n                      if (response.status !== 0) {\n                        setTimeout(function() { fareRulesLoader(Service.serviceId, retry); }, 5000);\n                      } else {\n                        var fareRules = response.body[0].offerInfo.fareRules;\n                        if (!Array.isArray(fareRules) || fareRules.length === 0) {\n                          setTimeout(function() { fareRulesLoader(Service.serviceId, retry); }, 5000);\n                        } else {\n                          OrderStorage.services[serviceId].offerInfo.fareRules = fareRules;\n                          modView.updateFareRules(serviceId, fareRules);\n                        }\n                      }\n                    });\n                };\n\n                setTimeout(function() { fareRulesLoader(Service.serviceId, 3); }, 5000);\n              }\n            }\n          });\n        });\n    };\n\n    /** Обработка смены валюты просмотра */\n    KT.on('KT.changedViewCurrency', function() {\n      modView.$serviceList.html(Mustache.render(KT.tpl.spinner, {}));\n      var OrderStorage = _instance.mds.OrderStorage;\n      var serviceIds = _instance.mds.OrderStorage.getServiceIds();\n\n      if (serviceIds.length > 0) {\n        KT.apiClient.getOrderOffers(_instance.orderId, serviceIds)\n          .then(function(offersData) {\n            if (offersData.status === 0) {\n              OrderStorage.setServices(offersData.body);\n              if (OrderStorage.loadStates.transitionsdata === 'loaded') {\n                callServicesRendering(_instance.mds.OrderStorage);\n              }\n            } else {\n              return $.Deferred().reject();\n            }\n          });\n      }\n    });\n\n    /** Рендер пустого списка если в заявке нет услуг */\n    KT.on('OrderStorage.initialized', function(e, OrderStorage) {\n      if (OrderStorage.getServices().length === 0) {\n        modView.renderEmptyServiceList();\n      }\n    });\n\n    /** Обработка инициализации доступных действий с услугами */\n    KT.on('OrderStorage.setAllowedTransitions', function(e, OrderStorage) {\n      if (OrderStorage.loadStates.touristdata === 'loaded') {\n        callServicesRendering(_instance.mds.OrderStorage);\n      }\n    });\n\n    /** Обработка обновления данных туристов в хранилище */\n    KT.on('OrderStorage.setTourists', function(e, OrderStorage) {\n      if (OrderStorage.loadStates.transitionsdata === 'loaded') {\n        callServicesRendering(OrderStorage);\n      }\n    });\n\n    /** Обработка привязки туриста к услуге */\n    KT.on('OrderStorage.savedServiceLinkage', function(e, data) {\n      modView.renderServiceTourists(data.serviceId);\n    });\n\n    /** Обработка добавления/создания туриста (перерисовка блока услуг) */\n    KT.on('OrderStorage.savedTourist', function(e, data) {\n      _instance.mds.OrderStorage.getServiceIds().forEach(function(serviceId) {\n          _instance.mds.OrderStorage.updateServiceTourists(serviceId);\n          modView.renderServiceTourists(serviceId);\n      });\n\n      // проверка на добавление туриста из услуги для привязки\n      var linkingServiceId = window.sessionStorage.getItem('serviceToAddTourist');\n\n      if (linkingServiceId !== null) {\n        window.sessionStorage.removeItem('serviceToAddTourist');\n\n        var touristId = +data.touristId;\n        linkingServiceId = +linkingServiceId;\n\n        KT.dispatch('OrderEdit.setActiveTab', {activeTab:'services', callback: function() {\n          modView.navigateToService(linkingServiceId);\n        }});\n        KT.notify('linkingTourists');\n\n        var touristLinkage = {};\n        touristLinkage[touristId] = {\n          'state': true,\n          'loyalityCardNumber': null,\n          'loyalityProviderId': null\n        };\n        var linkageInfo = _instance.mds.OrderStorage.createLinkageStructure(linkingServiceId, touristLinkage);\n\n        KT.apiClient.setTouristsLinkage(_instance.orderId, linkingServiceId, linkageInfo)\n          .done(function(response) {\n            if (+response.status === 0) {\n              var link = response.body.result[0];\n\n              if (link === undefined) {\n                KT.notify('linkingTouristFailed', ['Турист', tourist.lastname, tourist.firstname].join(' '));\n                _instance.mds.OrderStorage.updateServiceTourists(response.serviceid);\n                modView.renderServiceTourists(response.serviceId);\n\n              } else if (!Boolean(link.success)) {\n                var tourist = _instance.mds.OrderStorage.tourists[link.touristId];\n                KT.notify('linkingTouristFailed', [\n                    'Турист', tourist.lastname, tourist.firstname,\n                    ':', link.error\n                  ].join(' '));\n                _instance.mds.OrderStorage.updateServiceTourists(response.serviceid);\n                modView.renderServiceTourists(response.serviceId);\n\n              } else {\n                _instance.mds.OrderStorage.saveServiceLinkage(response.serviceId, response.linkageInfo);\n                KT.notify('touristsLinked');\n                \n              }\n            } else {\n              KT.notify('linkingTouristFailed', response.errors);\n            }\n          });\n      }\n    });\n\n    /** Обработка удаления туриста (перерисовка блока услуг) */\n    KT.on('OrderStorage.touristRemoved', function() {\n      modView.renderServices(_instance.mds.OrderStorage);\n    });\n\n    /*==========Обработчики событий представления============================*/\n\n    /** Скрыть/показать подробную информацию по услуге */\n    modView.$serviceList.on('click','.js-service-form-header', function() {\n      var $sf = $(this).closest('.js-service-form');\n      var $dataform = $sf.find('.js-service-form-content');\n\n      if ($sf.hasClass('active')) {\n        $sf.removeClass('active');\n        $dataform.css({'display':'block'}).slideUp(500);\n      } else {\n        $sf.addClass('active');\n        $dataform.css({'display':'none'}).slideDown(500);\n      }\n    });\n\n    /** Обработка изменения значения привязки туриста */\n    modView.$serviceList.on('change','.js-service-form-tourist--service-bound', function() {\n      var touristId = +$(this).attr('data-touristid');\n      var tourist = _instance.mds.OrderStorage.tourists[touristId];\n      var $serviceForm = $(this).closest('.js-service-form');\n      var serviceId = +$serviceForm.attr('data-sid');\n      var service = _instance.mds.OrderStorage.services[serviceId];\n\n      var agegroup = service.getAgeGroup(service.getAgeByServiceEnding(tourist.birthdate));\n\n      if ($(this).prop('checked')) {\n        if ((service.touristAges[agegroup] + 1) <= service.declaredTouristAges[agegroup]) {\n          service.touristAges[agegroup] += 1;\n          $serviceForm.data('unsaved',true);\n        } else {\n          $(this).prop('checked',false).closest('.simpletoggler').removeClass('active');\n          KT.notify('touristLinkageNotAllowedByAge');\n        }\n      } else {\n        service.touristAges[agegroup] -= 1;\n        $serviceForm.data('unsaved',true);\n      }\n    });\n\n    /** Обработка изменения данных программы лояльности */\n    modView.$serviceList.on('change', [\n        '.js-service-avia-loyalty-program--provider',\n        '.js-service-avia-loyalty-program--number'\n      ].join(','), \n      function() {\n        $(this).closest('.js-service-form').data('unsaved', true);\n      }\n    );\n\n    /** Обработка нажатия на кнопку \"Забронировать\" услуги */\n    modView.$serviceList.on('click','.js-service-form-actions--book', function() {\n      var $serviceForm = $(this).closest('.js-service-form');\n      var serviceId = +$serviceForm.data('sid');\n      var Service = _instance.mds.OrderStorage.services[serviceId];\n\n      var startBooking = function() {\n        if ($serviceForm.data('unsaved') === false) {\n          _instance.saveCustomFields(serviceId)\n            .then(function() {\n              return _instance.bookService(serviceId);\n            });\n        } else {\n          _instance.saveServiceLinkage(serviceId)\n            .then(function() {\n              return _instance.saveCustomFields(serviceId);\n            })\n            .then(function() {\n              return _instance.bookService(serviceId);\n            });\n        }\n      };\n\n      var submitAction = function() {\n        KT.Modal.closeModal();\n        startBooking();\n      };\n\n      var cancelAction = function () {\n        KT.Modal.closeModal();\n      };\n\n      if (Service.isNonRefundable) {\n        modView.showNonrefundableModal(submitAction, cancelAction);\n      } else {\n        startBooking();\n      }\n    });\n\n    /** Обработка изменения переключателя согласия с условиями бронирования */\n    modView.$serviceList.on('change','.js-service-form-tos-agreement input', function() {\n      var serviceId = +$(this).closest('.js-service-form').data('sid');\n      var service = _instance.mds.OrderStorage.services[serviceId];\n      service.isTOSAgreementSet = $(this).prop('checked');\n    });\n\n    /** Обработка нажатия на кнопку сохранения полей услуги */\n    modView.$serviceList.on('click','.js-service-form-actions--save', function() {\n      var serviceId = +$(this).closest('.js-service-form').data('sid');\n\n      modView.renderPendingServiceProcess(serviceId);\n\n      _instance.saveCustomFields(serviceId)\n        .always(function() {\n          modView.renderServiceActions(serviceId);\n        });\n    });\n\n    /** Обработка нажатия на кнопку \"Выписать билеты\" */\n    modView.$serviceList.on('click','.js-service-form-actions--issue', function() {\n      var serviceId = +$(this).closest('.js-service-form').attr('data-sid');\n\n      modView.renderPendingServiceProcess(serviceId);\n\n      KT.apiClient.issueTickets(_instance.orderId, serviceId)\n        .done(function(response) {\n          if (response.status === 0) {\n            KT.notify('ticketsIssued');\n          } else {\n            if (response.errors !== undefined) {\n              KT.notify('issuingTicketsFailed', response.errors);\n            }\n          }\n\n          KT.dispatch('OrderEdit.reloadInfo');\n        });\n    });\n\n    /** Обработка нажатия на кнопку \"Изменить бронь\" */\n    modView.$serviceList.on('click','.js-service-form-actions--book-change', function() {\n      var serviceId = +$(this).closest('.js-service-form').data('sid');\n\n      // действие при подтверждении изменений брони\n      var submitAction = function() {\n        var bookChangeParams = modView.BookChangeModal.getParams();\n\n        if (bookChangeParams === null) { return; }\n\n        modView.renderPendingServiceProcess(serviceId);\n        KT.Modal.showLoader();\n        \n        KT.apiClient.bookChange(_instance.orderId, bookChangeParams)\n          .done(function(response) {\n            if (response.status === 0) {\n              KT.notify('bookingChanged');\n              var Service = _instance.mds.OrderStorage.services[serviceId];\n\n              console.warn('data changed:');\n              console.log(Service.compareSalesTerms(response.body.newSalesTerms));\n\n              if (!Service.compareSalesTerms(response.body.newSalesTerms)) {\n                modView.showPricesChangedModal(response.body.newSalesTerms, Service);\n              } else {\n                KT.Modal.closeModal();\n              }\n            } else {\n              KT.Modal.closeModal();\n\n              switch(+response.errorCode) {\n                case 165:\n                  KT.notify('bookingChangeNotSupported');\n                  break;\n                case 170:\n                  KT.notify('bookingChangeProhibited');\n                  break;\n                default:\n                  KT.notify('bookingChangeFailed');\n                  break;\n              }\n            }\n\n            /** @todo убрать это и заменить */\n            KT.dispatch('OrderEdit.reloadInfo');\n          });\n      };\n\n      // действие при отмене изменений брони\n      var cancelAction = function() {\n        KT.Modal.closeModal();\n      };\n\n      // действие при передаче услуги менеджеру\n      var toManagerAction = function() {\n        var toManagerParams = modView.BookChangeModal.getToManagerParams();\n        \n        if (toManagerParams === null) { return; }\n\n        modView.renderPendingServiceProcess(serviceId);\n        KT.Modal.showLoader();\n        \n        KT.apiClient.setServiceToManual(_instance.orderId, toManagerParams)\n          .then(function(response) {\n            KT.Modal.closeModal();\n\n            if (response.status === 0) {\n              KT.notify('serviceSetToManual');\n            } else {\n              KT.notify('settingServiceToManualFailed');\n            }\n            \n            KT.dispatch('OrderEdit.reloadInfo');\n          }, function(err) {\n            modView.renderServiceActions(serviceId);\n            \n            if (err.error !== 'denied') {\n              KT.Modal.closeModal(); \n            }\n          });\n      };\n\n      modView.BookChangeModal.showModal(serviceId, submitAction, cancelAction, toManagerAction);\n    });\n\n    /** Обработка нажатия на кнопку \"Отменить бронь\" */\n    modView.$serviceList.on('click','.js-service-form-actions--book-cancel', function() {\n      var serviceId = +$(this).closest('.js-service-form').data('sid');\n\n      var submitAction = function() {\n        var bookCancelParams = modView.BookCancelModal.getParams();\n        if (bookCancelParams === null) { return; }\n\n        modView.renderPendingServiceProcess(serviceId);\n        KT.Modal.showLoader();\n  \n        KT.apiClient.bookCancel(_instance.orderId, bookCancelParams)\n          .done(function(response) {\n            KT.Modal.closeModal();\n\n            if (response.status === 0) {\n              KT.notify('bookingCancelled');\n            } else {\n              KT.notify('bookingCancelFailed');\n            }\n            KT.dispatch('OrderEdit.reloadInfo');\n          });\n      };\n\n      var cancelAction = function() {\n        KT.Modal.closeModal();\n      };\n\n      modView.BookCancelModal.showModal(serviceId, submitAction, cancelAction);\n    });\n\n    /** Обработка нажатия на кнопку \"Выставить счет\" */\n    modView.$serviceList.on('click','.js-service-form-actions--set-invoice', function() {\n      KT.dispatch('OrderEdit.openSetInvoiceForm');\n    });\n\n    /** Обработка нажатия на кнопку \"Перевести в ручной режим\" */\n    modView.$serviceList.on('click','.js-service-form-actions--to-manual', function() {\n      var serviceId = +$(this).closest('.js-service-form').data('sid');\n\n      modView.renderPendingServiceProcess(serviceId);\n\n      KT.apiClient.setServiceToManual(_instance.orderId, {'serviceId': serviceId})\n        .done(function(response) {\n          if (response.status === 0) {\n            console.log('Услуга переведена в ручной режим');\n          } else {\n            console.error('Не удалось перевести услугу в ручной режим');\n          }\n          \n          KT.dispatch('OrderEdit.reloadInfo');\n        });\n    });\n\n    /** Обработка нажатия на кнопку \"Добавить туриста\" */\n    modView.$serviceList.on('click','.js-service-form--add-tourist', function() {\n      var $serviceForm = $(this).closest('.js-service-form');\n      var serviceId = +$serviceForm.attr('data-sid');\n\n      /** ID сервиса, из которого вызвано добавление туриста */\n      window.sessionStorage.setItem('serviceToAddTourist', serviceId);\n\n      KT.dispatch('OrderEdit.setActiveTab', {activeTab: 'tourists'});\n      KT.dispatch('OrderEdit.createAddTouristForm');\n    });\n\n    /** Обработка нажатия на кнопку добавления доп. услуги */\n    modView.$serviceList.on('click','.js-service-form-add-service--action-add', function() {\n      var $addService = $(this).closest('.js-service-form-add-service--available-service');\n      var $serviceForm = $addService.closest('.js-service-form');\n\n      var OrderStorage = _instance.mds.OrderStorage;\n      var serviceId = +$serviceForm.attr('data-sid');\n      var addServiceId = +$addService.data('add-service-id');\n\n      $addService.closest('.js-service-form--add-services')\n        .html(Mustache.render(KT.tpl.spinner, {}));\n\n      KT.apiClient.addExtraService(OrderStorage.orderId, {\n        'serviceId': serviceId,\n        'touristIds': OrderStorage.services[serviceId].getServiceTourists()\n          .map(function(tourist) { return tourist.touristId; }),\n        'addServiceOfferId': addServiceId,\n        'viewCurrency': KT.profile.viewCurrency\n      }).then(function(response) {\n        if (response.status !== 0) {\n          KT.notify('AddingAdditionalServiceFailed', response.errors);\n        } else {\n          OrderStorage.services[serviceId].addAdditionalService(response.body.addService);\n        }\n\n        modView.updateAdditionalServices(serviceId);\n      });\n    });\n\n    /** Обработка нажатия на кнопку удаления доп. услуги */\n    modView.$serviceList.on('click','.js-service-form-add-service--action-remove', function() {\n      var $addService = $(this).closest('.js-service-form-add-service--issued-service');\n      var $serviceForm = $addService.closest('.js-service-form');\n\n      var OrderStorage = _instance.mds.OrderStorage;\n      var serviceId = +$serviceForm.attr('data-sid');\n      var addServiceId = +$addService.data('add-service-id');\n\n      $addService.closest('.js-service-form--add-services')\n        .html(Mustache.render(KT.tpl.spinner, {}));\n\n      KT.apiClient.removeExtraService(OrderStorage.orderId, {\n        'serviceId': serviceId,\n        'addServiceId': addServiceId\n      }).then(function(response) {\n        if (response.status !== 0) {\n          KT.notify('RemovingAdditionalServiceFailed', response.errors);\n        } else {\n          OrderStorage.services[serviceId].removeAdditionalService(addServiceId);\n        }\n\n        modView.updateAdditionalServices(serviceId);\n      });\n    });\n\n    /** Отобразить полную информацию по отелю  */\n    modView.$serviceList.on('click', '.js-service-hotel--hotel-link', function(e) {\n      e.stopPropagation();\n      var hotelId = +$(this).data('hotelid');\n      \n      if (modView.HotelInfoPages.init(hotelId)) {\n        KT.apiClient.getHotelInfo(hotelId)\n          .done(function(response) {\n            if (response.status !== 0) {\n              console.error(response.errors);\n            } else {\n              modView.HotelInfoPages.render(response.body);\n            }\n          });\n      } else {\n        modView.HotelInfoPages.open(hotelId);\n      }\n    });\n\n    /** Открыть окно редактирования услуги в ручном режиме */\n    modView.$serviceList.on('click', '.js-service-form-actions--manual-edit', function() {\n      var $serviceForm = $(this).closest('.js-service-form');\n      var serviceId = +$serviceForm.attr('data-sid');\n\n      modView.ManualEditForms.open(serviceId);\n    });\n\n    /*==========Обработчики ручного режима============================*/\n    /** Изменение параметров услуги */\n    modView.$manualFormsRoot.on('click', '.js-ore-service-manualedit--save-common-data', function() {\n      var orderId = _instance.mds.OrderStorage.orderId;\n      var $manualForm = $(this).closest('.js-ore-service-manualedit');\n      var serviceId = +$manualForm.data('serviceid');\n\n      var actionParams = modView.ManualEditForms.getSaveServiceDataParams(serviceId);\n      if (actionParams === false) {\n        console.error('Некорректные параметры для изменения услуги');\n        return;\n      }\n\n      modView.ManualEditForms.forms[serviceId].close();\n      modView.renderPendingServiceProcess(serviceId);\n\n      KT.Modal.showLoader();\n\n      KT.apiClient.setServiceData(orderId, serviceId, actionParams)\n        .done(function(response) {\n          KT.Modal.closeModal();\n          if (response.status === 0) {\n            KT.notify('serviceDataChanged');\n          } else {\n            KT.notify('changingServiceDataFailed', response.errors);\n          }\n          KT.dispatch('OrderEdit.reloadInfo');\n        });\n    });\n\n    /** Изменение статуса услуги */\n    modView.$manualFormsRoot.on('click', '.js-ore-service-manualedit--save-service-status', function() {\n      var orderId = _instance.mds.OrderStorage.orderId;\n      var $manualForm = $(this).closest('.js-ore-service-manualedit');\n      var serviceId = +$manualForm.data('serviceid');\n\n      var actionParams = modView.ManualEditForms.getSaveServiceStatusParams(serviceId);\n      if (actionParams === false) {\n        console.error('Некорректные параметры для изменения статуса');\n        return;\n      }\n\n      modView.ManualEditForms.forms[serviceId].close();\n      modView.renderPendingServiceProcess(serviceId);\n\n      KT.Modal.showLoader();\n\n      KT.apiClient.manualSetStatus(orderId, serviceId, actionParams)\n        .done(function(response) {\n          KT.Modal.closeModal();\n          if (response.status === 0) {\n            KT.notify('reservationDataChanged');\n          } else {\n            KT.notify('changingReservationDataFailed');\n          }\n          KT.dispatch('OrderEdit.reloadInfo');\n        });\n    });\n\n    /** Изменение параметров брони */\n    modView.$manualFormsRoot.on('click', '.js-ore-service-manualedit--save-book-info', function() {\n      var orderId = _instance.mds.OrderStorage.orderId;\n      var $manualForm = $(this).closest('.js-ore-service-manualedit');\n      var serviceId = +$manualForm.data('serviceid');\n\n      var actionParams = modView.ManualEditForms.getChangeBookDataParams(serviceId);\n      if (actionParams === false) {\n        console.error('Некорректные параметры для изменения брони');\n        return;\n      }\n\n      modView.ManualEditForms.forms[serviceId].close();\n      modView.renderPendingServiceProcess(serviceId);\n\n      KT.Modal.showLoader();\n\n      KT.apiClient.setReservationData(orderId, serviceId, actionParams)\n        .done(function(response) {\n          KT.Modal.closeModal();\n          if (response.status === 0) {\n            KT.notify('reservationDataChanged');\n          } else {\n            KT.notify('changingReservationDataFailed');\n          }\n          KT.dispatch('OrderEdit.reloadInfo');\n        });\n    });\n\n    /** Изменение авиабилета */\n    modView.$manualFormsRoot.on('click', '.js-ore-service-manualedit--save-changed-avia-ticket', function() {\n      var orderId = _instance.mds.OrderStorage.orderId;\n      var $manualForm = $(this).closest('.js-ore-service-manualedit');\n      var serviceId = +$manualForm.data('serviceid');\n\n      var actionParams = modView.ManualEditForms.getChangeTicketDataParams(serviceId);\n      if (actionParams === false) {\n        console.error('Некорректные параметры для изменения билета');\n        return;\n      }\n\n      modView.ManualEditForms.forms[serviceId].close();\n      modView.renderPendingServiceProcess(serviceId);\n\n      KT.Modal.showLoader();\n\n      KT.apiClient.setTicketsData(orderId, serviceId, actionParams)\n        .done(function(response) {\n          KT.Modal.closeModal();\n          if (response.status === 0) {\n            KT.notify('ticketsDataChanged');\n          } else {\n            KT.notify('changingTicketsDataFailed');\n          }\n          KT.dispatch('OrderEdit.reloadInfo');\n        });\n    });\n\n    /** Добавление авиабилета */\n    modView.$manualFormsRoot.on('click', '.js-ore-service-manualedit--save-new-avia-ticket', function() {\n      var orderId = _instance.mds.OrderStorage.orderId;\n      var $manualForm = $(this).closest('.js-ore-service-manualedit');\n      var serviceId = +$manualForm.data('serviceid');\n\n      var actionParams = modView.ManualEditForms.getAddTicketParams(serviceId);\n      if (actionParams === false) {\n        console.error('Некорректные параметры для изменения билета');\n        return;\n      }\n\n      modView.ManualEditForms.forms[serviceId].close();\n      modView.renderPendingServiceProcess(serviceId);\n\n      KT.Modal.showLoader();\n\n      KT.apiClient.setTicketsData(orderId, serviceId, actionParams)\n        .done(function(response) {\n          KT.Modal.closeModal();\n          if (response.status === 0) {\n            KT.notify('ticketsDataChanged');\n          } else {\n            KT.notify('changingTicketsDataFailed');\n          }\n          KT.dispatch('OrderEdit.reloadInfo');\n        });\n    });\n  };\n\n  /** \n  * Передача данных призязки туристов к услуге\n  * @param {Integer} serviceId - ID услуги\n  */\n  oesController.prototype.saveServiceLinkage = function(serviceId) {\n    var _instance = this;\n    var modView = _instance.mds.services.view;\n    var request = $.Deferred();\n\n    if (_instance.mds.OrderStorage.getTourists().length > 0) {\n      var newTouristLinkage = modView.getServiceTouristsData(serviceId);\n      if (newTouristLinkage === false) {\n        return request.reject();\n      }\n\n      var linkageInfo = _instance.mds.OrderStorage.createLinkageStructure(serviceId, newTouristLinkage);\n      if (linkageInfo === false) {\n        return request.reject();\n      } else if (linkageInfo.length === 0) {\n        return request.resolve(serviceId);\n      } else {\n        KT.apiClient.setTouristsLinkage(_instance.orderId, serviceId, linkageInfo)\n          .done(function(response) {\n            if (+response.status === 0) {\n              var errors = [];\n              \n              response.body.result.forEach(function(link) {\n                if (!Boolean(link.success)) {\n                  var tourist = _instance.mds.OrderStorage.tourists[link.touristId];\n                  errors.push([\n                    'Турист', tourist.lastname, tourist.firstname,\n                    ':',link.error\n                  ].join(' '));\n                }\n              });\n\n              /** \n               * @todo по идее, это должно вызываться только после сохранения, \n               * но тогда не сохраняются данные мильных карт. пересмотреть.\n               */\n              _instance.mds.OrderStorage.saveServiceLinkage(serviceId, linkageInfo);\n\n              if (errors.length !== 0) {\n                KT.notify('linkingTouristFailed', errors.join('<br>'));\n                _instance.mds.OrderStorage.updateServiceTourists(serviceId);\n                modView.renderServiceTourists(serviceId);\n\n                request.reject();\n              } else {\n                KT.notify('touristsLinked');\n                request.resolve(serviceId);\n              }\n            } else {\n              KT.notify('linkingTouristFailed', response.errors);\n              request.reject();\n            }\n          });\n      }\n    } else {\n      KT.notify('saveServiceFailedNoTourists');\n      return request.reject();\n    }\n\n    return request.promise();\n  };\n\n  /** \n  * Передача значений дополнительных полей\n  * @param {Integer} serviceId - ID услуги\n  */\n  oesController.prototype.saveCustomFields = function(serviceId) {\n    var _instance = this;\n    var modView = _instance.mds.services.view;\n    var customFieldsValues = modView.getCustomFieldsValues(serviceId);\n    var request = $.Deferred();\n\n    if (customFieldsValues === null) {\n      KT.notify('notAllCustomFieldsSet');\n      request.reject();\n    } else {\n      if (customFieldsValues.length === 0) {\n        request.resolve(serviceId);\n      } else {\n        KT.apiClient.setServiceAdditionalData(_instance.orderId, customFieldsValues)\n          .done(function(response) {\n            if (response.status === 0) {\n              KT.notify('customFieldsSaved');\n              request.resolve(serviceId);\n            } else {\n              KT.notify('savingCustomFieldsFailed', response.errors);\n              request.reject();\n            }\n          });\n      }\n    }\n\n    return request.promise();\n  };\n\n  /** \n  * Бронирование услуги\n  * @param {Integer} serviceId - ID услуги\n  */\n  oesController.prototype.bookService = function(serviceId) {\n    var _instance = this;\n    var modView = _instance.mds.services.view;\n    var $serviceForm = modView.serviceForms[serviceId];\n    var orderTourists = _instance.mds.OrderStorage.getTourists();\n    var request = $.Deferred();\n\n    if (orderTourists.length > 0) {\n      var service = _instance.mds.OrderStorage.services[serviceId];\n\n      var isTOSAgreementSet = $serviceForm\n        .find('.js-service-form-tos-agreement')\n        .find('input[type=\"checkbox\"]')\n        .prop('checked');\n\n      var hasAllTouristsLinked = service.checkAllTouristsLinked();\n\n      if (!hasAllTouristsLinked) {\n        KT.notify('notAllTouristsLinked');\n        request.reject();\n      } else if (!isTOSAgreementSet) {\n        KT.notify('bookingTermsNotAccepted');\n        request.reject();\n      } else {\n        modView.renderPendingServiceProcess(serviceId);\n\n        var actionParams = _instance.mds.OrderStorage.getServiceCommandParams('BookStart', serviceId);\n        \n        if (actionParams !== false) {\n          KT.apiClient.startBooking(_instance.orderId, actionParams)\n            .then(function(response) {\n              //в этом блоке выполняется проверка на изменение цен, обработка результата бронирования в следующием \n              var bookrequest = $.Deferred();\n\n              if (\n                response.status === 0 && \n                response.body.newOfferData !== undefined && \n                typeof response.body.newOfferData === 'object'\n              ) {\n                KT.notify('pricesChanged');\n                var Service = _instance.mds.OrderStorage.services[serviceId];\n\n                var submitAction = function() {\n                  KT.Modal.closeModal();\n                  KT.apiClient.startBooking(_instance.orderId, actionParams)\n                    .done(function(rebookResponse) {\n                      bookrequest.resolve(rebookResponse);\n                    });\n                };\n\n                var cancelAction = function() {\n                  KT.Modal.closeModal();\n                  KT.dispatch('OrderEdit.reloadInfo');\n                  bookrequest.reject();\n                };\n\n                modView.showPricesChangedModal(response.body.newOfferData, Service, submitAction, cancelAction);\n              } else {\n                bookrequest.resolve(response);\n              }\n\n              return bookrequest.promise();\n            })\n            .then(function(response) {\n              if (response.status === 0) {\n                if (response.body.serviceStatus === 1) {\n                  KT.notify('bookingStarted');\n                } else if (response.body.serviceStatus === 2) {\n                  KT.notify('bookingFinished');\n                } else {\n                  KT.notify('bookingFailed');\n                }\n                request.resolve(serviceId);\n              } else {\n                KT.notify('bookingFailed', response.errors);\n                request.reject(serviceId);\n              }\n\n              KT.dispatch('OrderEdit.reloadInfo');\n            }, function() {\n              // отказ от принятия измененной цены\n              request.resolve(serviceId);\n            });\n        } else {\n          request.reject();\n        }\n      }\n    } else {\n      KT.notify('bookingFailedNoTourists');\n      request.reject();\n    }\n\n    return request.promise();\n  };\n\n  return oesController;\n\n}));\n","(function(global,factory) {\n\n    KT.crates.OrderEdit.payment.view = factory();\n\n}(this, function() {\n  /**\n  * Редактирование заявки: оформление\n  * @constructor\n  * @param {Object} module - сслыка на радительский модуль\n  * @param {Object} [options] - Объект конфигурации класса\n  */\n  var modView = function(module,options) {\n    this.mds = module;\n    if (options === undefined) { options = {}; }\n    this.config = $.extend(true,{\n      'templateUrl':'/cabinetUI/orders/getTemplates',\n      'templates':{\n        serviceList:'orderEdit/payment/serviceList',\n        serviceListRow:'orderEdit/payment/serviceListRow',\n        serviceActions:'orderEdit/payment/serviceActions',\n        serviceNoActions: 'orderEdit/payment/serviceNoActions',\n        invoiceListItem:'orderEdit/payment/invoiceListItem',\n        invoiceListItemService:'orderEdit/payment/invoiceListItemService',\n        invoiceListEmpty:'orderEdit/payment/invoiceListEmpty',\n        TOSAgreementModal:'orderEdit/modals/acceptBookingTerms',\n        multiBookCancelModal: 'orderEdit/modals/multiBookCancel'\n      }\n    },options);\n\n    this.$serviceList = $('#order-edit-payment--services');\n    this.$invoiceList = $('#order-edit-payment--invoices');\n    this.$invoiceActions = $('#order-edit-payment--invoice-actions');\n\n    /** @todo this should be in model? */\n    this.discountSum = 0;\n  };\n\n  /**\n  * Отображение списка услуг заявки\n  * @param {ServiceStorage[]} services - сервисы заявки\n  * @todo add param for setdiscount event or rework?\n  */\n  modView.prototype.renderServiceList = function(services) {\n    var _instance = this;\n\n    var serviceList = '';\n    var totalNet = 0,\n        totalGross = 0,\n        totalCommission = 0,\n        totalDiscount = 0;\n    var showNetPrice = (KT.profile.userType === 'op');\n\n    services.forEach(function(service) {\n      var serviceInfo = {\n        'serviceId': service.serviceId,\n        'serviceIcon': KT.getCatalogInfo('servicetypes', service.typeCode, 'icon'),\n        'serviceTypeName': KT.getCatalogInfo('servicetypes',service.typeCode, 'title'),\n        'statusIcon': KT.getCatalogInfo('servicestatuses', service.status, 'icon'),\n        'statusTitle': KT.getCatalogInfo('servicestatuses', service.status, 'title'),\n        'serviceName': service.name,\n        'net': showNetPrice ? service.prices.inLocal.supplier.gross.toMoney(2,',',' ') : null,\n        'gross': service.prices.inLocal.client.gross.toMoney(2,',',' '),\n        'offline': service.isOffline,\n        'travelPolicyViolations': (!service.hasTPViolations) ? null : \n          {'list': service.offerInfo.travelPolicy.travelPolicyFailCodes}\n      };\n\n      if (KT.profile.userType === 'op' && service.status === 9) {\n        serviceInfo.statusTitle = 'Ручной режим';\n      }\n\n      totalDiscount += service.discount;\n      totalNet += service.prices.inLocal.supplier.gross;\n      totalGross += service.prices.inLocal.client.gross;\n      totalCommission += service.prices.inLocal.client.commission.amount;\n\n      serviceList += Mustache.render(_instance.mds.tpl.serviceListRow, serviceInfo);\n    });\n\n    var serviceActions = Mustache.render(_instance.mds.tpl.serviceNoActions,{});\n\n    var serviceTable = {\n      'serviceList': serviceList,\n      'showNetPrice': showNetPrice,\n      'totalNet': showNetPrice ? totalNet.toMoney(2,',',' ') : null,\n      'totalGross': totalGross.toMoney(2,',',' '),\n      'totalCommission': totalCommission.toMoney(2,',',' '),\n      'serviceActions': serviceActions,\n      'discount': (KT.profile.userType === 'agent') ? totalDiscount.toMoney(2,',','') : null,\n      'profit': (KT.profile.userType === 'agent') ? (totalCommission - totalDiscount).toMoney(2,',',' ') : null\n    };\n\n    _instance.$serviceList.html(Mustache.render(_instance.mds.tpl.serviceList, serviceTable));\n    /** \n    * @todo не очень красиво, наверное, стоит подумать, как лучше блокировать чекбоксы услуг \n    * до загрузки доступных переходов\n    */\n    if (_instance.mds.OrderStorage.loadStates.transitionsdata === null) {\n      _instance.$serviceList\n        .find('.js-ore-payment-services--check-service')\n          .prop('disabled', true);\n    }\n\n    if(KT.profile.userType === 'agent') {\n      var $discountField = _instance.$serviceList.find('.js-ore-payment-services--discount');\n      \n      $discountField.jirafize({\n        position: 'right',\n        margin: '20px',\n        buttons:{\n          name: 'submit',\n          type: 'submit',\n          callback: function() {\n            $discountField.prop('disabled',true);\n            KT.dispatch('PaymentView.setDiscount', {\n              'discount':parseFloat($discountField.val().replace(/ /g,'').replace(',','.')).toFixed(2)\n            });\n          }\n        }\n      });\n    }\n  };\n\n  /**\n  * Вывод элементов для управления услугами\n  * @param {Object|false} actions - список действия или false если действия недоступны\n  */\n  modView.prototype.renderServiceActions = function(actions) {\n    this.$serviceList\n      .find('.js-ore-payment-services--check-service')\n        .not('[data-offline=\"true\"]')\n          .prop('disabled', false);\n\n    if (actions === false) {\n      this.$serviceList.find('.js-ore-payment-services--service-actions')\n        .html(Mustache.render(this.mds.tpl.serviceNoActions, {}));\n    } else {\n      this.$serviceList.find('.js-ore-payment-services--service-actions')\n        .html(Mustache.render(this.mds.tpl.serviceActions, actions));\n    }\n  };\n\n  /** Очистка списка доступных действий с услугами */\n  modView.prototype.clearServiceActions = function() {\n    this.$serviceList\n      .find('.js-ore-payment-services--check-service')\n        .empty();\n  };\n\n  /**\n  * Возвращает идентификаторы выбранных для совершения действия услуг\n  * @return {Integer[]} - массив ID услуг\n  */\n  modView.prototype.getSelectedServices = function() {\n      var serviceIds = [];\n      var $serviceControls = this.$serviceList.find('.js-ore-payment-services--check-service');\n\n      // получим ID всех выбранных услуг\n      $serviceControls\n        .filter(':checked')\n          .each(function() {\n            serviceIds.push(+$(this).data('serviceid'));\n      });\n\n      return serviceIds;\n  };\n\n  /**\n  * Отображение списка счетов заявки\n  * @param {InvoiceStorage[]} invoices - массив счетов\n  */\n  modView.prototype.renderInvoiceList = function(Invoices) {\n    var invoiceList = '';\n    var _instance = this;\n\n    Invoices.forEach(function(Invoice) {\n      var serviceDetails = '';\n      var currencySign = KT.getCatalogInfo('lcurrency',Invoice.currency,'icon');\n      if (currencySign === 'unknown') {\n        currencySign = Invoice.currency;\n      }\n\n      Invoice.getServiceDetails().forEach(function(service) {\n        serviceDetails += Mustache.render(_instance.mds.tpl.invoiceListItemService, {\n          'serviceId': service.serviceId,\n          'name': service.name,\n          'sum': service.sum.toMoney(2,',',' '),\n          'currencySign': currencySign\n        });\n      });\n\n      var invoiceInfo = {\n        'invoiceId': Invoice.invoiceId,\n        'statusIcon': KT.getCatalogInfo('invoicestatuses', Invoice.status, 'icon'),\n        'statusTitle': KT.getCatalogInfo('invoicestatuses', Invoice.status, 'title'),\n        'number': Invoice.number,\n        'creationDate': Invoice.creationDate.format('DD.MM.YY'),\n        'description': Invoice.description !== null ?\n          Invoice.description : '[Без названия]',\n        'sum': Invoice.sum.toMoney(2,',',' '),\n        'currencySign': currencySign,\n        'serviceDetails': serviceDetails,\n        'actions': {\n          /** Возможность удаления счетов убрана (возможно, временно) */\n          'cancel': false // (Invoice.status !== 5) ? true : false\n        }\n      };\n\n      invoiceList += Mustache.render(_instance.mds.tpl.invoiceListItem, invoiceInfo);\n    });\n\n    if (invoiceList === '') {\n      invoiceList = Mustache.render(_instance.mds.tpl.invoiceListEmpty,{});\n    }\n\n    _instance.$invoiceList.html(invoiceList);\n  };\n\n  /** Очистка данных списка счетов */\n  modView.prototype.flushInvoiceList = function() {\n    this.$invoiceList.html(Mustache.render(KT.tpl.spinner,{}));\n  };\n\n  /** Очистка данных списка услуг */\n  modView.prototype.flushServiceList = function() {\n    this.$serviceList.html(Mustache.render(KT.tpl.spinner,{}));\n  };\n\n  /**\n  * Рендер диалога бронирования нескольких услуг\n  * @param {Object} tosData - данные по условиям юронирования\n  * @param {Function} submitAction - действие при подтверждении\n  */\n  modView.prototype.showChainBookingModal = function(tosData, submitAction) {\n    var _instance = this;\n\n    KT.Modal.notify({\n      type:'info',\n      title:'Бронирование услуг',\n      msg: Mustache.render(this.mds.tpl.TOSAgreementModal, tosData),\n      buttons:[{\n          type:'common',\n          title:'да',\n          callback: submitAction\n        },\n        {\n          type:'common',\n          title:'нет',\n          callback: function() {\n            KT.Modal.closeModal();\n          }\n      }]\n    }).$container\n      .find('#order-edit-payment--tos-agreement')\n        .on('click', '.js-modal-accept-book-terms--tos-link', function() {\n          var tosDocName = $(this).data('tosdoc');\n          _instance.mds.servicesTermsDocuments[tosDocName].open();\n        });\n  };\n\n  /**\n  * Рендер диалога множественной отмены бронирования\n  * @param {ServiceStorage[]} Services - массив услуг\n  * @param {Function} submitAction - действие при подтверждении\n  */\n  modView.prototype.showChainBookCancelModal = function(Services, submitAction) {\n    var modalParams = {\n      'hasPenalty': false,\n      'services': []\n    };\n\n    Services.forEach(function(Service) {\n      var cancelPenaltySum = Service.countClientCancelPenalty();\n\n      var servicePenalty = {\n        'serviceId': Service.serviceId,\n        'name': Service.name,\n        'penalty': (cancelPenaltySum !== null && cancelPenaltySum.inLocal !== 0) ? {\n            'localAmount': Number(cancelPenaltySum.inLocal).toMoney(0,',',' '),\n            'localCurrency': KT.getCatalogInfo('lcurrency', KT.profile.localCurrency, 'icon'),\n            'viewAmout': Number(cancelPenaltySum.inView).toMoney(0,',',' '),\n            'viewCurrency': KT.getCatalogInfo('lcurrency', KT.profile.viewCurrency, 'icon'),\n          } : null,\n        'isInvoiceOptional': false // (KT.profile.userType === 'op' && servicePenalty.penalty !== false) ? true : false;\n      };\n\n      modalParams.services.push(servicePenalty);\n\n      if (servicePenalty.penalty !== null) {\n        modalParams.hasPenalty = true;\n      }\n    });\n    \n    KT.Modal.notify({\n      type: 'info',\n      title:'Отмена бронирования',\n      msg: Mustache.render(this.mds.tpl.multiBookCancelModal, modalParams),\n      buttons:[{\n          type:'common',\n          title:'да',\n          callback: submitAction\n        },\n        {\n          type:'common',\n          title:'нет',\n          callback: function() {\n            KT.Modal.closeModal();\n          }\n      }]\n    });\n\n    return ;\n  };\n\n  /**\n  * Рендер диалога множественной выписки билетов/ваучеров\n  * @param {Function} submitAction - действие при подтверждении\n  */\n  modView.prototype.showChainIssueModal = function(submitAction) {\n    KT.Modal.notify({\n      type:'info',\n      title:'Выписка ваучеров',\n      msg: '<p>Выписать ваучеры для всех выбранных услуг?</p>',\n      buttons:[{\n          type:'common',\n          title:'да',\n          callback: submitAction\n        },\n        {\n          type:'common',\n          title:'нет',\n          callback: function() {\n            KT.Modal.closeModal();\n          }\n      }]\n    });\n  };\n\n  /**\n  * Рендер диалога множественного перевода услуг в ручной режим\n  * @param {Function} submitAction - действие при подтверждении\n  */\n  modView.prototype.showChainSetToManualModal = function(submitAction) {\n    KT.Modal.notify({\n      type:'info',\n      title:'Перевод в ручной режим',\n      msg: '<p>Перевести выбранные услуги в ручной режим?</p>',\n      buttons:[{\n          type:'common',\n          title:'да',\n          callback: submitAction\n        },\n        {\n          type:'common',\n          title:'нет',\n          callback: function() {\n            KT.Modal.closeModal();\n          }\n      }]\n    });\n  };\n\n  /**\n  * Рендер диалога отмены счета\n  * @param {InvoiceStorage} InvoiceStorage - данные счета\n  * @param {Function} submitAction - действие при подтверждении\n  */\n  modView.prototype.showCancelInvoiceModal = function(InvoiceStorage, submitAction) {\n    KT.Modal.notify({\n      type:'info',\n      title:'Отмена счета',\n      msg: 'Вы действительно хотите отменить счет № ' + InvoiceStorage.number,\n      buttons:[{\n          type:'common',\n          title:'да',\n          callback: submitAction\n        },\n        {\n          type:'common',\n          title:'нет',\n          callback: function() {\n            KT.Modal.closeModal();\n          }\n      }]\n    });\n  };\n\n  return modView;\n}));\n","(function(global,factory) {\n\n    KT.crates.OrderEdit.payment.controller = factory(KT.crates.OrderEdit.payment);\n\n}(this, function(crate) {\n  /**\n  * Редактирование заявки: оформление\n  * @constructor\n  * @param {Object} module - хранилище родительского модуля\n  * @param {Object} orderId - ID заявки\n  */\n  var oepController = function(module, orderId) {\n    this.mds = module;\n    this.orderId = orderId;\n    this.mds.payment.view = new crate.view(this.mds);\n  };\n\n  oepController.prototype.init = function() {\n    var _instance = this;\n    var modView = this.mds.payment.view;\n\n    /** Рендер пустого списка если в заявке нет услуг */\n    KT.on('OrderStorage.initialized', function(e, OrderStorage) {\n      if (OrderStorage.getServices().length === 0) {\n        modView.renderServiceList([]);\n      }\n    });\n\n    /** Рендер списка услуг */\n    KT.on('OrderStorage.setServices', function(e, OrderStorage) {\n      modView.renderServiceList(OrderStorage.getServices());\n    });\n\n    /** Обработка загрузки данных по счетам */\n    KT.on('OrderStorage.setInvoices', function(e, OrderStorage) {\n      modView.renderInvoiceList(OrderStorage.getInvoices());\n    });\n\n    /**\n    * При загрузке доступных переходов разблокировать выбор услуг для совершения действий\n    */\n    KT.on('OrderStorage.setAllowedTransitions', function() {\n      modView.renderServiceActions(false);\n    });\n\n    /** Обработка получения всех запрашиваемых валидаций действий над услугами */\n    KT.on('OrderStorage.setValidatedActions', function(e, OrderStorage) {\n      console.warn('service validations:');\n      console.log(OrderStorage.validatedActions);\n\n      var actions = $.extend(true, {}, OrderStorage.validatedActions);\n\n      // хак для разного стиля кнопок, переделать?\n      if (KT.profile.userType !== 'op' && actions['Manual']) {\n        actions['ToManager'] = actions['Manual'];\n        delete actions['Manual'];\n      }\n\n      modView.renderServiceActions(actions);\n    });\n\n    /*===============================================\n    * Обработчики событий представления\n    **===============================================*/\n    \n    /** Обработка нажатия кнопки \"Сохранить\" на вкладке оформления заявки */\n    KT.on('PaymentView.setDiscount', function(e, data) {\n      KT.apiClient.setDiscount(_instance.orderId, data.discount)\n        .done(function(response) {\n          if (response.status === 0) {\n            KT.notify('discountSet',{'discount': response.discount});\n            modView.flushSetInvoiceForm();\n            modView.flushServiceList();\n          } else {\n            $(modView.$serviceList).find('input[name=\"discount\"]')\n              .prop('disabled',false)\n              .val(modView.discountSum);\n            KT.notify('settingDicountFailed', response.errors);\n          }\n        });\n    });\n\n    /** Раскрыть/свернуть информацию по счету */\n    modView.$invoiceList.on('click','.js-ore-invoice--header', function() {\n      var $invoice = $(this).closest('.js-ore-invoice');\n      if ($invoice.hasClass('active')) { $invoice.removeClass('active'); }\n      else { $invoice.addClass('active'); }\n      $invoice.find('.js-ore-invoice--description').toggle(500);\n    });\n\n    /**\n    * Обработка выбора услуги на вкладке \"Оформление\": \n    * вычисление доступных действий с услугами\n    */\n    modView.$serviceList.on('change','.js-ore-payment-services--check-service', function() {\n      modView.clearServiceActions();\n      _instance.mds.OrderStorage.validatedActions = {};\n      \n      var checkedServices = modView.getSelectedServices();\n      modView.$serviceList\n        .find('.js-ore-payment-services--check-service')\n          .prop('disabled', true);\n      \n      if (checkedServices.length === 0) {\n        modView.renderServiceActions(false);\n      } else {\n        var servicesTransitions = [];\n        // для каждой услуги получим набор доступных переходов по checkTransitions ...\n        checkedServices.forEach(function(serviceId) {\n          servicesTransitions.push(\n            $.extend(true, [], _instance.mds.OrderStorage.services[serviceId].allowedTransitions)\n          );\n        });\n        // ... и отфильтруем переходы, общие для всех выбранных услуг\n        var commonTransitions;\n        if (servicesTransitions.length === 1) {\n          commonTransitions = servicesTransitions[0];\n        } else {\n          commonTransitions = servicesTransitions.shift().filter(function(v) {\n            return servicesTransitions.every(function(a) {\n              return a.indexOf(v) !== -1;\n            });\n          });\n        }\n\n        var validationParams = {};\n        var transitionsAmount = 0;\n\n        // для каждого перехода получим масив парвметров по всем услугам для передачи на validate\n        commonTransitions.forEach(function(transition) {\n          validationParams[transition] = [];\n          var paramsMergeError = false;\n\n          checkedServices.forEach(function(serviceId) {\n            var serviceValidations = _instance.mds.OrderStorage.getServiceCommandParams(transition, serviceId);\n            if (serviceValidations === false) {\n              paramsMergeError = true;\n            } else {\n              /** @todo хак для галочки bookStart */\n              if (transition === 'BookStart') {\n                serviceValidations.agreementSet = true;\n              }\n\n              validationParams[transition].push(serviceValidations);\n            }\n          });\n\n          if (paramsMergeError) {\n            delete validationParams[transition];\n          } else {\n            transitionsAmount++;\n          }\n        });\n        \n        if (transitionsAmount === 0) {\n          modView.renderServiceActions(false);\n        } else {\n          _instance.mds.OrderStorage.pendingValidations = transitionsAmount;\n          for (var action in validationParams) {\n            if (validationParams.hasOwnProperty(action)) {\n              KT.apiClient.validateAction(_instance.orderId, action, validationParams[action])\n                .done(function(response) {\n                  if (response.status === 0) {\n                    _instance.mds.OrderStorage.setValidatedAction(response.action, response.body);\n                  } else {\n                    _instance.mds.OrderStorage.setValidatedAction(response.action, false);\n                  }  \n                });\n            }\n          }\n        }\n      }\n    });\n\n    /** Обработка нажатия на кнопку \"Бронировать\" */\n    modView.$serviceList.on('click','.js-ore-payment-services--book', function() {\n      var serviceIds = modView.getSelectedServices();\n      var tosData = {\n        'services': [],\n        'hasNonRefundableServices': false\n      };\n\n      serviceIds.forEach(function(serviceId) {\n        var Service = _instance.mds.OrderStorage.services[serviceId];\n\n        if (Service.isNonRefundable) {\n          tosData.hasNonRefundableServices = true;\n        }\n\n        tosData.services.push({\n          'icon': KT.getCatalogInfo('servicetypes', Service.typeCode, 'icon'),\n          'type': KT.getCatalogInfo('servicetypes', Service.typeCode, 'title'),\n          'name': Service.name,\n          'tosdoc': Service.tosDocumentName\n        });\n      });\n\n      var chainBooking = function() {\n        KT.Modal.showLoader();\n\n        var bookProcesses = [];\n        \n        serviceIds.forEach(function(serviceId) {\n          var commandParams = _instance.mds.OrderStorage.getServiceCommandParams('BookStart', serviceId);\n          commandParams['agreementSet'] = true;\n          bookProcesses.push(KT.apiClient.startBooking(_instance.orderId, commandParams));\n        });\n\n        $.when.apply($, bookProcesses).always(function() {\n          KT.Modal.closeModal();\n          KT.dispatch('OrderEdit.reloadInfo');\n        });\n      };\n\n      modView.showChainBookingModal(tosData, chainBooking);\n    });\n\n    /** Обработка нажатия на кнопку \"Отменить бронь\" */\n    modView.$serviceList.on('click','.js-ore-payment-services--book-cancel', function() {\n      var serviceIds = modView.getSelectedServices();\n      var services = [];\n\n      serviceIds.forEach(function(serviceId) {\n        services.push(_instance.mds.OrderStorage.services[serviceId]);\n      });\n\n      var chainBookCancel = function($modal) {\n        var $isSetInvoiceSelected = $modal.find('.js-modal-book-cancel--set-invoice');\n        KT.Modal.showLoader();\n\n        var bookCancelProcesses = [];\n\n        serviceIds.forEach(function(serviceId) {\n          var commandParams = _instance.mds.OrderStorage.getServiceCommandParams('BookCancel', serviceId);\n          var $serviceInvoiceCheckbox = $isSetInvoiceSelected.filter('[data-serviceid=\"' + serviceId + '\"]');\n          if ($serviceInvoiceCheckbox.length !== 0) {\n            commandParams['createPenaltyInvoice'] = $serviceInvoiceCheckbox.prop('checked');\n          } else {\n            commandParams['createPenaltyInvoice'] = true;\n          }\n\n          bookCancelProcesses.push(KT.apiClient.bookCancel(_instance.orderId, commandParams));\n        });\n\n        $.when.apply($, bookCancelProcesses).always(function() {\n          KT.Modal.closeModal();\n          KT.dispatch('OrderEdit.reloadInfo');\n        });\n      };\n\n      modView.showChainBookCancelModal(services, chainBookCancel);\n    });\n\n    /** Обработка нажатия на кнопку \"Выставить счет\" */\n    modView.$serviceList.on('click','.js-ore-payment-services--set-invoice', function() {\n      KT.dispatch('OrderEdit.openSetInvoiceForm');\n    });\n\n    /** Обработка нажатия кнопки \"Аннулировать услугу\" */\n    /** @todo template, не реализовано */\n    modView.$serviceList.on('click','.js-ore-payment-services--cancel', function() {\n      var serviceIds = modView.getSelectedServices();\n\n      KT.Modal.notify({\n        type:'info',\n        title:'Аннулирование услуг',\n        msg:'<p>Вы действительно хотите аннулировать выбранные услуги: ' +\n          serviceIds.join(',') + ' ?</p>',\n        buttons:[\n          {title:'Да'},\n          {title:'Нет'}\n        ]\n      });\n    });\n\n    /** Обработка нажатия кнопки \"Выписать ваучер\" */\n    modView.$serviceList.on('click','.js-ore-payment-services--issue', function() {\n      var serviceIds = modView.getSelectedServices();\n      var services = [];\n\n      serviceIds.forEach(function(serviceId) {\n        services.push(_instance.mds.OrderStorage.services[serviceId]);\n      });\n\n      var chainIssueTickets = function() {\n        KT.Modal.showLoader();\n\n        var issueProcesses = [];\n\n        serviceIds.forEach(function(serviceId) {\n          var commandParams = _instance.mds.OrderStorage.getServiceCommandParams('IssueTickets', serviceId);\n          issueProcesses.push(KT.apiClient.issueTickets(_instance.orderId, commandParams));\n        });\n\n        $.when.apply($, issueProcesses).always(function() {\n          KT.Modal.closeModal();\n          KT.dispatch('OrderEdit.reloadInfo');\n        });\n      };\n\n      modView.showChainIssueModal(chainIssueTickets);\n    });\n\n    /** Обработка нажатия кнопки \"Перевести в ручной режим\" */\n    modView.$serviceList.on('click','.js-ore-payment-services--to-manual', function() {\n      var serviceIds = modView.getSelectedServices();\n      var services = [];\n\n      serviceIds.forEach(function(serviceId) {\n        services.push(_instance.mds.OrderStorage.services[serviceId]);\n      });\n\n      var chainSetServiceToManual = function() {\n        KT.Modal.showLoader();\n\n        var chainProcesses = [];\n\n        serviceIds.forEach(function(serviceId) {\n          var commandParams = _instance.mds.OrderStorage.getServiceCommandParams('Manual', serviceId);\n          chainProcesses.push(KT.apiClient.setServiceToManual(_instance.orderId, commandParams));\n        });\n\n        $.when.apply($, chainProcesses).always(function() {\n          KT.Modal.closeModal();\n          KT.dispatch('OrderEdit.reloadInfo');\n        });\n      };\n\n      modView.showChainSetToManualModal(chainSetServiceToManual);\n    });\n\n    /** Обработка нажатия на ссылку на условия бронирования */\n    modView.$serviceList.on('click','.js-ore-payment-services--tos', function() {\n      var serviceId = +$(this).data('serviceid');\n      var service = _instance.mds.OrderStorage.services[serviceId];\n\n      if (service.cancellationDocumentName !== false) {\n        if (_instance.mds.servicesTermsDocuments[service.cancellationDocumentName] !== undefined) {\n          _instance.mds.servicesTermsDocuments[service.cancellationDocumentName].open();\n        } else {\n          KT.notify('waitTOSLoading');\n        }\n      }\n    });\n\n    /** Обработка нажатия на кнопку отмены счета */\n    /** @todo добавить обновление модели счета? */\n    modView.$invoiceList.on('click', '.js-ore-invoice-actions--cancel', function() {\n      var invoiceId = +$(this).closest('.js-ore-invoice').data('invoiceid');\n      var InvoiceStorage = _instance.mds.OrderStorage.invoices[invoiceId];\n\n      var cancelInvoce = function() {\n        KT.Modal.showLoader();\n\n        KT.apiClient.cancelInvoice(invoiceId)\n          .then(function(response) {\n            if (response.status === 0) {\n              //InvoiceStorage.status = InvoiceStorage.statuses.CANCELLED;\n              modView.flushInvoiceList();\n\n              var getServices = KT.apiClient.getOrderOffers(_instance.orderId, _instance.mds.OrderStorage.getServiceIds());\n              var getInvoices = KT.apiClient.getOrderInvoices(_instance.orderId);\n\n              getServices.done(function(offersData) {\n                if (offersData.status !== 0) {\n                  console.error('offer load error: ' + offersData.error);\n                } else {\n                  _instance.mds.OrderStorage.setServices(offersData.body);\n                }\n              });\n\n              getInvoices.done(function(invoiceData) {\n                var invoices = (invoiceData.body.Invoices !== undefined && Array.isArray(invoiceData.body.Invoices)) ?\n                    invoiceData.body.Invoices : [];\n                _instance.mds.OrderStorage.setInvoices(invoices);\n              });\n\n              $.when.apply($, [getServices, getInvoices]).always(function() {\n                KT.Modal.closeModal();\n              });\n            }\n          });\n      };\n\n      modView.showCancelInvoiceModal(InvoiceStorage, cancelInvoce);\n    });\n  };\n\n  return oepController;\n}));\n","(function(global,factory){\n\n    KT.crates.OrderEdit.view = factory();\n\n}(this,function() {\n  /**\n  * Редактирование заявки\n  * @constructor\n  * @param {Object} module - хранилище родительского модуля\n  * @param {Number} orderId - Id заявки\n  * @param {Object} [options] - Объект конфигурации класса\n  */\n  var modView = function(module, orderId, options) {\n    this.mds = module;\n    if (options === undefined) { options = {}; }\n    this.config = $.extend(true, {\n      'templateUrl':'/cabinetUI/orders/getTemplates',\n      'templates':{\n        headerOrderInfo:'orderEdit/headerInfo',\n        headerSpinner:'orderEdit/headerSpinner',\n        invoices:'orderEdit/invoices',\n        invoicesRow:'orderEdit/invoicesRow',\n        documents:'orderEdit/documents',\n        documentsRow:'orderEdit/documentsRow',\n        documentsEmpty:'orderEdit/documentsEmpty',\n        history:'orderEdit/history',\n        historyRow:'orderEdit/historyRow',\n      }\n    },options);\n\n    this.mds.tpl = {};\n\n    this.orderId = orderId;\n\n    this.$headerInfo = $('#order-edit-header__info');\n    this.$headerControls = $('#order-edit-header__controls');\n    this.$breadcrumb = $('#order-edit-header__ordernum');\n\n    this.$btnInvoices = this.$headerControls.find('.js-ore-show-invoices');\n    this.$btnDocuments = this.$headerControls.find('.js-ore-show-documents');\n\n    /** @todo set forms loaded via ajax? */\n    this.SetInvoiceForm = {};\n    this.SetInvoiceForm.controls = {};\n    this.SetInvoiceForm.$wrapper = $('.js-ore-set-invoice');\n    this.SetInvoiceForm.wnd = $.featherlight(this.SetInvoiceForm.$wrapper, {\n      persist:true,\n      closeIcon:'',\n      openSpeed:0,\n      closeSpeed:0\n    });\n    this.SetInvoiceForm.wnd.close();\n    this.SetInvoiceForm.wnd.openSpeed = 200;\n    this.SetInvoiceForm.wnd.closeSpeed = 200;\n    this.SetInvoiceForm.$content = this.SetInvoiceForm.wnd.$content.find('.js-ore-set-invoice--content');\n    //this.Invoices.$content = this.invoices.$wrapper.find('.js-ore-invoices--content');\n\n    this.documents = {};\n    this.documents.$wrapper = $('.js-ore-documents');\n    this.documents.$content = this.documents.$wrapper.find('.js-ore-documents--content');\n\n    this.$history = $('.js-ore-history');\n    this.History = this.setHistory(this.$history, this.$headerControls, '.js-ore-show-history');\n\n    this.$addServiceBlock = $('.order-footer .add-service-block');\n\n    /** Установка хлебной крошки */\n    this.$breadcrumb.html(\n      this.orderId === 'new' ?\n      'Новая заявка' :\n      'Заявка '+this.orderId\n    );\n\n    /** @todo move it */\n    this.initTabs();\n    this.History.init();\n\n    /*\n    this.$btnInvoices.featherlight(this.invoices.$wrapper, {\n      persist:'shared',\n      closeIcon:''\n    }); */\n    this.$btnDocuments.featherlight(this.documents.$wrapper, {\n      persist:'shared',\n      closeIcon:''\n    });\n  };\n\n  /** Разблокировка раздела */\n  modView.prototype.enableTab = function(tab) {\n    $('#tab-headers')\n      .find('.js-tab-header')\n      .filter('[data-tab=\"'+tab+'\"]')\n      .prop('disabled', false);\n  };\n  /** Блокировка раздела */\n  modView.prototype.disableTab = function(tab) {\n    $('#tab-headers')\n      .find('.js-tab-header')\n      .filter('[data-tab=\"'+tab+'\"]')\n      .prop('disabled', true);\n  };\n\n  /**\n  * Установка текущей активной вкладки\n  * @param {String} tab - код вкладки\n  */\n  modView.prototype.setActiveTab = function(tab) {\n    $('#tab-headers')\n      .find('.js-tab-header')\n        .removeClass('active')\n        .filter('[data-tab=\"'+tab+'\"]')\n          .addClass('active')\n          .prop('disabled', false)\n        .end();\n    $('.js-content-tab')\n      .removeClass('active')\n      .filter('[data-tab=\"'+tab+'\"]')\n        .addClass('active')\n      .end();\n    $('#main-scroller').scrollTop(0);\n  };\n\n  /** Инициализация табов */\n  modView.prototype.initTabs = function() {\n    var _instance = this;\n\n    $('#tab-headers').on('click','.js-tab-header',function(e){\n      e.preventDefault();\n      var tab = $(this).attr('data-tab');\n      _instance.setActiveTab(tab);\n    });\n  };\n\n  /**\n  * Отображение информации о заявке в шапке\n  * @param {Object} orderInfo - информация о заявке\n  */\n  modView.prototype.renderHeaderInfo = function(OrderStorage) {\n    var localSum = 0;\n    var requestedSum = 0;\n    var tourleaderName = '';\n    var hasTourleader = false;\n    var gatewayOrderIds = false;\n    var kmpManager = null;\n    var clientManager = null;\n    var clientCompany = null;\n    var creator = null;\n\n    if (this.orderId !== 'new' && KT.profile.userType === 'op') {\n      this.$breadcrumb.html(\n        'Заявка ' + OrderStorage.orderId +\n        (\n          (OrderStorage.creationDate !== null) ?\n           ' (от ' + OrderStorage.creationDate.format('DD.MM.YYYY') + ')' :\n           ''\n        )\n      );\n\n      if (OrderStorage.orderIdGp !== null || OrderStorage.orderIdUtk !== null) {\n        gatewayOrderIds = {\n          'gp':OrderStorage.orderIdGp,\n          'utk':OrderStorage.orderIdUtk\n        };\n      }\n    }\n\n    if (OrderStorage.tourleader === null) {\n      tourleaderName = 'Ф.И.О. туриста';\n    } else {\n      hasTourleader = true;\n      tourleaderName = OrderStorage.tourleader.lastname +\n        ((OrderStorage.tourleader.firstname !== null) ?\n          ' ' + OrderStorage.tourleader.firstname : '');\n    }\n\n    kmpManager = (OrderStorage.kmpManager === null) ? null :\n      OrderStorage.kmpManager.lastname + ' ' +\n        ((OrderStorage.kmpManager.firstname !== null) ?\n          (OrderStorage.kmpManager.firstname.substr(0,1) + '. ') : '') +\n        ((OrderStorage.kmpManager.middlename !== null) ?\n          (OrderStorage.kmpManager.middlename.substr(0,1) + '.') : '');\n\n    clientManager = (OrderStorage.clientManager === null) ? null : \n      OrderStorage.clientManager.lastname + ' ' +\n        ((OrderStorage.clientManager.firstname !== null) ?\n          (OrderStorage.clientManager.firstname.substr(0,1) + '. ') : '') +\n        ((OrderStorage.clientManager.middlename !== null) ?\n          (OrderStorage.clientManager.middlename.substr(0,1) + '.') : '');\n\n    creator = (OrderStorage.creator === null) ? null : \n      OrderStorage.creator.lastname + ' ' +\n        ((OrderStorage.creator.firstname !== null) ?\n          (OrderStorage.creator.firstname.substr(0,1) + '. ') : '') +\n        ((OrderStorage.creator.middlename !== null) ?\n          (OrderStorage.creator.middlename.substr(0,1) + '.') : '');\n    \n    clientCompany = (KT.profile.userType !== 'op') ? null :\n      ('\"' + OrderStorage.client.name + '\"').replace('\"\"','\"');\n\n    OrderStorage.getServices().forEach(function(Service) {\n      switch (KT.profile.prices) {\n        case 'gross':\n          localSum += Service.prices.inLocal.client.gross;\n          requestedSum += Service.prices.inView.client.gross;\n          break;\n        case 'net':\n          switch (KT.profile.userType) {\n            case 'op':\n              localSum += Service.prices.inLocal.supplier.gross;\n              requestedSum += Service.prices.inView.supplier.gross;\n              break;\n            case 'agent':\n              localSum += Service.prices.inLocal.client.gross - Service.prices.inLocal.client.commission.amount;\n              requestedSum += Service.prices.inView.client.gross - Service.prices.inView.client.commission.amount;\n              break;\n            default:\n              localSum += Service.prices.inLocal.client.gross;\n              requestedSum += Service.prices.inView.client.gross;\n              break;\n          }\n          break;\n      }\n    });\n\n    var order = {\n      'vip': OrderStorage.isVip,\n      'orderStatusIcon': KT.getCatalogInfo('orderstatuses', OrderStorage.status, 'icon'),\n      'orderStatusTitle': KT.getCatalogInfo('orderstatuses', OrderStorage.status, 'title'),\n      'orderId': (OrderStorage.orderId !== 'new') ? OrderStorage.orderId : null,\n      'creationDate': (OrderStorage.creationDate === null) ? 'не указана' :\n        OrderStorage.creationDate.format('YYYY-MM-DD HH:mm:ss'),\n      'gatewayOrderIds': gatewayOrderIds,\n      'kmpManager': kmpManager,\n      'clientCompany': clientCompany,\n      'clientManager': clientManager,\n      'creator': creator,\n      'touristSet': hasTourleader,\n      'touristName': htmlDecode(tourleaderName),\n      'touristCount': (OrderStorage.touristsAmount > 1) ? '+ ' + (OrderStorage.touristsAmount - 1) : '',\n      'touristTel': hasTourleader ? OrderStorage.tourleader.phone : null,\n      'touristEmail': hasTourleader ? OrderStorage.tourleader.email : null,\n      'localSum': localSum.toMoney(0,',',' '),\n      'requestedSum': requestedSum.toMoney(2,',',' '),\n      'requestedCurrency': KT.getCatalogInfo('lcurrency',KT.profile.viewCurrency,'icon')\n    };\n\n    if (KT.profile.userType === 'op' && OrderStorage.status === 1) {\n      order.orderStatusTitle = 'Ручной режим';\n    }\n\n    this.$headerInfo.html( Mustache.render(this.mds.tpl.headerOrderInfo, order) );\n  };\n\n  /**\n  * Инициализация формы выставления счетов\n  * @param {Object} $container контейнер формы\n  * @param {Object} $bindcontainer элемент, на который вешается обработка клика для открытия окна\n  * @param {String} bindelem селектор элемента-цели для открытия окна\n  */\n  modView.prototype.setHistory = function($container,$bindcontainer,bindelem) {\n    var _instance = this;\n\n    var History = {\n      elem: {\n        $container: $container,\n        $bindcontainer: $bindcontainer,\n        $history: $container.find('.js-ore-history--content')\n      },\n      toggler: bindelem,\n      wnd: null,\n      init: function() {\n        var self = this;\n        self.wnd = $.featherlight(this.elem.$container, {\n          persist:'shared',\n          closeIcon:'',\n          openSpeed:0,\n          closeSpeed:0\n        });\n        self.wnd.close();\n        self.wnd.openSpeed = 250;\n        self.wnd.closeSpeed = 250;\n\n        self.elem.$bindcontainer.on('click',self.toggler+':not(:disabled)',function() {\n          self.wnd.open();\n        });\n\n        self.elem.$container.on('click','button[data-action=\"cancel\"]',function(){\n          self.wnd.close();\n        });\n      },\n      render: function(history) {\n        if (Array.isArray(history)) {\n          var historyList = {\n            'history': ''\n          };\n\n          history.forEach(function(record) {\n            record.eventTime = moment(record.eventTime,'YYYY-MM-DD HH:mm:ss').format('D MMMM YYYY, HH:mm');\n            record.serviceStatusTitle = KT.getCatalogInfo('servicestatuses', record.serviceStatus,'title');\n            record.serviceStatusIcon = KT.getCatalogInfo('servicestatuses', record.serviceStatus,'icon');\n            record.orderStatusTitle = KT.getCatalogInfo('orderstatuses', record.orderStatus,'title');\n            record.orderStatusIcon = KT.getCatalogInfo('orderstatuses', record.orderStatus,'icon');\n            record.success = (+record.result === 0) ? true : false;\n\n            historyList.history += Mustache.render(_instance.mds.tpl.historyRow, record);\n          });\n\n          this.elem.$history.html( Mustache.render(_instance.mds.tpl.history,historyList) );\n          this.elem.$bindcontainer.find(this.toggler).prop('disabled', false);\n        }\n      }\n    };\n\n    return History;\n  };\n\n  /**\n  * Отображение формы выставления счетов\n  * @param {ServiceStorage[]} services - сервисы заявки (ServiceStorage)\n  */\n  modView.prototype.renderSetInvoiceForm = function(services) {\n    var _instance = this;\n    var invoiceRows = '';\n    /** @todo надо бы понять, как выставлять счета на все услуги, если у них разные валюты */\n    var currencySign = '';\n\n    _instance.$btnInvoices.prop('disabled', false);\n\n    services.forEach(function(service) {\n      currencySign = KT.getCatalogInfo('lcurrency',service.paymentCurrency,'icon');\n      if (currencySign === 'unknown') {\n        currencySign = service.paymentCurrency;\n      }\n\n      var serviceData = {\n        'serviceId': service.serviceId,\n        'statusIcon': KT.getCatalogInfo('servicestatuses',service.status,'icon'),\n        'statusTitle': KT.getCatalogInfo('servicestatuses',service.status,'title'),\n        'serviceName': service.name,\n        'price': service.prices.inClient.client.gross.toMoney(2,',',' '),\n        'disabled': !service.isActionAvailable.setInvoice,\n        'leftToPay': (!service.isActionAvailable.setInvoice) ? 0 :\n          Number(service.unpaidSum).toMoney(2,',',' '),\n        'currencyIcon': currencySign\n      };\n\n      if (KT.profile.userType === 'op' && service.status === 9) {\n        serviceData.statusTitle = 'Ручной режим';\n      }\n\n      invoiceRows += Mustache.render(_instance.mds.tpl.invoicesRow, serviceData);\n    });\n\n    /** @todo rework currency icon for services..*/\n\n\n    var invoiceTable = {\n      'services': invoiceRows,\n      'currencyCode': currencySign\n    };\n\n    _instance.SetInvoiceForm.$content.html(Mustache.render(_instance.mds.tpl.invoices, invoiceTable));\n\n    _instance.SetInvoiceForm.controls.selectPayment = $('#SetInv-SelectPayment').selectize({\n        openOnFocus: true,\n        create: false,\n        createOnBlur:true\n    });\n  };\n\n  /**\n  * Отображение формы управления документами заявки\n  * @param {Object[]} documents - массив документов заявки\n  */\n  modView.prototype.renderDocumentsForm = function(documents) {\n    var _instance = this;\n    var documentsList = '';\n\n    _instance.$btnDocuments.prop('disabled', false);\n\n    if (Array.isArray(documents) && documents.length > 0) {\n      documents.forEach(function(document) {\n        if (document.fileName === '') { document.fileName = 'Документ'; }\n        documentsList += Mustache.render(_instance.mds.tpl.documentsRow, document);\n      });\n    } else {\n      documentsList = Mustache.render(_instance.mds.tpl.documentsEmpty, {});\n    }\n\n    _instance.documents.$content.html(Mustache.render(_instance.mds.tpl.documents, {\n      'documents': documentsList\n    }));\n  };\n\n  /**\n  * Отображение прогресса загрузки документов\n  * @param {Integer} percent - процент загрузки\n  */\n  modView.prototype.showDocUploadProgress = function(percent) {\n    var $progresslabel = this.documents.$content.find('.js-ore-documents--upload-progress-text');\n    var $progressbar = this.documents.$content.find('.js-ore-documents--upload-progress-bar');\n\n    if (+percent !== 100) {\n      $progresslabel.text(percent + ' %');\n      $progressbar.css({'width':percent + '%'});\n    } else {\n      $progresslabel.text('обработка документа...');\n      $progressbar.removeClass('active').css({'width':'100%'});\n    }\n  };\n\n  /** Очистка блока документов */\n  modView.prototype.flushDocumentsForm = function() {\n    this.documents.$content.html(Mustache.render(KT.tpl.spinner, {}));\n  };\n\n  /**\n  * Управление значениями полей ввода в форме выставления счета\n  * @param {Object} $input - поле ввода\n  * @param {Number} maxInvoiceSum - максимальная сумма счета для услуги\n  */\n  modView.prototype.checkInvoiceFormInput = function($serviceRow, maxInvoiceSum) {\n    var $inputs = this.SetInvoiceForm.$content.find('.js-ore-set-invoice--service-sum');\n    var $input = $serviceRow.find('.js-ore-set-invoice--service-sum');\n    var $checkbox = $serviceRow.find('.js-ore-set-invoice--service-check');\n\n    $input.prop('disabled',true);\n    var inputValue = parseFloat($input.val().replace(/\\s+/g,'').replace(',','.'));\n\n    \n    $checkbox.on('change.onhold', function(e) { e.stopPropagation(); });\n\n    if (isNaN(inputValue)) {\n      /** @todo fire error */\n      console.log('NaN entered');\n      $input.val('');\n      $checkbox.prop('checked', false);\n    } else {\n      if (inputValue < 0) { inputValue = 0; }\n      if (inputValue > maxInvoiceSum) {\n        inputValue = maxInvoiceSum;\n      }\n\n      if (inputValue !== 0) {\n        $input.val(inputValue.toMoney(2,',',' '));\n        $checkbox.prop('checked', true);\n      } else {\n        $input.val('');\n        $checkbox.prop('checked', false);\n      }\n    }\n\n    $checkbox.off('change.onhold');\n\n    var total = 0;\n\n    $inputs.each(function() {\n      var currentValue = parseFloat($(this).val().replace(/\\s+/g,'').replace(',','.'));\n      total += isNaN(currentValue) ? 0 : currentValue;\n    });\n\n    this.SetInvoiceForm.$content.find('.js-ore-set-invoice--total-invoice').text(total.toMoney(2,',',' '));\n    $input.prop('disabled',false);\n  };\n\n  /** Отметить услугу для выставления счета */\n  modView.prototype.markServiceForInvoice = function($serviceRow, defaultInvoiceSum) {\n    var $inputs = this.SetInvoiceForm.$content.find('.js-ore-set-invoice--service-sum');\n    var $input = $serviceRow.find('.js-ore-set-invoice--service-sum');\n\n    $input.prop('disabled',true);\n\n    if (defaultInvoiceSum !== 0) {\n      $input.val(defaultInvoiceSum.toMoney(2,',',' '));\n    } else {\n      $input.val('');\n    }\n\n    var total = 0;\n    $inputs.each(function() {\n      var currentValue = parseFloat($(this).val().replace(/\\s+/g,'').replace(',','.'));\n      total += isNaN(currentValue) ? 0 : currentValue;\n    });\n\n    this.SetInvoiceForm.$content.find('.js-ore-set-invoice--total-invoice').text(total.toMoney(2,',',' '));\n    $input.prop('disabled',false);\n  };\n\n  /** Сбор данных из формы выставления счета */\n  modView.prototype.getInvoiceFormData = function() {\n    var invServices = [];\n    var hasZeroSum = false;\n\n    this.SetInvoiceForm.$content\n      .find('.js-ore-set-invoice--service-check:checked')\n        .each(function() {\n          var $row = $(this).closest('.js-ore-set-invoice--service');\n          var sum = Number($row.find('.js-ore-set-invoice--service-sum').val().replace(/\\s+/g,'').replace(',','.'));\n\n          if (sum === 0) {\n            hasZeroSum = true;\n          } else if (sum > 0) {\n            sum = sum.toFixed(2);\n            invServices.push({\n              'id':+$row.attr('data-serviceid'),\n              'sum':sum\n            });\n          }\n    });\n\n    if (invServices.length === 0 && hasZeroSum) { return false; }\n    else { return invServices; }\n  };\n\n  /** Очистка данных формы выставления счета */\n  modView.prototype.flushSetInvoiceForm = function() {\n    this.SetInvoiceForm.$content.html(Mustache.render(KT.tpl.spinner, {}));\n  };\n\n  /** Очистка шапки */\n  modView.prototype.flushTopInfo = function() {\n    /** @todo поменять на общий spinner */\n    this.$headerInfo.html(Mustache.render(this.mds.tpl.headerSpinner));\n  };\n\n  return modView;\n}));\n","(function(global,factory) {\n\n    KT.crates.OrderEdit.controller = factory(KT.crates.OrderEdit);\n\n}(this,function(crate) {\n  /**\n  * Редактирование заявки\n  * @constructor\n  * @param {Object} module - ссылка на модуль\n  */\n  var oeController = function(module) {\n    /** Module storage - модуль со всеми его компонентами */\n    this.mds = module;\n\n    window.sessionStorage.removeItem('inOrderInfo');\n\n    /** Получение номера запрашиваемой заявки из ссылки */\n    try {\n      this.orderId = window.location.pathname.match(/[^/]+$/)[0];\n      if (this.orderId !== 'new') {\n        this.orderId = +this.orderId;\n        if (isNaN(this.orderId) || this.orderId <= 0) {\n          this.orderId = null;\n        }\n      }\n    } catch (e) {\n      this.orderId = null;\n    }\n\n    this.mds.view = new crate.view(this.mds, this.orderId);\n    this.mds.OrderStorage = new KT.storage.OrderStorage(this.orderId);\n\n    if (this.orderId === 'new') {\n      this.mds.view.setActiveTab('tourists');\n      this.mds.tourists.controller = new crate.tourists.controller(this.mds, this.orderId);\n      this.mds.view.$addServiceBlock.find('.iconed-link[data-srv]').addClass('disabled');\n      \n    } else if (this.orderId !== null) {\n      this.mds.view.enableTab('tourists');\n      this.mds.view.enableTab('payment');\n      this.mds.view.setActiveTab('services');\n\n      this.mds.payment.controller = new crate.payment.controller(this.mds, this.orderId);\n      this.mds.tourists.controller = new crate.tourists.controller(this.mds, this.orderId);\n      this.mds.services.controller = new crate.services.controller(this.mds, this.orderId);\n    }\n  };\n\n  /** Инициализация событий */\n  oeController.prototype.init = function() {\n    var _instance = this;\n    var modView = _instance.mds.view;\n\n    /** Обработка смены валюты просмотра */\n    KT.on('KT.changedViewCurrency', function() {\n      //modView.flushSetInvoiceForm();\n      if (_instance.orderId !== 'new') {\n        modView.flushTopInfo();\n        KT.apiClient.getOrderInfo(_instance.orderId)\n          .done(function(response) {\n            if (response.status !== 0) {\n              window.location.assign('/cabinetUI/orders/order/' + _instance.orderId);\n            } else {\n              _instance.mds.OrderStorage.initialize(response.body);\n            }\n          });\n      }\n    });\n\n    /** Обработка изменения значения переключателя нетто/брутто */\n    KT.on('KT.changedViewPrice',function() {\n      //modView.flushSetInvoiceForm();\n      if (_instance.orderId !== 'new') {\n        modView.flushTopInfo();\n        KT.apiClient.getOrderInfo(_instance.orderId)\n          .done(function(response) {\n            if (response.status !== 0) {\n              window.location.assign('/cabinetUI/orders/order/' + _instance.orderId);\n            } else {\n              _instance.mds.OrderStorage.initialize(response.body);\n            }\n          });\n      }\n    });\n\n    /** Обработка запроса на переход по вкладке */\n    KT.on('OrderEdit.setActiveTab', function(e, data) {\n      if (data.activeTab !== undefined) {\n        modView.setActiveTab(data.activeTab);\n        if (typeof data.callback === 'function') {\n          data.callback();\n        }\n      }\n    });\n\n    /** Обработка обновления информации по туристам */\n    KT.on('OrderEdit.reloadInfo', function() {\n      //modView.flushSetInvoiceForm();\n      modView.flushTopInfo();\n      _instance.mds.OrderStorage.loadStates.servicedata = 'pending';\n      _instance.mds.OrderStorage.loadStates.transitionsdata = 'pending';\n      console.warn('reload catched');\n\n      KT.apiClient.getOrderInfo(_instance.orderId)\n        .then(function(orderInfo) {\n          if (orderInfo.status === 0) {\n            _instance.mds.OrderStorage.initialize(orderInfo.body);\n            var serviceIds = _instance.mds.OrderStorage.getServiceIds();\n            return KT.apiClient.getOrderOffers(_instance.orderId, serviceIds);\n          } else {\n            return $.Deferred().reject();\n          }\n        })\n        .then(function(offersData) {\n          if (offersData.status === 0) {\n            _instance.mds.OrderStorage.setServices(offersData.body);\n            return KT.apiClient.getAllowedTransitions(_instance.orderId);\n          } else {\n            return $.Deferred().reject();\n          }\n        })\n        .then(function(transitionsData) {\n          console.warn('got transitions data');\n          if (transitionsData.status === 0 ) {\n            if (Array.isArray(transitionsData.body.services)) {\n              _instance.mds.OrderStorage.setAllowedTransitions(transitionsData.body.services);\n            } else {\n              _instance.mds.OrderStorage.setAllowedTransitions([]);\n            }\n          } else {\n            console.error('не удалось получить доступные действия');\n          }\n        });\n\n      KT.apiClient.getOrderHistory(_instance.orderId)\n        .done(function(response) {\n          if (response.status !== 0) {\n            if (response.errorCode === 8) {\n              console.log('Для данной заявки нет истории');\n            } else {\n              KT.notify('loadingHistoryFailed', response.errorCode + ': ' + response.errors);\n            }\n          } else {\n            _instance.mds.OrderStorage.setHistory(response.body);\n          }\n        });\n    });\n\n    /** Обработка запроса на обновление информации в шапке\n    * @todo normalize event model\n    */\n    KT.on('OrderEdit.reloadHeader', function() {\n      modView.flushTopInfo();\n      modView.renderHeaderInfo(_instance.mds.OrderStorage);\n    });\n\n    /** Открытие формы выставления счетов */\n    KT.on('OrderEdit.openSetInvoiceForm', function() {\n      modView.SetInvoiceForm.wnd.open();\n    });\n\n    /*==========Обработчики событий модели============================*/\n\n    /** Обработка инициализации хранилища данных заявки */\n    KT.on('OrderStorage.initialized', function(e, OrderStorage) {\n      modView.renderHeaderInfo(OrderStorage);\n    });\n\n    /** Обработка обновления документов заявки */\n    KT.on('OrderStorage.setDocuments', function(e, documents) {\n      modView.renderDocumentsForm(documents.items);\n    });\n\n    /** Обработка обновления истории заявки */\n    KT.on('OrderStorage.setHistory', function(e, history) {\n      modView.History.render(history.records);\n    });\n\n    /** Обработка обновления данных по услугам */\n    KT.on('OrderStorage.setServices', function(e, OrderStorage) {\n      modView.renderSetInvoiceForm(OrderStorage.getServices());\n    });\n\n    /** Обработка выписки билетов */\n    /*\n    KT.on('ApiClient.issuedTickets',function(e, data) {\n      if (data.status === 0) {\n        KT.apiClient.getOrderDocuments(_instance.mds.OrderStorage.orderId);\n      }\n    }); */\n\n    /** Обработка отмены счета */\n    KT.on('ApiClient.cancelledInvoice', function(e, response) {\n      KT.Modal.closeModal();\n      if (+response.status === 0) {\n        modView.flushSetInvoiceForm();\n        KT.notify('invoiceCancelled');\n        KT.apiClient.getOrderOffers(_instance.orderId, _instance.mds.OrderStorage.getServiceIds());\n        KT.apiClient.getOrderInvoices(_instance.orderId);\n      } else {\n        KT.notify('cancellingInvoiceFailed', response.errors);\n      }\n    });\n\n    /** Обработка ответа сервера на установку скидки */\n    /*\n    KT.on('ApiClient.setDiscount', function(e, data) {\n      if (data.status === 0) {\n        KT.apiClient.getOrderInfo(_instance.orderId);\n      }\n    }); */\n\n    /** Обработка получения информации о прогрессе загрузки документа */\n    KT.on('ApiClient.documentUploadProgress',function(e, data) {\n      modView.showDocUploadProgress( parseInt(data.percent) );\n    });\n\n    /** Обработка загрузки документа */\n    KT.on('ApiClient.uploadedDocument',function(e, data) {\n      if (data.error !== undefined) {\n        KT.notify('uploadDocumentFailed');\n      } else {\n        if (data.status !== 0) {\n          if (data.status === 2) {\n            if (data.errorCode === 2) {\n              KT.notify('uploadDocumentNotAllowedByFilesize');\n            } else {\n              KT.notify('uploadDocumentFailed', data.errors);\n            }\n          } else {\n            KT.notify('uploadDocumentFailed', data.errors);\n          }\n        } else {\n          KT.notify('documentUploaded');\n          modView.flushDocumentsForm();\n          KT.apiClient.getOrderDocuments(_instance.orderId);\n        }\n      }\n    });\n\n    /*==========Обработчики событий представления========================*/\n\n    /** Изменение тогглера\n    * @todo move to library\n    */\n    $('body').on('change','.simpletoggler input', function() {\n      if ($(this).prop('checked')) {\n        $(this).closest('.simpletoggler').addClass('active');\n      } else {\n        $(this).closest('.simpletoggler').removeClass('active');\n      }\n    });\n    \n    /** Открытие формы выставления счетов по клику на кнопку \"Счета\" в шапке */\n    modView.$btnInvoices.on('click', function() {\n      KT.dispatch('OrderEdit.openSetInvoiceForm');\n    });\n\n    /** Обработка изменения значения в поле ввода \"К оплате\" блока выставления счетов */\n    modView.SetInvoiceForm.$content.on('change','.js-ore-set-invoice--service-sum', function() {\n      var $serviceRow = $(this).closest('.js-ore-set-invoice--service');\n      var serviceId = +$serviceRow .attr('data-serviceid');\n      var Service = _instance.mds.OrderStorage.services[serviceId];\n      modView.checkInvoiceFormInput($serviceRow, Service.unpaidSum);\n    });\n\n    /** Обработка выбора услуги (чекбокс) на форме выставления счетов */\n    modView.SetInvoiceForm.$content.on('change','.js-ore-set-invoice--service-check', function() {\n      var $serviceRow = $(this).closest('.js-ore-set-invoice--service');\n      var serviceId = +$serviceRow.attr('data-serviceid');\n      var Service = _instance.mds.OrderStorage.services[serviceId];\n      if ($(this).prop('checked')) {\n        modView.markServiceForInvoice($serviceRow, Service.unpaidSum);\n      } else {\n        modView.markServiceForInvoice($serviceRow, 0);\n      }\n    });\n\n    /** Обработка нажатия кнопки \"Выставить счет\" в форме выставления счета */\n    modView.SetInvoiceForm.$content.on('click','.js-ore-set-invoice--action-set', function() {\n      var invoices = modView.getInvoiceFormData();\n\n      if (invoices === false) {\n        KT.Modal.notify({\n          high: true,\n          type:'info',\n          title:'Выставление счета',\n          msg:'<p>Нельзя выставить нулевой счет</p>',\n          buttons:{\n            title:'ok'\n          }\n        });\n      } else if (invoices.length === 0) {\n        KT.Modal.notify({\n          high: true,\n          type:'info',\n          title:'Выставление счета',\n          msg:'Вы не выбрали ни одной услуги для выставления счета!',\n          buttons:{\n            title:'ok'\n          }\n        });\n      } else {\n        KT.Modal.showLoader();\n\n        KT.apiClient.setInvoice(_instance.mds.OrderStorage, invoices)\n          .done(function(response) {\n            if (response.status === 0) {\n              modView.flushSetInvoiceForm();\n\n              KT.apiClient.getOrderOffers(_instance.orderId, _instance.mds.OrderStorage.getServiceIds())\n                .done(function(offersData) {\n                  if (offersData.status !== 0) {\n                    console.error('offer load error: ' + offersData.error);\n                  } else {\n                    _instance.mds.OrderStorage.setServices(offersData.body);\n                  }\n                });\n\n              KT.apiClient.getOrderInvoices(_instance.orderId)\n                .done(function(invoiceData) {\n                  var invoices = (invoiceData.body.Invoices !== undefined && Array.isArray(invoiceData.body.Invoices)) ?\n                      invoiceData.body.Invoices : [];\n                  _instance.mds.OrderStorage.setInvoices(invoices);\n                });\n\n              KT.Modal.notify({\n                high: true,\n                type: 'success',\n                title: 'Выставление счета',\n                msg: 'Счет успешно выставлен!',\n                buttons: {type:'success', title:'ok'}\n              });\n            } else {\n              KT.Modal.notify({\n                high: true,\n                type: 'error',\n                title: 'Выставление счета',\n                msg: 'Не удалось выставить счет<br>Код ошибки: ' + response.errors,\n                buttons: {type:'error', title:'ok'}\n              });\n            }\n          })\n          .fail(function(err) {\n            if (err.error !== 'denied') {\n              KT.Modal.closeModal();\n            }\n          });\n      }\n    });\n\n    /** Обработка нажатия кнопки \"Отмена\" в форме выставления счета */\n    modView.SetInvoiceForm.$content.on('click','.js-ore-set-invoice--action-cancel', function() {\n      modView.SetInvoiceForm.wnd.close();\n    });\n\n    /** Обработка выбора документа для загрузки */\n    modView.documents.$content.on('change','.js-ore-documents--upload-field',function() {\n      var $lbl = modView.documents.$content.find('.js-ore-documents--upload-label');\n      var file;\n\n      if ($(this)[0].files.length > 0) {\n        file = $(this)[0].files[0].name;\n      }\n      if (file !== undefined) {\n        $lbl.text(file);\n      } else {\n        $lbl.text('Добавить документ');\n      }\n    });\n\n    /** Обработка нажатия кнопки \"отмена\" формы загрузки документов */\n    modView.documents.$content.on('click', '.js-ore-documents--upload-decline', function(){\n      var $form = modView.documents.$content.find('.js-ore-documents--upload');\n      $form[0].reset();\n      $form\n        .find('.js-ore-documents--upload-field').change()\n        .end()\n        .find('.js-ore-documents--upload-control').show()\n        .end()\n        .find('.js-ore-documents--upload-progress').hide()\n          .find('js-ore-documents--upload-progress-text').text('0 %')\n          .end()\n          .find('.js-ore-documents--upload-progress-bar')\n            .css({'width':'0%'})\n            .removeClass('active')\n        .end();\n    });\n\n    /** Блокировка подтверждения формы загрузки файла при сабмите формы */\n    modView.documents.$content.on('submit', '.js-ore-documents--upload', function(e) {\n      e.preventDefault();\n    });\n\n    /** Обработка подтвержения формы загрузки файла кликом на кнопку  */\n    modView.documents.$content.on('click', '.js-ore-documents--upload-confirm', function() {\n      var $docform = modView.documents.$content.find('.js-ore-documents--upload');\n      if ($docform.find('.js-ore-documents--upload-field').val() !== '') {\n        modView.documents.$content.find('.js-ore-documents--upload-control').hide();\n        modView.documents.$content.find('.js-ore-documents--upload-progress')\n          .find('.js-ore-documents--upload-progress-bar')\n            .css({'width':'0%'})\n            .addClass('active')\n          .end()\n          .show();\n        KT.apiClient.uploadDocument(_instance.orderId, $docform)\n          .done(function(response) {\n            if (response.status !== 0) {\n              KT.notify('loadingDocumentsFailed', response.errorCode + ': ' + response.errors);\n            } else {\n              _instance.mds.OrderStorage.setDocuments(response.body);\n            }\n          });\n      }\n    });\n\n    /** Обработка нажатия на кнопки добавления услуг */\n    modView.$addServiceBlock.on('click', '.iconed-link[data-srv]:not(.disabled)', function() {\n      if (!_instance.mds.OrderStorage.isOffline) {\n        var serviceType = $(this).attr('data-srv');\n        window.sessionStorage.setItem('inOrderInfo', JSON.stringify(_instance.mds.OrderStorage));\n\n        switch(serviceType) {\n          case 'flight':\n            window.location.assign('/UI/searchAvia/index');\n            break;\n          case 'accommodation':\n            window.location.assign('/UI/searchHotel/index');\n            break;\n          default:\n            window.sessionStorage.removeItem('inOrderInfo');\n            break;\n        }\n      }\n    });\n  };\n\n  /** Инициализация модуля управления заявкой */\n  oeController.prototype.load = function() {\n    var _instance = this;\n\n    //==== сбор данных по требуемым шаблонам\n    $.extend(_instance.mds.view.config.templates, _instance.mds.payment.view.config.templates);\n    $.extend(_instance.mds.view.config.templates, _instance.mds.tourists.view.config.templates);\n    $.extend(_instance.mds.view.config.templates, _instance.mds.services.view.config.templates);\n\n    //==== инициализация контроллеров субмодулей\n    _instance.mds.payment.controller.init();\n    _instance.mds.tourists.controller.init();\n    _instance.mds.services.controller.init();\n\n    //==== загрузка шаблонов\n    var templates = KT.getTemplates(\n        _instance.mds.view.config.templateUrl,\n        _instance.mds.view.config.templates\n      );\n\n    //==== обработка шаблонов\n    templates\n      .then(function(templates) {\n        _instance.mds.tpl = templates;\n        return KT.apiClient.getOrderInfo(_instance.orderId);\n      })\n      .then(function(orderInfo) {\n        if (orderInfo.status !== 0 || orderInfo.body.orderId === undefined) {\n          console.error('Заявка ' + _instance.orderId + ' не найдена');\n          window.location.assign('/cabinetUI/orders/index');\n        }\n\n        _instance.mds.OrderStorage.initialize(orderInfo.body);\n        if (_instance.orderId === 'new') { \n          _instance.mds.OrderStorage.setServices([]); // надо ли? это всего лишь для сброса крутилок\n          return $.Deferred().reject(); \n        } else {\n          return;\n        }\n      })\n      .then(function() {\n        var serviceIds = _instance.mds.OrderStorage.getServiceIds();\n        if (serviceIds.length > 0) {\n          KT.apiClient.getOrderOffers(_instance.orderId, serviceIds)\n            .then(function(offersData) {\n              if (offersData.status === 0) {\n                _instance.mds.OrderStorage.setServices(offersData.body);\n                return KT.apiClient.getAllowedTransitions(_instance.orderId);\n              } else {\n                return $.Deferred().reject();\n              }\n            })\n            .then(function(transitionsData) {\n              if (transitionsData.status === 0 ) {\n                if (Array.isArray(transitionsData.body.services)) {\n                  _instance.mds.OrderStorage.setAllowedTransitions(transitionsData.body.services);\n                } else {\n                  console.warn('список доступных действий пуст');\n                  _instance.mds.OrderStorage.setAllowedTransitions([]);\n                }\n              } else {\n                console.error('не удалось получить доступные действия');\n              }\n            });\n        } else {\n          _instance.mds.OrderStorage.setServices([]);\n        }\n\n        KT.apiClient.getOrderTourists(_instance.orderId)\n          .done(function(response) {\n            var tourists = (response.body.tourists !== undefined) ?\n              response.body.tourists : [];\n            _instance.mds.OrderStorage.setTourists(tourists);\n          });\n        \n        KT.apiClient.getOrderInvoices(_instance.orderId)\n          .done(function(response) {\n            var invoices = (response.body.Invoices !== undefined && Array.isArray(response.body.Invoices)) ?\n                response.body.Invoices : [];\n            _instance.mds.OrderStorage.setInvoices(invoices);\n          });\n\n        KT.apiClient.getOrderHistory(_instance.orderId)\n          .done(function(response) {\n            if (response.status !== 0) {\n              if (response.errorCode === 8) {\n                console.log('Для данной заявки нет истории');\n              } else {\n                KT.notify('loadingHistoryFailed', response.errorCode + ': ' + response.errors);\n              }\n            } else {\n              _instance.mds.OrderStorage.setHistory(response.body);\n            }\n          });\n             \n        KT.apiClient.getOrderDocuments(_instance.orderId)\n          .done(function(response) {\n            if (response.status !== 0) {\n              KT.notify('loadingDocumentsFailed', response.errorCode + ': ' + response.errors);\n            } else {\n              _instance.mds.OrderStorage.setDocuments(response.body);\n            }\n          });\n      });\n  };\n\n  /** Загрузка необходимых данных для интерфейса создания новой заявки */\n  oeController.prototype.loadBare = function() {\n    var _instance = this;\n\n    $.extend(_instance.mds.view.config.templates, _instance.mds.tourists.view.config.templates);\n\n    _instance.mds.tourists.controller.init();\n\n    var clientId = window.sessionStorage.getItem('clientId');\n    var contractId = window.sessionStorage.getItem('contractId');\n\n    if (clientId === null) { \n      clientId = KT.getStoredSettings().companyId;\n    }\n\n    /** Обработка загрузки шаблонов модуля */\n    var templates = KT.getTemplates(\n        _instance.mds.view.config.templateUrl,\n        _instance.mds.view.config.templates\n      );\n    \n    var companyInfo = KT.Dictionary.getAsList('companies', {\n        'companyId': +clientId,\n        'fieldsFilter': [],\n        'lang': 'ru'\n      });\n\n    templates.done(function(templates) {\n      _instance.mds.tpl = templates;\n    });\n\n    companyInfo.fail(function() {\n      console.error('Ошибка получения данных клиента');\n    });\n\n    $.when(templates, companyInfo)\n      .done(function(tpl, companyInfo) {\n        if (companyInfo.length !== 0) {\n          var clientData = companyInfo[0];\n\n          _instance.mds.OrderStorage.initializeBare({\n            'clientId': +clientId,\n            'clientType': clientData.companyRoleType,\n            'clientName': clientData.name,\n            'contractId': contractId\n          });\n        } else {\n          console.error('Ошибка получения данных клиента');\n        }\n      });\n  };\n\n  return oeController;\n}));\n\n(function() {\n  KT.on('KT.initializedCore', function() {\n    /** Инициализация модуля */\n    KT.mdx.OrderEdit.controller = new KT.crates.OrderEdit.controller(KT.mdx.OrderEdit);\n    KT.mdx.OrderEdit.controller.init();\n\n    if (KT.mdx.OrderEdit.controller.orderId === 'new') {\n      KT.mdx.OrderEdit.controller.loadBare();\n    } else if (KT.mdx.OrderEdit.controller.orderId !== null) {\n      KT.mdx.OrderEdit.controller.load();\n    } else {\n      window.location.assign('/cabinetUI/orders/index');\n    }\n  });\n}());\n"]}