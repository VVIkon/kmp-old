KT.crates.OrderList={},KT.mdx.OrderList={},KT.mdx.OrderList.tpl={},$.extend(KT.notifications,{getOrderListFailed:{type:"error",title:"Не удалось загрузить список",msg:"Попробуйте перезагрузить страницу",killtarget:"body"}}),function(t,e){(function(t){t.getOrderList=function(t){var e=this;t.detailsType="long";t.getInCurrency=KT.profile.viewCurrency;if(t.offset===undefined){t.offset=0}return KT.rest({caller:"orderList - getOrderList",data:t,url:e.urls.getOrderList})}})(KT.apiClient)}(),function(t,e){KT.storage.OrderListStorage=e()}(0,function(){var t=ktStorage.extend(function(){this.namespace="OrderListStorage",this.orders=[],this.totalOrdersAmount=0,this.listPaging=20,this.setDefaultRequestParams();var t=window.sessionStorage.getItem("OrderListRequestParams");null!==t&&""!==t&&($.extend(!0,this.requestParams,JSON.parse(t)),this.requestParams.limit=this.listPaging),this.aggregateOrderData={managers:{},countries:{},cities:{},tourleaders:{}}});return KT.addMixin(t,"Dispatcher"),t.prototype.setDefaultRequestParams=function(){return this.requestParams={limit:this.listPaging,archived:!1,sortBy:["lastChangeDate"],sortDir:"desc"},this.getRequestParams()},t.prototype.getRequestParams=function(){return $.extend(!0,{},this.requestParams)},t.prototype.setFilterOption=function(t,e){return this.requestParams[t]=e,this.requestParams.limit=this.listPaging,window.sessionStorage.setItem("OrderListRequestParams",JSON.stringify(this.requestParams)),this},t.prototype.setFilterOptions=function(t){$.extend(!0,this.requestParams,t),this.requestParams.limit=this.listPaging,window.sessionStorage.setItem("OrderListRequestParams",JSON.stringify(this.requestParams))},t.prototype.setTotalOrdersAmount=function(t){this.totalOrdersAmount=t,this.dispatch("changedTotalOrdersAmount",t)},t.prototype.setOrders=function(t){var e=this;e.orders.splice(0,e.orders.length),t.forEach(function(t){e.updateAggregateOrderData(t),e.orders.push(t)}),e.dispatch("setOrders",{orders:e.orders})},t.prototype.updateOrders=function(t){var e,r,i=this,o=[],s=[],a=0;t.forEach(function(t){o.push(t.orderId)}),i.orders.forEach(function(t){s.push(t.orderId);var e=null!==t.dolc?moment(t.dolc,"YYYY-MM-DD HH:mm:ss").valueOf():e;a=a<e?e:a});var n=function(t,l){if(void 0!==i.orders[l]&&i.orders[l].orderId===t.orderId)i.orders[l].dolc!==t.dolc&&(r=i.orders[l].status!==t.status,i.orders.splice(l,1,t),i.dispatch("orderChanged",[t,r]));else if(void 0!==i.orders[l]&&-1===o.indexOf(i.orders[l].orderId))s.splice(l,1),i.dispatch("orderRemoved",i.orders.splice(l,1)[0].orderId),n(t,l);else{var d=s.indexOf(t.orderId);if(-1===d){i.orders.splice(l,0,t),s.splice(l,0,t.orderId);var c=moment(t.dolc,"YYYY-MM-DD HH:mm:ss").valueOf()>a;i.dispatch("orderAdded",[t,l,c])}else{var u=i.orders.splice(d,1)[0];s.splice(d,1),i.orders.splice(l,0,t),s.splice(l,0,t.orderId),e=u.dolc!==t.dolc,r=u.status!==t.status,i.dispatch("orderReordered",[t,l,e,r])}}};t.forEach(n);for(var l=t.length;l<i.orders.length;)i.dispatch("orderRemoved",i.orders.splice(l,1)[0].orderId);i.dispatch("ordersUpdated")},t.prototype.appendOrders=function(t){var e=this;e.requestParams.limit+=e.listPaging,t.forEach(function(t){e.updateAggregateOrderData(t),e.orders.push(t)}),e.dispatch("setOrders",{orders:t})},t.prototype.updateAggregateOrderData=function(t){var e=this.aggregateOrderData;void 0!==t.mgrLastName&&null!==t.mgrLastName&&(e.managers[t.mgrLastName]=t.mgrLastName),void 0!==t.country&&null!==t.country&&(e.countries[t.country]=t.country),void 0!==t.city&&null!==t.city&&(e.cities[t.city]=t.city),void 0!==t.touristLastName&&null!==t.touristLastName&&(e.tourleaders[t.touristLastName]=t.touristLastName)},t}),function(t,e){KT.crates.OrderList.view=e()}(0,function(){var t=function(t,e){this.mds=t,void 0===e&&(e={}),this.config=$.extend(!0,{templateUrl:"/cabinetUI/orders/getTemplates",templates:{createOrderModal:"orderList/modals/createOrder",orderListItem:"orderList/listItem",orderListItemServices:"orderList/itemServices",orderListFilters:"orderList/filterControls",filterControlLabel:"orderList/filterControlLabel",sortOption:"orderList/sortOption",clndr:"clndrTemplate"}},e),this.$createOrder=$(".js-orl--add-new-order"),this.$searchForm=$("#order-list-filter"),this.$sortForm=$("#order-list-sorting"),this.SearchForm=this.setSearchForm(this.$searchForm,this.$sortForm),this.$orderListContainer=$("#order-list-items"),this.$spinner=this.$orderListContainer.find(".spinner"),this.$actionsPanel=$("#order-list-actions"),this.$showMore=this.$actionsPanel.find(".js-orl-list-actions--show-more"),this.initPreLoader()};return t.prototype.renderOrderList=function(t){this.stopPreLoader();var e=this;return t.forEach(function(t){var r=e.mapOrderInfo(t);$(Mustache.render(e.mds.tpl.orderListItem,r)).appendTo(e.$orderListContainer).show()}),this},t.prototype.renderOrderCount=function(t){return this.searchForm.$orderQuan.text(t),this.searchForm.$orderQuanLabel.text(declOfNum(t,["найденная заявка","найденные заявки","найденных заявок"])),this},t.prototype.setSearchForm=function(t,e){var r=this,i=[];for(var o in KT.getCatalogInfo.orderstatuses)KT.getCatalogInfo.orderstatuses.hasOwnProperty(o)&&i.push({value:o,text:KT.getCatalogInfo.orderstatuses[o][1]});return{elem:{$searchContainer:t,$inputField:t.find(".js-orl-filter-statusbar"),$placeholder:t.find(".js-orl-filter-statusbar--placeholder"),$filters:t.find(".js-orl-filter--selectors"),$sortContainer:e,$orderQuan:e.find(".js-orl-sorting--amount"),$orderQuanLabel:e.find(".js-orl-sorting--amount-label"),$sortOptionsList:e.find(".js-orl-sorting--actions"),$sortFields:null},enabledFilters:{orderNumber:!0,startDate:!0,country:!0,city:!0,modificationDate:!0,company:"op"===KT.profile.userType,manager:!0,orderStatus:!0,tourleader:!0,offline:!0,archive:!0},controls:{},controlsKeyMap:{},render:function(t,e){var i=this;this.elem.$filters.html(Mustache.render(r.mds.tpl.orderListFilters,this.enabledFilters)),this.initSearchFormControls(t),this.initSortFormControls(t,e),this.togglePlaceholder(),this.elem.$inputField.on("click",function(){i.toggleForm()})},initSearchFormControls:function(t){var e=$("#orl-filter--start-date-from").clndrize({template:r.mds.tpl.clndr,eventName:"Дата заезда - с"}),o=$("#orl-filter--start-date-to").clndrize({template:r.mds.tpl.clndr,eventName:"Дата заезда - по"}),s=$("#orl-filter--modification-date-from").clndrize({template:r.mds.tpl.clndr,eventName:"Дата модификации - с"}),a=$("#orl-filter--modification-date-to").clndrize({template:r.mds.tpl.clndr,eventName:"Дата модификации - по"}),n=$("#orl-filter--country").selectize({openOnFocus:!0,create:!0,createOnBlur:!0,valueField:"value",labelField:"text"}),l=$("#orl-filter--city").selectize({openOnFocus:!0,create:!0,createOnBlur:!0,valueField:"value",labelField:"text"}),d=$("#orl-filter--creator").selectize({openOnFocus:!0,create:!0,createOnBlur:!0,valueField:"value",labelField:"text"}),c=$("#orl-filter--tourleader").selectize({openOnFocus:!0,create:!0,createOnBlur:!0,valueField:"value",labelField:"text"}),u=$("#orl-filter--status").selectize({openOnFocus:!0,create:!1,options:i}),m=$("#orl-filter--offline").selectize({openOnFocus:!0,create:!1,options:[{value:0,text:"онлайн"},{value:1,text:"оффлайн"}]});if(this.controls.orderId={$target:$("#orl-filter--orderid"),field:"№ заявки:",key:"orderId",getValue:function(){return this.$target.val()},getTitle:function(){return this.$target.val()},clear:function(){this.$target.val("").change()},init:function(t){this.$target.val(t)}},this.controls.dateStart={$target:$("#orl-filter--start-date-from"),field:"заезд с:",key:"startDate",getValue:function(){if(""===this.$target.val())return"";try{return moment(this.$target.val(),"DD.MM.YYYY").format("YYYY-MM-DD")}catch(t){return""}},getTitle:function(){try{return this.$target.val()}catch(t){return""}},clear:function(){e.clinstance.removeEvents(function(){return!0}),this.$target.val("").change()},init:function(t){var r=moment(t,"YYYY-MM-DD");this.$target.val(r.format("DD.MM.YYYY")),e.clinstance.setEvents([{date:t,title:"Дата заезда"}]),e.clinstance.setMonth(r.month()),e.clinstance.setYear(r.year())}},this.controls.dateEnd={$target:$("#orl-filter--start-date-to"),field:"заезд по:",key:"finishDate",getValue:function(){if(""===this.$target.val())return"";try{return moment(this.$target.val(),"DD.MM.YYYY").format("YYYY-MM-DD")}catch(t){return""}},getTitle:function(){try{return this.$target.val()}catch(t){return""}},clear:function(){o.clinstance.removeEvents(function(){return!0}),this.$target.val("").change()},init:function(t){var e=moment(t,"YYYY-MM-DD");this.$target.val(moment(t,"YYYY-MM-DD").format("DD.MM.YYYY")),o.clinstance.setEvents([{date:t,title:"Дата заезда"}]),o.clinstance.setMonth(e.month()),o.clinstance.setYear(e.year())}},this.controls.modificationDateFrom={$target:$("#orl-filter--modification-date-from"),field:"изменены после:",key:"modificationDateFrom",getValue:function(){if(""===this.$target.val())return"";try{return moment(this.$target.val(),"DD.MM.YYYY").format("YYYY-MM-DD")}catch(t){return""}},getTitle:function(){try{return this.$target.val()}catch(t){return""}},clear:function(){s.clinstance.removeEvents(function(){return!0}),this.$target.val("").change()},init:function(t){var e=moment(t,"YYYY-MM-DD");this.$target.val(e.format("DD.MM.YYYY")),s.clinstance.setEvents([{date:t,title:"Дата модификации"}]),s.clinstance.setMonth(e.month()),s.clinstance.setYear(e.year())}},this.controls.modificationDateTo={$target:$("#orl-filter--modification-date-to"),field:"изменены до:",key:"modificationDateTo",getValue:function(){if(""===this.$target.val())return"";try{return moment(this.$target.val(),"DD.MM.YYYY").format("YYYY-MM-DD")}catch(t){return""}},getTitle:function(){try{return this.$target.val()}catch(t){return""}},clear:function(){a.clinstance.removeEvents(function(){return!0}),this.$target.val("").change()},init:function(t){var e=moment(t,"YYYY-MM-DD");this.$target.val(e.format("DD.MM.YYYY")),a.clinstance.setEvents([{date:t,title:"Дата модификации"}]),a.clinstance.setMonth(e.month()),a.clinstance.setYear(e.year())}},this.controls.Country={$target:n,field:"страна:",key:"countryName",getValue:function(){return this.$target.val()},getTitle:function(){return this.$target[0].selectize.options[this.$target.val()].text},clear:function(){this.$target[0].selectize.clear()},init:function(t){this.$target[0].selectize.addOption({value:t,text:t}),this.$target[0].selectize.addItem(t)}},this.controls.City={$target:l,field:"город:",key:"cityName",getValue:function(){return this.$target.val()},getTitle:function(){return this.$target[0].selectize.options[this.$target.val()].text},clear:function(){this.$target[0].selectize.clear()},init:function(t){this.$target[0].selectize.addOption({value:t,text:t}),this.$target[0].selectize.addItem(t)}},this.controls.Manager={$target:d,field:"менеджер:",key:"managerName",getValue:function(){return this.$target.val()},getTitle:function(){return this.$target[0].selectize.options[this.$target.val()].text},clear:function(){this.$target[0].selectize.clear()},init:function(t){this.$target[0].selectize.addOption({value:t,text:t}),this.$target[0].selectize.addItem(t)}},this.controls.Tourleader={$target:c,field:"турлидер:",key:"touristName",getValue:function(){return this.$target.val()},getTitle:function(){return this.$target[0].selectize.options[this.$target.val()].text},clear:function(){this.$target[0].selectize.clear()},init:function(t){this.$target[0].selectize.addOption({value:t,text:t}),this.$target[0].selectize.addItem(t)}},this.controls.Status={$target:u,field:"статус:",key:"orderStatus",getValue:function(){return this.$target.val()},getTitle:function(){return $(this.$target[0].selectize.getItem(this.$target.val())).text()},clear:function(){this.$target[0].selectize.clear()},init:function(t){this.$target[0].selectize.addOption({value:t,text:KT.getCatalogInfo.orderstatuses[t][1]}),this.$target[0].selectize.addItem(t)}},this.controls.Offline={$target:m,field:"тип заявки:",key:"offline",getValue:function(){return this.$target.val()},getTitle:function(){return $(this.$target[0].selectize.getItem(this.$target.val())).text()},clear:function(){this.$target[0].selectize.clear()},init:function(t){this.$target[0].selectize.addItem(t)}},this.controls.Archived={$target:$("#orl-filter--archived"),field:"архивные",key:"archived",getValue:function(){return this.$target.prop("checked")},getTitle:function(){return this.$target.prop("checked")},clear:function(){this.$target.prop("checked",!1).change()},init:function(t){this.$target.prop("checked",t)}},this.enabledFilters.company){var h=$("#orl-filter--company").selectize({plugins:{key_down:{start:2}},openOnFocus:!0,create:!1,selectOnTab:!0,highlight:!1,loadThrottle:300,valueField:"companyId",labelField:"name",sortField:"seqid",options:[],score:function(){return function(t){return 1e3/t.seqid}},load:function(t,e){var r=this;if(this.clearOptions(),!t.length||t.length<2)return e();KT.Dictionary.getAsList("companies",{textFilter:t,fieldsFilter:[],lang:"ru"}).then(function(t){var i=r.$control;t.forEach(function(t,e){t.seqid=e+1}),e(t),0===t.length&&(i.addClass("warning"),setTimeout(function(){i.removeClass("warning")},2e3))}).fail(function(){e(),r.refreshOptions(!0);var t=r.$control;t.addClass("warning"),setTimeout(function(){t.removeClass("warning")},2e3)})},onType:function(t){t.length<2&&(this.close(),this.clearOptions())},onItemRemove:function(){this.clearOptions()},onChange:function(t){""===t&&this.trigger("item_remove")}});this.controls.Company={$target:h,field:"компания:",key:"clientId",getValue:function(){return this.$target.val()},getTitle:function(){var t=$(this.$target[0].selectize.getItem(this.$target.val())).text();return""!==t?t:"..."},clear:function(){this.$target[0].selectize.clear()},init:function(t){var e=this,r=this.$target[0].selectize;KT.Dictionary.getAsList("companies",{companyId:t,fieldsFilter:[],lang:"ru"}).done(function(t){0!==t.length?(r.addOption(t[0]),r.addItem(t[0].companyId)):e.clear()}).fail(function(){e.clear()})}}}var f=this;for(var g in this.controls){var p=this.controls[g],v=p.key;f.controlsKeyMap[v]=p,void 0!==t[v]&&null!==t[v]&&!1!==t[v]&&""!==t[v]&&(p.init(t[v]),f.renderControlLabel(p,!0)),p.$target.on("change",{ctrl:p},function(t){var e=t.data.ctrl,r=e.getValue();""!==r&&null!==r&&!1!==r&&r!==[]?f.renderControlLabel(e):f.clearControlLabel(e.key),f.togglePlaceholder()})}},initSortFormControls:function(t,e){var i="";for(var o in e)e.hasOwnProperty(o)&&(i+=Mustache.render(r.mds.tpl.sortOption,{sortOption:o,optionName:e[o][1]}));this.elem.$sortOptionsList.html(i),this.elem.$sortFields=this.elem.$sortOptionsList.find('input[name="orderField"]'),this.setSortOption(t.sortBy[0],t.sortDir)},getControlByKey:function(t){return this.controlsKeyMap[t]},updateControlSuggest:function(t,e){var r=e.$target[0].selectize,i=r.getValue(),o=[];for(var s in t)t.hasOwnProperty(s)&&o.push({value:s,text:t[s]});return r.addOption(o),""!==i?(void 0===t[i]&&r.updateOption(i,{value:i,text:i}),r.addItem(i,!0)):r.clear(!0),this},renderControlLabel:function(t,e){var i=t.field,o=t.getTitle(),s=t.key,a=-1===i.indexOf(":")?i:i+" "+o,n=this.elem.$inputField.children(".js-orl-filter--control-label").filter('[data-key="'+s+'"]');return n.length>0?n.text(a):$(Mustache.render(r.mds.tpl.filterControlLabel,{key:s,text:a,isApplied:!0===e})).appendTo(this.elem.$inputField),this},getFilterValues:function(){var t={};for(var e in this.controls){var r=this.controls[e],i=r.getValue();""!==i&&i!==[]||(i=null),t[r.key]=i}return t},markLabelsApplied:function(){this.elem.$inputField.children(".js-orl-filter--control-label").addClass("is-applied")},clearControlLabel:function(t){this.elem.$inputField.children('div[data-key="'+t+'"]').remove()},clearControls:function(){for(var t in this.controls)this.controls[t].clear()},setSortOption:function(t,e){this.elem.$sortFields.prop("checked",!1).parent().removeClass("sort-asc sort-desc checked"),this.elem.$sortFields.filter('[value="'+t+'"]').parent().addClass("checked sort-"+e)},renderOrdersAmount:function(t){this.elem.$orderQuan.text(t),this.elem.$orderQuanLabel.text(declOfNum(t,["найденная заявка","найденные заявки","найденных заявок"]))},toggleForm:function(t){void 0!==t?"show"===t?this.elem.$searchContainer.addClass("focus"):this.elem.$searchContainer.removeClass("focus"):this.elem.$searchContainer.hasClass("focus")?this.elem.$searchContainer.removeClass("focus"):this.elem.$searchContainer.addClass("focus")},togglePlaceholder:function(){this.elem.$inputField.children(".orl-filter-statusbar__item").length>0?this.elem.$placeholder.css({display:"none"}):this.elem.$placeholder.css({display:"inline-block"})}}},t.prototype.updateSearchFormSuggest=function(t){this.SearchForm.updateControlSuggest(t.managers,this.SearchForm.controls.Manager).updateControlSuggest(t.tourleaders,this.SearchForm.controls.Tourleader).updateControlSuggest(t.countries,this.SearchForm.controls.Country).updateControlSuggest(t.cities,this.SearchForm.controls.City)},t.prototype.clearOrderList=function(){return this.$orderListContainer.children(".js-orl-list-item").remove(),this.initPreLoader(),this},t.prototype.showOrderChanges=function(t,e){var r=$(Mustache.render(this.mds.tpl.orderListItem,this.mapOrderInfo(t)));this.$orderListContainer.find(".js-orl-list-item").filter('[data-id="'+t.orderId+'"]').animate({height:"1px"},500,"linear",function(){$(this).html(r.html()).attr("data-id",t.orderId).addClass("orderChanged")}).animate({height:"73px"},1e3,"swing",function(){(r=$(this)).css({outline:"2px solid #fde93e",overflow:"visible"}).animate({boxShadow:"0 0 20px rgba(253,233,62,0.7),0 0 10px rgba(253,233,62,0.7),0 0 5px rgba(253,233,62,0.7)"},1e3,"overBounce");var t=r.find(".js-orl-list-item--status-icon");1===e&&t.parent().find(".js-orl-list-item--status-bg").pulse({opacity:"1"},{duration:700,pulses:4}),setTimeout(function(){r.css({outline:"0px solid #fde93e"}).animate({boxShadow:"0 0 0px rgba(253,233,62,0.7),0 0 0px rgba(253,233,62,0.7)"},100,"linear")},5e3)})},t.prototype.showOrderRemoval=function(t){console.log("removing: "+t),this.$orderListContainer.find(".js-orl-list-item").filter('[data-id="'+t+'"]').animate({height:"1px"},500,"swing",function(){$(this).remove()})},t.prototype.showOrderAdd=function(t,e,r){var i=$('<div class="orl-list-item js-orl-list-item is-placeholder"></div>');i.css({overflow:"hidden",height:"1px"}),i=0===e?i.insertBefore(this.$orderListContainer.find(".js-orl-list-item").first()):i.insertAfter(this.$orderListContainer.find(".js-orl-list-item").eq(e-1));var o=$(Mustache.render(this.mds.tpl.orderListItem,this.mapOrderInfo(t))),s=r?"orderAdded":"";i.html(o.html()).attr("data-id",t.orderId).removeClass("is-placeholder").addClass(s).animate({height:"73px"},1e3,"swing",function(){var t=$(this);t.css({outline:"2px solid #56db3b",overflow:"visible"}).animate({boxShadow:"0 0 20px rgba(86,219,59,0.7),0 0 10px rgba(86,219,59,0.7),0 0 5px rgba(86,219,59,0.7)"},1e3,"overBounce"),setTimeout(function(){t.css({outline:"0px solid #fde93e"}).animate({boxShadow:"0 0 0px rgba(86,219,59,0.7),0 0 0px rgba(86,219,59,0.7)"},100,"linear")},5e3)})},t.prototype.showOrderMove=function(t,e,r,i){var o=this;console.log("перемещение: "+e),console.log(this.$orderListContainer.find(".js-orl-list-item").first());var s=$('<div class="orl-list-item js-orl-list-item is-placeholder"></div>');s.css({overflow:"hidden",height:"1px"}),s=0===e?s.insertBefore(this.$orderListContainer.find(".js-orl-list-item").first()):s.insertAfter(this.$orderListContainer.find(".js-orl-list-item").eq(e-1)),o.$orderListContainer.find(".js-orl-list-item").filter('[data-id="'+t.orderId+'"]').animate({height:"1px"},300,"swing",function(){var e=$(this).detach();r&&(e=$(Mustache.render(o.mds.tpl.orderListItem,o.mapOrderInfo(t))));var a=r?"orderChanged":"";s.html(e.html()).attr("data-id",t.orderId).removeClass("is-placeholder").addClass(a).animate({height:"73px"},1e3,"swing",function(){var t=(e=$(this)).find(".js-orl-list-item--status-icon");0!==r&&(e.css({outline:"2px solid #fde93e"}).animate({boxShadow:"0 0 20px rgba(253,233,62,0.7),0 0 10px rgba(253,233,62,0.7),0 0 5px rgba(253,233,62,0.7)"},500,"easeOutBounce"),2===i&&t.parent().find(".js-orl-list-item--status-bg").pulse({opacity:"1"},{duration:700,pulses:4})),e.css({overflow:"visible"}),setTimeout(function(){e.css({outline:"0px solid #fde93e"}).animate({boxShadow:"0 0 0px rgba(253,233,62,0.7),0 0 0px rgba(253,233,62,0.7)"},100,"linear")},5e3)})})},t.prototype.initPreLoader=function(){return this.$spinner=this.$spinner.appendTo(this.$orderListContainer),this},t.prototype.stopPreLoader=function(){return this.$spinner=this.$spinner.detach(),this},t.prototype.disableMoar=function(){this.$showMore.prop("disabled",!0)},t.prototype.enableMoar=function(){this.$showMore.prop("disabled",!1)},t.prototype.mapOrderInfo=function(t){var e,r=this,i=0,o=0,s="",a="unknown",n=[],l=!1;if(void 0!==t.countryIataCode&&null!==t.countryIataCode&&(a=String(t.countryIataCode).toLowerCase()),Array.isArray(t.services)&&t.services.length>0){t.services.forEach(function(t){if("0000-00-00 00:00:00"!==t.dateAmend&&null!==t.dateAmend){var r=moment(t.dateAmend,"YYYY-MM-DD HH:mm:ss").valueOf();e=void 0===e?r:e<r?e:r}var s=parseInt(t.serviceType);switch(void 0!==n[s]?(n[s].allServicesDone&=8===t.status,n[s].servicesList+="<br>"+t.serviceName):n[s]={allServicesDone:8===t.status,servicesList:KT.getCatalogInfo("servicetypes",s,"title")+"<br>"+t.serviceName,serviceIcon:KT.getCatalogInfo("servicetypes",s,"icon").replace('"',"'")},!0===t.offline&&(l=!0),KT.profile.userType){case"op":switch(KT.profile.prices){case"net":i+=Number(t.localNetSum),o+=Number(t.requestedNetSum);break;case"gross":i+=Number(t.localSum),o+=Number(t.requestedSum)}break;case"agent":switch(KT.profile.prices){case"net":i+=Number(t.localSum)-Number(t.localCommission),o+=Number(t.requestedSum)-Number(t.requestedCommission);break;case"gross":i+=Number(t.localSum),o+=Number(t.requestedSum)}}}),n.forEach(function(t){s+=Mustache.render(r.mds.tpl.orderListItemServices,t)})}var d=t.managerKMPLastName+" "+(""!==t.managerKMPFirstName?t.managerKMPFirstName.substr(0,1)+". ":"")+(""!==t.managerKMPMiddleName?t.managerKMPMiddleName.substr(0,1)+".":""),c=(t.mgrLastName,""!==t.mgrFirstName&&t.mgrFirstName.substr(0,1),""!==t.mgrMiddleName&&t.mgrMiddleName.substr(0,1),t.creatorLastName+" "+(""!==t.creatorFirstName?t.creatorFirstName.substr(0,1)+". ":"")+(""!==t.creatorMiddleName?t.creatorMiddleName.substr(0,1)+".":"")),u=(null!==t.touristLastName?t.touristLastName:"")+" "+(null!==t.touristFirstName?t.touristFirstName:""),m=parseInt(t.status),h={isArchived:t.archive,orderId:t.orderId,dolc:moment(t.dolc,"YYYY-MM-DD HH:mm:ss").format(KT.config.datetimeFormat),dateAmend:"op"!==KT.profile.userType&&void 0!==e&&moment(e).format(KT.config.datetimeOutFormat),orderStatusIcon:KT.getCatalogInfo("orderstatuses",m,"icon"),orderStatusText:KT.getCatalogInfo("orderstatuses",m,"title"),touristName:htmlDecode(u),touristCount:t.touristsCount>1?"+ "+(t.touristsCount-1):"",startDate:null!==t.startdate?moment(t.startdate,"YYYY-MM-DD HH:mm:ss").format("DD.MM"):"*",endDate:null!==t.enddate?moment(t.enddate,"YYYY-MM-DD HH:mm:ss").format("DD.MM"):"*",country:t.country,countryCode:a,orderServices:s,localSum:i.toMoney(0,","," "),requestedSum:o.toMoney(0,","," "),requestedCurrency:KT.getCatalogInfo("lcurrency",KT.profile.viewCurrency,"icon"),KmpManagerName:htmlDecode(d),clientCompany:"op"!==KT.profile.userType?null:t.agentCompany,creator:htmlDecode(c),vip:t.vip,offline:l};switch(KT.profile.userType){case"op":1===m&&(h.orderStatusText="Ручной режим",h.manualMode=!0)}return h},t.prototype.renderCreateOrderModal=function(t){var e=KT.Modal.notify({type:"info",title:"Создание заявки",msg:Mustache.render(this.mds.tpl.createOrderModal,{}),buttons:t}),r=e.$container.find(".js-modal-create-order--company"),i=e.$container.find(".js-modal-create-order--contract");r.selectize({plugins:{key_down:{start:2},jirafize:{completely:!0}},openOnFocus:!0,create:!1,selectOnTab:!0,highlight:!1,loadThrottle:300,valueField:"companyId",labelField:"name",sortField:"seqid",options:[],score:function(){return function(t){return 1e3/t.seqid}},render:{item:function(t){return'<div class="modal-create-order-company-select__control-item">'+t.name+"</div>"},option:function(t){return'<div class="modal-create-order-company-select__control-option">'+t.name+"</div>"}},load:function(t,e){var r=this;if(this.clearOptions(),!t.length||t.length<2)return e();KT.Dictionary.getAsList("companies",{textFilter:t,fieldsFilter:[],lang:"ru"}).done(function(t){var i=r.$control;t.forEach(function(t,e){t.seqid=e+1}),e(t),0===t.length&&(i.addClass("warning"),setTimeout(function(){i.removeClass("warning")},2e3))}).fail(function(){e(),r.refreshOptions(!0);var t=r.$control;t.addClass("warning"),setTimeout(function(){t.removeClass("warning")},2e3)})},onType:function(t){t.length<2&&(this.close(),this.clearOptions())},onItemAdd:function(t){var e=i[0].selectize,r=this.options[t].Contracts.map(function(t){return{ContractID:t.ContractID,ContractID_UTK:t.ContractID_UTK,ContractDate:null===t.ContractDate?null:moment(t.ContractDate,"YYYY-MM-DD").format("DD.MM.YYYY"),ContractExpiry:null===t.ContractExpiry?"бессрочный":"до "+moment(t.ContractExpiry,"YYYY-MM-DD").format("DD.MM.YYYY"),expired:t.expired}});e.clearOptions(),e.addOption(r),e.addItem(r[0].ContractID),e.enable()},onItemRemove:function(){this.clearOptions();var t=i[0].selectize;t.clear(),t.clearOptions(),t.disable()},onChange:function(t){""===t&&this.trigger("item_remove")}}),i.selectize({plugins:{key_down:{},on_blur:{}},openOnFocus:!0,create:!1,selectOnTab:!0,highlight:!1,valueField:"ContractID",labelField:"ContractID_UTK",options:[],render:{item:function(t){return'<div class="modal-create-order-company-select__control-item '+(t.expired?"modal-create-order-company-select--expired":"")+'">'+t.ContractID_UTK+" ("+t.ContractExpiry+")</div>"},option:function(t){return'<div class="modal-create-order-company-select__control-option '+(t.expired?"modal-create-order-company-select--expired":"")+'">'+t.ContractID_UTK+" ("+t.ContractExpiry+")</div>"}}}),e.$content.data("$company",r),e.$content.data("$contract",i)},t}),function(t,e){KT.crates.OrderList.controller=e(KT.crates.OrderList)}(0,function(t){var e=function(e){this.mds=e,this.mds.view=new t.view(this.mds),this.mds.OrderListStorage=new KT.storage.OrderListStorage,this.sortOptions={lastChangeDate:["desc","по дате изменения"],dateStart:["asc","по дате заезда"],touristName:["asc","по туристу"],agentCompany:["asc","по агентству"],countryName:["asc","по стране"],offline:["asc","по типу"],status:["asc","по статусу"]}};return e.prototype.init=function(){var t=this,e=this.mds.view,r=this.mds.OrderListStorage,i=null,o=function(t){null!==i&&(clearTimeout(i),i=null),KT.apiClient.getOrderList(t).then(function(t){0===t.status?(r.setTotalOrdersAmount(t.body.nums),r.setOrders(t.body.orders)):KT.notify("getOrderListFailed")})};KT.on("KT.changedViewCurrency",function(){e.clearOrderList();var t=r.getRequestParams();t.offset=0,o(t)}),KT.on("KT.changedViewPrice",function(){e.clearOrderList();var t=r.getRequestParams();t.offset=0,o(t)}),KT.on("OrderListStorage.setOrders",function(t,o){e.stopPreLoader(),e.updateSearchFormSuggest(r.aggregateOrderData),e.renderOrderList(o.orders),r.totalOrdersAmount>r.orders.length?e.enableMoar():e.disableMoar();var s=r.getRequestParams();s.offset=0;var a=function(){var t=i;KT.apiClient.getOrderList(s).then(function(e){0===e.status&&(r.setTotalOrdersAmount(e.body.nums),r.updateOrders(e.body.orders)),i===t&&(i=setTimeout(a,1e4))},function(e){"denied"!==e.error&&i===t&&(i=setTimeout(a,1e4))})};i=setTimeout(a,1e4)}),KT.on("OrderListStorage.changedTotalOrdersAmount",function(t,r){e.SearchForm.renderOrdersAmount(r)}),KT.on("OrderListStorage.ordersUpdated",function(){r.totalOrdersAmount>=r.orders.length?e.enableMoar():e.disableMoar()}),KT.on("OrderListStorage.orderChanged",function(t,r,i){e.showOrderChanges(r,i)}),KT.on("OrderListStorage.orderRemoved",function(t,r){e.showOrderRemoval(r)}),KT.on("OrderListStorage.orderAdded",function(t,r,i,o){e.showOrderAdd(r,i,o)}),KT.on("OrderListStorage.orderReordered",function(t,r,i,o,s){e.showOrderMove(r,i,o,s)}),e.$createOrder.on("click",function(){console.log("add new order"),"op"===KT.profile.userType?e.renderCreateOrderModal([{type:"common",title:"создать заявку",callback:function(t){var e=t.data("$contract"),r=t.data("$company");window.sessionStorage.setItem("clientId",r.val()),window.sessionStorage.setItem("contractId",e.val()),window.location.assign("/cabinetUI/orders/order/new")}},{type:"common",title:"отмена",callback:function(){KT.Modal.closeModal()}}]):window.location.assign("/cabinetUI/orders/order/new")}),e.SearchForm.elem.$inputField.on("click",".js-orl-filter--control-label",function(t){t.stopPropagation();var i=$(this).attr("data-key"),s=$(this).hasClass("is-applied"),a=e.SearchForm.getControlByKey(i);if(a.clear(),s){r.setFilterOption(a.key,a.getValue()),e.clearOrderList();var n=r.getRequestParams();n.offset=0,o(n)}}),e.$searchForm.on("click",".js-orl-filter--action-find",function(t){t.preventDefault(),t.stopPropagation();var i=e.SearchForm.getFilterValues();r.setFilterOptions(i),e.SearchForm.markLabelsApplied(),e.SearchForm.toggleForm("hide"),e.clearOrderList();var s=r.getRequestParams();s.offset=0,o(s)}),e.$sortForm.on("change",'input[name="orderField"]',function(){var i=$(this).val(),s=$(this).closest("label"),a=$(this).closest("label").hasClass("sort-desc")?"asc":"desc";a=s.hasClass("sort-desc")?"asc":s.hasClass("sort-asc")?"desc":t.sortOptions[i][0],r.setFilterOption("sortDir",a).setFilterOption("sortBy",new Array(i));var n=r.getRequestParams();n.offset=0,e.clearOrderList(),e.SearchForm.setSortOption(i,n.sortDir),o(n)}),e.$searchForm.on("click",".js-orl-filter--action-reset",function(t){t.preventDefault(),e.SearchForm.clearControls(),r.setDefaultRequestParams(),e.SearchForm.toggleForm("hide"),e.clearOrderList();var i=r.getRequestParams();i.offset=0,o(i)}),e.$showMore.on("click",function(){e.disableMoar(),e.initPreLoader();var t=r.getRequestParams();t.offset=r.orders.length,t.limit=r.listPaging,null!==i&&(clearTimeout(i),i=null),KT.apiClient.getOrderList(t).then(function(t){0===t.status?(r.setTotalOrdersAmount(t.body.nums),r.appendOrders(t.body.orders)):KT.notify("getOrderListFailed")})})},e.prototype.load=function(){var t=this,e=this.mds.view,r=this.mds.OrderListStorage;KT.getTemplates(e.config.templateUrl,e.config.templates).done(function(i){t.mds.tpl=i;var o=r.getRequestParams();o.offset=0,e.SearchForm.render(o,t.sortOptions),KT.apiClient.getOrderList(o).then(function(t){0===t.status?(r.setTotalOrdersAmount(t.body.nums),r.setOrders(t.body.orders)):KT.notify("getOrderListFailed")})})},e}),KT.on("KT.initializedCore",function(){KT.mdx.OrderList.controller=new KT.crates.OrderList.controller(KT.mdx.OrderList),KT.mdx.OrderList.controller.init(),KT.mdx.OrderList.controller.load()});
//# sourceMappingURL=cui-orderList.min.js.map