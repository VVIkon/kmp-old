KT.crates.OrderEdit={},KT.crates.OrderEdit.services={},KT.crates.OrderEdit.tourists={},KT.crates.OrderEdit.payment={},KT.mdx.OrderEdit={},KT.mdx.OrderEdit.tpl={},KT.mdx.OrderEdit.services={},KT.mdx.OrderEdit.tourists={},KT.mdx.OrderEdit.payment={},function(e,t){KT.config.touristDocuments=t()}(0,function(){var e=function(e){$.extend(this,e)};return e.prototype.getTouristNameFullValidation=function(){return new RegExp("^("+this.touristNameValidation[0].source+")+$")},e.prototype.getDocumentSerialFullValidation=function(){return new RegExp("^"+this.numberValidation[0].source+this.numberValidation[2]+"$")},e.prototype.getDocumentNumberFullValidation=function(){return new RegExp("^"+this.numberValidation[1].source+this.numberValidation[3]+"$")},{1:new e({docname:"Паспорт гражданина РФ",numberValidation:[/[0-9]/,/[0-9]/,"{4}","{6}"],touristNameValidation:[/[A-z-]/],hasExpiryDate:!1}),2:new e({docname:"Загран паспорт гражданина РФ",numberValidation:[/[0-9]/,/[0-9]/,"{2}","{7}"],touristNameValidation:[/[A-z-]/],hasExpiryDate:!0}),6:new e({docname:"Военный билет солдата (матроса, сержанта, старшины)",numberValidation:[/[А-я]/,/[0-9]/,"{2}","{7}"],touristNameValidation:[/[A-z-]/],hasExpiryDate:!1}),7:new e({docname:"Военный билет офицера",numberValidation:[/[А-я]/,/[0-9]/,"{2}","{7}"],touristNameValidation:[/[A-z-]/],hasExpiryDate:!1}),9:new e({docname:"Удостоверение личности моряка",numberValidation:[/[XIVLMCxivlmc]/,/[0-9]/,"{2}","{7}"],touristNameValidation:[/[A-z-]/],hasExpiryDate:!0,lifetime:moment.duration(5,"years")}),10:new e({docname:"Свидетельство о рождении",numberValidation:[/[А-я]|[XIVLMCxivlmc-]/,/[0-9]/,"{1,6}","{6}"],touristNameValidation:[/[A-z-]/],hasExpiryDate:!1}),18:new e({docname:"Другой документ",numberValidation:[/./,/./,"{0,10}","{0,30}"],touristNameValidation:[/./],hasExpiryDate:!1})}}),$.extend(KT.notifications,{bookingFailedNoTourists:{type:"warning",title:"Не удалось забронировать услугу",msg:"Вы еще не добавили туристов в заявку!",killtarget:"body",timeout:1e4},saveServiceFailedNoTourists:{type:"warning",title:"Не удалось сохранить услугу",msg:"Вы еще не добавили туристов в заявку!",killtarget:"body",timeout:1e4},saveServiceFailedIncorrectLoyality:{type:"warning",title:"Не удалось сохранить услугу",msg:"Некорректные данные программы лояльности",killtarget:"body",timeout:1e4},linkingTouristFailed:{type:"error",title:"Не удалось сохранить привязку!",msg:"",killtarget:"body"},removingTouristFailed:{type:"error",title:"Не удалось удалить туриста!",msg:"",killtarget:"body"},bookingFailed:{type:"error",title:"Бронирование не запустилось",msg:"Не удалось запустить процесс бронирования, обратитесь к менеджеру КМП для уточнения причин"},bookingChangeFailed:{type:"error",title:"Не удалось изменить данные брони",msg:"Не удалось изменить данные брони, обратитесь к менеджеру КМП для уточнения причин"},bookingCancelFailed:{type:"error",title:"Бронь не отменена",msg:"Не удалось отменить бронирование, обратитесь к менеджеру КМП для уточнения причин"},issuingTicketsFailed:{type:"error",title:"Выписка билетов не удалась!",msg:"",killtarget:"body",timeout:1e4},saveTouristFailed:{type:"error",title:"Не удалось сохранить туриста",msg:"",killtarget:"body"},loadingDocumentsFailed:{type:"error",title:"Не удалось загрузить документы",msg:"",killtarget:"body"},loadingHistoryFailed:{type:"error",title:"Не удалось загрузить историю заявки",msg:"",killtarget:"body"},settingDicountFailed:{type:"error",title:"Не удалось сохранить скидку",msg:""},changingServiceDataFailed:{type:"error",title:"Не удалось изменить данные услуги",msg:""},changingReservationDataFailed:{type:"error",title:"Не удалось изменить данные брони",msg:""},changingTicketsDataFailed:{type:"error",title:"Не удалось изменить данные билетов",msg:""},cancellingInvoiceFailed:{type:"error",title:"Не удалось отменить счет",msg:""},savingUserFailed:{type:"error",title:"Не удалось сохранить сотрудника",msg:""},savingCustomFieldsFailed:{type:"error",title:"Не удалось сохранить данные услуги",msg:""},settingServiceToManualFailed:{type:"error",title:"Не удалось отправить запрос на изменение услуги менеджеру",msg:""},AddingAdditionalServiceFailed:{type:"error",title:"Не удалось добавить дополнительную услугу",msg:""},RemovingAdditionalServiceFailed:{type:"error",title:"Не удалось удалить дополнительную услугу",msg:""}}),$.extend(KT.notifications,{linkingTourists:{type:"success",title:"Выполняется привязка туристов...",msg:"",killtarget:"body",timeout:1e3},touristsLinked:{type:"success",title:"Привязка туристов прошла успешно!",msg:"",killtarget:"body"},bookingChanged:{type:"success",title:"Данные брони успешно изменены",msg:""},bookingStarted:{type:"success",title:"Бронирование началось!",msg:"Процесс бронирования успешно запущен"},bookingFinished:{type:"success",title:"Бронирование завершено!",msg:"Услуга успешно забронирована"},bookingCancelled:{type:"success",title:"Бронь отменена!",msg:"Отмена брони прошла успешно"},ticketsIssued:{type:"success",title:"Выписка билетов совершена успешно!",msg:"Маршрутная квитанция отправлена на указанный e-mail",killtarget:"body",timeout:1e4},touristAdded:{type:"success",title:"Информация сохранена успешно!",msg:"Турист <b>{{name}}</b> добавлен в заявку",killtarget:"body"},touristUpdated:{type:"success",title:"Информация сохранена успешно!",msg:"Информация по туристу <b>{{name}}</b> обновлена",killtarget:"body"},touristRemoved:{type:"success",title:"Операция выполнена успешно!",msg:"Турист <b>{{name}}</b> удален из заявки",killtarget:"body"},documentUploaded:{type:"success",title:"Документ успешно загружен!",msg:"",ontop:!0,killtarget:"body"},discountSet:{type:"success",title:"Скидка успешно выставлена!",msg:"Новый размер скидки: {{discount}}"},reservationDataChanged:{type:"success",title:"Данные брони успешно изменены!",msg:""},serviceDataChanged:{type:"success",title:"Данные услуги успешно изменены!",msg:""},serviceStatusSet:{type:"success",title:"Статус услуги успешно изменен!",msg:""},ticketsDataChanged:{type:"success",title:"Данные билетов успешно изменены!",msg:""},invoiceCancelled:{type:"success",title:"Счет успешно отменен!",msg:""},userSaved:{type:"success",title:"Данные сотрудника успешно сохранены!",msg:""},customFieldsSaved:{type:"success",title:"Внесенные данные успешно сохранены!",msg:""},serviceSetToManual:{type:"success",title:"Услуга передана менеджеру на редактирование",msg:""}}),$.extend(KT.notifications,{bookingFailedNoTourists:{type:"warning",title:"Не удалось забронировать услугу",msg:"Вы еще не добавили туристов в заявку!",killtarget:"body",timeout:1e4},saveServiceFailedNoTourists:{type:"warning",title:"Не удалось сохранить услугу",msg:"Вы еще не добавили туристов в заявку!",killtarget:"body",timeout:1e4},bookingTermsNotAccepted:{type:"warning",title:"Вы не можете начать бронирование",msg:"Необходимо подтвердить согласие с условиями бронирования",killtarget:"body",timeout:1e4},bookingChangeNotSupported:{type:"warning",title:"Невозможно изменить бронь",msg:"Поставщик не поддерживает изменение брони"},bookingChangeProhibited:{type:"warning",title:"Невозможно изменить бронь",msg:"Поставщик отказал в изменении брони для данной услуги"},notAllTouristsLinked:{type:"warning",title:"Вы не можете выполнить операцию",msg:"Необходимо прикрепить к услуге заявленное число туристов",killtarget:"body",timeout:1e4},touristLinkageNotAllowedByDocument:{type:"warning",title:"Туриста нельзя привязать к услуге",msg:"У туриста заканчивается срок действия документа",killtarget:"body",timeout:1e4},touristLinkageNotAllowedByAge:{type:"warning",title:"Данного туриста нельзя привязать к услуге",msg:"В эту услугу нельзя добавить еще одного туриста данной возрастной группы",killtarget:"body",timeout:1e4},incorrectTouristData:{type:"warning",title:"Некорретные данные!",msg:"Проверьте форму на правильность заполнения",killtarget:"body"},uploadDocumentFailed:{type:"warning",title:"Не удалось загрузить документ",msg:"Сбой загрузки, попробуйте еще раз",ontop:!0,killtarget:"body"},uploadDocumentNotAllowedByFilesize:{type:"warning",title:"Не удалось загрузить документ",msg:"Размер файла превышает допустимое значение",ontop:!0,killtarget:"body"},pricesChanged:{type:"warning",title:"Изменились цены предложения",msg:"Для продолжения операции требуется подтверждение согласия с новыми ценами",ontop:!0,killtarget:"body"},waitTOSLoading:{type:"warning",title:"Документ еще загружается",msg:"Попробуйте открыть снова через несколько секунд",ontop:!0,killtarget:"body"},noManualEditForm:{type:"warning",title:"Нет формы для редактирования услуги",msg:"Для данной услуги не поддерживается ручное редактирование",ontop:!0,killtarget:"body"},reservationNumberNotSet:{type:"warning",title:"Не указан номер брони",msg:"Для создания брони необходимо указать номер",ontop:!0,killtarget:"body"},ticketNumberNotEntered:{type:"warning",title:"Не указан номер билета",msg:"Введите номер билета",ontop:!0,killtarget:"body"},ticketTouristNotSet:{type:"warning",title:"Не указан турист для создания билета",msg:"Укажите туриста",ontop:!0,killtarget:"body"},changingTicketNotSelected:{type:"warning",title:"Не выбран билет для редактирования",msg:"Выберите билет",ontop:!0,killtarget:"body"},notAllCustomFieldsSet:{type:"warning",title:"Не все обязательные поля заполнены",msg:"",ontop:!0,killtarget:"body"},customFieldsRevealed:{type:"warning",title:"Проверьте данные",msg:"У туриста есть незаполненные дополнительные поля",ontop:!0,killtarget:"body"}}),function(e,t){KT.crates.OrderEdit.CustomFieldsFactory=t()}(0,function(){var e=function(e){this.fieldTypeId=e.fieldTypeId,this.typeTemplate=e.typeTemplate,this.fieldTypeName=e.fieldTypeName,this.required=e.require,this.modifiable=e.modifyAvailable,this.valueOptions=e.availableValueList,this.value=e.value,this.$field=null,this.$control=null,this.$errorTarget=null,this.$focusTarget=null};e.prototype.render=function(){return this.$field=$(Mustache.render(this.tpl,{fieldTypeId:this.fieldTypeId,fieldTypeName:this.fieldTypeName,required:this.required})),this.$control=this.$field.find(".js-custom-field--control"),this.modifiable||this.$control.prop("disabled",!0),this.$field},e.prototype.initialize=function(){throw new Error("CustomField:init not implemented")},e.prototype.getValue=function(){return this.$control.val()},e.prototype.validate=function(e){if(void 0===e&&(e=this.getValue()),""===e){var t=this;return!this.required||(t.$errorTarget.addClass("error"),t.$focusTarget.one("focus change",function(){t.$errorTarget.removeClass("error")}),!1)}return!0},e.extend=function(e){return e.prototype=Object.create(this.prototype),e.__super__=this.prototype,e.constructor=e,e};var t,r=function(e){this.tpl=e};r.prototype.create=function(e){return t.hasOwnProperty(e.typeTemplate)?new t[e.typeTemplate](e,this.tpl):null};var i=e.extend(function(t,r){e.call(this,t),this.tpl=r.TextCF});i.prototype.initialize=function(){Array.isArray(this.valueOptions)?(this.$control.selectize({openOnFocus:!0,create:!1,maxItems:1,options:this.valueOptions.map(function(e){return{value:e,label:e}}),selectOnTab:!0,labelField:"label"}),this.$errorTarget=this.$control[0].selectize.$control,this.$focusTarget=this.$control[0].selectize.$control_input,null!==this.value&&this.$control[0].selectize.addItem(this.value),this.getValue=function(){return this.$control[0].selectize.getValue()}):(this.$control.jirafize({position:"left",buttons:{name:"clear",type:"reset",callback:function(e){e.val("").change()}}}),this.$errorTarget=this.$control,this.$focusTarget=this.$control,null!==this.value&&this.$control.val(this.value))};var o=e.extend(function(t,r){e.call(this,t),this.tpl=r.TextAreaCF});o.prototype.initialize=function(){this.$control.jirafize({position:"left",buttons:{name:"clear",type:"reset",callback:function(e){e.val("").change()}}}),this.$errorTarget=this.$control,this.$focusTarget=this.$control,null!==this.value&&this.$control.val(this.value)};var s=e.extend(function(t,r){e.call(this,t),this.tpl=r.NumberCF});s.prototype.initialize=function(){Array.isArray(this.valueOptions)?(this.$control.selectize({openOnFocus:!0,create:!1,maxItems:1,options:this.valueOptions.map(function(e){return{value:e,label:e}}),selectOnTab:!0,labelField:"label"}),this.$errorTarget=this.$control[0].selectize.$control,this.$focusTarget=this.$control[0].selectize.$control_input,null!==this.value&&this.$control[0].selectize.addItem(this.value),this.getValue=function(){var e=this.$control[0].selectize.getValue();return""!==e?Number(e):e}):(this.$control.jirafize({position:"left",buttons:{name:"clear",type:"reset",callback:function(e){e.val("").change()}}}),this.$errorTarget=this.$control,this.$focusTarget=this.$control,null!==this.value&&this.$control.val(this.value),this.$control.on("keypress",function(e){var t=String.fromCharCode(e.which);if(!/[0-9.,]/.test(t))return!1}),this.getValue=function(){var e=this.$control.val();return""!==e?Number(String(e).replace(",",".")):e})};var n=e.extend(function(t,r){e.call(this,t),this.tpl=r.DateCF,this.calendarTpl=r.clndr});return n.prototype.initialize=function(){null!==this.value&&this.$control.val(moment(this.value,"YYYY-MM-DD").format("DD.MM.YYYY")),this.$control.clndrize({template:this.calendarTpl,eventName:"Дата",showDate:moment()}),this.$errorTarget=this.$control,this.$focusTarget=this.$control,this.getValue=function(){var e=this.$control.val();return""!==e?moment(e,"DD.MM.YYYY").format("YYYY-MM-DD"):e}},t={1:i,2:o,3:s,4:n},r}),function(e,t){(function(e){e.getClientUserSuggest=function(e){var t=this;KT.rest({caller:"orderEdit - getClientUserSuggest",data:e.data,url:t.urls.getClientUserSuggest}).done(e.success).fail(e.error)};e.setUser=function(e,t){var r=this;var i=$.Deferred();KT.rest({caller:"orderEdit#tourists - setUser",url:r.urls.setUser,data:e}).done(function(e){e.touristId=t;i.resolve(e)}).fail(i.reject);return i};e.getClientUser=function(e){var t=this;return KT.rest({caller:"orderEdit#tourists - getClientUser",url:t.urls.getClientUser,data:{docId:e}})}})(KT.apiClient)}(),function(e,t){(function(e){e.getHotelInfo=function(e){var t=this;var r={hotelId:e,lang:"ru"};return KT.rest({caller:"orderEdit - getHotelInfo",data:r,url:t.urls.getHotelInfo})}})(KT.apiClient)}(),function(e,t){(function(e){e.setDiscount=function(e,t){var r=this;var i=$.Deferred();var o={orderId:e,agentOrderDiscount:t};KT.rest({caller:"orderEdit#payment - setDiscount",data:o,url:r.urls.setDiscount}).done(function(e){e.discount=t;i.resolve(e)}).fail(i.reject);return i};e.removeOrderTourist=function(e,t){var r=this;var i=$.Deferred();var o={orderId:e,touristId:t};KT.rest({caller:"orderEdit#tourists - removeOrderTourist",data:o,url:r.urls.removeOrderTourist}).done(function(e){e.touristId=t;i.resolve(e)}).fail(i.reject);return i};e.setOrderTourist=function(e,t){var r=this;var i=$.Deferred();if(String(t.touristId).indexOf("tmp")===0||String(t.touristId).indexOf("doc")===0){delete t.touristId}var o={orderId:e.orderId!=="new"?e.orderId:null,action:"AddTourist",actionParams:t};KT.rest({caller:"orderEdit#tourists - setOrderTourist",data:o,url:r.urls.orderWorkflowManager}).done(function(e){i.resolve(e)}).fail(i.reject);return i};e.uploadDocument=function(e,t){var r=this;t.ajaxSubmit({url:r.urls.uploadDocument,data:{orderId:e,usertoken:KT.profile.userToken},uploadProgress:function(e,t,i,o){r.dispatch("documentUploadProgress",{percent:o})},success:function(e){try{var t=JSON.parse(e);r.dispatch("uploadedDocument",t)}catch(e){r.dispatch("uploadedDocument",{error:"uploadDocument: not json"})}},error:function(e,t,i){r.dispatch("uploadedDocument",{error:t+" "+i})}})};e.setInvoice=function(e,t){var r=this;var i=[];t.forEach(function(e){i.push({serviceId:e.id,invoicePrice:e.sum})});var o={userId:KT.profile.userId,orderId:e.orderId,paymentType:"2",currency:e.getServices()[0].prices.inClient.currencyCode,Services:i};return KT.rest({caller:"orderEdit - setInvoice",data:o,url:r.urls.setInvoice})};e.cancelInvoice=function(e){var t=this;var r={invoiceId:e};return KT.rest({caller:"orderEdit - setInvoice",data:r,url:t.urls.cancelInvoice})}})(KT.apiClient)}(),function(e,t){(function(e){e.getOrderInfo=function(e){var t=this;var r={orderId:e,getInCurrency:KT.profile.viewCurrency};return KT.rest({caller:"orderEdit - getOrderInfo",data:r,url:t.urls.getOrder})};e.getOrderOffers=function(e,t){var r=this;var i={orderId:e,servicesIds:t,lang:"ru",getInCurrency:KT.profile.viewCurrency};return KT.rest({caller:"orderEdit#services - getOrderOffers",data:i,url:r.urls.getOrderOffers})};e.getOrderTourists=function(e){var t=this;var r=$.Deferred();var i={orderId:e};KT.rest({caller:"orderEdit#tourists - getOrderTourists",data:i,url:t.urls.getOrderTourists}).done(function(e){if(e.status===0&&Array.isArray(e.body.tourists)){e.body.tourists.forEach(function(e){if(e.surName!==undefined){e.lastName=e.surName;delete e.surName}if(e.document.surName!==undefined){e.document.lastName=e.document.surName;delete e.document.surName}if(e.document.serialNum!==undefined){e.document.serialNumber=e.document.serialNum;delete e.document.serialNum}})}r.resolve(e)}).fail(r.reject);return r};e.getOrderInvoices=function(e){var t=this;var r={orderId:e};return KT.rest({caller:"orderEdit - getOrderInvoices",data:r,url:t.urls.getOrderInvoices})};e.getOrderDocuments=function(e){var t=this;var r={orderId:e};return KT.rest({caller:"orderEdit - getOrderDocuments",data:r,url:t.urls.getOrderDocuments})};e.getOrderHistory=function(e){var t=this;var r={orderId:e,lang:"ru"};return KT.rest({caller:"orderEdit - getOrderHistory",data:r,url:t.urls.getOrderHistory})}})(KT.apiClient)}(),function(e,t){(function(e){e.getAllowedTransitions=function(e){var t=this;var r={operation:"checkTransition",orderId:e};return KT.rest({caller:"orderEdit - getAllowedTransitions",data:r,url:t.urls.checkWorkflow})};e.validateAction=function(e,t,r){var i=this;var o=$.Deferred();var s={operation:"validate",orderId:e,action:t,actionParams:r};KT.rest({caller:"orderEdit - validateAction",data:s,url:i.urls.checkWorkflow}).done(function(e){e.action=t;if(e.status===0){r.forEach(function(t,r){e.body[r].serviceId=t.serviceId})}o.resolve(e)}).fail(o.reject);return o};e.startBooking=function(e,t){var r=this;var i={orderId:e,action:"BookStart",actionParams:t};return KT.rest({caller:"orderEdit#services - startBooking",url:r.urls.orderWorkflowManager,data:i})};e.issueTickets=function(e,t){var r=this;var i={orderId:e,action:"IssueTickets",actionParams:{serviceId:t}};return KT.rest({caller:"orderEdit#services - issueTickets",url:r.urls.orderWorkflowManager,data:i})};e.bookChange=function(e,t){var r=this;var i=$.Deferred();var o={orderId:e,action:"BookChange",actionParams:t};KT.rest({caller:"orderEdit#services - bookChange",url:r.urls.orderWorkflowManager,data:o}).done(function(e){e.body.serviceId=t.serviceId;i.resolve(e)}).fail(i.reject);return i};e.bookCancel=function(e,t){var r=this;var i={orderId:e,action:"BookCancel",actionParams:t};return KT.rest({caller:"orderEdit#services - bookCancel",url:r.urls.orderWorkflowManager,data:i})};e.setServiceToManual=function(e,t){var r=this;var i=$.Deferred();var o={orderId:e,action:"Manual",actionParams:t};KT.rest({caller:"orderEdit#services - Manual",url:r.urls.orderWorkflowManager,data:o}).done(function(e){e.serviceId=t.serviceId;i.resolve(e)}).fail(i.reject);return i};e.setTouristsLinkage=function(e,t,r){var i=this;var o=$.Deferred();var s={orderId:e,action:"TouristToService",actionParams:{serviceId:t,touristData:r}};KT.rest({caller:"orderEdit#services - setTouristsLinkage",data:s,url:i.urls.orderWorkflowManager}).done(function(e){e.serviceId=t;e.linkageInfo=r;o.resolve(e)}).fail(o.reject);return o};e.setServiceData=function(e,t,r){var i=this;var o={orderId:e,action:"SetServiceData",actionParams:r};return KT.rest({caller:"orderEdit#services - setServiceData",data:o,url:i.urls.orderWorkflowManager})};e.manualSetStatus=function(e,t,r){var i=this;var o={orderId:e,action:"ManualSetStatus",actionParams:r};return KT.rest({caller:"orderEdit#services - manualSetStatus",data:o,url:i.urls.orderWorkflowManager})};e.setReservationData=function(e,t,r){var i=this;var o={orderId:e,action:"SetReservationData",actionParams:r};return KT.rest({caller:"orderEdit#services - SetReservationData",data:o,url:i.urls.orderWorkflowManager})};e.setTicketsData=function(e,t,r){var i=this;var o={orderId:e,action:"SetTicketsData",actionParams:r};return KT.rest({caller:"orderEdit#services - SetTicketsData",data:o,url:i.urls.orderWorkflowManager})};e.setServiceAdditionalData=function(e,t){var r=this;var i={orderId:e,action:"SetAdditionalData",actionParams:{additionalFields:t}};return KT.rest({caller:"orderEdit#services - SetAdditionalData",data:i,url:r.urls.orderWorkflowManager})};e.addExtraService=function(e,t){var r=this;var i={orderId:e,action:"AddExtraService",actionParams:t};return KT.rest({caller:"orderEdit#services - AddExtraService",data:i,url:r.urls.orderWorkflowManager})};e.removeExtraService=function(e,t){var r=this;var i={orderId:e,action:"RemoveExtraService",actionParams:t};return KT.rest({caller:"orderEdit#services - RemoveExtraService",data:i,url:r.urls.orderWorkflowManager})}})(KT.apiClient)}(),function(e,t){KT.storage.ServiceStorage=t()}(0,function(){function e(e,t,r){if(e.length!==t.length)return console.error("amount of penalties in local currency and in view currency not equal!"),null;var i=[];return e.forEach(function(e,o){i.push({dateFrom:moment(e.dateFrom,"YYYY-MM-DD HH:mm:ss"),dateTo:moment(e.dateTo,"YYYY-MM-DD HH:mm:ss"),description:e.description,penaltySum:{inLocal:{currency:e.penalty.currency,amount:e.penalty.amount},inView:{currency:t[o].penalty.currency,amount:t[o].penalty.amount},inClient:{currency:r[o].penalty.currency,amount:r[o].penalty.amount}}})}),i}var t=ktStorage.extend(function(e){this.namespace="ServiceStorage",this.serviceId=e,this.isPartial=!1,this.isTOSAgreementSet=!1,this.tosDocumentName=!1,this.prices={inLocal:{currencyCode:"RUB",client:{net:null,gross:null,commission:{amount:null,percent:null}},supplier:{net:null,gross:null,commission:{amount:null,percent:null}}},inView:{currencyCode:null,client:{net:null,gross:null,commission:{amount:null,percent:null}},supplier:{net:null,gross:null,commission:{amount:null,percent:null}}},inSupplier:{currencyCode:null,client:{net:null,gross:null,commission:{amount:null,percent:null}},supplier:{net:null,gross:null,commission:{amount:null,percent:null}}},inClient:{currencyCode:null,client:{net:null,gross:null,commission:{amount:null,percent:null}},supplier:{net:null,gross:null,commission:{amount:null,percent:null}}}},this.offerInfo=null,this.isNonRefundable=!1,this.clientCancelPenalties=null,this.supplierCancelPenalties=null,this.penalties=null,this.penaltySums=null,this.requestData=null,this.tourists={},this.allowedTransitions=[],this.invoiceSum=0,this.unpaidSum=0,this.hasTravelPolicy=!1,this.hasTPViolations=!1,this.additionalServices=[],this.customFields=null});return KT.addMixin(t,"Dispatcher"),t.prototype.initialize=function(e){e.serviceID!==this.serviceId&&KT.error(this.namespace+": попытка инициализации данными другой услуги,"+" текущая: ".this.serviceId+" данные от: ".serviceData.serviceID);var t=function(e){return!(void 0===e||null===e||""===e)};switch(this.name=e.serviceName,this.description=e.serviceDescription,this.status=e.status,this.isOffline=e.offline,this.typeCode=+e.serviceType,this.typeCode){case 1:this.tosDocumentName="hotelBookTerms-"+this.serviceId,this.cancellationDocumentName=this.tosDocumentName;break;case 2:this.tosDocumentName="aviaBookTerms",this.fareRuleDocumentName="aviaFareRule-"+this.serviceId,this.cancellationDocumentName=this.fareRuleDocumentName}this.gatewayId=e.supplierId,this.startDate=moment(e.startDateTime,"YYYY-MM-DD HH:mm:ss"),this.endDate=moment(e.endDateTime,"YYYY-MM-DD HH:mm:ss"),this.creationDate=moment(e.dateOrdered,"YYYY-MM-DD HH:mm:ss"),this.dateAmend=t(e.dateAmend)?moment(e.dateAmend,"YYYY-MM-DD HH:mm:ss"):null,this.prices.inLocal.client.gross=Number(e.localSum),this.prices.inLocal.client.commission.amount=Number(e.localCommission),this.prices.inLocal.supplier.gross=Number(e.localNetSum),this.prices.inView.currencyCode=KT.profile.viewCurrency,this.prices.inView.client.gross=Number(e.requestedSum),this.prices.inView.supplier.gross=Number(e.requestedNetSum),this.prices.inSupplier.currencyCode=e.supplierCurrencyCode,this.prices.inSupplier.client.gross=Number(e.supplierPrice),this.prices.inSupplier.supplier.gross=Number(e.supplierNetPrice),this.prices.inClient.currencyCode=e.paymentCurrencyCode,this.prices.inClient.client.gross=Number(e.paymentSum),this.paymentCurrency=this.prices.inClient.currency,this.discount=t(e.discount)?Number(e.discount):0,this.customFields=Array.isArray(e.additionalData)?e.additionalData:null,this.isActionAvailable={setInvoice:-1!==[2,3,4,8].indexOf(this.status)||"op"===KT.profile.userType&&9===this.status}},t.prototype.updateFullInfo=function(t){var r=this;this.status=+t.serviceStatus,this.offerInfo=t.offerInfo,this.requestData=t.requestData;var i=t.serviceSalesTermsInfo;if(this.prices={inLocal:{currencyCode:"RUB",client:{net:Number(i.localCurrency.client.amountNetto),gross:Number(i.localCurrency.client.amountBrutto),commission:{amount:Number(i.localCurrency.client.commission.amount),percent:Number(i.localCurrency.client.commission.percent)}},supplier:{net:Number(i.localCurrency.supplier.amountNetto),gross:Number(i.localCurrency.supplier.amountBrutto),commission:{amount:Number(i.localCurrency.supplier.commission.amount),percent:Number(i.localCurrency.supplier.commission.percent)}}},inView:{currencyCode:i.viewCurrency.client.currency,client:{net:Number(i.viewCurrency.client.amountNetto),gross:Number(i.viewCurrency.client.amountBrutto),commission:{amount:Number(i.viewCurrency.client.commission.amount),percent:Number(i.viewCurrency.client.commission.percent)}},supplier:{net:Number(i.viewCurrency.supplier.amountNetto),gross:Number(i.viewCurrency.supplier.amountBrutto),commission:{amount:Number(i.viewCurrency.supplier.commission.amount),percent:Number(i.viewCurrency.supplier.commission.percent)}}},inSupplier:{currencyCode:i.supplierCurrency.supplier.currency,client:{net:Number(i.supplierCurrency.client.amountNetto),gross:Number(i.supplierCurrency.client.amountBrutto),commission:{amount:Number(i.supplierCurrency.client.commission.amount),percent:Number(i.supplierCurrency.client.commission.percent)}},supplier:{net:Number(i.supplierCurrency.supplier.amountNetto),gross:Number(i.supplierCurrency.supplier.amountBrutto),commission:{amount:Number(i.supplierCurrency.supplier.commission.amount),percent:Number(i.supplierCurrency.supplier.commission.percent)}}},inClient:{currencyCode:i.clientCurrency.client.currency,client:{net:Number(i.clientCurrency.client.amountNetto),gross:Number(i.clientCurrency.client.amountBrutto),commission:{amount:Number(i.clientCurrency.client.commission.amount),percent:Number(i.clientCurrency.client.commission.percent)}},supplier:{net:Number(i.clientCurrency.supplier.amountNetto),gross:Number(i.clientCurrency.supplier.amountBrutto),commission:{amount:Number(i.clientCurrency.supplier.commission.amount),percent:Number(i.clientCurrency.supplier.commission.percent)}}}},this.unpaidSum=Number(t.restPaymentAmount),this.paymentCurrency=t.restPaymentAmountCurrency,this.penalties=t.penalties,null!==this.penalties&&(this.penaltySums={inLocal:{currencyCode:this.penalties.client.localCurrency.currency,client:Number(this.penalties.client.localCurrency.amount),supplier:Number(this.penalties.supplier.localCurrency.amount)},inView:{currencyCode:this.penalties.client.viewCurrency.currency,client:Number(this.penalties.client.viewCurrency.amount),supplier:Number(this.penalties.supplier.viewCurrency.amount)},inClient:{currencyCode:this.penalties.client.clientCurrency.currency,client:Number(this.penalties.client.clientCurrency.amount),supplier:Number(this.penalties.supplier.clientCurrency.amount)}}),this.isActionAvailable.setInvoice=this.isActionAvailable.setInvoice&&this.unpaidSum>0,null===this.offerInfo)switch(this.isPartial=!0,this.typeCode){case 1:this.touristAges={adults:t.serviceTourists.length,children:0},this.declaredTouristAges={adults:t.serviceTourists.length,children:0};break;case 2:this.touristAges={adults:t.serviceTourists.length,children:0,infants:0},this.declaredTouristAges={adults:t.serviceTourists.length,children:0,infants:0}}else{switch(this.typeCode){case 1:this.touristAges={adults:null,children:null},this.declaredTouristAges={adults:this.offerInfo.adult,children:this.offerInfo.child};break;case 2:this.touristAges={adults:null,children:null,infants:null},this.declaredTouristAges={adults:this.offerInfo.requestData.adult,children:this.offerInfo.requestData.child,infants:this.offerInfo.requestData.infant},Array.isArray(this.offerInfo.fareRules)&&this.offerInfo.fareRules.forEach(function(e){!1===e.aviaFareRule.shortRules.refund_before_rule&&(r.isNonRefundable=!0)})}if(null!==this.offerInfo.cancelPenalties){var o=this.offerInfo.cancelPenalties.localCurrency.client,s=this.offerInfo.cancelPenalties.viewCurrency.client,n=this.offerInfo.cancelPenalties.clientCurrency.client;Array.isArray(o)&&o.length>0&&(this.clientCancelPenalties=e(o,s,n));var a=this.offerInfo.cancelPenalties.localCurrency.supplier,c=this.offerInfo.cancelPenalties.viewCurrency.supplier,l=this.offerInfo.cancelPenalties.clientCurrency.supplier;Array.isArray(a)&&a.length>0&&(this.supplierCancelPenalties=e(a,c,l)),Array.isArray(this.supplierCancelPenalties)&&this.supplierCancelPenalties.forEach(function(e){!r.isNonRefundable&&e.dateFrom.valueOf()<moment().endOf("day").valueOf()&&(r.isNonRefundable=!0)})}this.declaredTouristAmount=0;for(var d in this.declaredTouristAges)this.declaredTouristAges.hasOwnProperty(d)&&(this.declaredTouristAmount+=this.declaredTouristAges[d]);this.hasTravelPolicy="object"==typeof this.offerInfo.travelPolicy&&null!==this.offerInfo.travelPolicy,this.hasTPViolations=this.hasTravelPolicy&&Array.isArray(this.offerInfo.travelPolicy.travelPolicyFailCodes)&&this.offerInfo.travelPolicy.travelPolicyFailCodes.length>0,Array.isArray(t.addServices)&&(this.additionalServices=t.addServices)}},t.prototype.setAllowedTransitions=function(e){this.allowedTransitions=e},t.prototype.checkTransition=function(e){return-1!==this.allowedTransitions.indexOf(e)},t.prototype.getServiceTourists=function(){var e=[];for(var t in this.tourists)this.tourists.hasOwnProperty(t)&&e.push(this.tourists[t]);return e},t.prototype.getAgeByServiceEnding=function(e){return moment.duration(this.endDate.valueOf()-e.valueOf()).asYears()},t.prototype.getAgeGroup=function(e){var t="adults";switch(this.typeCode){case 1:t=e<12?"children":"adults";break;case 2:t=e<3?"infants":e<12?"children":"adults"}return t},t.prototype.checkAllTouristsLinked=function(){var e=!0;for(var t in this.touristAges)this.touristAges.hasOwnProperty(t)&&this.touristAges[t]!==this.declaredTouristAges[t]&&(e=!1);return e},t.prototype.setTouristAges=function(e){if(this.isPartial)return!1;var t,r;switch(this.typeCode){case 1:this.touristAges={adults:0,children:0};for(t in e)this.tourists.hasOwnProperty(t)&&((r=e[t].age)<12?this.touristAges.children+=1:this.touristAges.adults+=1);break;case 2:this.touristAges={adults:0,children:0,infants:0};for(t in this.tourists)this.tourists.hasOwnProperty(t)&&((r=e[t].age)<3?this.touristAges.infants+=1:r<12?this.touristAges.children+=1:this.touristAges.adults+=1)}},t.prototype.countClientCancelPenalty=function(){return this.isPartial?null:null===this.clientCancelPenalties?null:this.clientCancelPenalties.reduce(function(e,t){return console.log("penalty:"),console.log(t),moment().isBetween(t.dateFrom,t.dateTo,null,"[]")&&(e.inLocal+=t.penaltySum.inLocal.amount,e.inView+=t.penaltySum.inView.amount),e},{inLocal:0,inView:0})},t.prototype.compareSalesTerms=function(e){return this.prices.inClient.client.gross===Number(e.clientCurrency.client.amountBrutto)},t.prototype.addAdditionalService=function(e){this.additionalServices.push(e)},t.prototype.removeAdditionalService=function(e){this.additionalServices=this.additionalServices.filter(function(t){return t.idAddService!==e})},t}),function(e,t){KT.storage.TouristStorage=t()}(0,function(){var e=ktStorage.extend(function(e){this.namespace="TouristStorage",this.touristId=e,this.linkedServices=[],this.bonusCards=[],this.customFields=null});return KT.addMixin(e,"Dispatcher"),e.prototype.initialize=function(e){e.touristId!==this.touristId&&KT.error(this.namespace+": попытка инициализации данными другого туриста,"+" текущий: ".this.touristId+" данные от: ".serviceData.touristId);var t=function(e){return!(void 0===e||null===e||""===e)};if(this.firstname=htmlDecode(e.firstName),this.lastname=htmlDecode(e.lastName),this.middlename=t(e.middleName)?htmlDecode(e.middleName):null,this.sex=1===e.sex?"male":"female",this.email=t(e.email)?e.email:null,this.phone={countryCode:null,cityCode:null,number:null},t(e.phone)){var r=String(e.phone).replace(/\s/g,""),i=r.match(/^\+?(\d+)\((\d+)\)(\d+)$/);null===i?this.phone.number=r:(this.phone.countryCode=i[1],this.phone.cityCode=i[2],this.phone.number=i[3])}this.isTourleader=e.isTourLeader,this.birthdate=null!==e.birthdate?moment(e.birthdate,"YYYY-MM-DD"):null,this.age=null!==this.birthdate?moment.duration(moment().valueOf()-this.birthdate.valueOf()).asYears():null;var o=e.document;this.document={series:o.serialNumber,number:o.number,type:o.documentType,firstname:htmlDecode(o.firstName),lastname:htmlDecode(o.lastName),middlename:t(o.middleName)?htmlDecode(o.middleName):null,expiryDate:null!==o.expiryDate?moment(o.expiryDate,"YYYY-MM-DD"):null,citizenship:o.citizenship};var s=this;Array.isArray(e.services)&&e.services.forEach(function(e){s.linkedServices.push({serviceId:e.serviceId,loyalityProviderId:e.aviaLoyalityProgrammId,loyalityCardNumber:e.bonuscardNumber})}),this.bonusCards=Array.isArray(e.bonusCards)?e.bonusCards:[],this.customFields=Array.isArray(e.touristAdditionalData)&&e.touristAdditionalData.length>0?e.touristAdditionalData:null},e.prototype.initializeFromUser=function(e){var t=function(e){return!(void 0===e||null===e||""===e)};if(this.userId=e.user.userId,this.firstname=htmlDecode(e.user.name),this.lastname=htmlDecode(e.user.surname),this.middlename=t(e.user.secondName)?htmlDecode(e.user.secondName):null,this.sex=1===e.user.prefix?"male":"female",this.email=t(e.user.email)?e.user.email:null,this.phone={countryCode:null,cityCode:null,number:null},t(e.user.contactPhone)){var r=String(e.user.contactPhone).replace(/\s/g,""),i=r.match(/^\+?(\d+)\((\d+)\)(\d+)$/);null===i?this.phone.number=r:(this.phone.countryCode=i[1],this.phone.cityCode=i[2],this.phone.number=i[3])}this.isTourleader=!1,this.birthdate=null!==e.user.birthDate?moment(e.user.birthDate,"YYYY-MM-DD"):null,this.age=null!==e.user.birthDate?moment.duration(moment().valueOf()-this.birthdate.valueOf()).asYears():null,this.document={documentId:e.document.docId,series:e.document.docSerial,number:e.document.docNumber,type:e.document.docType,firstname:htmlDecode(e.document.firstName),lastname:htmlDecode(e.document.lastName),middlename:t(e.document.middleName)?htmlDecode(e.document.middleName):null,expiryDate:null!==e.document.docExpiryDate?moment(e.document.docExpiryDate,"YYYY-MM-DD"):null,citizenship:e.document.citizenship},this.bonusCards=Array.isArray(e.user.bonusCards)?e.user.bonusCards:[],this.customFields=Array.isArray(e.addData)?e.addData:null},e.prototype.getPhoneNumber=function(){return null!==this.phone.number?null!==this.phone.countryCode?"+"+this.phone.countryCode+"("+this.phone.cityCode+")"+this.phone.number:this.phone.number:null},e}),function(e,t){KT.storage.InvoiceStorage=t()}(0,function(){var e=ktStorage.extend(function(e){this.namespace="InvoiceStorage",this.invoiceId=e});return KT.addMixin(e,"Dispatcher"),e.prototype.statuses={WAIT:1,INVOICED:2,PARTIAL_PAID:3,PAID:4,CANCELLED:5},e.prototype.initialize=function(e){e.invoiceId!==this.invoiceId&&KT.error(this.namespace+": попытка инициализации данными другого инвойса,"+" текущая: ".this.invoiceId+" данные от: ".invoiceData.invoiceId),this.number=e.invoiceNum,this.status=+e.status,this.description=e.description,this.creationDate=moment(e.creationDate,"YYYY-MM-DD HH:mm:ss"),this.sum=Number(e.invoiceSum),this.currency=e.invoiceCur,this.serviceDetails={};var t=this;e.InvoiceServices.forEach(function(e){t.serviceDetails[e.serviceId]={sum:Number(e.serviceSum),name:e.serviceName}})},e.prototype.getServiceDetails=function(){var e,t=[];for(var r in this.serviceDetails)this.serviceDetails.hasOwnProperty(r)&&((e=$.extend(!0,{},this.serviceDetails[r])).serviceId=r,t.push(e));return t},e}),function(e,t){KT.storage.OrderStorage=t()}(0,function(){var e=ktStorage.extend(function(e){this.namespace="OrderStorage",this.loadStates={orderdata:null,servicedata:null,invoicedata:null,touristdata:null,transitionsdata:null},this.orderId=e,this.services={},this.invoices={},this.tourists={},this.documents=[],this.history=[],this.pendingValidations=0,this.validatedActions={}});return KT.addMixin(e,"Dispatcher"),e.prototype.initialize=function(e){e.orderId!==this.orderId&&KT.error(this.namespace+": попытка инициализации данными другой заявки,"+" текущая: ".this.orderId+" данные от: ".orderData.orderId);var t=function(e){return!(void 0===e||null===e||""===e)};this.orderIdGp=t(e.orderIdGp)?e.orderIdGp:null,this.orderIdUtk=t(e.orderIdUtk)?e.orderIdUtk:null,this.status=+e.status,this.isVip=e.VIP,this.isArchived=e.archive,this.isOffline=!1,this.isAddTouristAllowed=!1,this.contractId=e.contractID,this.creationDate=null!==e.orderDate?moment(e.orderDate,"YYYY-MM-DD HH:mm:ss"):null,this.startDate=moment(e.startDate,"YYYY-MM-DD HH:mm:ss"),this.endDate=moment(e.endDate,"YYYY-MM-DD HH:mm:ss"),this.creator=null===e.creator.id?null:{id:e.creator.id,firstname:e.creator.firstName,lastname:e.creator.lastName,middlename:t(e.creator.middleName)?e.creator.middleName:null},this.companyRoleType=function(t){switch(e.companyRoleType){case 1:return"op";case 2:return"agent";case 3:return"corp";default:return KT.profile.userType}}(),this.kmpManager=null===e.managerKMP.id?null:{id:e.managerKMP.id,firstname:e.managerKMP.firstName,lastname:e.managerKMP.lastName,middlename:t(e.managerKMP.middleName)?e.managerKMP.middleName:null},this.clientManager=null===e.clientManager.id?null:{id:e.clientManager.id,firstname:e.clientManager.firstName,lastname:e.clientManager.lastName,middlename:t(e.clientManager.middleName)?e.clientManager.middleName:null},this.client={id:e.agentId,name:e.agencyName},this.tourleader=null!==e.touristFirstName&&null!==e.touristLastName?{firstname:e.touristFirstName,lastname:e.touristLastName,middlename:null,phone:t(e.liderPhone)?e.liderPhone:null,email:t(e.liderEmail)?e.liderEmail:null}:null,this.touristsAmount=e.touristsNums,this.servicesTouristLinkage={};var r=this;Array.isArray(e.services)&&e.services.forEach(function(e){void 0===r.services[e.serviceID]&&(r.services[e.serviceID]=new KT.storage.ServiceStorage(e.serviceID)),r.services[e.serviceID].initialize(e),r.services[e.serviceID].isOffline&&(r.isOffline=!0)}),-1!==[0,1,2,5,9,10].indexOf(this.status)&&(this.isAddTouristAllowed=!0),this.loadStates.orderdata="loaded",this.dispatch("initialized",this)},e.prototype.initializeBare=function(e){this.orderIdGp=null,this.orderIdUtk=null,this.status=0,this.isVip=!1,this.isArchived=!1,this.isOffline=!1,this.isAddTouristAllowed=!0,this.contractId=e.contractId,this.creationDate=moment(),this.startDate=this.creationDate,this.endDate=this.creationDate,this.creator={id:KT.profile.user.id,firstname:KT.profile.user.firstName,lastname:KT.profile.user.lastName,middlename:KT.profile.user.middleName},this.companyRoleType=function(t){switch(e.clientType){case 1:return"op";case 2:return"agent";case 3:return"corp";default:return KT.profile.userType}}(),this.kmpManager=null,this.clientManager=null,this.client={id:e.clientId,name:e.clientName},this.tourleader=null,this.touristsAmount=0,this.dispatch("initialized",this)},e.prototype.setDocuments=function(e){this.documents=e,this.dispatch("setDocuments",{items:e})},e.prototype.setHistory=function(e){this.history=e,this.dispatch("setHistory",{records:e})},e.prototype.setServices=function(e){var t=this;e.forEach(function(e){void 0!==t.services[e.serviceId]?t.services[e.serviceId].updateFullInfo(e):KT.error(this.namespace+": неизвестная услуга:"+e.serviceId)}),null!==this.loadStates.touristdata&&this.updateServiceTourists(),this.loadStates.servicedata="loaded",this.dispatch("setServices",this)},e.prototype.getServices=function(){var e=[];for(var t in this.services)this.services.hasOwnProperty(t)&&e.push(this.services[t]);return e},e.prototype.getServiceIds=function(){var e=[];for(var t in this.services)this.services.hasOwnProperty(t)&&e.push(t);return e},e.prototype.setInvoices=function(e){var t=this;for(var r in this.services)this.services.hasOwnProperty(r)&&(this.services[r].invoiceSum=0);e.forEach(function(e){void 0===t.invoices[e.invoiceId]&&(t.invoices[e.invoiceId]=new KT.storage.InvoiceStorage(e.invoiceId)),t.invoices[e.invoiceId].initialize(e)}),this.loadStates.invoicedata="loaded",this.dispatch("setInvoices",this)},e.prototype.getInvoices=function(){var e=[];for(var t in this.invoices)this.invoices.hasOwnProperty(t)&&e.push(this.invoices[t]);return e},e.prototype.setTourists=function(e){var t=this;this.servicesTouristLinkage={},e.forEach(function(e){void 0===t.tourists[e.touristId]&&(t.tourists[e.touristId]=new KT.storage.TouristStorage(e.touristId)),t.tourists[e.touristId].initialize(e);var r=t.tourists[e.touristId];r.linkedServices.forEach(function(e){t.servicesTouristLinkage.hasOwnProperty(e.serviceId)||(t.servicesTouristLinkage[e.serviceId]={}),t.servicesTouristLinkage[e.serviceId][r.touristId]={touristId:r.touristId,isAttached:!0,firstname:r.firstname,lastname:r.lastname,middlename:r.middlename,loyalityProviderId:e.loyalityProviderId,loyalityCardNumber:e.loyalityCardNumber}})}),null!==this.loadStates.servicedata&&this.updateServiceTourists(),this.loadStates.touristdata="loaded",this.dispatch("setTourists",this)},e.prototype.getTourists=function(){var e=[];for(var t in this.tourists)this.tourists.hasOwnProperty(t)&&e.push(this.tourists[t]);return e},e.prototype.updateServiceTourists=function(e){var t=this,r=function(e){t.servicesTouristLinkage.hasOwnProperty(e)&&(t.services[e].tourists=t.servicesTouristLinkage[e]),t.services[e].setTouristAges(t.tourists)};if(void 0!==e)r(e);else for(var i in this.services)this.services.hasOwnProperty(i)&&r(i)},e.prototype.saveTourist=function(e){this.tourists[e.touristId]=e,(e.isTourleader||null===this.tourleader)&&(this.tourleader={firstname:e.firstname,lastname:e.lastname,middlename:null,phone:e.getPhoneNumber(),email:e.email}),this.touristsAmount=this.getTourists().length,this.dispatch("savedTourist",{touristId:e.touristId})},e.prototype.saveServiceLinkage=function(e,t){var r=this,i=this.services[e];t.forEach(function(t){var o=r.tourists[t.touristId];!0===t.link?(o.linkedServices.push({serviceId:i.serviceId,loyalityProviderId:t.aviaLoyalityProgrammId,loyalityCardNumber:t.bonuscardNumber}),i.tourists[o.touristId]={touristId:o.touristId,isAttached:!0,firstname:o.firstname,lastname:o.lastname,middlename:o.middlename,loyalityProviderId:t.aviaLoyalityProgrammId,loyalityCardNumber:t.bonuscardNumber}):(o.linkedServices=o.linkedServices.filter(function(t){return t.serviceId!==e}),delete i.tourists[o.touristId])}),i.setTouristAges(this.tourists),this.dispatch("savedServiceLinkage",{serviceId:e})},e.prototype.removeTourist=function(e){this.tourists[e].isTourleader&&(this.tourleader=null),delete this.tourists[e],this.dispatch("touristRemoved",{touristId:e})},e.prototype.setAllowedTransitions=function(e){var t=this;e.forEach(function(e){t.services[e.serviceId].setAllowedTransitions(e.controls)}),this.loadStates.transitionsdata="loaded",this.dispatch("setAllowedTransitions",this)},e.prototype.createLinkageStructure=function(e,t){var r=[],i={},o=this.services[e];o.getServiceTourists().forEach(function(e){i[e.touristId]=!0});for(var s in t)if(t.hasOwnProperty(s)){var n=t[s].state;if(n){var a=this.tourists[s];if(null!==a.document.expiryDate&&a.document.expiryDate.valueOf()<=o.endDate.valueOf())return KT.notify("touristLinkageNotAllowedByDocument"),!1;r.push({touristId:+s,bonuscardNumber:t[s].loyalityCardNumber,aviaLoyalityProgrammId:t[s].loyalityProviderId,link:!0})}else!0!==i[s]||n||r.push({touristId:+s,bonuscardNumber:null,aviaLoyalityProgrammId:null,link:!1})}return r},e.prototype.getServiceCommandParams=function(e,t){switch(e){case"BookStart":return void 0===this.services[t]?(console.error("BookStart: услуга "+t+" не найдена"),!1):{serviceId:t,agreementSet:this.services[t].isTOSAgreementSet};case"BookCancel":return{serviceId:t,createPenaltyInvoice:!0};case"IssueTickets":case"PayStart":case"Manual":case"ServiceChange":case"ServiceCancel":return{serviceId:t};default:return!1}},e.prototype.setValidatedAction=function(e,t){var r=this;r.pendingValidations--,!1===t?r.validatedActions[e]={validated:!1}:(r.validatedActions[e]={validated:!0},t.forEach(function(t){!1===t.validationResult&&(r.validatedActions[e].validated=!1)})),0===this.pendingValidations&&this.dispatch("setValidatedActions",this)},e}),function(e,t){KT.crates.OrderEdit.tourists.view=t(KT.crates.OrderEdit)}(0,function(e){function t(e,t){void 0!==t&&null!==t||(t=""),e.addClass("error").attr("data-pl",e.attr("placeholder")).attr("placeholder",t).one("focus",function(){$(this).removeClass("error").attr("placeholder",$(this).attr("data-pl")).removeAttr("data-pl")})}function r(e,r,i,o){var s=e.val();return void 0!==o&&null!==o||(o=""),r(s)?s:(t(e,o),i.val=!0,null)}function i(e,t,r){var i=e.val();if(""!==i&&/^\d{2}\.\d{2}\.\d{4}$/gi.test(i)){var o=e.data("plugin_clndrize").config.clndr.constraints,s=moment(i,"DD.MM.YYYY");if(s>=moment(o.startDate,"YYYY-MM-DD")&&s<=moment(o.endDate,"YYYY-MM-DD"))return e.attr("title",""),moment(i,"DD.MM.YYYY").format(r);e.attr("title","Введенная дата выходит за допустимые границы")}return e.closest(".clndr-datepicker-wrap").addClass("error").end().one("focus click",function(){$(this).closest(".clndr-datepicker-wrap").removeClass("error")}),t.val=!0,null}function o(e,t){var r={plugins:{jirafize:{}},openOnFocus:!0,create:!1,options:[],selectOnTab:!0,valueField:"programId",searchField:["IATAcode","loyalityProgramName","aircompanyName"],render:{item:function(e){return'<div class="item" data-tooltip="авиакомпания: '+e.aircompanyName+"<br> альянс: "+e.allianceName+'"><b>['+e.IATAcode+"]</b> "+e.loyalityProgramName+"</div>"},option:function(e){return'<div class="option" data-tooltip="авиакомпания: '+e.aircompanyName+"<br> альянс: "+e.allianceName+'"><b>['+e.IATAcode+"]</b> "+e.loyalityProgramName+"</div>"}}};"object"==typeof t&&$.extend(r,t),e.selectize(r)}var s=function(e,t){this.mds=e,void 0===t&&(t={}),this.config=$.extend(!0,{templateUrl:"/cabinetUI/orders/getTemplates",templates:{touristForm:"orderEdit/tourists/touristForm",touristFormActions:"orderEdit/tourists/touristFormActions",touristFormBonusCard:"orderEdit/tourists/touristFormBonusCard",touristFormNoBonusCards:"orderEdit/tourists/touristFormNoBonusCards",touristFormBonusCardActions:"orderEdit/tourists/touristFormBonusCardActions",touristListControls:"orderEdit/tourists/touristListControls",touristListEmpty:"orderEdit/tourists/touristListEmpty",clndr:"clndrTemplate",TextCF:"orderEdit/customFields/textCF",TextAreaCF:"orderEdit/customFields/textAreaCF",NumberCF:"orderEdit/customFields/numberCF",DateCF:"orderEdit/customFields/dateCF"}},t),this.$tabLabel=$("#tab-headers").find('.tab-headers__link[data-tab="tourists"]'),this.$touristList=$("#order-edit-tourists"),this.$touristListControls=$("#order-edit-tourists--controls"),this.touristForms={},this.tlFlag=!1,this.customFields={},this.doctypes=[];for(var r in KT.config.touristDocuments)KT.config.touristDocuments.hasOwnProperty(r)&&this.doctypes.push({value:r,text:KT.config.touristDocuments[r].docname});this.countries=[];for(var i in KT.countryCodes)KT.countryCodes.hasOwnProperty(i)&&this.countries.push({value:i,text:KT.countryCodes[i]})};return s.prototype.renderTouristList=function(e){var t=this;t.$touristList.empty(),t.touristForms={};var r={allowAdd:e.isAddTouristAllowed};t.$touristListControls.html(Mustache.render(t.mds.tpl.touristListControls,r));var i=e.getTourists();if(0===i.length)return t.$tabLabel.addClass("empty"),void t.$touristList.html(Mustache.render(t.mds.tpl.touristListEmpty,{}));t.$tabLabel.removeClass("empty"),i.sort(function(e,t){return e.isTourleader?t.isTourleader?0:-1:t.isTourleader?1:0});var o=null!==e.tourleader,s=!0===e.isOffline,n=e.companyRoleType;i.forEach(function(r){var i=t.mapTouristInfo(r,o,e.isOffline);i.actions=Mustache.render(t.mds.tpl.touristFormActions,s?{}:{allowedSave:!0,allowedUserCreation:"corp"===n,allowedReset:!0,allowedDelete:!0}),t.touristForms[r.touristId]=$(Mustache.render(t.mds.tpl.touristForm,i)).appendTo(t.$touristList),t.initControls(r.touristId),t.initCustomFields(r)})},s.prototype.addTouristForm=function(e){var t=this,r=null!==e.tourleader,i=e.companyRoleType,o="new"===e.orderId,s="tmp"+moment().valueOf();0===this.$touristList.children(".js-ore-tourist").length&&this.$touristList.empty();var n=Mustache.render(this.mds.tpl.touristFormActions,{allowedSave:!0,allowedUserCreation:"corp"===i,allowedReset:!o,allowedDelete:!o});this.touristForms[s]=$(Mustache.render(this.mds.tpl.touristForm,{touristId:s,isNewTourist:!0,isEditable:!0,allowedTouristSelect:"corp"===i,isTourleaderSet:r,bonusCards:Mustache.render(t.mds.tpl.touristFormNoBonusCards,{}),bonusCardsActions:Mustache.render(t.mds.tpl.touristFormBonusCardActions,{add:!0}),actions:n})).addClass("active").appendTo(this.$touristList),"corp"===i&&this.touristForms[s].find(".js-ore-tourist--suggest").selectize({plugins:{key_down:{start:2}},openOnFocus:!0,create:!1,selectOnTab:!0,highlight:!1,loadThrottle:300,valueField:"docId",labelField:"name",sortField:"seqid",options:[],render:{item:function(e){return'<div class="ore-tourist-suggest__item">'+e.lastName+" "+e.firstName+" ("+e.docSerial+" "+e.docNumber+")</div>"},option:function(e){return'<div class="ore-tourist-suggest__option">'+e.lastName+" "+e.firstName+" ("+e.docSerial+" "+e.docNumber+")</div>"}},score:function(){return function(e){return 1e3/e.seqid}},load:function(e,r){var i=this;if(this.clearOptions(),!e.length||e.length<2)return r();KT.apiClient.getClientUserSuggest({data:{companyId:t.mds.OrderStorage.client.id,substringFIO:e},error:function(){r()},success:function(e){var t=i.$control;0==+e.status&&Array.isArray(e.body)?(e.body.forEach(function(e,t){e.seqid=t+1}),r(e.body),0===e.body.length&&(t.addClass("warning"),setTimeout(function(){t.removeClass("warning")},2e3))):(r(),i.refreshOptions(!0),t.addClass("warning"),setTimeout(function(){t.removeClass("warning")},2e3))}})},onType:function(e){e.length<2&&(this.close(),this.clearOptions())},onItemRemove:function(){this.clearOptions()},onChange:function(e){""===e&&this.trigger("item_remove")}});var a=this.touristForms[s].offset().top;$("#main-scroller").stop().animate({scrollTop:$("#main-scroller").scrollTop()+(a-20)},300,"swing"),this.initControls(s)},s.prototype.renderPendingProcess=function(e){e.find(".js-ore-tourist--actions").html(Mustache.render(KT.tpl.spinner,{type:"medium"}))},s.prototype.refreshTouristForm=function(e,t){!0!==t&&(t=!1);var r="new"===this.mds.OrderStorage.orderId,i=this.mds.OrderStorage.companyRoleType;this.$tabLabel.removeClass("empty"),console.log("tourist: "),console.log(e);var o=this.touristForms[e.touristId],s=this.mapTouristInfo(e,!1,t);s.actions=Mustache.render(this.mds.tpl.touristFormActions,t?{}:{allowedSave:!0,allowedUserCreation:"corp"===i,allowedReset:!0,allowedDelete:!r});var n=$(Mustache.render(this.mds.tpl.touristForm,s));o.off().replaceWith(n),n.addClass("active"),this.touristForms[e.touristId]=n,this.initControls(e.touristId),this.initCustomFields(e)},s.prototype.refreshTouristFormActions=function(e,t){var r="new"===this.mds.OrderStorage.orderId,i=this.mds.OrderStorage.companyRoleType;e.find(".js-ore-tourist--actions").html(Mustache.render(this.mds.tpl.touristFormActions,t?{}:{allowedSave:!0,allowedUserCreation:"corp"===i,allowedReset:!0,allowedDelete:!r}))},s.prototype.removeTouristForm=function(e){var t=this.$touristList.find(".js-ore-tourist"),r=this.touristForms[e],i=t.length,o=$("#main-scroller").scrollTop(),s=r.offset().top;s<15&&((o-=15-s)<0&&(o=0),$("#main-scroller").animate({scrollTop:o},400)),r.slideUp(400,function(){$(this).remove()}),1===i&&this.$tabLabel.addClass("empty")},s.prototype.initControls=function(e){var t=this,r=t.touristForms[e];r.find(".simpletoggler input").trigger("change"),r.find('input[name="birthdate"]').each(function(){$(this).clndrize({template:t.mds.tpl.clndr,eventName:"Дата рождения",showDate:moment().subtract(20,"years"),clndr:{constraints:{startDate:"1915-01-01",endDate:moment().format("YYYY-MM-DD")}}})}),r.find('select[name="citizenship"]').selectize({openOnFocus:!0,create:!1,options:t.countries,selectOnTab:!0,sortField:"text",searchField:"text",render:{item:function(e){return'<div data-value="'+e.value+'" class="item" title="'+e.text+'">'+e.text+"</div>"},option:function(e){return'<div data-value="'+e.value+'" data-selectable class="option">'+e.text+"</div>"}}}),r.find('input[name="docenddate"]').each(function(){$(this).clndrize({template:t.mds.tpl.clndr,eventName:"Дата окончания",clndr:{constraints:{startDate:moment().add(2,"days").format("YYYY-MM-DD"),endDate:moment().add(10,"years").format("YYYY-MM-DD")}}})}),r.find('select[name="doctype"]').selectize({openOnFocus:!0,create:!1,selectOnTab:!0,options:t.doctypes,searchField:"text",onItemAdd:function(e){1!==(e=+e)&&2!==e||""===this.$input.closest(".js-ore-tourist").find('select[name="citizenship"]').val()&&this.$input.closest(".js-ore-tourist").find('select[name="citizenship"]')[0].selectize.addItem("RU")}}),r.find('input[name="country-prefix"],input[name="city-prefix"],input[name="phone"]').on("keypress",function(e){var t=String.fromCharCode(e.which);if(!/[0-9]/.test(t))return!1}),KT.Dictionary.getAsList("loyalityPrograms").then(function(e){r.find(".js-ore-tourist--bonus-card-program").each(function(){var t=$(this).val();o($(this),{options:e}),""!==t&&$(this)[0].selectize.addItem(+t)})}),t.livecheckDocument(r)},s.prototype.addBonusCardForm=function(e){var t=this,r=e.find(".js-ore-tourist--bonus-cards");KT.Dictionary.getAsList("loyalityPrograms").then(function(e){0===r.children(".js-ore-tourist--bonus-card").length&&r.empty(),o($(Mustache.render(t.mds.tpl.touristFormBonusCard,{})).appendTo(r).find(".js-ore-tourist--bonus-card-program"),{options:e})})},s.prototype.removeBonusCardForm=function(e){var t=e.closest(".js-ore-tourist--bonus-cards");e.remove(),0===t.children(".js-ore-tourist--bonus-card").length&&t.html(Mustache.render(this.mds.tpl.touristFormNoBonusCards,{}))},s.prototype.initCustomFields=function(t){if(null!==t.customFields&&0!==t.customFields.length){var r=new e.CustomFieldsFactory(this.mds.tpl),i=t.touristId;t.customFields.sort(function(e,t){var r=2===e.typeTemplate?2===t.typeTemplate?0:1:2===t.typeTemplate?-1:0;return 0!==r?r:e.require?t.require?0:-1:t.require?1:0});var o=this;o.customFields[i]=[],t.customFields.forEach(function(e){var t=r.create(e);null!==t&&o.customFields[i].push(t)});var s=$();o.customFields[i].forEach(function(e){s=s.add(e.render())}),this.touristForms[i].find(".js-ore-tourist-custom-fields").html(s),o.customFields[i].forEach(function(e){e.initialize()})}},s.prototype.lockClientSelect=function(e,t){var r=e.find(".js-ore-tourist--form-wrapper");e.addClass("is-locked").removeClass("active");var i=e.find(".js-ore-tourist--suggest");0!==i.length&&i[0].selectize.disable(),r.css({display:"block"}).slideUp(500,function(){e.find(".js-ore-tourist--header-lock").css({display:"block"}),"function"==typeof t&&t()})},s.prototype.unlockClientSelect=function(e){var t=e.find(".js-ore-tourist--form-wrapper");e.removeClass("is-locked").addClass("active");var r=e.find(".js-ore-tourist--suggest");0!==r.length&&r[0].selectize.enable(),t.css({display:"none"}).slideDown(500)},s.prototype.getTouristFormData=function(e){function o(e){return!(""===e||!/^[^0-9\.,\s\t\nъЪ]*$/g.test(e)||!/^([A-z-]+|[А-яёЁ-]+)$/g.test(e))}function s(e){return!(""===e||!/^[0-9]+$/g.test(e))}var n=e.find(".js-ore-tourist--phone-input"),a={sex:e.find('input[name="sex"]'),firstName:e.find('input[name="firstname"]').livetrim(),lastName:e.find('input[name="lastname"]').livetrim(),middleName:e.find('input[name="middlename"]').livetrim(),birthdate:e.find('input[name="birthdate"]'),email:e.find('input[name="email"]').livetrim(),phone:{countryPrefix:n.find('input[name="country-prefix"]'),cityPrefix:n.find('input[name="city-prefix"]'),number:n.find('input[name="phone"]')},document:{type:e.find('select[name="doctype"]'),firstName:e.find('input[name="docfirstname"]').livetrim().livecapitalize(),lastName:e.find('input[name="doclastname"]').livetrim().livecapitalize(),middleName:e.find('input[name="docmiddlename"]').livetrim().livecapitalize(),serial:e.find('input[name="docseries"]').livetrim(),number:e.find('input[name="docnumber"]').livetrim(),citizenship:e.find('select[name="citizenship"]'),expiryDate:e.find('input[name="docenddate"]')},bonusCards:e.find(".js-ore-tourist--bonus-card")},c={val:!1},l=e.data("touristid");-1===String(e.data("touristid")).indexOf("tmp")&&-1===String(e.data("touristid")).indexOf("doc")&&(l=+l);var d=e.data("userid"),u={userId:void 0!==d&&""!==d?+d:null,contractId:this.mds.OrderStorage.contractId,touristId:l,isTourLeader:"true"===e.data("leader"),sex:a.sex.prop("checked")?1:0,firstName:r(a.firstName,o,c,"Введите имя"),lastName:r(a.lastName,o,c,"Введите фамилию"),middleName:a.middleName.val(),birthdate:i(a.birthdate,c,"YYYY-MM-DD"),email:r(a.email,function(e){return!(""===e||!/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z0-9.-]+$/gi.test(e))},c,"Введите email"),phone:""===a.phone.number.val()?null:"+"+r(a.phone.countryPrefix,s,c)+"("+r(a.phone.cityPrefix,s,c)+")"+r(a.phone.number,s,c),bonusCards:[]},m=parseInt(a.document.type.val()),p=KT.config.touristDocuments[m];if(void 0!==p){var v=p.getTouristNameFullValidation(),f=p.getDocumentSerialFullValidation(),h=p.getDocumentNumberFullValidation(),g=e.find(".js-ore-tourist--document").data("documentid");u.document={user_documentID:void 0!==g&&""!==g?+g:null,documentType:m,firstName:r(a.document.firstName,function(e){return!(""===e||!v.test(e))},c,"Введите имя"),lastName:r(a.document.lastName,function(e){return!(""===e||!v.test(e))},c,"Введите фамилию"),middleName:a.document.middleName.val(),serialNumber:""===a.document.serial.val()?null:String(r(a.document.serial,function(e){return!!f.test(e)},c)).toUpperCase(),number:""===a.document.number.val()?null:String(r(a.document.number,function(e){return!!h.test(e)},c)).toUpperCase(),expiryDate:!p.hasExpiryDate||""===a.document.number.val()&&""===a.document.serial.val()?null:i(a.document.expiryDate,c,"YYYY-MM-DD"),citizenship:""!==a.document.citizenship.val()?a.document.citizenship[0].selectize.getValue():function(e,t){return t.val=!0,e.document.citizenship[0].selectize.$control.addClass("error").one("click",function(){$(this).removeClass("error")}),!1}(a,c)}}else u.document={},c.val=!0,a.document.type[0].selectize.$control.addClass("error"),a.document.type[0].selectize.$control_input.one("focus",function(){a.document.type[0].selectize.$control.removeClass("error")}),t(a.document.firstName),t(a.document.lastName),t(a.document.serial),t(a.document.number),console.error("Не определены правила валидации для документа: "+e.find('select[name="doctype"]').val());return[u.document.firstName,u.document.middleName,u.document.lastName].join("").length>55&&(c.val=!0,t(a.document.firstName),t(a.document.lastName),t(a.document.middleName)),(null===u.document.firstName||/[ьЬ]/.test(String(u.document.firstName).charAt(0)))&&(c.val=!0,t(a.document.firstName)),(null===u.document.lastName||/[ьЬ]/.test(String(u.document.lastName).charAt(0)))&&(c.val=!0,t(a.document.lastName)),""!==u.document.middleName&&/[ьЬ]/.test(String(u.document.middleName).charAt(0))&&(c.val=!0,t(a.document.middleName)),0!==a.bonusCards.length&&a.bonusCards.each(function(){var e=$(this).find(".js-ore-tourist--bonus-card-program");if(""!==e.val()){var t=$(this).find(".js-ore-tourist--bonus-card-number");if(""===t.val())c.val=!0,t.addClass("error").one("focus",function(){t.removeClass("error")});else{var r=$(this).data("cardid");u.bonusCards.push({id:void 0!==r?r:null,bonuscardNumber:t.val(),aviaLoyaltyProgramId:e.val()})}}}),Array.isArray(this.customFields[l])&&(u.userAdditionalFields=[],this.customFields[l].forEach(function(e){var t=e.getValue();e.modifiable&&e.validate(t)?u.userAdditionalFields.push({fieldTypeId:e.fieldTypeId,value:""!==t?t:null}):c.val=!0})),!c.val&&u},s.prototype.getUserFormData=function(e){var t=this,r=this.getTouristFormData(e);return!1!==r&&{user:{userId:r.userId,clientId:t.mds.OrderStorage.client.id,sex:r.sex,firstName:r.firstName,middleName:r.middleName,lastName:r.lastName,birthdate:r.birthdate,citizenshipId:null,"сontactPhone":r.phone,email:r.email,bonusCards:Array.isArray(r.bonusCards)?r.bonusCards.map(function(e){return delete e.id,e}):r.bonusCards},document:{userDocId:r.document.user_documentID,docType:r.document.documentType,firstName:r.document.firstName,middleName:r.document.middleName,lastName:r.document.lastName,docSerial:r.document.serialNumber,docNumber:r.document.number,docExpiryDate:r.document.expiryDate,citizenship:r.document.citizenship}}},s.prototype.livecheckDocument=function(e){var t=parseInt(e.find('select[name="doctype"]').val()),r=e.find("input").filter('[name="docfirstname"],[name="docmiddlename"],[name="doclastname"]'),i=e.find('input[name="docseries"]'),o=e.find('input[name="docnumber"]'),s=e.find('input[name="docenddate"]'),n=KT.config.touristDocuments[t];void 0!==n&&(n.hasExpiryDate?(s.prop("disabled",!1).trigger("change"),void 0!==n.lifetime&&(s.data("plugin_clndrize").config.clndr.constraints.endDate=moment().add(n.lifetime).format("YYYY-MM-DD"))):s.prop("disabled",!0).val("").trigger("change"),s.closest(".clndr-datepicker-wrap").removeClass("error"),r.off(".livecheck").removeClass("error").on("keypress.livecheck",function(e){var t=String.fromCharCode(e.which);if(!n.touristNameValidation[0].test(t))return!1}),i.off(".livecheck").removeClass("error").on("keypress.livecheck",function(e){var t=String.fromCharCode(e.which);if(!n.numberValidation[0].test(t))return!1}).attr("maxlength",n.numberValidation[2].replace(/[{}]/g,"").split(",").pop()),o.off(".livecheck").removeClass("error").on("keypress.livecheck",function(e){var t=String.fromCharCode(e.which);if(!n.numberValidation[1].test(t))return!1}).attr("maxlength",n.numberValidation[3].replace(/[{}]/g,"").split(",").pop()))},s.prototype.removeTLSetter=function(){return this.$touristList.find(".js-ore-tourist--tourleader-block").remove(),this},s.prototype.rearrange=function(){return this.$touristList.find(".js-ore-tourist").filter('[data-leader="true"]').detach().prependTo(this.$touristList),this},s.prototype.mapTouristInfo=function(e,t,r){var i=this;return!0!==r&&(r=!1),{isEditable:!r,touristId:e.touristId,userId:void 0!==e.userId?e.userId:null,isTourleader:e.isTourleader,firstname:e.firstname,lastname:e.lastname,middlename:null!==e.middlename?e.middlename:"",email:null!==e.email?e.email:"",phoneCountryCode:null!==e.phone.countryCode?e.phone.countryCode:"",phoneCityCode:null!==e.phone.cityCode?e.phone.cityCode:"",phoneNumber:null!==e.phone.number?e.phone.number:"",phone:null!==e.phone.countryCode?e.phone.countryCode+"("+e.phone.cityCode+")"+e.phone.number:e.phone.number,isTourleaderSet:t,isMale:"male"===e.sex,birthdate:null!==e.birthdate?e.birthdate.format("DD.MM.YYYY"):"",document:{documentId:void 0!==e.document.documentId?e.document.documentId:null,type:e.document.type,series:e.document.series,number:e.document.number,firstname:e.document.firstname,lastname:e.document.lastname,middlename:null!==e.document.middlename?e.document.middlename:"",citizenship:e.document.citizenship,expiryDate:null!==e.document.expiryDate?e.document.expiryDate.format("DD.MM.YYYY"):""},bonusCards:0===e.bonusCards.length?Mustache.render(i.mds.tpl.touristFormNoBonusCards,{}):e.bonusCards.map(function(e){return Mustache.render(i.mds.tpl.touristFormBonusCard,e)}).join(""),bonusCardsActions:Mustache.render(i.mds.tpl.touristFormBonusCardActions,{add:!0}),hasCustomFields:null!==e.customFields&&e.customFields.length>0}},s.prototype.copyNamesToDoc=function(e){var t=e.closest(".js-ore-tourist");t.find('input[name="doclastname"]').removeClass("error").val(transliterate(t.find('input[name="lastname"]').val())),t.find('input[name="docfirstname"]').removeClass("error").val(transliterate(t.find('input[name="firstname"]').val())),t.find('input[name="docmiddlename"]').removeClass("error").val(transliterate(t.find('input[name="middlename"]').val()))},s.prototype.showRevertAddTouristModal=function(e){KT.Modal.notify({type:"warning",title:"Удаление туриста из заявки",msg:"<p>Вы действительно хотите отменить добавление туриста?</p>",buttons:[{type:"warning",title:"нет"},{type:"error",title:"да",callback:e}]})},s.prototype.showRemoveTouristModal=function(e){KT.Modal.notify({type:"warning",title:"Удаление туриста из заявки",msg:"<p>Вы действительно хотите удалить туриста из заявки?</p>",buttons:[{type:"warning",title:"нет"},{type:"error",title:"да",callback:e}]})},s}),function(e,t){KT.crates.OrderEdit.tourists.controller=t(KT.crates.OrderEdit.tourists)}(0,function(e){var t=function(t,r){this.mds=t,this.orderId=r,this.mds.tourists.view=new e.view(this.mds)};return t.prototype.init=function(){var e=this,t=this.mds.tourists.view;window.sessionStorage.removeItem("serviceToAddTourist"),KT.on("OrderEdit.createAddTouristForm",function(){t.addTouristForm(e.mds.OrderStorage)}),KT.on("OrderStorage.initialized",function(r,i){"new"===i.orderId&&(t.$touristList.empty(),t.addTouristForm(e.mds.OrderStorage))}),KT.on("OrderStorage.setTourists",function(e,r){t.renderTouristList(r)}),KT.on("OrderStorage.savedTourist",function(r,i){var o=i.touristId,s=e.mds.OrderStorage.tourists[o],n=e.mds.OrderStorage.isOffline;t.refreshTouristForm(s,n),null!==e.mds.OrderStorage.touleader&&t.removeTLSetter().rearrange(),KT.dispatch("OrderEdit.reloadHeader")}),t.$touristList.on("change",".js-ore-tourist--suggest",function(){var e=$(this).val();if(""!==e){var r=$(this)[0].selectize.options[+e].userId,i=$(this).closest(".js-ore-tourist").attr("data-touristid"),o=t.touristForms[i];t.lockClientSelect(o,function(){KT.apiClient.getClientUser(e).done(function(e){if(0===e.status){var s="doc"+e.body.document.docId,n=new KT.storage.TouristStorage(s);o.attr("data-touristid",s),o.data("userid",r),t.touristForms[s]=t.touristForms[i],delete t.touristForms[i],n.initializeFromUser(e.body),t.refreshTouristForm(n,!1)}})})}}),t.$touristList.on("click",".js-ore-tourist--header",function(e){var t=$(this).closest(".js-ore-tourist");if(!t.hasClass("is-locked")){var r=t.find(".js-ore-tourist--form-wrapper");0===$(e.target).closest(".js-ore-tourist--suggest-field",t).length&&(t.hasClass("active")?(t.removeClass("active"),r.css({display:"block"}).slideUp(500)):(t.addClass("active"),r.css({display:"none"}).slideDown(500)))}}),t.$touristList.on("click",".js-ore-tourist--remove",function(r){r.stopPropagation();var i=$(this).closest(".js-ore-tourist"),o=i.data("touristid");0===String(o).indexOf("tmp")||0===String(o).indexOf("doc")?t.showRevertAddTouristModal(function(){KT.Modal.closeModal(),i.remove(),window.sessionStorage.removeItem("serviceToAddTourist")}):t.showRemoveTouristModal(function(){KT.Modal.showLoader(),t.renderPendingProcess(i),o=+o,KT.apiClient.removeOrderTourist(e.orderId,o).done(function(r){if(KT.Modal.closeModal(),0===r.status){var s=e.mds.OrderStorage.tourists[o];e.mds.OrderStorage.removeTourist(o),t.removeTouristForm(o),KT.dispatch("OrderEdit.reloadHeader"),KT.notify("touristRemoved",{name:s.firstname+" "+s.lastname})}else t.refreshTouristFormActions(i,e.mds.OrderStorage.isOffline),KT.notify("removingTouristFailed",r.errors)})})}),t.$touristList.on("click",".js-ore-tourist--reset",function(){var r=$(this).closest(".js-ore-tourist"),i=r.data("touristid");if(-1!==String(i).indexOf("tmp"))t.removeTouristForm(i);else if(-1!==String(i).indexOf("doc")){var o=+i.substr(3);t.renderPendingProcess(r),KT.apiClient.getClientUser(o).done(function(e){if(0===e.status){var r=new KT.storage.TouristStorage(i);r.initializeFromUser(e.body),t.refreshTouristForm(r,!1)}})}else{i=+i;var s=e.mds.OrderStorage.tourists[i],n=e.mds.OrderStorage.isOffline;t.refreshTouristForm(s,n)}}),t.$touristList.on("submit",".js-ore-tourist",function(r){r.preventDefault();var i=$(this),o=t.getTouristFormData(i);if(!1!==o&&"object"==typeof o){t.renderPendingProcess(i);var s,n=o.touristId;KT.apiClient.setOrderTourist(e.mds.OrderStorage,o).then(function(r){0===r.status?"new"===e.mds.OrderStorage.orderId?(window.sessionStorage.removeItem("clientId"),window.sessionStorage.removeItem("contractId"),window.location.assign("/cabinetUI/orders/order/"+r.body.orderId)):(s=r.body.touristId,e.updateTouristForm(n,s)):(null===e.mds.OrderStorage.tourleader&&i.removeAttr("data-leader").find(".js-ore-tourist--tourleader-toggler").prop("checked",!1).change(),t.refreshTouristFormActions(i,e.mds.OrderStorage.isOffline),KT.notify("saveTouristFailed",r.errors))})}else KT.notify("incorrectTouristData")}),t.$touristList.on("click",".js-ore-tourist--save-user",function(){var r=$(this).closest(".js-ore-tourist"),i=r.data("touristid"),o=t.getTouristFormData(r),s=t.getUserFormData(r);if(!1!==o&&!1!==s){s.user.clientId=e.mds.OrderStorage.client.id;var n,a=o.touristId;t.renderPendingProcess(r);var c=KT.apiClient.setOrderTourist(e.mds.OrderStorage,o),l=KT.apiClient.setUser(s,i);$.when(c,l).then(function(o,s){if(0===o.status)"new"===e.mds.OrderStorage.orderId?(window.sessionStorage.removeItem("clientId"),window.sessionStorage.removeItem("contractId"),window.location.assign("/cabinetUI/orders/order/"+o.body.orderId)):(n=o.body.touristId,e.updateTouristForm(a,n),0===s.status?KT.notify("userSaved"):KT.notify("savingUserFailed",s.errors));else if(null===e.mds.OrderStorage.tourleader&&r.removeAttr("data-leader").find(".js-ore-tourist--tourleader-toggler").prop("checked",!1).change(),t.refreshTouristFormActions(r,e.mds.OrderStorage.isOffline),KT.notify("saveTouristFailed",o.errors),0===s.status){if(!!isNaN(parseInt(i))){var c=s.body.userDocId,l=s.body.userId;(n="doc"+c)!==i&&(r.attr("data-touristid",n),r.attr("data-userid",l),r.data("userid",l),t.touristForms[n]=t.touristForms[i],delete t.touristForms[i]),t.lockClientSelect(r,function(){KT.apiClient.getClientUser(c).done(function(e){if(0===e.status){var r=new KT.storage.TouristStorage(n);r.initializeFromUser(e.body),t.refreshTouristForm(r,!1)}})})}KT.notify("userSaved")}else KT.notify("savingUserFailed",s.errors)})}else console.error("Ошибка ввода данных туриста")}),t.$touristList.on("change",".js-ore-tourist--tourleader-toggler",function(){var e=$(this),t=e.closest(".js-ore-tourist");e.prop("checked")?KT.Modal.notify({type:"info",title:"Определить заказчика",msg:"<p>Вы действительно хотите сделать этого туриста заказчиком?</p>",buttons:[{type:"common",title:"нет",callback:function(){e.prop("checked",!1).change(),KT.Modal.closeModal()}},{type:"success",title:"да",callback:function(){KT.Modal.closeModal(),t.attr("data-leader","true"),t.submit()}}]}):(e.closest(".simpletoggler").removeClass("active"),t.removeAttr("data-leader"))}),t.$touristList.on("change",'select[name="doctype"]',function(){t.livecheckDocument($(this).closest(".js-ore-tourist"))}),t.$touristList.on("click",".js-ore-tourist--bonus-card-add",function(){t.addBonusCardForm($(this).closest(".js-ore-tourist"))}),t.$touristList.on("click",".js-ore-tourist--bonus-card-delete",function(){t.removeBonusCardForm($(this).closest(".js-ore-tourist--bonus-card"))}),t.$touristList.on("change",".simpletoggler input",function(){$(this).prop("checked")?$(this).closest(".simpletoggler").addClass("active"):$(this).closest(".simpletoggler").removeClass("active")}),t.$touristList.on("click",".js-ore-tourist--copy-name",function(){t.copyNamesToDoc($(this))}),t.$touristList.on("change",'input[name="getvisa"]',function(){var e=$(this).prop("checked")?"Требуется":"Не требуется";$(this).closest(".js-ore-tourist").find(".js-ore-tourist--require-visa").text(e)}),t.$touristList.on("change",'input[name="getinsurance"]',function(){var e=$(this).prop("checked")?"Требуется":"Не требуется";$(this).closest(".js-ore-tourist").find(".js-ore-tourist--require-insurance").text(e)}),t.$touristListControls.on("click",".js-ore-tourists--add-new",function(){t.addTouristForm(e.mds.OrderStorage)})},t.prototype.updateTouristForm=function(e,t){var r=this,i=r.mds.tourists.view,o=i.touristForms[e];KT.apiClient.getOrderTourists(r.orderId).then(function(s){if(0!==s.status)window.location.assign("/cabinetUI/orders/order/"+r.orderId);else{var n=s.body.tourists.filter(function(e){return t===e.touristId})[0],a=new KT.storage.TouristStorage(n.touristId);a.initialize(n),t!==e&&(o.attr("data-touristid",t).data("touristid",t),i.touristForms[t]=o,delete i.touristForms[e],delete i.customFields[e],null!==a.customFields&&(window.sessionStorage.removeItem("serviceToAddTourist"),KT.notify("customFieldsRevealed"))),r.mds.OrderStorage.saveTourist(a),t===e?KT.notify("touristUpdated",{name:[a.firstname,a.lastname].join(" ")}):KT.notify("touristAdded",{name:[a.firstname,a.lastname].join(" ")})}})},t}),function(e,t){KT.crates.OrderEdit.services.ServiceViewModel=t(KT.crates.OrderEdit)}(0,function(e){var t=function(e,t){this.ServiceStorage=e,this.tpl=t,this.customFields=[],this.headerView="",this.mainView="",this.additionalServicesView="",this.minimalPriceView="",this.actionsView=""};return t.extend=function(e){return e.prototype=Object.create(this.prototype),e.__super__=this.prototype,e.constructor=e,e},t.prototype.prepareViews=function(){throw new Error("ServiceViewModel:prepareViews not implemented")},t.prototype.prepareHeaderView=function(){throw new Error("ServiceViewModel:prepareHeaderView not implemented")},t.prototype.prepareMainView=function(){throw new Error("ServiceViewModel:prepareMainView not implemented")},t.prototype.prepareActionsView=function(){throw new Error("ServiceViewModel:prepareActionsView not implemented")},t.prototype.processCustomFields=function(){var t=this,r=this.ServiceStorage,i=new e.CustomFieldsFactory(this.tpl);this.customFields=[];var o=[];return Array.isArray(r.customFields)?(r.customFields.sort(function(e,t){var r=2===e.typeTemplate?2===t.typeTemplate?0:1:2===t.typeTemplate?-1:0;return 0!==r?r:e.require?t.require?0:-1:t.require?1:0}),r.customFields.forEach(function(e){var r=i.create(e);null!==r?t.customFields.push(r):o.push(e)}),o):null},t.prototype.initControls=function(){throw new Error("ServiceViewModel:initControls not implemented")},t.prototype.getCustomFieldsValues=function(){var e=this.ServiceStorage,t=[],r=!0;return this.customFields.forEach(function(i){var o=i.getValue();i.modifiable&&i.validate(o)?t.push({fieldTypeId:i.fieldTypeId,value:""!==o?o:null,serviceId:e.serviceId}):r=!1}),r?t:null},t.prototype.mapTouristsInfo=function(){throw new Error("ServiceViewModel:mapTouristsInfo not implemented")},t.prototype.getTouristsMap=function(){return void 0!==this.touristsMap?this.touristsMap:(console.error("Ошибка получения данных формы туристов: сначала необходимо вызвать mapTouristInfo()"),!1)},t.prototype.checkTouristAddAllowance=function(){var e=this.ServiceStorage;if(!(!e.isPartial&&(9===e.status&&"op"===KT.profile.userType||0===e.status)))return!1;var t=!1;for(var r in this.touristsAges)this.touristsAges.hasOwnProperty(r)&&this.touristsAges[r].ordered>this.touristsAges[r].current&&(t=!0);return t},t.prototype.setCommonManualFormParams=function(){var e=this.ServiceStorage;return{serviceId:e.serviceId,clientCurrency:e.prices.inClient.currencyCode,clientGrossPrice:e.prices.inClient.client.gross.toMoney(2,","," "),agentCommission:e.prices.inClient.client.commission.amount.toMoney(2,","," "),supplierGrossPrice:e.prices.inSupplier.supplier.gross.toMoney(2,","," "),supplierCurrency:e.prices.inSupplier.currencyCode,clientCancelPenalties:null===e.clientCancelPenalties?null:e.clientCancelPenalties.map(function(e,t){return{penaltyIndex:t,dateFrom:e.dateFrom.format(KT.config.dateFormat),dateTo:e.dateTo.format(KT.config.dateFormat),amount:Number(e.penaltySum.inClient.amount).toMoney(2,","," "),currency:e.penaltySum.inClient.currency,currencyIcon:KT.getCatalogInfo("lcurrency",e.penaltySum.inClient.currency,"icon")}})}},t.prototype.initManualFormControls=function(e,t){var r=this.ServiceStorage;e.on("click",".js-ore-service-manualedit--tab-link",function(){if(!$(this).hasClass("active")){var e=$(this).closest(".js-ore-service-manualedit");e.children(".js-ore-service-manualedit--tab-header").children(".js-ore-service-manualedit--tab-link").filter(".active").removeClass("active"),$(this).addClass("active"),e.children(".js-ore-service-manualedit--tab").removeClass("active").filter('[data-tab="'+$(this).data("tab")+'"]').addClass("active")}}),e.find(".js-ore-service-manualedit--start-date").val(this.ServiceStorage.startDate.format("DD.MM.YYYY")).clndrize({template:t.tpl.clndr,eventName:"Дата начала услуги",showDate:this.ServiceStorage.startDate,clndr:{constraints:{startDate:moment().format("YYYY-MM-DD"),endDate:moment().add(1,"years").format("YYYY-MM-DD")}}}),e.find(".js-ore-service-manualedit--end-date").val(this.ServiceStorage.endDate.format("DD.MM.YYYY")).clndrize({template:t.tpl.clndr,eventName:"Дата окончания услуги",showDate:this.ServiceStorage.endDate,clndr:{constraints:{startDate:moment().format("YYYY-MM-DD"),endDate:moment().add(1,"years").format("YYYY-MM-DD")}}});var i=e.find(".js-ore-service-manualedit--selected-currency");e.find(".js-ore-service-manualedit--currency").selectize({openOnFocus:!0,create:!1,allowEmptyOption:!1,valueField:"value",labelField:"text",options:[{value:r.prices.inClient.currencyCode,text:"Валюта продажи"},{value:r.prices.inSupplier.currencyCode,text:"Валюта поставщика"},{value:r.prices.inView.currencyCode,text:"Валюта просмотра"},{value:r.prices.inLocal.currencyCode,text:"Локальная валюта"}],items:[r.prices.inClient.currencyCode],render:{item:function(e){return'<div class="item">'+e.value+" ("+e.text+")</div>"},option:function(e){return'<div class="option">'+e.value+" ("+e.text+")</div>"}},onItemAdd:function(e){i.text(e)}}),e.find(".js-ore-service-manualedit--client-gross-price").setValidation("price",null,!0).on("change, focusout",function(){var e=parseFloat($(this).val().replace(/\s+/g,"").replace(",","."));(isNaN(e)||""===$(this).val())&&($(this).val(r.prices.inClient.client.gross.toMoney(2,","," ")),$(this).addClass("error").one("click, focusin",function(){$(this).removeClass("error")}))}),e.find(".js-ore-service-manualedit--agent-commission").setValidation("price",null,!0).on("change, focusout",function(){var e=parseFloat($(this).val().replace(/\s+/g,"").replace(",","."));(isNaN(e)||""===$(this).val())&&($(this).val(r.prices.inClient.client.commission.amount.toMoney(2,","," ")),$(this).addClass("error").one("click, focusin",function(){$(this).removeClass("error")}))}),e.find(".js-ore-service-manualedit--client-cancel-penalty-amount").setValidation("price",null,!0).on("change, focusout",function(){var e=parseFloat($(this).val().replace(/\s+/g,"").replace(",","."));(isNaN(e)||""===$(this).val())&&$(this).val($(this).data("penalty"))});var o=[];for(var s in KT.getCatalogInfo.servicestatuses)s=+s,-1!==[0,2,5,7,8].indexOf(s)&&o.push({value:s,name:KT.getCatalogInfo.servicestatuses[s][1],icon:KT.getCatalogInfo.servicestatuses[s][0]});e.find(".js-ore-service-manualedit--change-status").selectize({openOnFocus:!0,create:!1,valueField:"value",labelField:"name",options:o,render:{item:function(e){return'<div data-value="'+e.value+'" class="item" title="'+e.name+'"><i class="service-status-small service-sm-status-'+e.icon+'"></i> '+e.name+"</div>"},option:function(e){return'<div data-value="'+e.value+'" data-selectable class="option"><i class="service-status-small service-sm-status-'+e.icon+'"></i> '+e.name+"</div>"}}})},t}),function(e,t){KT.crates.OrderEdit.services.AviaServiceViewModel=t(KT.crates.OrderEdit)}(0,function(e){var t=e.services.ServiceViewModel,r={1:"ISSUED",2:"VOIDED",3:"RETURNED",4:"CHANGED"},i=t.extend(function(e,r,i){t.call(this,e,r),this.serviceTypeName="avia",this.touristsAges={adults:{ordered:e.declaredTouristAges.adults,current:0},children:{ordered:e.declaredTouristAges.children,current:0},infants:{ordered:e.declaredTouristAges.infants,current:0}},this.fareRulesView="",this.tripData=[],this.tripDates=[],this.tripPoints=[],this.hasPnr=!1,this.pnrNumber=!1,this.tickets=!1,this.receipts=!1,this.ticketLink=!1,this.touristsMap=[],e.isPartial||(this.supplierCode=e.offerInfo.supplierCode,this.supplierName=void 0!==i[this.supplierCode]?i[this.supplierCode].name:this.supplierCode),this.manualFormParams=null});return i.templates={aviaFormHeader:"orderEdit/services/avia/aviaFormHeader",aviaFormMain:"orderEdit/services/avia/aviaFormMain",aviaServiceActions:"orderEdit/services/avia/aviaServiceActions",aviaTrip:"orderEdit/services/avia/aviaTrip",aviaTripRoute:"orderEdit/services/avia/aviaTripRoute",aviaLoyaltyCard:"orderEdit/services/avia/aviaLoyaltyCard",aviaNoLoyaltyCards:"orderEdit/services/avia/aviaNoLoyaltyCards",aviaFareRule:"orderEdit/services/avia/aviaFareRule",aviaFareRuleUnavailable:"orderEdit/services/avia/aviaFareRuleUnavailable",aviaMinimalPrice:"orderEdit/services/avia/aviaMinimalPrice",aviaManualForm:"orderEdit/services/avia/aviaManualForm"},i.prototype.prepareViews=function(){var e=this.ServiceStorage;e.isPartial?this.tripDates.push({wd:e.startDate.format("dd"),dm:e.startDate.format("DD.MM")}):(this.processTrips(),this.processPnr(),this.processCustomFields()),this.prepareHeaderView(),this.prepareMainView(),this.prepareActionsView()},i.prototype.processTrips=function(){var e=this;this.tripData=[],this.tripDates=[],this.tripPoints=[];var t=!this.ServiceStorage.isPartial&&void 0!==this.ServiceStorage.offerInfo.pnr&&null!==this.ServiceStorage.offerInfo.pnr;this.ServiceStorage.offerInfo.itinerary.forEach(function(r){var i=r.segments[0],o=r.segments[+r.segments.length-1],s=moment(i.departureDate,"YYYY-MM-DD HH:mm:ss"),n=i.marketingAirline;e.tripDates.push({wd:s.format("dd"),dm:s.format("DD.MM")}),e.tripPoints.push({dep:{city:i.departureCityName,iata:i.departureAirportCode},arr:{city:o.arrivalCityName,iata:o.arrivalAirportCode}});var a={alName:void 0!==KT.airlineCodes[n]?KT.airlineCodes[n].name:n,alLogo:void 0!==KT.airlineCodes[n]&&!0===KT.airlineCodes[n].hasLogo&&n,segments:[]};r.segments.forEach(function(e,t){var i=!1;if(t+1<r.segments.length){var o=r.segments[t+1],s=moment(e.arrivalDate,"YYYY-MM-DD HH:mm:ss"),n=moment(o.departureDate,"YYYY-MM-DD HH:mm:ss");i=moment.duration(n.valueOf()-s.valueOf()).asMinutes()}a.segments.push({flightNum:e.marketingAirline+" "+e.flightNumber,transporter:e.operatingAirline!==e.marketingAirline&&{code:e.operatingAirline,name:void 0!==KT.airlineCodes[e.operatingAirline]?KT.airlineCodes[e.operatingAirline].name:e.operatingAirline},aircraft:e.aircraft,class:null!==e.categoryClassType?e.categoryClassType.substr(0,1):"A",className:null!==e.categoryClassType&&e.categoryClassType,dhours:parseInt(e.duration/60),dminutes:e.duration%60,startpoint:{city:e.departureCityName,airport:e.departureAirportName,terminal:e.departureTerminal,iata:e.departureAirportCode,date:e.departureDate.split(" ")[0],time:e.departureDate.split(" ")[1].substr(0,5)},endpoint:{city:e.arrivalCityName,airport:e.arrivalAirportName,terminal:e.arrivalTerminal,iata:e.arrivalAirportCode,date:e.arrivalDate.split(" ")[0],time:e.arrivalDate.split(" ")[1].substr(0,5)},waiting:!1!==i&&{hours:Math.floor(i/60),minutes:i%60},stops:[]})});var c=[];1===r.segments.length?Array.isArray(r.segments[0].baggage)&&c.push(r.segments[0].baggage.map(function(e){return[e.measureQuantity,"PC"===e.measureCode?declOfNum(e.measureQuantity,["место","места","мест"]):e.measureCode].join(" ")}).join(", ")):r.segments.forEach(function(e){Array.isArray(e.baggage)&&c.push(e.departureAirportCode+" - "+e.arrivalAirportCode+": "+e.baggage.map(function(e){return[e.measureQuantity,"PC"===e.measureCode?declOfNum(e.measureQuantity,["место","места","мест"]):e.measureCode].join(" ")}).join(", "))});var l=r.segments.length-1;e.tripData.push(Mustache.render(e.tpl.aviaTrip,{route:Mustache.render(e.tpl.aviaTripRoute,a),hasPnr:t,baggageInfo:c,transfersNum:0===l?"без пересадок":l+" "+declOfNum(l,["пересадка","пересадки","пересадок"])}))})},i.prototype.processPnr=function(){var e=this,t=this.ServiceStorage;void 0!==t.offerInfo.pnr&&null!==t.offerInfo.pnr&&(e.hasPnr=!0,e.pnrNumber=t.offerInfo.pnr.pnrNumber,e.pnrBaggageInfo={info:null},void 0!==t.offerInfo.pnr.receipts&&Array.isArray(t.offerInfo.pnr.receipts)&&(e.receipts=t.offerInfo.pnr.receipts,e.ticketLink=void 0!==e.receipts[0]&&e.receipts[0].receiptUrl),void 0!==t.offerInfo.pnr.tickets&&Array.isArray(t.offerInfo.pnr.tickets)&&0!==t.offerInfo.pnr.tickets.length&&(e.tickets={},t.offerInfo.pnr.tickets.forEach(function(t){e.tickets.hasOwnProperty(t.touristId)||(e.tickets[t.touristId]=[]),e.tickets[t.touristId].push({status:r[t.ticketStatus],number:t.ticketNumber})})),Array.isArray(t.offerInfo.pnr.baggage)&&(t.offerInfo.pnr.baggage.map(function(e){"PC"===e.measureCode&&(e.measureCode=declOfNum(e.measureQuantity,["место","места","мест"]))}),e.pnrBaggageInfo.info=t.offerInfo.pnr.baggage))},i.prototype.processCustomFields=function(){var e=this,r=t.prototype.processCustomFields.call(this);Array.isArray(r)&&r.forEach(function(t){switch(t.typeTemplate){case 5:if(null===t.value)return;var r=JSON.parse(t.value);e.minimalPriceView=Mustache.render(e.tpl.aviaMinimalPrice,{from:r.from,to:r.to,dateStart:moment(r.dateStart,"YYYY-MM-DD HH:mm:ss").format("HH:mm YYYY-MM-DD"),dateFinish:moment(r.dateFinish,"YYYY-MM-DD HH:mm:ss").format("HH:mm YYYY-MM-DD"),duration:{hours:Math.floor(r.duration/60),minutes:r.duration%60},changes:[r.changes,declOfNum(r.changes,["пересадка","пересадки","пересадок"])].join(" "),price:Number(r.price).toMoney(0,","," "),currency:KT.getCatalogInfo("lcurrency",r.currency,"icon")})}})},i.prototype.prepareHeaderView=function(){var e=this.ServiceStorage,t="";if(e.isPartial)t=e.serviceName;else if(void 0!==e.offerInfo.itinerary[0]&&void 0!==e.offerInfo.itinerary[0].segments[0]){var r=e.offerInfo.itinerary[0].segments[0];t=r.marketingAirline+"-"+r.flightNumber}this.headerView=Mustache.render(this.tpl.aviaFormHeader,{firstFlightNum:t,amendDate:null!==e.dateAmend&&e.dateAmend.format("DD.MM.YYYY"),priceLocal:Number(e.prices.inLocal.client.gross).toMoney(0,","," "),priceInView:Number(e.prices.inView.client.gross).toMoney(0,","," "),viewCurrencyIcon:KT.getCatalogInfo("lcurrency",e.prices.inView.currencyCode,"icon"),statusIcon:KT.getCatalogInfo("servicestatuses",e.status,"icon"),statusTitle:"op"===KT.profile.userType&&9===e.status?"Ручной режим":KT.getCatalogInfo("servicestatuses",e.status,"title"),dates:this.tripDates,flights:this.tripPoints,passengers:{adult:e.declaredTouristAges.adults,child:e.declaredTouristAges.children,infant:e.declaredTouristAges.infants},pnrNumber:this.pnrNumber,ticketLink:this.ticketLink})},i.prototype.prepareMainView=function(){var e=this.ServiceStorage;if(e.isPartial)this.mainView="";else{var t=null!==e.offerInfo.lastTicketingDate?moment(e.offerInfo.lastTicketingDate,"YYYY-MM-DD HH:mm:ss").format("HH:mm DD-MM-YYYY"):null;this.mainView=Mustache.render(this.tpl.aviaFormMain,{offerSupplier:"op"===KT.profile.userType&&this.supplierName,lastTicketingDate:t,flightTrips:this.tripData,overNightFlight:!!e.hasTravelPolicy&&e.offerInfo.travelPolicy.overNightFlight,nightTransfer:!!e.hasTravelPolicy&&e.offerInfo.travelPolicy.nightTransfer,pnrBaggageInfo:this.pnrBaggageInfo,ticketLink:this.ticketLink})}},i.prototype.prepareActionsView=function(){var e=this;if(this.ServiceStorage.isPartial)this.actionsView="";else{var t=this.getServiceActions();this.actionsView=Mustache.render(e.tpl.aviaServiceActions,t),this.prepareFareRulesView()}},i.prototype.prepareFareRulesView=function(){var e=this.ServiceStorage;if(Array.isArray(e.offerInfo.fareRules)&&0!==e.offerInfo.fareRules.length){var t={rules:[]},r=!0,i={};e.offerInfo.itinerary.forEach(function(e){e.segments.forEach(function(e){i[e.arrivalAirportCode]=e.arrivalCityName,i[e.departureAirportCode]=e.departureCityName})}),e.offerInfo.fareRules.forEach(function(e){var o={},s=e.segment.flightSegmentName.split(/\s*-\s*/),n=i[s[0]]+" - "+i[s[1]];for(var a in e.aviaFareRule.shortRules)if(e.aviaFareRule.shortRules.hasOwnProperty(a))switch(e.aviaFareRule.shortRules[a]){case!0:o[a]={allowed:!0};break;case!1:o[a]={forbidden:!0};break;default:o[a]={undefined:!0}}t.rules.push({active:r,segment:e.segment.flightSegmentName,fullSegmentName:n,shortRules:o,rulesText:e.aviaFareRule.rules}),r=!1}),this.fareRulesView=Mustache.render(this.tpl.aviaFareRule,t)}else this.fareRulesView=Mustache.render(KT.tpl.spinner,{})},i.prototype.prepareEmptyFareRulesView=function(){this.fareRulesView=Mustache.render(this.tpl.aviaFareRuleUnavailable,{})},i.prototype.initControls=function(e){if(this.customFields.length>0){var t=$();this.customFields.forEach(function(e){t=t.add(e.render())}),e.find(".js-service-form-custom-fields").html(t),this.customFields.forEach(function(e){e.initialize()})}},i.prototype.mapTouristsInfo=function(e,t){var r=this,i=this.ServiceStorage;if(this.touristsAges={adults:{ordered:i.declaredTouristAges.adults,current:0},children:{ordered:i.declaredTouristAges.children,current:0},infants:{ordered:i.declaredTouristAges.infants,current:0}},this.touristsMap=[],0!==e.length){void 0===t&&(t=!1);var o=!i.isPartial&&(9===i.status&&"op"===KT.profile.userType||0===i.status);e.forEach(function(e){var s=i.tourists.hasOwnProperty(e.touristId),n=s?i.tourists[e.touristId]:null,a="";if(!i.isPartial){if(s){var c=moment.duration(moment().valueOf()-e.birthdate.valueOf()).asYears();c<3?r.touristsAges.infants.current+=1:c<12?r.touristsAges.children.current+=1:r.touristsAges.adults.current+=1}if(void 0!==r.tickets&&void 0!==r.tickets[e.touristId]){var l=r.tickets[e.touristId].filter(function(e){return"ISSUED"===e.status}).map(function(e){return e.number});a='<div class="service-form-tourist__ticket-number">№ билет'+(l.length>1?"ов":"а")+": "+l.join(", ")+"</div>"}else a=s&&null!==n.loyalityProviderId||e.bonusCards.length>0?Mustache.render(r.tpl.aviaLoyaltyCard,{isSavingAllowed:o,loyalityProgram:s?n.loyalityProviderId:null,loyalityCardNumber:s?n.loyalityCardNumber:null}):Mustache.render(r.tpl.aviaNoLoyaltyCards,{})}(t||o||s)&&r.touristsMap.push({allowSave:o,touristId:e.touristId,firstName:e.firstname,bonusCards:e.bonusCards,surName:e.lastname,attached:s,touristExtra:a})})}},i.prototype.renderTouristControls=function(e,t){KT.Dictionary.getAsMap("loyalityPrograms","programId").then(function(r){var i=t.bonusCards.map(function(e){if(r.hasOwnProperty(e.aviaLoyaltyProgramId))return $.extend(!0,{cardNumber:e.bonuscardNumber},r[e.aviaLoyaltyProgramId])});if(0!==i.length){var o=e.find(".js-service-avia-loyalty-program");if(0!==o.length){var s=o.find(".js-service-avia-loyalty-program--provider"),n=o.find(".js-service-avia-loyalty-program--number"),a=s.val();s.selectize({plugins:{jirafize:{}},openOnFocus:!0,create:!1,options:i,selectOnTab:!0,valueField:"programId",searchField:["IATAcode","loyalityProgramName","aircompanyName"],render:{item:function(e){return'<div class="item" data-tooltip="авиакомпания: '+e.aircompanyName+"<br> альянс: "+e.allianceName+'"><b>['+e.IATAcode+"]</b> "+e.loyalityProgramName+"</div>"},option:function(e){return'<div class="option" data-tooltip="авиакомпания: '+e.aircompanyName+"<br> альянс: "+e.allianceName+'"><b>['+e.IATAcode+"]</b> "+e.loyalityProgramName+"</div>"}},onItemAdd:function(e){n.val(this.options[e].cardNumber)},onItemRemove:function(){n.val("")},onClear:function(){n.val("")}}),""!==a&&null!==a?s[0].selectize.addItem(+a):i.length>0&&t.allowSave&&!t.attached&&s[0].selectize.addItem(i[0].programId)}}})},i.prototype.getServiceActions=function(){var e=this.ServiceStorage,t={serviceId:e.serviceId,ManualEdit:"op"===KT.profile.userType&&9===e.status,save:this.customFields.length>0};return e.allowedTransitions.forEach(function(e){t[e]=!0}),"op"!==KT.profile.userType&&t.Manual&&(t.Manual=!1,t.ToManager=!0),t.agreementSet=e.isTOSAgreementSet,t.BookStart||(t.agreementDisabled=!0,t.agreementSet=!0),t},i.prototype.defineTermsDocuments=function(){var e=this,t=this.ServiceStorage,r={companyTOS:{load:function(e,t){t("companyTOS",e)}}};return r[t.tosDocumentName]={load:function(e,t){t("aviaBookTerms",e)}},r[t.fareRuleDocumentName]={load:function(r){r(t.fareRuleDocumentName,e.fareRulesView).on("click",".js-avs-fare-rule--tab-link",function(){if(!$(this).hasClass("active")){var e=$(this).closest(".js-avs-fare-rule");e.children(".js-avs-fare-rule--tab-header").children(".js-avs-fare-rule--tab-link").filter(".active").removeClass("active"),$(this).addClass("active"),e.children(".js-avs-fare-rule--tab").removeClass("active").filter('[data-tab="'+$(this).data("tab")+'"]').addClass("active")}})}},r},i.prototype.renderManualForm=function(e){var i=this.ServiceStorage,o=t.prototype.setCommonManualFormParams.call(this),s=$.extend(o,{flightTariff:i.offerInfo.flightTariff,pnr:this.hasPnr?i.offerInfo.pnr.pnrNumber:null,tickets:null});if(this.hasPnr){var n=this.ServiceStorage.offerInfo.pnr.tickets;void 0!==n&&0!==n.length&&(s.tickets=[],n.forEach(function(t){var o=e.OrderStorage.tourists[t.touristId];s.tickets.push({pnr:i.offerInfo.pnr.pnrNumber,number:t.ticketNumber,tourist:{id:o.touristId,fullname:[o.lastname,o.firstname,null===o.middlename?"":o.middlename].join(" "),document:{docname:KT.config.touristDocuments[o.document.type].docname,number:o.document.series+" "+o.document.number}},status:r[+t.ticketStatus],disabled:"ISSUED"!==r[+t.ticketStatus],newNumber:void 0!==t.newTicket?t.newTicket:null})}))}return this.manualFormParams=s,Mustache.render(this.tpl.aviaManualForm,s)},i.prototype.initManualFormControls=function(e,r){var i=this;t.prototype.initManualFormControls.call(this,e,r);var o=this.ServiceStorage;KT.Dictionary.getAsList("suppliers",{serviceId:o.typeCode,active:1}).then(function(t){e.find(".js-ore-service-manualedit--supplier").selectize({openOnFocus:!0,create:!1,valueField:"supplierCode",labelField:"name",options:t,items:[i.supplierCode]})});var s=null!==o.offerInfo.lastTicketingDate?moment(o.offerInfo.lastTicketingDate,"YYYY-MM-DD HH:mm:ss"):null;e.find(".js-ore-service-manualedit--last-ticketing-date").val(null!==s?s.format("DD.MM.YYYY"):"").clndrize({template:r.tpl.clndr,eventName:"Выписать до",showDate:null!==s?s:"",clndr:{constraints:{startDate:moment().format("YYYY-MM-DD"),endDate:this.ServiceStorage.startDate.format("YYYY-MM-DD")}}});var n=null===this.manualFormParams.tickets?[]:this.manualFormParams.tickets.filter(function(e){return"ISSUED"===e.status}),a=e.find(".js-ore-service-manualedit--avia-tickets-list"),c=e.find(".js-ore-service-manualedit--change-avia-ticket"),l=e.find(".js-ore-service-manualedit--add-avia-ticket"),d=e.find(".js-ore-service-manualedit--current-ticket-number"),u=e.find(".js-ore-service-manualedit--add-avia-ticket-button");d.selectize({openOnFocus:!0,create:!1,valueField:"number",labelField:"number",options:n}),a.on("click",".js-ore-service-manualedit--avia-ticket:not(.disabled)",function(){l.removeClass("active"),c.addClass("active"),d[0].selectize.addItem($(this).data("ticket"))}),u.on("click",function(){c.removeClass("active"),l.addClass("active")});var m=[];r.OrderStorage.getTourists().forEach(function(e){o.tourists.hasOwnProperty(e.touristId)&&m.push({value:e.touristId,name:[e.lastname,e.firstname].join(" "),document:[KT.config.touristDocuments[e.document.type].docname,e.document.series,e.document.number].join(" ")})}),e.find(".js-ore-service-manualedit--new-ticket-tourist").selectize({openOnFocus:!0,create:!1,valueField:"value",labelField:"name",options:m,render:{item:function(e){return'<div data-value="'+e.value+'" class="item" data-tooltip="'+e.document+'">'+e.name+"</div>"},option:function(e){return'<div data-value="'+e.value+'" data-selectable class="option">'+e.name+"<br>("+e.document+")</div>"}}})},i.prototype.getChangeBookDataParams=function(e){var t=this.ServiceStorage,r=e.find(".js-ore-service-manualedit--new-pnr-number").val(),i=e.find(".js-ore-service-manualedit--supplier").val(),o=e.find(".js-ore-service-manualedit--tariff").val(),s=e.find(".js-ore-service-manualedit--last-ticketing-date").val();if(""===r){if(void 0===t.offerInfo.pnr.pnrNumber)return KT.notify("reservationNumberNotSet"),!1;r=t.offerInfo.pnr.pnrNumber}return""===i&&(i=this.supplierCode),s=""!==s?moment(s,"DD.MM.YYYY").format("YYYY-MM-DD HH:mm:ss"):null,{serviceId:t.serviceId,reservationData:[{reservationAction:"update",PNR:r,aviaReservation:{PNR:r,segments:null,supplierCode:i,status:1},flightTariff:o,lastTicketingDate:s}]}},i.prototype.getChangeTicketDataParams=function(e){var t,r=e.find(".js-ore-service-manualedit--change-avia-ticket"),i=r.find(".js-ore-service-manualedit--current-ticket-number")[0].selectize,o=i.getValue();if(""===o||null===o)return KT.notify("changingTicketNotSelected"),!1;t=i.options[o];var s=r.find(".js-ore-service-manualedit--new-ticket-number").val();return""===s?(KT.notify("ticketNumberNotEntered"),!1):{serviceId:this.ServiceStorage.serviceId,ticketData:{ticketAction:"update",ticketNumber:t.number,ticketData:{pnr:t.pnr,touristId:t.tourist.id,ticketNumber:s,ticketStatus:1,newTicket:null}}}},i.prototype.getAddTicketParams=function(e){var t=e.find(".js-ore-service-manualedit--add-avia-ticket"),r=t.find(".js-ore-service-manualedit--new-ticket-number").val();if(""===r)return KT.notify("ticketNumberNotEntered"),!1;var i=t.find(".js-ore-service-manualedit--new-ticket-tourist").val();return""===i?(KT.notify("ticketTouristNotSet"),!1):{serviceId:this.ServiceStorage.serviceId,ticketData:{ticketAction:"add",ticketNumber:null,ticketData:{pnr:this.ServiceStorage.offerInfo.pnr.pnrNumber,touristId:+i,ticketNumber:r,ticketStatus:1,newTicket:null}}}},i}),function(e,t){KT.crates.OrderEdit.services.HotelServiceViewModel=t(KT.crates.OrderEdit)}(0,function(e){var t=e.services.ServiceViewModel,r={FIVE:5,FOUR:4,THREE:3,TWO:2,ONE:1},i=t.extend(function(e,r,i){t.call(this,e,r),this.serviceTypeName="hotel",this.touristsAges={adults:{ordered:e.declaredTouristAges.adults,current:0},children:{ordered:e.declaredTouristAges.children,current:0}},this.bookTermsView="",this.hotelName=e.name,this.hotelAddress="",this.hotelPhoto="",this.category=null,this.roomType="",this.reservationData=!1,this.voucherLink=!1,this.hasAdditionalServices=!1,this.touristsMap=[],e.isPartial||(this.supplierCode=e.offerInfo.supplierCode,this.supplierName=void 0!==i[this.supplierCode]?i[this.supplierCode].name:this.supplierCode,this.tosDocumentName=e.tosDocumentName)});return i.templates={hotelFormHeader:"orderEdit/services/hotel/hotelFormHeader",hotelFormMain:"orderEdit/services/hotel/hotelFormMain",hotelServiceActions:"orderEdit/services/hotel/hotelServiceActions",hotelBookTerms:"orderEdit/services/hotel/hotelBookTerms",hotelFullInfo:"orderEdit/services/hotel/hotelFullInfo",hotelAdditionalServices:"orderEdit/services/hotel/hotelAdditionalServices",hotelMinimalPrice:"orderEdit/services/hotel/hotelMinimalPrice",hotelManualForm:"orderEdit/services/hotel/hotelManualForm"},i.prototype.prepareViews=function(){this.ServiceStorage.isPartial||(this.processHotelInfo(),this.processReservation(),this.processCustomFields()),this.prepareHeaderView(),this.prepareMainView(),this.prepareAdditionalServicesView(),this.prepareActionsView(),this.prepareBookTermsView()},i.prototype.processHotelInfo=function(){var e=this.ServiceStorage;this.hotelName=null!==e.offerInfo.hotelInfo?e.offerInfo.hotelInfo.name:"нет названия",this.hotelAddress=null!==e.offerInfo.hotelInfo?e.offerInfo.hotelInfo.address:"нет адреса",this.hotelPhoto=null!==e.offerInfo.hotelInfo?e.offerInfo.hotelInfo.mainImageUrl:"",this.category=null!==e.offerInfo.hotelInfo&&null!==e.offerInfo.hotelInfo.category&&function(e){var t=[];if(void 0!==r[e])for(var i=0;i<r[e];i++)t.push(!0);return t}(e.offerInfo.hotelInfo.category),this.roomType=e.offerInfo.roomType},i.prototype.processReservation=function(){var e=this.ServiceStorage;this.reservationData=null!==e.offerInfo.hotelReservations&&{number:e.offerInfo.hotelReservations.reservationNumber},this.voucherLink=!(null===e.offerInfo.hotelReservations||null===e.offerInfo.hotelReservations.hotelVouchers||!Array.isArray(e.offerInfo.hotelReservations.hotelVouchers))&&e.offerInfo.hotelReservations.hotelVouchers[0].receiptUrl},i.prototype.processCustomFields=function(){var e=this,r=t.prototype.processCustomFields.call(this);Array.isArray(r)&&r.forEach(function(t){switch(t.typeTemplate){case 5:if(null===t.value)return;var r=JSON.parse(t.value);e.minimalPriceView=Mustache.render(e.tpl.hotelMinimalPrice,{hotelName:r.hotelName,room:r.roomType,mealType:r.mealType,price:Number(r.price).toMoney(0,","," "),currency:KT.getCatalogInfo("lcurrency",r.currency,"icon")})}})},i.prototype.prepareHeaderView=function(){var e=this,t=this.ServiceStorage,r=t.startDate,i=t.endDate,o=i.startOf("day").diff(r.startOf("day"),"days")+1;this.headerView=Mustache.render(this.tpl.hotelFormHeader,{priorityOffer:!!t.hasTravelPolicy&&t.offerInfo.travelPolicy.priorityOffer,isPartial:t.isPartial,roomType:t.isPartial?"":t.offerInfo.roomType,hotelId:t.isPartial?"":t.offerInfo.hotelId,hotelName:e.hotelName,hotelAddress:e.hotelAddress,hotelPhoto:e.hotelPhoto,category:e.category,priceLocal:Number(t.prices.inLocal.client.gross).toMoney(0,","," "),priceInView:Number(t.prices.inView.client.gross).toMoney(0,","," "),viewCurrencyIcon:KT.getCatalogInfo("lcurrency",t.prices.inView.currencyCode,"icon"),statusIcon:KT.getCatalogInfo("servicestatuses",t.status,"icon"),statusTitle:"op"===KT.profile.userType&&9===t.status?"Ручной режим":KT.getCatalogInfo("servicestatuses",t.status,"title"),dateFrom:{wd:r.format("dd"),dm:r.format("DD.MM")},dateTo:{wd:i.format("dd"),dm:i.format("DD.MM")},days:{count:o,label:declOfNum(o,["день","дня","дней"])},residents:{adults:t.declaredTouristAges.adults,children:t.declaredTouristAges.children},reservationData:e.reservationData,voucherLink:e.voucherLink})},i.prototype.prepareMainView=function(){var e=this.ServiceStorage,t=e.startDate,r=e.endDate.startOf("day").diff(t.startOf("day"),"days"),i=r+1;e.isPartial||(this.mainView=Mustache.render(this.tpl.hotelFormMain,{offerSupplier:"op"===KT.profile.userType&&this.supplierName,roomType:this.roomType,roomTypeDescription:"string"==typeof e.offerInfo.roomTypeDescription&&""!==e.offerInfo.roomTypeDescription&&e.offerInfo.roomTypeDescription.replace(/<\/?[^>]+>/gi,""),mealType:e.offerInfo.mealType,daysCount:i+" "+declOfNum(i,["день","дня","дней"]),nightsCount:r+" "+declOfNum(r,["ночь","ночи","ночей"]),fareName:"string"==typeof e.offerInfo.fareName&&""!==e.offerInfo.fareName&&e.offerInfo.fareName.replace(/<\/?[^>]+>/gi,""),fareDescription:"string"==typeof e.offerInfo.fareDescription&&""!==e.offerInfo.fareDescription&&e.offerInfo.fareDescription.replace(/<\/?[^>]+>/gi,""),voucherLink:this.voucherLink}))},i.prototype.prepareAdditionalServicesView=function(){if(!this.ServiceStorage.isPartial){var e=this.ServiceStorage.offerInfo.additionalServices,t=this.ServiceStorage.additionalServices;if(Array.isArray(e)&&0!==e.length){var r={};t.forEach(function(e){r[e.serviceSubType]={oneOfTypeAllowed:!Boolean(e.bookingSomeServices)}}),this.hasAdditionalServices=!0;var i={1:{icon:"service-meal",name:"Дополнительное питание"}},o=this;this.additionalServicesView=Mustache.render(this.tpl.hotelAdditionalServices,{issued:t.map(function(e){var t=e.serviceSubType;if(!i.hasOwnProperty(t))return!1;var r=e.salesTermsInfo.localCurrency.client,s=e.salesTermsInfo.viewCurrency.client,n=+e.status;return{id:e.idAddService,name:e.name,typeName:i[t].name,icon:i[t].icon,localPrice:Number(r.amountBrutto).toMoney(0,","," "),localCurrency:KT.getCatalogInfo("lcurrency",r.currency,"icon"),viewPrice:Number(s.amountBrutto).toMoney(2,","," "),viewCurrency:KT.getCatalogInfo("lcurrency",s.currency,"icon"),isBooked:0!==n,bookedWithService:0===n&&e.bookedWithService,bookAllowed:0===n&&!e.bookedWithService,removeAllowed:o.ServiceStorage.checkTransition("RemoveExtraService")&&0===n}}).filter(function(e){return!1!==e}),available:e.map(function(e){var t=e.serviceSubType;if(!i.hasOwnProperty(t))return!1;var o=e.salesTermsInfo.localCurrency.client,s=e.salesTermsInfo.viewCurrency.client;return{id:e.idAddService,name:e.name,typeName:i[t].name,icon:i[t].icon,addingAllowed:!r.hasOwnProperty(t)||!r[t].oneOfTypeAllowed,localPrice:Number(o.amountBrutto).toMoney(0,","," "),localCurrency:KT.getCatalogInfo("lcurrency",o.currency,"icon"),viewPrice:Number(s.amountBrutto).toMoney(2,","," "),viewCurrency:KT.getCatalogInfo("lcurrency",s.currency,"icon")}}).filter(function(e){return!1!==e})})}}},i.prototype.prepareActionsView=function(){var e=this;if(this.ServiceStorage.isPartial)this.actionsView="";else{var t=this.getServiceActions();this.actionsView=Mustache.render(e.tpl.hotelServiceActions,t)}},i.prototype.prepareBookTermsView=function(){var e=this.ServiceStorage,t=null;Array.isArray(e.clientCancelPenalties)&&(t=[],e.clientCancelPenalties.forEach(function(e){t.push({dateFrom:e.dateFrom.format(KT.config.dateFormat),dateTo:e.dateTo.format(KT.config.dateFormat),description:e.description,localAmount:Number(e.penaltySum.inLocal.amount).toMoney(2,","," "),localCurrency:KT.getCatalogInfo("lcurrency",e.penaltySum.inLocal.currency,"icon"),viewAmount:Number(e.penaltySum.inView.amount).toMoney(2,","," "),viewCurrency:KT.getCatalogInfo("lcurrency",e.penaltySum.inView.currency,"icon")})})),this.bookTermsView=Mustache.render(this.tpl.hotelBookTerms,{hotelName:this.hotelName,roomType:this.roomType,penalties:t})},i.prototype.initControls=function(e){if(this.initAddServicesControls(e),this.customFields.length>0){var t=$();this.customFields.forEach(function(e){t=t.add(e.render())}),e.find(".js-service-form-custom-fields").html(t),this.customFields.forEach(function(e){e.initialize()})}},i.prototype.initAddServicesControls=function(e){if(this.hasAdditionalServices){var t=e.find(".js-service-form--available-add-services-list"),r=e.find(".js-service-form--show-add-services-list"),i=e.find(".js-service-form--hide-add-services-list");r.on("click",function(){i.addClass("active"),r.removeClass("active"),t.slideDown(200).addClass("active")}),i.on("click",function(){i.removeClass("active"),r.addClass("active"),t.slideUp(200).removeClass("active")})}},i.prototype.mapTouristsInfo=function(e,t){var r=this,i=this.ServiceStorage;if(this.touristsAges={adults:{ordered:i.declaredTouristAges.adults,current:0},children:{ordered:i.declaredTouristAges.children,current:0}},this.touristsMap=[],0!==e.length){void 0===t&&(t=!1);var o=!i.isPartial&&(9===i.status&&"op"===KT.profile.userType||0===i.status);e.forEach(function(e){var s=i.tourists.hasOwnProperty(e.touristId);i.isPartial||s&&(moment.duration(moment().valueOf()-e.birthdate.valueOf()).asYears()<12?r.touristsAges.children.current+=1:r.touristsAges.adults.current+=1),(t||o||s)&&r.touristsMap.push({allowSave:o,touristId:e.touristId,firstName:e.firstname,surName:e.lastname,attached:s,touristExtra:""})})}},i.prototype.renderTouristControls=function(){},i.prototype.getServiceActions=function(){var e=this.ServiceStorage,t={serviceId:e.serviceId,ManualEdit:"op"===KT.profile.userType&&9===e.status,save:this.customFields.length>0};return e.allowedTransitions.forEach(function(e){t[e]=!0}),"op"!==KT.profile.userType&&t.Manual&&(t.Manual=!1,t.ToManager=!0),t.agreementSet=e.isTOSAgreementSet,t.BookStart||(t.agreementDisabled=!0,t.agreementSet=!0),t},i.prototype.defineTermsDocuments=function(){var e=this,t={companyTOS:{load:function(e,t){t("companyTOS",e)}}};return t[e.tosDocumentName]={load:function(t){t(e.tosDocumentName,e.bookTermsView)}},t},i.prototype.renderManualForm=function(){var e=t.prototype.setCommonManualFormParams.call(this),r=$.extend(e,{reservation:null!==this.ServiceStorage.offerInfo.hotelReservations&&null!==this.ServiceStorage.offerInfo.hotelReservations.reservationNumber?this.ServiceStorage.offerInfo.hotelReservations.reservationNumber:null});return Mustache.render(this.tpl.hotelManualForm,r)},i.prototype.initManualFormControls=function(e,r){var i=this;t.prototype.initManualFormControls.call(this,e,r);var o=this.ServiceStorage;KT.Dictionary.getAsList("suppliers",{serviceId:o.typeCode,active:1}).then(function(t){e.find(".js-ore-service-manualedit--supplier").selectize({openOnFocus:!0,create:!1,valueField:"supplierCode",labelField:"name",options:t,items:[i.supplierCode]})})},i.prototype.getChangeBookDataParams=function(e){var t=e.find(".js-ore-service-manualedit--new-reservation-number").val(),r=e.find(".js-ore-service-manualedit--supplier").val();if(""===t){if(null===this.ServiceStorage.offerInfo.hotelReservations)return!1;t=this.ServiceStorage.offerInfo.hotelReservations.reservationNumber}return""===r&&(r=this.supplierCode),{serviceId:this.serviceId,reservationData:[{reservationNumber:t,supplierCode:r}]}},i}),function(e,t){KT.crates.OrderEdit.services.view=t(KT.crates.OrderEdit.services)}(0,function(e){var t=e.AviaServiceViewModel,r=e.HotelServiceViewModel,i=function(e,i){this.mds=e,void 0===i&&(i={}),this.config=$.extend(!0,{templateUrl:"/cabinetUI/orders/getTemplates",staticDocumentUrl:"/cabinetUI/orders/getStaticDocument",templates:{serviceForm:"orderEdit/services/serviceForm",serviceTourist:"orderEdit/services/serviceTourist",serviceListEmpty:"orderEdit/services/serviceListEmpty",pricesChangedModal:"orderEdit/modals/pricesChanged",bookChangeModal:"orderEdit/modals/bookChange",bookCancelModal:"orderEdit/modals/bookCancel",sendToManagerModal:"orderEdit/modals/sendToManager",TextCF:"orderEdit/customFields/textCF",TextAreaCF:"orderEdit/customFields/textAreaCF",NumberCF:"orderEdit/customFields/numberCF",DateCF:"orderEdit/customFields/dateCF"}},i),$.extend(this.config.templates,t.templates),$.extend(this.config.templates,r.templates),this.mds.servicesTermsDocuments={},this.$serviceList=$("#cab-services"),this.$manualFormsRoot=$("body"),this.$bookChangeModal=null,this.serviceViewModels={},this.serviceForms={},this.BookChangeModal=this.setBookChangeModal(),this.BookCancelModal=this.setBookCancelModal(),this.HotelInfoPages=this.setHotelInfoPages(),this.ManualEditForms=this.setManualEditForms()};return i.prototype.renderServices=function(e){var i=this,o=$.Deferred(),s=KT.Dictionary.getAsMap("suppliers","supplierCode",{serviceId:2,active:1}),n=KT.Dictionary.getAsMap("suppliers","supplierCode",{serviceId:1,active:1});return $.when(s,n).then(function(s,n){var a=[],c={},l=$("#main-scroller").scrollTop(),d={};i.$serviceList.find(".js-service-form").each(function(){d[$(this).attr("data-sid")]=$(this).hasClass("active")}).end().empty(),e.getServices().forEach(function(o){var l,u=o.serviceId;if(i.serviceViewModels.hasOwnProperty(u))l=i.serviceViewModels[u];else{switch(o.typeCode){case 1:l=new r(o,i.mds.tpl,n);break;case 2:l=new t(o,i.mds.tpl,s);break;default:return}i.serviceViewModels[u]=l}l.prepareViews(),l.mapTouristsInfo(e.getTourists()),$.extend(c,l.defineTermsDocuments()),i.ManualEditForms.prepare(l);var m=$(Mustache.render(i.mds.tpl.serviceForm,{serviceId:o.serviceId,isCancelled:7===o.status||null!==o.penaltySums,serviceName:KT.getCatalogInfo("servicetypes",o.typeCode,"title"),serviceType:o.typeCode,serviceTypeName:l.serviceTypeName,serviceIcon:KT.getCatalogInfo("servicetypes",o.typeCode,"icon"),penalty:null===o.penaltySums?null:{client:{inLocal:o.penaltySums.inLocal.client.toMoney(0,","," "),inView:o.penaltySums.inView.client.toMoney(2,","," "),viewCurrencyIcon:KT.getCatalogInfo("lcurrency",o.penaltySums.inView.currencyCode,"icon")},supplier:"op"!==KT.profile.userType?null:{inLocal:o.penaltySums.inLocal.supplier.toMoney(0,","," "),inView:o.penaltySums.inView.supplier.toMoney(2,","," "),viewCurrencyIcon:KT.getCatalogInfo("lcurrency",o.penaltySums.inView.currencyCode,"icon")}},header:l.headerView,main:l.mainView,additionalServices:l.hasAdditionalServices?l.additionalServicesView:null,minimalPrice:l.minimalPriceView,travelPolicyViolations:o.hasTPViolations?{list:o.offerInfo.travelPolicy.travelPolicyFailCodes}:null,allowTouristAdd:!(!e.isAddTouristAllowed||!l.checkTouristAddAllowance()),tourists:"",hasCustomFields:l.customFields.length>0})).appendTo(i.$serviceList).data("unsaved",!1);l.initControls(m),i.serviceForms[u]=m,!0===d[o.serviceId]&&m.addClass("active"),i.serviceForms[o.serviceId]=m,a.push(u)}),$("#main-scroller").scrollTop(l),i.prepareServiceTermsDocuments(c),a.forEach(function(e){i.serviceForms[e].find(".js-service-form-actions").html(i.serviceViewModels[e].actionsView).end().find(".js-service-form-tos-agreement").on("click",".js-service-form-tos-agreement--tos-link",function(){var e=$(this).attr("data-link");i.mds.servicesTermsDocuments[e].open()}),i.renderServiceTourists(e)}),i.getServiceTermsDocuments(c),o.resolve()}),o.promise()},i.prototype.renderEmptyServiceList=function(){this.$serviceList.html(Mustache.render(this.mds.tpl.serviceListEmpty,{}))},i.prototype.renderPendingServiceProcess=function(e){this.serviceForms[e].find(".js-service-form-actions").html(Mustache.render(KT.tpl.spinner,{type:"medium"}))},i.prototype.navigateToService=function(e){var t=this.serviceForms[e];console.log("navigating to service: "+e+", offset: "+t.offset().top),void 0!==t&&$("#main-scroller").animate({scrollTop:t.offset().top},400,function(){t.addClass("active")})},i.prototype.renderServiceTourists=function(e){var t=this,r=t.serviceForms[e],i=t.serviceViewModels[e],o=i.ServiceStorage;i.mapTouristsInfo(t.mds.OrderStorage.getTourists());var s=r.find(".js-service-form-tourists");s.data("unsaved",!1).empty(),i.touristsMap.forEach(function(e){var r=$(Mustache.render(t.mds.tpl.serviceTourist,e)).appendTo(s);i.renderTouristControls(r,e)}),o.checkAllTouristsLinked()&&r.find(".js-service-form--add-tourist").remove()},i.prototype.renderServiceActions=function(e){var t=this.serviceViewModels[e],r=this.serviceForms[e];t.prepareActionsView(),r.find(".js-service-form-actions").html(t.actionsView)},i.prototype.getServiceTouristsData=function(e){var t={},r=!1;return this.serviceForms[e].find(".js-service-form-tourist").each(function(){var e=$(this).find(".js-service-form-tourist--service-bound"),i=+e.attr("data-touristid");t[i]={state:e.prop("checked"),loyalityProviderId:null,loyalityCardNumber:null};var o=$(this).find(".js-service-avia-loyalty-program");if(0!==o.length){var s=o.find(".js-service-avia-loyalty-program--provider"),n=o.find(".js-service-avia-loyalty-program--number");""!==n.val()&&(""===s.val()?(r=!0,KT.notify("saveServiceFailedIncorrectLoyality"),n.addClass("error").one("focus",function(){n.removeClass("error")})):(t[i].loyalityProviderId=s.val(),t[i].loyalityCardNumber=n.val()))}}),!r&&t},i.prototype.prepareServiceTermsDocuments=function(e){for(var t in e)this.mds.servicesTermsDocuments[t]=$.featherlight(Mustache.render(KT.tpl.lightbox,{classes:"js-service-form--staticdoc",attributes:'data-doc="doc"'}),{persist:!0,closeIcon:"",openSpeed:0,closeSpeed:0}),this.mds.servicesTermsDocuments[t].close(),this.mds.servicesTermsDocuments[t].openSpeed=250,this.mds.servicesTermsDocuments[t].closeSpeed=250},i.prototype.getServiceTermsDocuments=function(e){var t=this;for(var r in e)e[r].load(function(e,r){return t.mds.servicesTermsDocuments[e].$content.html(r),t.mds.servicesTermsDocuments[e].$content},function(e,r){$.ajax({type:"POST",data:JSON.stringify({document:e}),contentType:"application/json; charset=utf-8",url:t.config.staticDocumentUrl,success:function(t){var i;try{0===(i=JSON.parse(t)).status?r(e,i.document):r("Document not found")}catch(e){console.error("Не получилось загрузить статические документы =("),r("Document not found")}}})})},i.prototype.updateFareRules=function(e,t){var r=this.serviceViewModels[e],i=r.ServiceStorage.fareRuleDocumentName;void 0===t?r.prepareEmptyFareRulesView():r.prepareFareRulesView(),this.mds.servicesTermsDocuments[i].$content.html(r.fareRulesView)},i.prototype.updateAdditionalServices=function(e){var t=this.serviceViewModels[e],r=this.serviceForms[e];t.prepareAdditionalServicesView(),r.find(".js-service-form--add-services").html(t.additionalServicesView),t.initAddServicesControls(r)},i.prototype.getCustomFieldsValues=function(e){return this.serviceViewModels[e].getCustomFieldsValues()},i.prototype.setManualEditForms=function(){var e=this;return{elem:{$root:$("body")},forms:{},prepare:function(e){if("op"===KT.profile.userType){var t=e.ServiceStorage,r=t.serviceId;9===t.status?(void 0===this.forms[r]?(this.forms[r]=$.featherlight(Mustache.render(KT.tpl.lightbox,{}),{persist:!0,variant:"featherlight--fix-scroll",closeIcon:"",openSpeed:0,closeSpeed:0}),this.forms[r].close(),this.forms[r].openSpeed=250,this.forms[r].closeSpeed=250):(this.forms[r].$content.html(Mustache.render(KT.tpl.spinner,{})),this.forms[r].$content.off()),this.forms[r].manualFormRendered=!1):void 0!==this.forms[r]&&delete this.forms[r]}},open:function(t){if("op"===KT.profile.userType){var r=e.serviceViewModels[t],i=this.forms[t];if(void 0===i)return console.warn("для услуги "+t+" не создана форма работы в ручном режиме!"),void KT.notify("noManualEditForm");if(i.open(),!i.manualFormRendered){i.$content.html(r.renderManualForm(e.mds)),r.initManualFormControls(i.$content,e.mds),i.manualFormRendered=!0;var o=i.$content.find(".js-ore-service-manualedit--tab"),s=0;o.each(function(){$(this).height()>s&&(s=$(this).height())}),o.height(s)}}},getSaveServiceDataParams:function(t){var r=e.serviceViewModels[t].ServiceStorage,i=this.forms[t].$content.find(".js-ore-service-manualedit"),o=i.find(".js-ore-service-manualedit--start-date").val(),s=i.find(".js-ore-service-manualedit--end-date").val(),n=i.find(".js-ore-service-manualedit--agent-commission").val();n=""!==n?parseFloat(n.replace(/\s+/g,"").replace(",",".")):null;var a=i.find(".js-ore-service-manualedit--client-gross-price").val();a=""!==a?parseFloat(a.replace(/\s+/g,"").replace(",",".")):null;var c=i.find(".js-ore-service-manualedit--currency").val(),l=[];return i.find(".js-ore-service-manualedit--client-cancel-penalty").each(function(){var e=+$(this).data("id"),t=$(this).data("currency"),i=$(this).find(".js-ore-service-manualedit--client-cancel-penalty-amount").val(),o=r.clientCancelPenalties[e];l.push({dateFrom:o.dateFrom.format("YYYY-MM-DD HH:mm"),dateTo:o.dateTo.format("YYYY-MM-DD HH:mm"),description:o.description,penalty:{amount:""!==i?parseFloat(i.replace(/\s+/g,"").replace(",",".")):0,currency:t}})}),{serviceId:t,orderServiceData:{dateStart:""!==o?moment(o,"DD.MM.YYYY").format("YYYY-MM-DD"):null,dateFinish:""!==s?moment(s,"DD.MM.YYYY").format("YYYY-MM-DD"):null,agencyProfit:n,cancelPenalties:{client:l},salesTerms:{client:{amountBrutto:a,currency:c}}}}},getSaveServiceStatusParams:function(t){var r=e.mds.OrderStorage.services[t],i=this.forms[t].$content.find(".js-ore-service-manualedit"),o=i.find(".js-ore-service-manualedit--change-status").val(),s=i.find(".js-ore-service-manualedit--set-offline").prop("checked"),n=i.find(".js-ore-service-manualedit--status-comment").val();return{serviceId:t,serviceStatus:""!==o&&+o!==r.status?+o:null,online:!s&&null,comment:n}},getChangeBookDataParams:function(t){var r=this.forms[t].$content.find(".js-ore-service-manualedit");return void 0!==e.serviceViewModels[t].getChangeBookDataParams&&e.serviceViewModels[t].getChangeBookDataParams(r)},getChangeTicketDataParams:function(t){var r=this.forms[t].$content.find(".js-ore-service-manualedit");return void 0!==e.serviceViewModels[t].getChangeTicketDataParams&&e.serviceViewModels[t].getChangeTicketDataParams(r)},getAddTicketParams:function(t){var r=this.forms[t].$content.find(".js-ore-service-manualedit");return void 0!==e.serviceViewModels[t].getAddTicketParams&&e.serviceViewModels[t].getAddTicketParams(r)}}},i.prototype.setHotelInfoPages=function(){var e=this;return{loaded:{},dummyPhoto:"/resources/hotels/dummy.jpg",photoLinkTest:/^(http|[^\/]{2,}\.[^\/.]{2,}\/).*/,categoryMap:{ONE:1,TWO:2,THREE:3,FOUR:4,FIVE:5},serviceGroupMap:{"Продленная регистрация":"prolonged-regtime","В номере":"room-service","Общие":"general","Стойка регистрации":"reception","Дети":"children","НА свежем воздухе":"fresh-air","Бизнес":"business","Развлечения":"entertainment","Питание и напитки":"food-n-drink","Спорт/Здоровье":"sports","Трансфер":"transfer","Парковка":"parking","Сейф":"safe","Персонал говорит":"staff-lang","Интернет":"internet","Домашние животные":"pet"},init:function(e){return!this.loaded.hasOwnProperty(e)&&(this.loaded[e]=$.featherlight(Mustache.render(KT.tpl.lightbox,{}),{persist:!0,closeIcon:"",openSpeed:250,closeSpeed:250}),!0)},render:function(t){var r=this;if(Array.isArray(t.descriptions)){var i={};t.descriptions.forEach(function(e){i[e.descriptionType]=e}),t.descriptions=[];for(var o in i)i[o].description=htmlDecode(i[o].description),"short"!==o?t.descriptions.push(i[o]):t.descriptions.unshift(i[o])}var s={};t.services.forEach(function(e){var t=r.serviceGroupMap[e.serviceGroupCode];void 0!==t&&(void 0===s[t]&&(s[t]={group:e.serviceGroupCode,icon:t,list:[]}),s[t].list.push({name:e.name}))});var n=[];for(var a in s)s.hasOwnProperty(a)&&n.push(s[a]);n.sort(function(e,t){return e.list.length>t.list.length?1:e.list.length<t.list.length?-1:0});var c={name:t.name,icon:t,hotelChain:""===t.hotelChain?null:t.hotelChain,mainImage:void 0!==t.mainImageUrl&&null!==t.mainImageUrl&&this.photoLinkTest.test(String(t.mainImageUrl))?t.mainImageUrl:this.dummyPhoto,category:null!==t.category&&void 0!==this.categoryMap[t.category]&&function(e){for(var t=[],r=0;r<e;r++)t.push(!0);return t}(this.categoryMap[t.category]),city:t.cityName,country:t.countryName,checkIn:null!==t.checkInTime?moment(t.checkInTime,"HH:mm:ss").format("HH:mm"):null,checkOut:null!==t.checkOutTime?moment(t.checkOutTime,"HH:mm:ss").format("HH:mm"):null,address:t.address,distance:t.distance,phone:t.phone,fax:t.fax,email:t.email,siteurl:"op"===KT.profile.userType?t.url:null,photos:t.images,services:n,descriptions:t.descriptions},l=this.loaded[t.hotelId].$content;l.html(Mustache.render(e.mds.tpl.hotelFullInfo,c)).find(".js-hotel-info__gallery").on("click",".js-hotel-info__gallery-item",function(){$(this).parent().children(".active").removeClass("active"),$(this).addClass("active");var e=$(this).data("url");l.find(".js-hotel-info__main-photo").css({"background-image":"url("+e+")"})}).addClass("baron baron__root baron__clipper _simple").wrapInner('<div class="js-hotel-info__gallery-wrap"></div>').wrapInner('<div class="js-hotel-info__gallery-scroller baron__scroller"></div>').append('<div class="js-hotel-info__gallery-track baron__track"><div class="baron__control baron__up">▲</div><div class="baron__free"><div class="js-hotel-info__gallery-bar baron__bar"></div></div><div class="baron__control baron__down">▼</div></div>').baron({root:$(".js-hotel-info__gallery"),scroller:".js-hotel-info__gallery-scroller",bar:".js-hotel-info__gallery-bar",track:".js-hotel-info__gallery-track",scrollingCls:"_scrolling",draggingCls:"_dragging"})},open:function(e){this.loaded[e].open()}}},i.prototype.showPricesChangedModal=function(e,t,r,i){var o={};o.client={oldPrice:t.prices.inClient.client.gross.toMoney(2,","," "),newPrice:Number(e.clientCurrency.client.amountBrutto).toMoney(2,","," "),currency:KT.getCatalogInfo("lcurrency",e.clientCurrency.client.currency,"icon")},"op"===KT.profile.userType&&(o.supplier={oldPrice:t.prices.inSupplier.supplier.gross.toMoney(2,","," "),newPrice:Number(e.supplierCurrency.supplier.amountBrutto).toMoney(2,","," "),currency:KT.getCatalogInfo("lcurrency",e.supplierCurrency.supplier.currency,"icon")});var s=[];"function"!=typeof r?s.push({type:"warning",title:"ok"}):(s.push({type:"warning",title:"принять",callback:r}),"function"==typeof i&&s.push({type:"warning",title:"отклонить",callback:i})),KT.Modal.notify({type:"warning",title:"Изменение данных брони",msg:Mustache.render(this.mds.tpl.pricesChangedModal,o),buttons:s})},i.prototype.showNonrefundableModal=function(e,t){KT.Modal.notify({type:"warning",title:"Невозвратная услуга",msg:'<p style="text-align:center">Услуга, которую Вы собираетесь забронировать, является невозвратной</p>',buttons:[{type:"warning",title:"Продолжить",callback:e},{type:"warning",title:"Отмена",callback:t}]})},i.prototype.setBookChangeModal=function(){var e=this;return{$modal:null,serviceId:null,touristAges:{},showModal:function(t,r,i,o){var s=this,n=e.serviceViewModels[t],a=n.ServiceStorage;s.serviceId=t,s.touristAges=$.extend(!0,{},a.touristAges),n.mapTouristsInfo(e.mds.OrderStorage.getTourists(),!0);var c={serviceId:t,serviceIcon:KT.getCatalogInfo("servicetypes",a.typeCode,"icon"),serviceName:a.name,dateIn:a.startDate.format("DD.MM.YYYY"),dateOut:a.endDate.format("DD.MM.YYYY"),tourists:n.touristsMap},l=[{title:"да",callback:r},{title:"нет",callback:function(e){s.clearData(),i(e)}}];"op"!==KT.profile.userType&&l.push({title:"Передать менеджеру",callback:function(){s.showSendToManagerModal(c,o,i)}}),s.$modal=KT.Modal.notify({type:"info",title:"Изменение данных брони",msg:Mustache.render(e.mds.tpl.bookChangeModal,c),buttons:l}).$content,s.$modal.find(".js-modal-book-change--date-in").clndrize({template:e.mds.tpl.clndr,eventName:"Дата заезда",showDate:moment(),clndr:{constraints:{startDate:moment().format("YYYY-MM-DD"),endDate:moment().add(1,"years").format("YYYY-MM-DD")}}}),s.$modal.find(".js-modal-book-change--date-out").clndrize({template:e.mds.tpl.clndr,eventName:"Дата выезда",showDate:moment(),clndr:{constraints:{startDate:moment().format("YYYY-MM-DD"),endDate:moment().add(1,"years").format("YYYY-MM-DD")}}}),s.$modal.on("change",".js-modal-book-change--tourist-bound",function(){var t=+$(this).attr("data-touristid"),r=e.mds.OrderStorage.tourists[t],i=a.getAgeGroup(a.getAgeByServiceEnding(r.birthdate));$(this).prop("checked")?s.touristAges[i]+1<=a.declaredTouristAges[i]?s.touristAges[i]+=1:($(this).prop("checked",!1).closest(".simpletoggler").removeClass("active"),KT.notify("touristLinkageNotAllowedByAge")):s.touristAges[i]-=1})},showSendToManagerModal:function(t,r,i){var o=this;o.$modal=KT.Modal.notify({type:"info",title:"Передача услуги менеджеру для исправления других параметров",msg:Mustache.render(e.mds.tpl.sendToManagerModal,t),buttons:[{title:"передать менеджеру",callback:r},{title:"отмена",callback:function(e){o.clearData(),i(e)}}]}).$content},getParams:function(){var t=this,r={},i=0;t.$modal.find(".js-modal-book-change--tourist-bound").each(function(){var e=+$(this).attr("data-touristid");r[e]={state:$(this).prop("checked"),loyalityProviderId:null,loyalityCardNumber:null},r[e].state&&i++});var o=e.mds.OrderStorage.createLinkageStructure(t.serviceId,r),s=e.mds.OrderStorage.services[t.serviceId];if(i!==s.declaredTouristAmount)return KT.notify("notAllTouristsLinked"),null;var n=t.$modal.find(".js-modal-book-change--date-in"),a=t.$modal.find(".js-modal-book-change--date-out"),c=n.val(),l=a.val();return c=moment(""===c||null===c?n.data("default"):c,"DD.MM.YYYY").format("YYYY-MM-DD"),l=moment(""===l||null===l?a.data("default"):l,"DD.MM.YYYY").format("YYYY-MM-DD"),{serviceId:t.serviceId,serviceData:{dateStart:c,dateFinish:l,touristData:o}}},getToManagerParams:function(){var e=this,t=e.$modal.find(".js-modal-send-to-manager--comment");return""===t.val()?(t.addClass("error").attr("placeholder","Оставьте комментарий").one("focus",function(){$(this).removeClass("error")}),null):{serviceId:e.serviceId,comment:t.val()}},clearData:function(){this.$modal=null,this.serviceId=null,this.touristAges={}}}},i.prototype.setBookCancelModal=function(){var e=this;return{$modal:null,serviceId:null,showModal:function(t,r,i){var o=this;o.serviceId=t;var s=e.serviceViewModels[t].ServiceStorage,n=s.countClientCancelPenalty(),a={serviceName:s.name,penalty:null!==n&&0!==n.inLocal?{localAmount:Number(n.inLocal).toMoney(0,","," "),localCurrency:KT.getCatalogInfo("lcurrency",KT.profile.localCurrency,"icon"),viewAmout:Number(n.inView).toMoney(0,","," "),viewCurrency:KT.getCatalogInfo("lcurrency",KT.profile.viewCurrency,"icon")}:null,isInvoiceOptional:!1};o.$modal=KT.Modal.notify({type:"info",title:"Отмена бронирования",msg:Mustache.render(e.mds.tpl.bookCancelModal,a),buttons:[{type:"common",title:"да",callback:r},{type:"common",title:"нет",callback:function(){o.clearData(),i()}}]}).$content},getParams:function(){var t=this,r=t.$modal.find(".js-modal-book-cancel--set-invoice"),i=e.mds.OrderStorage.getServiceCommandParams("BookCancel",t.serviceId);return 0!==r.length?i.createPenaltyInvoice=r.prop("checked"):i.createPenaltyInvoice=!0,i},clearData:function(){this.$modal=null,this.serviceId=null,this.touristAges={}}}},i}),function(e,t){KT.crates.OrderEdit.services.controller=t(KT.crates.OrderEdit)}(0,function(e){var t=function(t,r){this.mds=t,this.orderId=r,this.mds.services.view=new e.services.view(this.mds)};return t.prototype.init=function(){var e=this,t=this.mds.services.view,r=function(e){t.renderServices(e).then(function(){var r=window.sessionStorage.getItem("showService");null!==r&&(window.sessionStorage.removeItem("showService"),t.navigateToService(+r)),e.getServices().forEach(function(r){if(2===r.typeCode&&!r.isPartial){var i=r.offerInfo.fareRules;if(!Array.isArray(i)||0===i.length){var o=function(i,s){console.log("load rules"),0!==--s?KT.apiClient.getOrderOffers(e.orderId,[i]).then(function(n){if(0!==n.status)setTimeout(function(){o(r.serviceId,s)},5e3);else{var a=n.body[0].offerInfo.fareRules;Array.isArray(a)&&0!==a.length?(e.services[i].offerInfo.fareRules=a,t.updateFareRules(i,a)):setTimeout(function(){o(r.serviceId,s)},5e3)}}):t.updateFareRules(i)};setTimeout(function(){o(r.serviceId,3)},5e3)}}})})};KT.on("KT.changedViewCurrency",function(){t.$serviceList.html(Mustache.render(KT.tpl.spinner,{}));var i=e.mds.OrderStorage,o=e.mds.OrderStorage.getServiceIds();o.length>0&&KT.apiClient.getOrderOffers(e.orderId,o).then(function(t){if(0!==t.status)return $.Deferred().reject();i.setServices(t.body),"loaded"===i.loadStates.transitionsdata&&r(e.mds.OrderStorage)})}),KT.on("OrderStorage.initialized",function(e,r){0===r.getServices().length&&t.renderEmptyServiceList()}),KT.on("OrderStorage.setAllowedTransitions",function(t,i){"loaded"===i.loadStates.touristdata&&r(e.mds.OrderStorage)}),KT.on("OrderStorage.setTourists",function(e,t){"loaded"===t.loadStates.transitionsdata&&r(t)}),KT.on("OrderStorage.savedServiceLinkage",function(e,r){t.renderServiceTourists(r.serviceId)}),KT.on("OrderStorage.savedTourist",function(r,i){e.mds.OrderStorage.getServiceIds().forEach(function(r){e.mds.OrderStorage.updateServiceTourists(r),t.renderServiceTourists(r)});var o=window.sessionStorage.getItem("serviceToAddTourist");if(null!==o){window.sessionStorage.removeItem("serviceToAddTourist");var s=+i.touristId;o=+o,KT.dispatch("OrderEdit.setActiveTab",{activeTab:"services",callback:function(){t.navigateToService(o)}}),KT.notify("linkingTourists");var n={};n[s]={state:!0,loyalityCardNumber:null,loyalityProviderId:null};var a=e.mds.OrderStorage.createLinkageStructure(o,n);KT.apiClient.setTouristsLinkage(e.orderId,o,a).done(function(r){if(0==+r.status){var i=r.body.result[0];if(void 0===i)KT.notify("linkingTouristFailed",["Турист",o.lastname,o.firstname].join(" ")),e.mds.OrderStorage.updateServiceTourists(r.serviceid),t.renderServiceTourists(r.serviceId);else if(Boolean(i.success))e.mds.OrderStorage.saveServiceLinkage(r.serviceId,r.linkageInfo),KT.notify("touristsLinked");else{var o=e.mds.OrderStorage.tourists[i.touristId];KT.notify("linkingTouristFailed",["Турист",o.lastname,o.firstname,":",i.error].join(" ")),e.mds.OrderStorage.updateServiceTourists(r.serviceid),t.renderServiceTourists(r.serviceId)}}else KT.notify("linkingTouristFailed",r.errors)})}}),KT.on("OrderStorage.touristRemoved",function(){t.renderServices(e.mds.OrderStorage)}),t.$serviceList.on("click",".js-service-form-header",function(){var e=$(this).closest(".js-service-form"),t=e.find(".js-service-form-content");e.hasClass("active")?(e.removeClass("active"),t.css({display:"block"}).slideUp(500)):(e.addClass("active"),t.css({display:"none"}).slideDown(500))}),t.$serviceList.on("change",".js-service-form-tourist--service-bound",function(){var t=+$(this).attr("data-touristid"),r=e.mds.OrderStorage.tourists[t],i=$(this).closest(".js-service-form"),o=+i.attr("data-sid"),s=e.mds.OrderStorage.services[o],n=s.getAgeGroup(s.getAgeByServiceEnding(r.birthdate));$(this).prop("checked")?s.touristAges[n]+1<=s.declaredTouristAges[n]?(s.touristAges[n]+=1,i.data("unsaved",!0)):($(this).prop("checked",!1).closest(".simpletoggler").removeClass("active"),KT.notify("touristLinkageNotAllowedByAge")):(s.touristAges[n]-=1,i.data("unsaved",!0))}),t.$serviceList.on("change",[".js-service-avia-loyalty-program--provider",".js-service-avia-loyalty-program--number"].join(","),function(){$(this).closest(".js-service-form").data("unsaved",!0)}),t.$serviceList.on("click",".js-service-form-actions--book",function(){var r=$(this).closest(".js-service-form"),i=+r.data("sid"),o=function(){!1===r.data("unsaved")?e.saveCustomFields(i).then(function(){return e.bookService(i)}):e.saveServiceLinkage(i).then(function(){return e.saveCustomFields(i)}).then(function(){return e.bookService(i)})};e.mds.OrderStorage.services[i].isNonRefundable?t.showNonrefundableModal(function(){KT.Modal.closeModal(),o()},function(){KT.Modal.closeModal()}):o()}),t.$serviceList.on("change",".js-service-form-tos-agreement input",function(){var t=+$(this).closest(".js-service-form").data("sid");e.mds.OrderStorage.services[t].isTOSAgreementSet=$(this).prop("checked")}),t.$serviceList.on("click",".js-service-form-actions--save",function(){var r=+$(this).closest(".js-service-form").data("sid");t.renderPendingServiceProcess(r),e.saveCustomFields(r).always(function(){t.renderServiceActions(r)})}),t.$serviceList.on("click",".js-service-form-actions--issue",function(){var r=+$(this).closest(".js-service-form").attr("data-sid");t.renderPendingServiceProcess(r),KT.apiClient.issueTickets(e.orderId,r).done(function(e){0===e.status?KT.notify("ticketsIssued"):void 0!==e.errors&&KT.notify("issuingTicketsFailed",e.errors),KT.dispatch("OrderEdit.reloadInfo")})}),t.$serviceList.on("click",".js-service-form-actions--book-change",function(){var r=+$(this).closest(".js-service-form").data("sid");t.BookChangeModal.showModal(r,function(){var i=t.BookChangeModal.getParams();null!==i&&(t.renderPendingServiceProcess(r),KT.Modal.showLoader(),KT.apiClient.bookChange(e.orderId,i).done(function(i){if(0===i.status){KT.notify("bookingChanged");var o=e.mds.OrderStorage.services[r];console.warn("data changed:"),console.log(o.compareSalesTerms(i.body.newSalesTerms)),o.compareSalesTerms(i.body.newSalesTerms)?KT.Modal.closeModal():t.showPricesChangedModal(i.body.newSalesTerms,o)}else switch(KT.Modal.closeModal(),+i.errorCode){case 165:KT.notify("bookingChangeNotSupported");break;case 170:KT.notify("bookingChangeProhibited");break;default:KT.notify("bookingChangeFailed")}KT.dispatch("OrderEdit.reloadInfo")}))},function(){KT.Modal.closeModal()},function(){var i=t.BookChangeModal.getToManagerParams();null!==i&&(t.renderPendingServiceProcess(r),KT.Modal.showLoader(),KT.apiClient.setServiceToManual(e.orderId,i).then(function(e){KT.Modal.closeModal(),0===e.status?KT.notify("serviceSetToManual"):KT.notify("settingServiceToManualFailed"),KT.dispatch("OrderEdit.reloadInfo")},function(e){t.renderServiceActions(r),"denied"!==e.error&&KT.Modal.closeModal()}))})}),t.$serviceList.on("click",".js-service-form-actions--book-cancel",function(){var r=+$(this).closest(".js-service-form").data("sid");t.BookCancelModal.showModal(r,function(){var i=t.BookCancelModal.getParams();null!==i&&(t.renderPendingServiceProcess(r),KT.Modal.showLoader(),KT.apiClient.bookCancel(e.orderId,i).done(function(e){KT.Modal.closeModal(),0===e.status?KT.notify("bookingCancelled"):KT.notify("bookingCancelFailed"),KT.dispatch("OrderEdit.reloadInfo")}))},function(){KT.Modal.closeModal()})}),t.$serviceList.on("click",".js-service-form-actions--set-invoice",function(){KT.dispatch("OrderEdit.openSetInvoiceForm")}),t.$serviceList.on("click",".js-service-form-actions--to-manual",function(){var r=+$(this).closest(".js-service-form").data("sid");t.renderPendingServiceProcess(r),KT.apiClient.setServiceToManual(e.orderId,{serviceId:r}).done(function(e){0===e.status?console.log("Услуга переведена в ручной режим"):console.error("Не удалось перевести услугу в ручной режим"),KT.dispatch("OrderEdit.reloadInfo")})}),t.$serviceList.on("click",".js-service-form--add-tourist",function(){var e=+$(this).closest(".js-service-form").attr("data-sid");window.sessionStorage.setItem("serviceToAddTourist",e),KT.dispatch("OrderEdit.setActiveTab",{activeTab:"tourists"}),KT.dispatch("OrderEdit.createAddTouristForm")}),t.$serviceList.on("click",".js-service-form-add-service--action-add",function(){var r=$(this).closest(".js-service-form-add-service--available-service"),i=r.closest(".js-service-form"),o=e.mds.OrderStorage,s=+i.attr("data-sid"),n=+r.data("add-service-id");r.closest(".js-service-form--add-services").html(Mustache.render(KT.tpl.spinner,{})),KT.apiClient.addExtraService(o.orderId,{serviceId:s,touristIds:o.services[s].getServiceTourists().map(function(e){return e.touristId}),addServiceOfferId:n,viewCurrency:KT.profile.viewCurrency}).then(function(e){0!==e.status?KT.notify("AddingAdditionalServiceFailed",e.errors):o.services[s].addAdditionalService(e.body.addService),t.updateAdditionalServices(s)})}),t.$serviceList.on("click",".js-service-form-add-service--action-remove",function(){var r=$(this).closest(".js-service-form-add-service--issued-service"),i=r.closest(".js-service-form"),o=e.mds.OrderStorage,s=+i.attr("data-sid"),n=+r.data("add-service-id");r.closest(".js-service-form--add-services").html(Mustache.render(KT.tpl.spinner,{})),KT.apiClient.removeExtraService(o.orderId,{serviceId:s,addServiceId:n}).then(function(e){0!==e.status?KT.notify("RemovingAdditionalServiceFailed",e.errors):o.services[s].removeAdditionalService(n),t.updateAdditionalServices(s)})}),t.$serviceList.on("click",".js-service-hotel--hotel-link",function(e){e.stopPropagation();var r=+$(this).data("hotelid");t.HotelInfoPages.init(r)?KT.apiClient.getHotelInfo(r).done(function(e){0!==e.status?console.error(e.errors):t.HotelInfoPages.render(e.body)}):t.HotelInfoPages.open(r)}),t.$serviceList.on("click",".js-service-form-actions--manual-edit",function(){var e=+$(this).closest(".js-service-form").attr("data-sid");t.ManualEditForms.open(e)}),t.$manualFormsRoot.on("click",".js-ore-service-manualedit--save-common-data",function(){var r=e.mds.OrderStorage.orderId,i=+$(this).closest(".js-ore-service-manualedit").data("serviceid"),o=t.ManualEditForms.getSaveServiceDataParams(i);!1!==o?(t.ManualEditForms.forms[i].close(),t.renderPendingServiceProcess(i),KT.Modal.showLoader(),KT.apiClient.setServiceData(r,i,o).done(function(e){KT.Modal.closeModal(),0===e.status?KT.notify("serviceDataChanged"):KT.notify("changingServiceDataFailed",e.errors),KT.dispatch("OrderEdit.reloadInfo")})):console.error("Некорректные параметры для изменения услуги")}),t.$manualFormsRoot.on("click",".js-ore-service-manualedit--save-service-status",function(){var r=e.mds.OrderStorage.orderId,i=+$(this).closest(".js-ore-service-manualedit").data("serviceid"),o=t.ManualEditForms.getSaveServiceStatusParams(i);!1!==o?(t.ManualEditForms.forms[i].close(),t.renderPendingServiceProcess(i),KT.Modal.showLoader(),KT.apiClient.manualSetStatus(r,i,o).done(function(e){KT.Modal.closeModal(),0===e.status?KT.notify("reservationDataChanged"):KT.notify("changingReservationDataFailed"),KT.dispatch("OrderEdit.reloadInfo")})):console.error("Некорректные параметры для изменения статуса")}),t.$manualFormsRoot.on("click",".js-ore-service-manualedit--save-book-info",function(){var r=e.mds.OrderStorage.orderId,i=+$(this).closest(".js-ore-service-manualedit").data("serviceid"),o=t.ManualEditForms.getChangeBookDataParams(i);!1!==o?(t.ManualEditForms.forms[i].close(),t.renderPendingServiceProcess(i),KT.Modal.showLoader(),KT.apiClient.setReservationData(r,i,o).done(function(e){KT.Modal.closeModal(),0===e.status?KT.notify("reservationDataChanged"):KT.notify("changingReservationDataFailed"),KT.dispatch("OrderEdit.reloadInfo")})):console.error("Некорректные параметры для изменения брони")}),t.$manualFormsRoot.on("click",".js-ore-service-manualedit--save-changed-avia-ticket",function(){var r=e.mds.OrderStorage.orderId,i=+$(this).closest(".js-ore-service-manualedit").data("serviceid"),o=t.ManualEditForms.getChangeTicketDataParams(i);!1!==o?(t.ManualEditForms.forms[i].close(),t.renderPendingServiceProcess(i),KT.Modal.showLoader(),KT.apiClient.setTicketsData(r,i,o).done(function(e){KT.Modal.closeModal(),0===e.status?KT.notify("ticketsDataChanged"):KT.notify("changingTicketsDataFailed"),KT.dispatch("OrderEdit.reloadInfo")})):console.error("Некорректные параметры для изменения билета")}),t.$manualFormsRoot.on("click",".js-ore-service-manualedit--save-new-avia-ticket",function(){var r=e.mds.OrderStorage.orderId,i=+$(this).closest(".js-ore-service-manualedit").data("serviceid"),o=t.ManualEditForms.getAddTicketParams(i);!1!==o?(t.ManualEditForms.forms[i].close(),t.renderPendingServiceProcess(i),KT.Modal.showLoader(),KT.apiClient.setTicketsData(r,i,o).done(function(e){KT.Modal.closeModal(),0===e.status?KT.notify("ticketsDataChanged"):KT.notify("changingTicketsDataFailed"),KT.dispatch("OrderEdit.reloadInfo")})):console.error("Некорректные параметры для изменения билета")})},t.prototype.saveServiceLinkage=function(e){var t=this,r=t.mds.services.view,i=$.Deferred();if(!(t.mds.OrderStorage.getTourists().length>0))return KT.notify("saveServiceFailedNoTourists"),i.reject();var o=r.getServiceTouristsData(e);if(!1===o)return i.reject();var s=t.mds.OrderStorage.createLinkageStructure(e,o);return!1===s?i.reject():0===s.length?i.resolve(e):(KT.apiClient.setTouristsLinkage(t.orderId,e,s).done(function(o){if(0==+o.status){var n=[];o.body.result.forEach(function(e){if(!Boolean(e.success)){var r=t.mds.OrderStorage.tourists[e.touristId];n.push(["Турист",r.lastname,r.firstname,":",e.error].join(" "))}}),t.mds.OrderStorage.saveServiceLinkage(e,s),0!==n.length?(KT.notify("linkingTouristFailed",n.join("<br>")),t.mds.OrderStorage.updateServiceTourists(e),r.renderServiceTourists(e),i.reject()):(KT.notify("touristsLinked"),i.resolve(e))}else KT.notify("linkingTouristFailed",o.errors),i.reject()}),i.promise())},t.prototype.saveCustomFields=function(e){var t=this,r=t.mds.services.view.getCustomFieldsValues(e),i=$.Deferred();return null===r?(KT.notify("notAllCustomFieldsSet"),i.reject()):0===r.length?i.resolve(e):KT.apiClient.setServiceAdditionalData(t.orderId,r).done(function(t){0===t.status?(KT.notify("customFieldsSaved"),i.resolve(e)):(KT.notify("savingCustomFieldsFailed",t.errors),i.reject())}),i.promise()},t.prototype.bookService=function(e){var t=this,r=t.mds.services.view,i=r.serviceForms[e],o=t.mds.OrderStorage.getTourists(),s=$.Deferred();if(o.length>0){var n=t.mds.OrderStorage.services[e],a=i.find(".js-service-form-tos-agreement").find('input[type="checkbox"]').prop("checked");if(n.checkAllTouristsLinked())if(a){r.renderPendingServiceProcess(e);var c=t.mds.OrderStorage.getServiceCommandParams("BookStart",e);!1!==c?KT.apiClient.startBooking(t.orderId,c).then(function(i){var o=$.Deferred();if(0===i.status&&void 0!==i.body.newOfferData&&"object"==typeof i.body.newOfferData){KT.notify("pricesChanged");var s=t.mds.OrderStorage.services[e];r.showPricesChangedModal(i.body.newOfferData,s,function(){KT.Modal.closeModal(),KT.apiClient.startBooking(t.orderId,c).done(function(e){o.resolve(e)})},function(){KT.Modal.closeModal(),KT.dispatch("OrderEdit.reloadInfo"),o.reject()})}else o.resolve(i);return o.promise()}).then(function(t){0===t.status?(1===t.body.serviceStatus?KT.notify("bookingStarted"):2===t.body.serviceStatus?KT.notify("bookingFinished"):KT.notify("bookingFailed"),s.resolve(e)):(KT.notify("bookingFailed",t.errors),s.reject(e)),KT.dispatch("OrderEdit.reloadInfo")},function(){s.resolve(e)}):s.reject()}else KT.notify("bookingTermsNotAccepted"),s.reject();else KT.notify("notAllTouristsLinked"),s.reject()}else KT.notify("bookingFailedNoTourists"),s.reject();return s.promise()},t}),function(e,t){KT.crates.OrderEdit.payment.view=t()}(0,function(){var e=function(e,t){this.mds=e,void 0===t&&(t={}),this.config=$.extend(!0,{templateUrl:"/cabinetUI/orders/getTemplates",templates:{serviceList:"orderEdit/payment/serviceList",serviceListRow:"orderEdit/payment/serviceListRow",serviceActions:"orderEdit/payment/serviceActions",serviceNoActions:"orderEdit/payment/serviceNoActions",invoiceListItem:"orderEdit/payment/invoiceListItem",invoiceListItemService:"orderEdit/payment/invoiceListItemService",invoiceListEmpty:"orderEdit/payment/invoiceListEmpty",TOSAgreementModal:"orderEdit/modals/acceptBookingTerms",multiBookCancelModal:"orderEdit/modals/multiBookCancel"}},t),this.$serviceList=$("#order-edit-payment--services"),this.$invoiceList=$("#order-edit-payment--invoices"),this.$invoiceActions=$("#order-edit-payment--invoice-actions"),this.discountSum=0};return e.prototype.renderServiceList=function(e){var t=this,r="",i=0,o=0,s=0,n=0,a="op"===KT.profile.userType;e.forEach(function(e){var c={serviceId:e.serviceId,serviceIcon:KT.getCatalogInfo("servicetypes",e.typeCode,"icon"),serviceTypeName:KT.getCatalogInfo("servicetypes",e.typeCode,"title"),statusIcon:KT.getCatalogInfo("servicestatuses",e.status,"icon"),statusTitle:KT.getCatalogInfo("servicestatuses",e.status,"title"),serviceName:e.name,net:a?e.prices.inLocal.supplier.gross.toMoney(2,","," "):null,gross:e.prices.inLocal.client.gross.toMoney(2,","," "),offline:e.isOffline,travelPolicyViolations:e.hasTPViolations?{list:e.offerInfo.travelPolicy.travelPolicyFailCodes}:null};"op"===KT.profile.userType&&9===e.status&&(c.statusTitle="Ручной режим"),n+=e.discount,i+=e.prices.inLocal.supplier.gross,o+=e.prices.inLocal.client.gross,s+=e.prices.inLocal.client.commission.amount,r+=Mustache.render(t.mds.tpl.serviceListRow,c)});var c=Mustache.render(t.mds.tpl.serviceNoActions,{}),l={serviceList:r,showNetPrice:a,totalNet:a?i.toMoney(2,","," "):null,totalGross:o.toMoney(2,","," "),totalCommission:s.toMoney(2,","," "),serviceActions:c,discount:"agent"===KT.profile.userType?n.toMoney(2,",",""):null,profit:"agent"===KT.profile.userType?(s-n).toMoney(2,","," "):null};if(t.$serviceList.html(Mustache.render(t.mds.tpl.serviceList,l)),null===t.mds.OrderStorage.loadStates.transitionsdata&&t.$serviceList.find(".js-ore-payment-services--check-service").prop("disabled",!0),"agent"===KT.profile.userType){var d=t.$serviceList.find(".js-ore-payment-services--discount");d.jirafize({position:"right",margin:"20px",buttons:{name:"submit",type:"submit",callback:function(){d.prop("disabled",!0),KT.dispatch("PaymentView.setDiscount",{discount:parseFloat(d.val().replace(/ /g,"").replace(",",".")).toFixed(2)})}}})}},e.prototype.renderServiceActions=function(e){this.$serviceList.find(".js-ore-payment-services--check-service").not('[data-offline="true"]').prop("disabled",!1),!1===e?this.$serviceList.find(".js-ore-payment-services--service-actions").html(Mustache.render(this.mds.tpl.serviceNoActions,{})):this.$serviceList.find(".js-ore-payment-services--service-actions").html(Mustache.render(this.mds.tpl.serviceActions,e))},e.prototype.clearServiceActions=function(){this.$serviceList.find(".js-ore-payment-services--check-service").empty()},e.prototype.getSelectedServices=function(){var e=[];return this.$serviceList.find(".js-ore-payment-services--check-service").filter(":checked").each(function(){e.push(+$(this).data("serviceid"))}),e},e.prototype.renderInvoiceList=function(e){var t="",r=this;e.forEach(function(e){var i="",o=KT.getCatalogInfo("lcurrency",e.currency,"icon");"unknown"===o&&(o=e.currency),e.getServiceDetails().forEach(function(e){i+=Mustache.render(r.mds.tpl.invoiceListItemService,{serviceId:e.serviceId,name:e.name,sum:e.sum.toMoney(2,","," "),currencySign:o})});var s={invoiceId:e.invoiceId,statusIcon:KT.getCatalogInfo("invoicestatuses",e.status,"icon"),statusTitle:KT.getCatalogInfo("invoicestatuses",e.status,"title"),number:e.number,creationDate:e.creationDate.format("DD.MM.YY"),description:null!==e.description?e.description:"[Без названия]",sum:e.sum.toMoney(2,","," "),currencySign:o,serviceDetails:i,actions:{cancel:!1}};t+=Mustache.render(r.mds.tpl.invoiceListItem,s)}),""===t&&(t=Mustache.render(r.mds.tpl.invoiceListEmpty,{})),r.$invoiceList.html(t)},e.prototype.flushInvoiceList=function(){this.$invoiceList.html(Mustache.render(KT.tpl.spinner,{}))},e.prototype.flushServiceList=function(){this.$serviceList.html(Mustache.render(KT.tpl.spinner,{}))},e.prototype.showChainBookingModal=function(e,t){var r=this;KT.Modal.notify({type:"info",title:"Бронирование услуг",msg:Mustache.render(this.mds.tpl.TOSAgreementModal,e),buttons:[{type:"common",title:"да",callback:t},{type:"common",title:"нет",callback:function(){KT.Modal.closeModal()}}]}).$container.find("#order-edit-payment--tos-agreement").on("click",".js-modal-accept-book-terms--tos-link",function(){var e=$(this).data("tosdoc");r.mds.servicesTermsDocuments[e].open()})},e.prototype.showChainBookCancelModal=function(e,t){var r={hasPenalty:!1,services:[]};e.forEach(function(e){var t=e.countClientCancelPenalty(),i={serviceId:e.serviceId,name:e.name,penalty:null!==t&&0!==t.inLocal?{localAmount:Number(t.inLocal).toMoney(0,","," "),localCurrency:KT.getCatalogInfo("lcurrency",KT.profile.localCurrency,"icon"),viewAmout:Number(t.inView).toMoney(0,","," "),viewCurrency:KT.getCatalogInfo("lcurrency",KT.profile.viewCurrency,"icon")}:null,isInvoiceOptional:!1};r.services.push(i),null!==i.penalty&&(r.hasPenalty=!0)}),KT.Modal.notify({type:"info",title:"Отмена бронирования",msg:Mustache.render(this.mds.tpl.multiBookCancelModal,r),buttons:[{type:"common",title:"да",callback:t},{type:"common",title:"нет",callback:function(){KT.Modal.closeModal()}}]})},e.prototype.showChainIssueModal=function(e){KT.Modal.notify({type:"info",title:"Выписка ваучеров",msg:"<p>Выписать ваучеры для всех выбранных услуг?</p>",buttons:[{type:"common",title:"да",callback:e},{type:"common",title:"нет",callback:function(){KT.Modal.closeModal()}}]})},e.prototype.showChainSetToManualModal=function(e){KT.Modal.notify({type:"info",title:"Перевод в ручной режим",msg:"<p>Перевести выбранные услуги в ручной режим?</p>",buttons:[{type:"common",title:"да",callback:e},{type:"common",title:"нет",callback:function(){KT.Modal.closeModal()}}]})},e.prototype.showCancelInvoiceModal=function(e,t){KT.Modal.notify({type:"info",title:"Отмена счета",msg:"Вы действительно хотите отменить счет № "+e.number,buttons:[{type:"common",title:"да",callback:t},{type:"common",title:"нет",callback:function(){KT.Modal.closeModal()}}]})},e}),function(e,t){KT.crates.OrderEdit.payment.controller=t(KT.crates.OrderEdit.payment)}(0,function(e){var t=function(t,r){this.mds=t,this.orderId=r,this.mds.payment.view=new e.view(this.mds)};return t.prototype.init=function(){var e=this,t=this.mds.payment.view;KT.on("OrderStorage.initialized",function(e,r){0===r.getServices().length&&t.renderServiceList([])}),KT.on("OrderStorage.setServices",function(e,r){t.renderServiceList(r.getServices())}),KT.on("OrderStorage.setInvoices",function(e,r){t.renderInvoiceList(r.getInvoices())}),KT.on("OrderStorage.setAllowedTransitions",function(){t.renderServiceActions(!1)}),KT.on("OrderStorage.setValidatedActions",function(e,r){console.warn("service validations:"),console.log(r.validatedActions);var i=$.extend(!0,{},r.validatedActions);"op"!==KT.profile.userType&&i.Manual&&(i.ToManager=i.Manual,delete i.Manual),t.renderServiceActions(i)}),KT.on("PaymentView.setDiscount",function(r,i){KT.apiClient.setDiscount(e.orderId,i.discount).done(function(e){0===e.status?(KT.notify("discountSet",{discount:e.discount}),t.flushSetInvoiceForm(),t.flushServiceList()):($(t.$serviceList).find('input[name="discount"]').prop("disabled",!1).val(t.discountSum),KT.notify("settingDicountFailed",e.errors))})}),t.$invoiceList.on("click",".js-ore-invoice--header",function(){var e=$(this).closest(".js-ore-invoice");e.hasClass("active")?e.removeClass("active"):e.addClass("active"),e.find(".js-ore-invoice--description").toggle(500)}),t.$serviceList.on("change",".js-ore-payment-services--check-service",function(){t.clearServiceActions(),e.mds.OrderStorage.validatedActions={};var r=t.getSelectedServices();if(t.$serviceList.find(".js-ore-payment-services--check-service").prop("disabled",!0),0===r.length)t.renderServiceActions(!1);else{var i=[];r.forEach(function(t){i.push($.extend(!0,[],e.mds.OrderStorage.services[t].allowedTransitions))});var o={},s=0;if((1===i.length?i[0]:i.shift().filter(function(e){return i.every(function(t){return-1!==t.indexOf(e)})})).forEach(function(t){o[t]=[];var i=!1;r.forEach(function(r){var s=e.mds.OrderStorage.getServiceCommandParams(t,r);!1===s?i=!0:("BookStart"===t&&(s.agreementSet=!0),o[t].push(s))}),i?delete o[t]:s++}),0===s)t.renderServiceActions(!1);else{e.mds.OrderStorage.pendingValidations=s;for(var n in o)o.hasOwnProperty(n)&&KT.apiClient.validateAction(e.orderId,n,o[n]).done(function(t){0===t.status?e.mds.OrderStorage.setValidatedAction(t.action,t.body):e.mds.OrderStorage.setValidatedAction(t.action,!1)})}}}),t.$serviceList.on("click",".js-ore-payment-services--book",function(){var r=t.getSelectedServices(),i={services:[],hasNonRefundableServices:!1};r.forEach(function(t){var r=e.mds.OrderStorage.services[t];r.isNonRefundable&&(i.hasNonRefundableServices=!0),i.services.push({icon:KT.getCatalogInfo("servicetypes",r.typeCode,"icon"),type:KT.getCatalogInfo("servicetypes",r.typeCode,"title"),name:r.name,tosdoc:r.tosDocumentName})});t.showChainBookingModal(i,function(){KT.Modal.showLoader();var t=[];r.forEach(function(r){var i=e.mds.OrderStorage.getServiceCommandParams("BookStart",r);i.agreementSet=!0,t.push(KT.apiClient.startBooking(e.orderId,i))}),$.when.apply($,t).always(function(){KT.Modal.closeModal(),KT.dispatch("OrderEdit.reloadInfo")})})}),t.$serviceList.on("click",".js-ore-payment-services--book-cancel",function(){var r=t.getSelectedServices(),i=[];r.forEach(function(t){i.push(e.mds.OrderStorage.services[t])});t.showChainBookCancelModal(i,function(t){var i=t.find(".js-modal-book-cancel--set-invoice");KT.Modal.showLoader();var o=[];r.forEach(function(t){var r=e.mds.OrderStorage.getServiceCommandParams("BookCancel",t),s=i.filter('[data-serviceid="'+t+'"]');0!==s.length?r.createPenaltyInvoice=s.prop("checked"):r.createPenaltyInvoice=!0,o.push(KT.apiClient.bookCancel(e.orderId,r))}),$.when.apply($,o).always(function(){KT.Modal.closeModal(),KT.dispatch("OrderEdit.reloadInfo")})})}),t.$serviceList.on("click",".js-ore-payment-services--set-invoice",function(){KT.dispatch("OrderEdit.openSetInvoiceForm")}),t.$serviceList.on("click",".js-ore-payment-services--cancel",function(){var e=t.getSelectedServices();KT.Modal.notify({type:"info",title:"Аннулирование услуг",msg:"<p>Вы действительно хотите аннулировать выбранные услуги: "+e.join(",")+" ?</p>",buttons:[{title:"Да"},{title:"Нет"}]})}),t.$serviceList.on("click",".js-ore-payment-services--issue",function(){var r=t.getSelectedServices(),i=[];r.forEach(function(t){i.push(e.mds.OrderStorage.services[t])});t.showChainIssueModal(function(){KT.Modal.showLoader();var t=[];r.forEach(function(r){var i=e.mds.OrderStorage.getServiceCommandParams("IssueTickets",r);t.push(KT.apiClient.issueTickets(e.orderId,i))}),$.when.apply($,t).always(function(){KT.Modal.closeModal(),KT.dispatch("OrderEdit.reloadInfo")})})}),t.$serviceList.on("click",".js-ore-payment-services--to-manual",function(){var r=t.getSelectedServices(),i=[];r.forEach(function(t){i.push(e.mds.OrderStorage.services[t])});t.showChainSetToManualModal(function(){KT.Modal.showLoader();var t=[];r.forEach(function(r){var i=e.mds.OrderStorage.getServiceCommandParams("Manual",r);t.push(KT.apiClient.setServiceToManual(e.orderId,i))}),$.when.apply($,t).always(function(){KT.Modal.closeModal(),KT.dispatch("OrderEdit.reloadInfo")})})}),t.$serviceList.on("click",".js-ore-payment-services--tos",function(){var t=+$(this).data("serviceid"),r=e.mds.OrderStorage.services[t];!1!==r.cancellationDocumentName&&(void 0!==e.mds.servicesTermsDocuments[r.cancellationDocumentName]?e.mds.servicesTermsDocuments[r.cancellationDocumentName].open():KT.notify("waitTOSLoading"))}),t.$invoiceList.on("click",".js-ore-invoice-actions--cancel",function(){var r=+$(this).closest(".js-ore-invoice").data("invoiceid"),i=e.mds.OrderStorage.invoices[r];t.showCancelInvoiceModal(i,function(){KT.Modal.showLoader(),KT.apiClient.cancelInvoice(r).then(function(r){if(0===r.status){t.flushInvoiceList();var i=KT.apiClient.getOrderOffers(e.orderId,e.mds.OrderStorage.getServiceIds()),o=KT.apiClient.getOrderInvoices(e.orderId);i.done(function(t){0!==t.status?console.error("offer load error: "+t.error):e.mds.OrderStorage.setServices(t.body)}),o.done(function(t){var r=void 0!==t.body.Invoices&&Array.isArray(t.body.Invoices)?t.body.Invoices:[];e.mds.OrderStorage.setInvoices(r)}),$.when.apply($,[i,o]).always(function(){KT.Modal.closeModal()})}})})})},t}),function(e,t){KT.crates.OrderEdit.view=t()}(0,function(){var e=function(e,t,r){this.mds=e,void 0===r&&(r={}),this.config=$.extend(!0,{templateUrl:"/cabinetUI/orders/getTemplates",templates:{headerOrderInfo:"orderEdit/headerInfo",headerSpinner:"orderEdit/headerSpinner",invoices:"orderEdit/invoices",invoicesRow:"orderEdit/invoicesRow",documents:"orderEdit/documents",documentsRow:"orderEdit/documentsRow",documentsEmpty:"orderEdit/documentsEmpty",history:"orderEdit/history",historyRow:"orderEdit/historyRow"}},r),this.mds.tpl={},this.orderId=t,this.$headerInfo=$("#order-edit-header__info"),this.$headerControls=$("#order-edit-header__controls"),this.$breadcrumb=$("#order-edit-header__ordernum"),this.$btnInvoices=this.$headerControls.find(".js-ore-show-invoices"),this.$btnDocuments=this.$headerControls.find(".js-ore-show-documents"),this.SetInvoiceForm={},this.SetInvoiceForm.controls={},this.SetInvoiceForm.$wrapper=$(".js-ore-set-invoice"),this.SetInvoiceForm.wnd=$.featherlight(this.SetInvoiceForm.$wrapper,{persist:!0,closeIcon:"",openSpeed:0,closeSpeed:0}),this.SetInvoiceForm.wnd.close(),this.SetInvoiceForm.wnd.openSpeed=200,this.SetInvoiceForm.wnd.closeSpeed=200,this.SetInvoiceForm.$content=this.SetInvoiceForm.wnd.$content.find(".js-ore-set-invoice--content"),this.documents={},this.documents.$wrapper=$(".js-ore-documents"),this.documents.$content=this.documents.$wrapper.find(".js-ore-documents--content"),this.$history=$(".js-ore-history"),this.History=this.setHistory(this.$history,this.$headerControls,".js-ore-show-history"),this.$addServiceBlock=$(".order-footer .add-service-block"),this.$breadcrumb.html("new"===this.orderId?"Новая заявка":"Заявка "+this.orderId),this.initTabs(),this.History.init(),this.$btnDocuments.featherlight(this.documents.$wrapper,{persist:"shared",closeIcon:""})};return e.prototype.enableTab=function(e){$("#tab-headers").find(".js-tab-header").filter('[data-tab="'+e+'"]').prop("disabled",!1)},e.prototype.disableTab=function(e){$("#tab-headers").find(".js-tab-header").filter('[data-tab="'+e+'"]').prop("disabled",!0)},e.prototype.setActiveTab=function(e){$("#tab-headers").find(".js-tab-header").removeClass("active").filter('[data-tab="'+e+'"]').addClass("active").prop("disabled",!1).end(),$(".js-content-tab").removeClass("active").filter('[data-tab="'+e+'"]').addClass("active").end(),$("#main-scroller").scrollTop(0)},e.prototype.initTabs=function(){var e=this;$("#tab-headers").on("click",".js-tab-header",function(t){t.preventDefault();var r=$(this).attr("data-tab");e.setActiveTab(r)})},e.prototype.renderHeaderInfo=function(e){var t=0,r=0,i="",o=!1,s=!1,n=null,a=null,c=null,l=null;"new"!==this.orderId&&"op"===KT.profile.userType&&(this.$breadcrumb.html("Заявка "+e.orderId+(null!==e.creationDate?" (от "+e.creationDate.format("DD.MM.YYYY")+")":"")),null===e.orderIdGp&&null===e.orderIdUtk||(s={gp:e.orderIdGp,utk:e.orderIdUtk})),null===e.tourleader?i="Ф.И.О. туриста":(o=!0,i=e.tourleader.lastname+(null!==e.tourleader.firstname?" "+e.tourleader.firstname:"")),n=null===e.kmpManager?null:e.kmpManager.lastname+" "+(null!==e.kmpManager.firstname?e.kmpManager.firstname.substr(0,1)+". ":"")+(null!==e.kmpManager.middlename?e.kmpManager.middlename.substr(0,1)+".":""),a=null===e.clientManager?null:e.clientManager.lastname+" "+(null!==e.clientManager.firstname?e.clientManager.firstname.substr(0,1)+". ":"")+(null!==e.clientManager.middlename?e.clientManager.middlename.substr(0,1)+".":""),l=null===e.creator?null:e.creator.lastname+" "+(null!==e.creator.firstname?e.creator.firstname.substr(0,1)+". ":"")+(null!==e.creator.middlename?e.creator.middlename.substr(0,1)+".":""),c="op"!==KT.profile.userType?null:('"'+e.client.name+'"').replace('""','"'),e.getServices().forEach(function(e){switch(KT.profile.prices){case"gross":t+=e.prices.inLocal.client.gross,r+=e.prices.inView.client.gross;break;case"net":switch(KT.profile.userType){case"op":t+=e.prices.inLocal.supplier.gross,r+=e.prices.inView.supplier.gross;break;case"agent":t+=e.prices.inLocal.client.gross-e.prices.inLocal.client.commission.amount,r+=e.prices.inView.client.gross-e.prices.inView.client.commission.amount;break;default:t+=e.prices.inLocal.client.gross,r+=e.prices.inView.client.gross}}});var d={vip:e.isVip,orderStatusIcon:KT.getCatalogInfo("orderstatuses",e.status,"icon"),orderStatusTitle:KT.getCatalogInfo("orderstatuses",e.status,"title"),orderId:"new"!==e.orderId?e.orderId:null,creationDate:null===e.creationDate?"не указана":e.creationDate.format("YYYY-MM-DD HH:mm:ss"),gatewayOrderIds:s,kmpManager:n,clientCompany:c,clientManager:a,creator:l,touristSet:o,touristName:htmlDecode(i),touristCount:e.touristsAmount>1?"+ "+(e.touristsAmount-1):"",touristTel:o?e.tourleader.phone:null,touristEmail:o?e.tourleader.email:null,localSum:t.toMoney(0,","," "),requestedSum:r.toMoney(2,","," "),requestedCurrency:KT.getCatalogInfo("lcurrency",KT.profile.viewCurrency,"icon")};"op"===KT.profile.userType&&1===e.status&&(d.orderStatusTitle="Ручной режим"),this.$headerInfo.html(Mustache.render(this.mds.tpl.headerOrderInfo,d))},e.prototype.setHistory=function(e,t,r){var i=this;return{elem:{$container:e,$bindcontainer:t,$history:e.find(".js-ore-history--content")},toggler:r,wnd:null,init:function(){var e=this;e.wnd=$.featherlight(this.elem.$container,{persist:"shared",closeIcon:"",openSpeed:0,closeSpeed:0}),e.wnd.close(),e.wnd.openSpeed=250,e.wnd.closeSpeed=250,e.elem.$bindcontainer.on("click",e.toggler+":not(:disabled)",function(){e.wnd.open()}),e.elem.$container.on("click",'button[data-action="cancel"]',function(){e.wnd.close()})},render:function(e){if(Array.isArray(e)){var t={history:""};e.forEach(function(e){e.eventTime=moment(e.eventTime,"YYYY-MM-DD HH:mm:ss").format("D MMMM YYYY, HH:mm"),e.serviceStatusTitle=KT.getCatalogInfo("servicestatuses",e.serviceStatus,"title"),e.serviceStatusIcon=KT.getCatalogInfo("servicestatuses",e.serviceStatus,"icon"),e.orderStatusTitle=KT.getCatalogInfo("orderstatuses",e.orderStatus,"title"),e.orderStatusIcon=KT.getCatalogInfo("orderstatuses",e.orderStatus,"icon"),e.success=0==+e.result,t.history+=Mustache.render(i.mds.tpl.historyRow,e)}),this.elem.$history.html(Mustache.render(i.mds.tpl.history,t)),this.elem.$bindcontainer.find(this.toggler).prop("disabled",!1)}}}},e.prototype.renderSetInvoiceForm=function(e){var t=this,r="",i="";t.$btnInvoices.prop("disabled",!1),e.forEach(function(e){"unknown"===(i=KT.getCatalogInfo("lcurrency",e.paymentCurrency,"icon"))&&(i=e.paymentCurrency);var o={serviceId:e.serviceId,statusIcon:KT.getCatalogInfo("servicestatuses",e.status,"icon"),statusTitle:KT.getCatalogInfo("servicestatuses",e.status,"title"),serviceName:e.name,price:e.prices.inClient.client.gross.toMoney(2,","," "),disabled:!e.isActionAvailable.setInvoice,leftToPay:e.isActionAvailable.setInvoice?Number(e.unpaidSum).toMoney(2,","," "):0,currencyIcon:i};"op"===KT.profile.userType&&9===e.status&&(o.statusTitle="Ручной режим"),r+=Mustache.render(t.mds.tpl.invoicesRow,o)});var o={services:r,currencyCode:i};t.SetInvoiceForm.$content.html(Mustache.render(t.mds.tpl.invoices,o)),t.SetInvoiceForm.controls.selectPayment=$("#SetInv-SelectPayment").selectize({openOnFocus:!0,create:!1,createOnBlur:!0})},e.prototype.renderDocumentsForm=function(e){var t=this,r="";t.$btnDocuments.prop("disabled",!1),Array.isArray(e)&&e.length>0?e.forEach(function(e){""===e.fileName&&(e.fileName="Документ"),r+=Mustache.render(t.mds.tpl.documentsRow,e)}):r=Mustache.render(t.mds.tpl.documentsEmpty,{}),t.documents.$content.html(Mustache.render(t.mds.tpl.documents,{documents:r}))},e.prototype.showDocUploadProgress=function(e){var t=this.documents.$content.find(".js-ore-documents--upload-progress-text"),r=this.documents.$content.find(".js-ore-documents--upload-progress-bar");100!=+e?(t.text(e+" %"),r.css({width:e+"%"})):(t.text("обработка документа..."),r.removeClass("active").css({width:"100%"}))},e.prototype.flushDocumentsForm=function(){this.documents.$content.html(Mustache.render(KT.tpl.spinner,{}))},e.prototype.checkInvoiceFormInput=function(e,t){var r=this.SetInvoiceForm.$content.find(".js-ore-set-invoice--service-sum"),i=e.find(".js-ore-set-invoice--service-sum"),o=e.find(".js-ore-set-invoice--service-check");i.prop("disabled",!0);var s=parseFloat(i.val().replace(/\s+/g,"").replace(",","."));o.on("change.onhold",function(e){e.stopPropagation()}),isNaN(s)?(console.log("NaN entered"),i.val(""),o.prop("checked",!1)):(s<0&&(s=0),s>t&&(s=t),0!==s?(i.val(s.toMoney(2,","," ")),o.prop("checked",!0)):(i.val(""),o.prop("checked",!1))),o.off("change.onhold");var n=0;r.each(function(){var e=parseFloat($(this).val().replace(/\s+/g,"").replace(",","."));n+=isNaN(e)?0:e}),this.SetInvoiceForm.$content.find(".js-ore-set-invoice--total-invoice").text(n.toMoney(2,","," ")),i.prop("disabled",!1)},e.prototype.markServiceForInvoice=function(e,t){var r=this.SetInvoiceForm.$content.find(".js-ore-set-invoice--service-sum"),i=e.find(".js-ore-set-invoice--service-sum");i.prop("disabled",!0),0!==t?i.val(t.toMoney(2,","," ")):i.val("");var o=0;r.each(function(){var e=parseFloat($(this).val().replace(/\s+/g,"").replace(",","."));o+=isNaN(e)?0:e}),this.SetInvoiceForm.$content.find(".js-ore-set-invoice--total-invoice").text(o.toMoney(2,","," ")),i.prop("disabled",!1)},e.prototype.getInvoiceFormData=function(){var e=[],t=!1;return this.SetInvoiceForm.$content.find(".js-ore-set-invoice--service-check:checked").each(function(){var r=$(this).closest(".js-ore-set-invoice--service"),i=Number(r.find(".js-ore-set-invoice--service-sum").val().replace(/\s+/g,"").replace(",","."));0===i?t=!0:i>0&&(i=i.toFixed(2),e.push({id:+r.attr("data-serviceid"),sum:i}))}),(0!==e.length||!t)&&e},e.prototype.flushSetInvoiceForm=function(){this.SetInvoiceForm.$content.html(Mustache.render(KT.tpl.spinner,{}))},e.prototype.flushTopInfo=function(){this.$headerInfo.html(Mustache.render(this.mds.tpl.headerSpinner))},e}),function(e,t){KT.crates.OrderEdit.controller=t(KT.crates.OrderEdit)}(0,function(e){var t=function(t){this.mds=t,window.sessionStorage.removeItem("inOrderInfo");try{this.orderId=window.location.pathname.match(/[^/]+$/)[0],"new"!==this.orderId&&(this.orderId=+this.orderId,(isNaN(this.orderId)||this.orderId<=0)&&(this.orderId=null))}catch(e){this.orderId=null}this.mds.view=new e.view(this.mds,this.orderId),this.mds.OrderStorage=new KT.storage.OrderStorage(this.orderId),"new"===this.orderId?(this.mds.view.setActiveTab("tourists"),this.mds.tourists.controller=new e.tourists.controller(this.mds,this.orderId),this.mds.view.$addServiceBlock.find(".iconed-link[data-srv]").addClass("disabled")):null!==this.orderId&&(this.mds.view.enableTab("tourists"),this.mds.view.enableTab("payment"),this.mds.view.setActiveTab("services"),this.mds.payment.controller=new e.payment.controller(this.mds,this.orderId),this.mds.tourists.controller=new e.tourists.controller(this.mds,this.orderId),this.mds.services.controller=new e.services.controller(this.mds,this.orderId))};return t.prototype.init=function(){var e=this,t=e.mds.view;KT.on("KT.changedViewCurrency",function(){"new"!==e.orderId&&(t.flushTopInfo(),KT.apiClient.getOrderInfo(e.orderId).done(function(t){0!==t.status?window.location.assign("/cabinetUI/orders/order/"+e.orderId):e.mds.OrderStorage.initialize(t.body)}))}),KT.on("KT.changedViewPrice",function(){"new"!==e.orderId&&(t.flushTopInfo(),KT.apiClient.getOrderInfo(e.orderId).done(function(t){0!==t.status?window.location.assign("/cabinetUI/orders/order/"+e.orderId):e.mds.OrderStorage.initialize(t.body)}))}),KT.on("OrderEdit.setActiveTab",function(e,r){void 0!==r.activeTab&&(t.setActiveTab(r.activeTab),"function"==typeof r.callback&&r.callback())}),KT.on("OrderEdit.reloadInfo",function(){t.flushTopInfo(),e.mds.OrderStorage.loadStates.servicedata="pending",e.mds.OrderStorage.loadStates.transitionsdata="pending",console.warn("reload catched"),KT.apiClient.getOrderInfo(e.orderId).then(function(t){if(0===t.status){e.mds.OrderStorage.initialize(t.body);var r=e.mds.OrderStorage.getServiceIds();return KT.apiClient.getOrderOffers(e.orderId,r)}return $.Deferred().reject()}).then(function(t){return 0===t.status?(e.mds.OrderStorage.setServices(t.body),KT.apiClient.getAllowedTransitions(e.orderId)):$.Deferred().reject()}).then(function(t){console.warn("got transitions data"),0===t.status?Array.isArray(t.body.services)?e.mds.OrderStorage.setAllowedTransitions(t.body.services):e.mds.OrderStorage.setAllowedTransitions([]):console.error("не удалось получить доступные действия")}),KT.apiClient.getOrderHistory(e.orderId).done(function(t){0!==t.status?8===t.errorCode?console.log("Для данной заявки нет истории"):KT.notify("loadingHistoryFailed",t.errorCode+": "+t.errors):e.mds.OrderStorage.setHistory(t.body)})}),KT.on("OrderEdit.reloadHeader",function(){t.flushTopInfo(),t.renderHeaderInfo(e.mds.OrderStorage)}),KT.on("OrderEdit.openSetInvoiceForm",function(){t.SetInvoiceForm.wnd.open()}),KT.on("OrderStorage.initialized",function(e,r){t.renderHeaderInfo(r)}),KT.on("OrderStorage.setDocuments",function(e,r){t.renderDocumentsForm(r.items)}),KT.on("OrderStorage.setHistory",function(e,r){t.History.render(r.records)}),KT.on("OrderStorage.setServices",function(e,r){t.renderSetInvoiceForm(r.getServices())}),KT.on("ApiClient.cancelledInvoice",function(r,i){KT.Modal.closeModal(),0==+i.status?(t.flushSetInvoiceForm(),KT.notify("invoiceCancelled"),KT.apiClient.getOrderOffers(e.orderId,e.mds.OrderStorage.getServiceIds()),KT.apiClient.getOrderInvoices(e.orderId)):KT.notify("cancellingInvoiceFailed",i.errors)}),KT.on("ApiClient.documentUploadProgress",function(e,r){t.showDocUploadProgress(parseInt(r.percent))}),KT.on("ApiClient.uploadedDocument",function(r,i){void 0!==i.error?KT.notify("uploadDocumentFailed"):0!==i.status?2===i.status&&2===i.errorCode?KT.notify("uploadDocumentNotAllowedByFilesize"):KT.notify("uploadDocumentFailed",i.errors):(KT.notify("documentUploaded"),t.flushDocumentsForm(),KT.apiClient.getOrderDocuments(e.orderId))}),$("body").on("change",".simpletoggler input",function(){$(this).prop("checked")?$(this).closest(".simpletoggler").addClass("active"):$(this).closest(".simpletoggler").removeClass("active")}),t.$btnInvoices.on("click",function(){KT.dispatch("OrderEdit.openSetInvoiceForm")}),t.SetInvoiceForm.$content.on("change",".js-ore-set-invoice--service-sum",function(){var r=$(this).closest(".js-ore-set-invoice--service"),i=+r.attr("data-serviceid"),o=e.mds.OrderStorage.services[i];t.checkInvoiceFormInput(r,o.unpaidSum)}),t.SetInvoiceForm.$content.on("change",".js-ore-set-invoice--service-check",function(){var r=$(this).closest(".js-ore-set-invoice--service"),i=+r.attr("data-serviceid"),o=e.mds.OrderStorage.services[i];$(this).prop("checked")?t.markServiceForInvoice(r,o.unpaidSum):t.markServiceForInvoice(r,0)}),t.SetInvoiceForm.$content.on("click",".js-ore-set-invoice--action-set",function(){var r=t.getInvoiceFormData();!1===r?KT.Modal.notify({high:!0,type:"info",title:"Выставление счета",msg:"<p>Нельзя выставить нулевой счет</p>",buttons:{title:"ok"}}):0===r.length?KT.Modal.notify({high:!0,type:"info",title:"Выставление счета",msg:"Вы не выбрали ни одной услуги для выставления счета!",buttons:{title:"ok"}}):(KT.Modal.showLoader(),KT.apiClient.setInvoice(e.mds.OrderStorage,r).done(function(r){0===r.status?(t.flushSetInvoiceForm(),KT.apiClient.getOrderOffers(e.orderId,e.mds.OrderStorage.getServiceIds()).done(function(t){0!==t.status?console.error("offer load error: "+t.error):e.mds.OrderStorage.setServices(t.body)}),KT.apiClient.getOrderInvoices(e.orderId).done(function(t){var r=void 0!==t.body.Invoices&&Array.isArray(t.body.Invoices)?t.body.Invoices:[];e.mds.OrderStorage.setInvoices(r)}),KT.Modal.notify({high:!0,type:"success",title:"Выставление счета",msg:"Счет успешно выставлен!",buttons:{type:"success",title:"ok"}})):KT.Modal.notify({high:!0,type:"error",title:"Выставление счета",msg:"Не удалось выставить счет<br>Код ошибки: "+r.errors,buttons:{type:"error",title:"ok"}})}).fail(function(e){"denied"!==e.error&&KT.Modal.closeModal()}))}),t.SetInvoiceForm.$content.on("click",".js-ore-set-invoice--action-cancel",function(){t.SetInvoiceForm.wnd.close()}),t.documents.$content.on("change",".js-ore-documents--upload-field",function(){var e,r=t.documents.$content.find(".js-ore-documents--upload-label");$(this)[0].files.length>0&&(e=$(this)[0].files[0].name),void 0!==e?r.text(e):r.text("Добавить документ")}),t.documents.$content.on("click",".js-ore-documents--upload-decline",function(){var e=t.documents.$content.find(".js-ore-documents--upload");e[0].reset(),e.find(".js-ore-documents--upload-field").change().end().find(".js-ore-documents--upload-control").show().end().find(".js-ore-documents--upload-progress").hide().find("js-ore-documents--upload-progress-text").text("0 %").end().find(".js-ore-documents--upload-progress-bar").css({width:"0%"}).removeClass("active").end()}),t.documents.$content.on("submit",".js-ore-documents--upload",function(e){e.preventDefault()}),t.documents.$content.on("click",".js-ore-documents--upload-confirm",function(){var r=t.documents.$content.find(".js-ore-documents--upload");""!==r.find(".js-ore-documents--upload-field").val()&&(t.documents.$content.find(".js-ore-documents--upload-control").hide(),t.documents.$content.find(".js-ore-documents--upload-progress").find(".js-ore-documents--upload-progress-bar").css({width:"0%"}).addClass("active").end().show(),KT.apiClient.uploadDocument(e.orderId,r).done(function(t){0!==t.status?KT.notify("loadingDocumentsFailed",t.errorCode+": "+t.errors):e.mds.OrderStorage.setDocuments(t.body)}))}),t.$addServiceBlock.on("click",".iconed-link[data-srv]:not(.disabled)",function(){if(!e.mds.OrderStorage.isOffline){var t=$(this).attr("data-srv");switch(window.sessionStorage.setItem("inOrderInfo",JSON.stringify(e.mds.OrderStorage)),t){case"flight":window.location.assign("/UI/searchAvia/index");break;case"accommodation":window.location.assign("/UI/searchHotel/index");break;default:window.sessionStorage.removeItem("inOrderInfo")}}})},t.prototype.load=function(){var e=this;$.extend(e.mds.view.config.templates,e.mds.payment.view.config.templates),$.extend(e.mds.view.config.templates,e.mds.tourists.view.config.templates),$.extend(e.mds.view.config.templates,e.mds.services.view.config.templates),e.mds.payment.controller.init(),e.mds.tourists.controller.init(),e.mds.services.controller.init(),KT.getTemplates(e.mds.view.config.templateUrl,e.mds.view.config.templates).then(function(t){return e.mds.tpl=t,KT.apiClient.getOrderInfo(e.orderId)}).then(function(t){return 0===t.status&&void 0!==t.body.orderId||(console.error("Заявка "+e.orderId+" не найдена"),window.location.assign("/cabinetUI/orders/index")),e.mds.OrderStorage.initialize(t.body),"new"===e.orderId?(e.mds.OrderStorage.setServices([]),$.Deferred().reject()):void 0}).then(function(){var t=e.mds.OrderStorage.getServiceIds();t.length>0?KT.apiClient.getOrderOffers(e.orderId,t).then(function(t){return 0===t.status?(e.mds.OrderStorage.setServices(t.body),KT.apiClient.getAllowedTransitions(e.orderId)):$.Deferred().reject()}).then(function(t){0===t.status?Array.isArray(t.body.services)?e.mds.OrderStorage.setAllowedTransitions(t.body.services):(console.warn("список доступных действий пуст"),e.mds.OrderStorage.setAllowedTransitions([])):console.error("не удалось получить доступные действия")}):e.mds.OrderStorage.setServices([]),KT.apiClient.getOrderTourists(e.orderId).done(function(t){var r=void 0!==t.body.tourists?t.body.tourists:[];e.mds.OrderStorage.setTourists(r)}),KT.apiClient.getOrderInvoices(e.orderId).done(function(t){var r=void 0!==t.body.Invoices&&Array.isArray(t.body.Invoices)?t.body.Invoices:[];e.mds.OrderStorage.setInvoices(r)}),KT.apiClient.getOrderHistory(e.orderId).done(function(t){0!==t.status?8===t.errorCode?console.log("Для данной заявки нет истории"):KT.notify("loadingHistoryFailed",t.errorCode+": "+t.errors):e.mds.OrderStorage.setHistory(t.body)}),KT.apiClient.getOrderDocuments(e.orderId).done(function(t){0!==t.status?KT.notify("loadingDocumentsFailed",t.errorCode+": "+t.errors):e.mds.OrderStorage.setDocuments(t.body)})})},t.prototype.loadBare=function(){var e=this;$.extend(e.mds.view.config.templates,e.mds.tourists.view.config.templates),e.mds.tourists.controller.init();var t=window.sessionStorage.getItem("clientId"),r=window.sessionStorage.getItem("contractId");null===t&&(t=KT.getStoredSettings().companyId);var i=KT.getTemplates(e.mds.view.config.templateUrl,e.mds.view.config.templates),o=KT.Dictionary.getAsList("companies",{companyId:+t,fieldsFilter:[],lang:"ru"});i.done(function(t){e.mds.tpl=t}),o.fail(function(){console.error("Ошибка получения данных клиента")}),$.when(i,o).done(function(i,o){if(0!==o.length){var s=o[0];e.mds.OrderStorage.initializeBare({clientId:+t,clientType:s.companyRoleType,clientName:s.name,contractId:r})}else console.error("Ошибка получения данных клиента")})},t}),KT.on("KT.initializedCore",function(){KT.mdx.OrderEdit.controller=new KT.crates.OrderEdit.controller(KT.mdx.OrderEdit),KT.mdx.OrderEdit.controller.init(),"new"===KT.mdx.OrderEdit.controller.orderId?KT.mdx.OrderEdit.controller.loadBare():null!==KT.mdx.OrderEdit.controller.orderId?KT.mdx.OrderEdit.controller.load():window.location.assign("/cabinetUI/orders/index")});
//# sourceMappingURL=cui-orderEdit.min.js.map